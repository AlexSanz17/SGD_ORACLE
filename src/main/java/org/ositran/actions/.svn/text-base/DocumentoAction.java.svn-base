package org.osinerg.actions;

import com.btg.osinergmin.siged.domain.Accion;
import com.btg.osinergmin.siged.domain.Archivo;
import com.btg.osinergmin.siged.domain.ArchivoPendiente;
import com.btg.osinergmin.siged.domain.Cliente;
import com.btg.osinergmin.siged.domain.Concesionario;
import com.btg.osinergmin.siged.domain.Documento;
import com.btg.osinergmin.siged.domain.DocumentoStor;
import com.btg.osinergmin.siged.domain.Documentoenviado;
import com.btg.osinergmin.siged.domain.Documentoxexpediente;
import com.btg.osinergmin.siged.domain.Etapa;
import com.btg.osinergmin.siged.domain.Expediente;
import com.btg.osinergmin.siged.domain.Expedientestor;
import com.btg.osinergmin.siged.domain.Lista;
import com.btg.osinergmin.siged.domain.Notificacion;
import com.btg.osinergmin.siged.domain.Proceso;
import com.btg.osinergmin.siged.domain.Proveido;
import com.btg.osinergmin.siged.domain.Resolucionjaru;
import com.btg.osinergmin.siged.domain.Rol;
import com.btg.osinergmin.siged.domain.Sala;
import com.btg.osinergmin.siged.domain.SeguimientoXUsuario;
import com.btg.osinergmin.siged.domain.Submotivo;
import com.btg.osinergmin.siged.domain.Suministro;
import com.btg.osinergmin.siged.domain.Tipodocumento;
import com.btg.osinergmin.siged.domain.Tipoidentificacion;
import com.btg.osinergmin.siged.domain.Tipoproceso;
import com.btg.osinergmin.siged.domain.Trazabilidadapoyo;
import com.btg.osinergmin.siged.domain.Trazabilidadcopia;
import com.btg.osinergmin.siged.domain.Trazabilidaddocumento;
import com.btg.osinergmin.siged.domain.Trazabilidadexpediente;
import com.btg.osinergmin.siged.domain.Usuario;
import com.btg.osinergmin.siged.domain.UsuarioStor;
import com.opensymphony.xwork2.Action;
import com.opensymphony.xwork2.ActionContext;
import gob.osinergmin.siged.config.SigedProperties;
import java.io.File;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.math.BigDecimal;
import java.net.MalformedURLException;
import java.net.URL;
import java.rmi.RemoteException;
import java.text.NumberFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpUtils;
import javax.xml.stream.XMLStreamException;
import org.apache.commons.io.FileUtils;
import org.apache.struts2.ServletActionContext;
import org.apache.struts2.json.annotations.SMDMethod;
import org.osinerg.common.alfresco.AuthThreadLocalHolder;
import org.osinerg.pojos.jasper.CargoReporte;
import org.osinerg.services.AccionService;
import org.osinerg.services.ActividadService;
import org.osinerg.services.ArchivoService;
import org.osinerg.services.ConcesionarioService;
import org.osinerg.services.ControlDeCalidadService;
import org.osinerg.services.GestionDocumentos;
import org.osinerg.services.DocumentoService;
import org.osinerg.services.EtapaService;
import org.osinerg.services.ExpedientestorService;
import org.osinerg.services.IntalioService;
import org.osinerg.services.ListaService;
import org.osinerg.services.NotificacionxEnumerarService;
import org.osinerg.services.ParametroService;
import org.osinerg.services.PlantillaService;
import org.osinerg.services.ProcesoService;
import org.osinerg.services.ProveidoService;
import org.osinerg.services.ReemplazoService;
import org.osinerg.services.RepositorioService;
import org.osinerg.services.ClienteService;
import org.osinerg.services.DocumentoEnviadoService;
import org.osinerg.services.ExpedienteService;
import org.osinerg.services.NotificacionService;
import org.osinerg.services.ResolucionjaruService;
import org.osinerg.services.SeguimientoXUsuarioService;
import org.osinerg.services.TipodocumentoService;
import org.osinerg.services.TipoidentificacionService;
import org.osinerg.services.TrazabilidadapoyoService;
import org.osinerg.services.TrazabilidadcopiaService;
import org.osinerg.services.TrazabilidaddocumentoService;
import org.osinerg.services.TrazabilidadexpedienteService;
import org.osinerg.services.UsuarioService;
import org.osinerg.services.UsuariostorService;
import org.osinerg.utils.ArchivoTemporal;
import org.osinerg.utils.Constantes;
import org.osinerg.utils.DateUtil;
import org.osinerg.utils.DestinatarioList;
import org.osinerg.utils.DocumentoDetail;
import org.osinerg.utils.DocumentoMasivo;
import org.osinerg.utils.DocumentoTemporal;
import org.osinerg.utils.ExpedienteSearch;
import org.osinerg.utils.ExpedienteTree;
import org.osinerg.utils.FechaLimite;
import org.osinerg.utils.UtilEncrip;
import org.osinerg.services.ManejoDeEmailService;
import org.osinerg.siged.service.AlfrescoWSService;
import org.osinerg.utils.StringUtil;
import org.osinerg.utils.UtilOsinerg;
import org.osinerg.webservice.clientes.intalio.InvalidInputMessageFaultException;
import org.osinerg.webservice.clientes.intalio.InvalidParticipantTokenFaultException;
import org.osinerg.webservice.clientes.intalio.UnavailableTaskFaultException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class DocumentoAction {

	private final Logger log = LoggerFactory.getLogger(DocumentoAction.class);

	private File upload;

	private int idGrid;

	private char tipoBusqueda;

	private Boolean mostrarObservacion;
	private Boolean provieneDeMail;

	private Date fechaSesion;
	private Date fechaDerivacion;
	private Date fechaNotiReclamante;
	private Date fechaNotiConcesionario;
	private Date fecha;

	private boolean destinatarioIgualRemitente;
	private boolean paraAprobar;
	private boolean enVentana;
	private boolean bBandeja;
	private boolean bResponsable;
	private boolean ownerproceso;
	private boolean documentoStor;
	private boolean mostrarEtapa;
	private boolean desactivado;
	private boolean unico;
	private boolean flagMensaje;    
	private boolean deMail;
	private boolean apelacion;
	private boolean agregar;
	private boolean fecFueraHorario;

	private ExpedienteSearch objExpedienteSearch;
	private Concesionario objConcesionario = null;
	private GestionDocumentos gestionDocumentos;
	private Documento documento;
	private DocumentoDetail objDD;
	private Documento objDocumento;
	private Boolean bBotonHabilitado;
	private Expediente objExpediente;
	private Cliente objCliente;
	private ArchivoPendiente archivopendiente;
	private Expedientestor expedienteStor;
	private ExpedienteTree objExpedienteTree;
	private List<Tipoidentificacion> lstRadio;
	private List<DestinatarioList> lstDL;
	private List<Trazabilidadcopia> lstTrazabilidadCopia;
	private List<Documento> lstDocumento;
	private List<Archivo> archivos;
	private List<Submotivo> submotivos;
	private List<Suministro> suministros;
	private List<Proveido> proveidos;

	private Integer iIdDoc;
	private Integer iIdPro;
	private Integer avisopermiso;
	private Integer iIdExp;
	private Integer idtrazabilidaddocumento;
	private Integer idTrazabilidadapoyo;
	private Integer idDocumentoSeleccionado;
	private Integer idtipoidentificacion;
	private Integer idtipodocumento;
	private Integer iddestinatario;
	private Integer idccdestinatario;
	private Integer idcorrentista;
	private Integer iddepartamento;
	private Integer idprovincia;
	private Integer iddistrito;
	private Integer idproceso;
	private Integer idconcesionario;
	private Integer idDocumento;
	private Integer idmotivo;
	private Integer idsubmotivo;
	private Integer idsala;
	private Integer idanalista;
	private Integer idCumpleRequisito;
	private Integer idcliente;
	private Integer iIdUpload;
	private Integer iIdNotificacion;
	private Integer idExpedienteNuevo;
	private Integer idPlantilla;
	private Integer idArchivoPendiente;
	private Integer iIdDocumento;
	private Integer idenv;
	private Integer idDocPrincipalExpediente;
	private Integer[] storidsubmotivo;
	private Integer[] arrIdDoc;
	private Integer[] idSubmotivos;
	private Integer[] idSuministros;
	private Integer[] arrIdArchivos;

	private String nombreCliente;
	private String observacionDigitalizador = "";
	private String origenDetalleDoc = null;
	private String strAcc;
	private String digmensaje;
	private String mensaje;
	private String sFechaDocumento;
	private String puedeRechazar = "";
	private String sNombres;
	private String departamento;
	private String provincia;
	private String distrito;
	private String proceso;
	private String correntista;
	private String concesionario;
	private String strUnidad;
	private String strResponsable;
	private String tipodocumento;
	private String tipoidentificacion;
	private String nroidentificacion;
	private String strRazonSocial;
	private String strDireccionPrincipal;
	private String ta;
	private String uploadFileName;
	private String fullFileName;
	private String nrodocumento;
	private String strRUC;
	private String strDireccion;
	private String strCorreoConcesionario;
	private String strRepresentanteLegal;
	private String strTelefonoCliente;
	private String strCorreoCliente;    
	private String nmotivo;
	private String submotivo;
	private String sala;
	private String analista;
	private String cerrar;
	private String ocultar;
	private String sFromBandeja;
	private String sOpcion;
	private String remitenteObservacion;
	private String ultimaObservacion;
	private String otraObservacion;
	private String asuntoObservacion;
	private String accionObservacion;
	private String destinatarioObservacion;
	private String etapaActual;
	private String usuarioRegistro;
	private String codSala;
	private String codEstado;
	private String codVocal;
	private String codResultado;
	private String numeroResolucion;
	private String regresar;
	private String sTipoDerivacion;
	private String sTipoIdentificacion;
	private String sMontoReclamo;
	private String fechaEnTexto;
	private String urlIntalio;
	private String usuarioLogueado;
	private String idsDocumentoPorExSeleccionados;
	private String referencia;
	private String[] apoyo;
	private String[] strAcciones;
	private String[] strPrioridades;
	private String[] storsuministro;
	private List<String> conCopia;
	private List<String> condestinatarios;
	private List<String> concopias;

	private Map<String, String> detallesDocumentoStor;
	private Map<String, Integer> mapSessionStor;
	private Map<String, Object> mapSession;
	private Map<String, String> url;
	private Map<Integer, Boolean> mapChkDocumento = new HashMap<Integer, Boolean>();
	private Map<Integer, String> mapTipoDocumento = new HashMap<Integer, String>();
	private Map<Integer, String> mapCumpleRequisito = new HashMap<Integer, String>();

	private CargoReporte cargo;
	private ListaService listaService;
	private DocumentoEnviadoService documentoenviadoService;
	private TrazabilidadapoyoService trazabilidadapoyoService;
	private AccionService accionService;
	private ActividadService actividadService;
	private ArchivoService archivoService;
	private ClienteService clienteService;
	private ConcesionarioService concesionarioService;
	private DocumentoService documentoService;
	private EtapaService etapaService;
	private ExpedienteService expedienteService;
	private ExpedientestorService expedienteStorService;
	private IntalioService intalioService;
	private NotificacionService notificacionService;
	private NotificacionxEnumerarService notificacionxEnumerarService;
	private PlantillaService plantillaService;
	private ProcesoService procesoService;
	private RepositorioService repositorioService;
	private TipodocumentoService tipoDocumentoService;
	private TipoidentificacionService tipoIdentificacionService;
	private TrazabilidaddocumentoService trazabilidadDocumentoService;
	private TrazabilidadexpedienteService trazabilidadExpedienteService;
	private UsuarioService usuarioService;
	private UsuariostorService usuarioStorService;
	private ParametroService parametroService;
	private FechaLimite fechaLimite;
	private ProveidoService proveidoService;
	private ControlDeCalidadService controlDeCalidadService;
	private ResolucionjaruService resolucionJaruService;
	private ManejoDeEmailService mailService;
	private TrazabilidadcopiaService trazabilidadcopiaService;
	
	private String idDoc;
	private String rutaAlfresco;
	private Archivo archivo;
	//private String archivoPrincipal;
	private String PDF;
	private String asuntoDD;
	private AlfrescoWSService alfrescoWebServiceClient;
	
	@SuppressWarnings("unused")
	private ReemplazoService reemplazoService;
	private SeguimientoXUsuarioService seguimientoXUsuarioService;

	public DocumentoAction(DocumentoService srvD, ProcesoService srvP, ClienteService srvS, TipodocumentoService srvTD, TipoidentificacionService srvTI, UsuarioService srvU, ExpedientestorService expedienteStorservice) {
		documentoService = srvD;
		procesoService = srvP;
		clienteService = srvS;
		tipoDocumentoService = srvTD;
		tipoIdentificacionService = srvTI;
		usuarioService = srvU;
		expedienteStorService = expedienteStorservice;
	}

	public DocumentoAction() {
		super();
	}

	public String goOpenDocumentSearch() {
		log.debug("-> [Action] DocumentoAction - goOpenDocumentSearch():String ");

		if (iIdDoc == null || iIdDoc < 1) {
			log.error("No se recibio ID del documento principal");
			return Action.ERROR;
		}

		mapSession = ActionContext.getContext().getSession();
		mapSession.remove("iIdDocumento");
		mapSession.put("iIdDocumento", iIdDoc);

		log.debug("Se anexaran documentos al documento principal con ID [" + iIdDoc + "]");

		mapTipoDocumento = tipoDocumentoService.getTipoDocumentoMap();

		log.debug("Numero de Tipos de Documentos [" + mapTipoDocumento.size() + "]");

		return Action.SUCCESS;

	}


	public String buscarDocumentoPor() {
		log.debug("-> [Action] DocumentoAction - buscarDocumentoPor():String ");

		if (objExpedienteSearch == null) {
			log.error("No hay filtro de busqueda");
			return Action.ERROR;
		}

		Integer iIdDocumentoPrincipal = null;
		mapSession = ActionContext.getContext().getSession();
		iIdDocumentoPrincipal = (Integer) mapSession.get("iIdDocumento");
		lstDocumento = documentoService.buscarLstPor(iIdDocumentoPrincipal, objExpedienteSearch);
		log.debug("Numero de Documentos encontrados [" + lstDocumento.size() + "]");
		mapTipoDocumento = tipoDocumentoService.getTipoDocumentoMap();
		for (Documento objDoc : lstDocumento) {
			mapChkDocumento.put(objDoc.getIdDocumento(), false);
		}
		return Action.SUCCESS;
	}


	public String anexarDocumento() {
		log.debug("-> [Action] DocumentoAction - anexarDocumento():String ");

		if (arrIdDoc == null || arrIdDoc.length < 1) {
			log.error("No se selecciono ningun Documento a anexar");
			return Action.ERROR;
		}

		Integer iIdDocumentoPrincipal = null;
		Usuario objUsuario = null;
		mapSession = ActionContext.getContext().getSession();
		iIdDocumentoPrincipal = (Integer) mapSession.get("iIdDocumento");
		objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);

		log.debug("Propietario del expediente [" + objUsuario.getUsuario() + "]");
		log.debug("Documento principal con ID [" + iIdDocumentoPrincipal + "]");

		documentoService.anexarDocumento(iIdDocumentoPrincipal, arrIdDoc);
		mapSession.remove("iIdDocumento");

		return Action.NONE;
	}

	public String goOpenNuevoCliente() throws Exception {
		log.debug("-> [Action] DocumentoAction - goOpenNuevoCliente():String ");

		lstRadio = tipoIdentificacionService.getTipoIdentificacionMap();
		return Action.SUCCESS;
	}


	public String doSaveCliente() {
		log.debug("-> [Action] DocumentoAction - doSaveCliente():String ");

		if (objCliente == null) {
			log.error("No se recibio ningun cliente");
			return Action.ERROR;
		}

		if (clienteService.findByNroIdentificacion(objCliente.getNumeroIdentificacion()) != null) {
			log.info("El cliente con Nro de Identificacion [" + objCliente.getNumeroIdentificacion() + "] ya existe en la Base de Datos");
			return Action.SUCCESS;
		}

		Cliente objClienteNew = null;
		Cliente objClienteOld = null;
		String sTipoAuditoria = null;
		Usuario objUsuarioSesion = null;
		mapSession = ActionContext.getContext().getSession();
		objUsuarioSesion = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		objClienteOld = new Cliente();
		log.debug("** Creacion de Cliente **");
		objClienteNew = objCliente;
		objClienteNew.setRepresentanteLegal(StringUtil.isEmpty(objClienteNew.getRepresentanteLegal()) ? " " : objClienteNew.getRepresentanteLegal());
		objClienteNew.setDireccionAlternativa(StringUtil.isEmpty(objClienteNew.getDireccionAlternativa()) ? " " : objClienteNew.getDireccionAlternativa());
		objClienteNew.setTelefono(StringUtil.isEmpty(objClienteNew.getTelefono()) ? " " : objClienteNew.getTelefono());
		objClienteNew.setCorreo(StringUtil.isEmpty(objClienteNew.getCorreo()) ? " " : objClienteNew.getCorreo());
		sTipoAuditoria = Constantes.AUDITORIA_TIPO_REGISTRO;
		clienteService.guardarObj(objClienteOld, objClienteNew, objUsuarioSesion.getUsuario(), sTipoAuditoria);

		return Action.SUCCESS;
	}

	public String loadExpediente() {
		log.debug("-> [Action] DocumentoAction - loadExpediente():String ");

		Expediente objE = null;
		if (getIIdExp() == null) {
			return Action.ERROR;
		}
		objE = expedienteService.findByIdExpediente(getIIdExp());
		if (objE == null) {
			return Action.ERROR;
		}
		setObjDD(documentoService.getExpedienteData(getIIdExp()));
		setIdtipoidentificacion(getObjDD().getIIdTipoIdentificacion());
		setTipoidentificacion(getObjDD().getStrTipoIdentificacion());
		setNroidentificacion(getObjDD().getStrNroIdentificacion());
		setStrRazonSocial(getObjDD().getStrRazonSocial());
		setStrRepresentanteLegal(getObjDD().getStrRepresentanteLegal());
		setStrDireccionPrincipal(getObjDD().getStrDireccionPrincipal());
		setIddepartamento(getObjDD().getIIdDepartamento());
		setDepartamento(getObjDD().getStrDepartamento());
		setIdprovincia(getObjDD().getIIdProvincia());
		setProvincia(getObjDD().getStrProvincia());
		setIddistrito(getObjDD().getIIdDistrito());
		setDistrito(getObjDD().getStrDistrito());
		setStrTelefonoCliente(getObjDD().getStrTelefonoCliente());
		setStrCorreoCliente(getObjDD().getStrCorreoCliente());
		setStrRUC(getObjDD().getStrRUC());
		setIdcorrentista(getObjDD().getIIdCorrentista());
		setCorrentista(getObjDD().getStrCorrentista());
		setStrDireccion(getObjDD().getStrDireccionConcesionario());
		setIdcliente(getObjDD().getIIdCliente());
		if (objE.getConcesionario() != null) {
			setStrCorreoConcesionario(objE.getConcesionario().getCorreo());
		}
		setIdproceso(objE.getProceso().getIdproceso());
		setProceso(objE.getProceso().getNombre());
		setStrUnidad(objE.getProceso().getResponsable().getUnidad().getNombre());
		setStrResponsable(objE.getProceso().getResponsable().getNombres() + " " + objE.getProceso().getResponsable().getApellidos());

		return Action.SUCCESS;
	}

	public String loadNewDoc() throws Exception {
		log.debug("-> [Action] DocumentoAction - loadNewDoc():String ");

		Proceso objP = null;
		setLstRadio(tipoIdentificacionService.getTipoIdentificacionMap());

		if (getIdproceso() == null) {
			return Action.ERROR;
		}

		objP = procesoService.findByIdProceso(getIdproceso());

		if (objP == null) {
			return Action.ERROR;
		}

		setIdproceso(objP.getIdproceso());
		setProceso(objP.getNombre());
		setStrUnidad(objP.getResponsable().getUnidad().getNombre());
		setStrResponsable(objP.getResponsable().getNombres() + " " + objP.getResponsable().getApellidos());
		getObjDD().setStrAbreviado(objP.getTipoproceso().getNombre());

		return Action.SUCCESS;
	}
	/**REN Metodo que llama al adjuntar del detalle de la lista de documentos -----------------------------------------------*/
	public String goAdjuntarArchivo(){
		log.debug("-> [Action] DocumentoAction - goAdjuntarArchivo():String ");

		return Action.SUCCESS;

	}
	/**REN Metodo que se encarga de adjuntar archivos adicionales a un documento --------------------------------------------*/
	@SuppressWarnings("unchecked")
	public String doAdjuntarArchivo(){
		log.debug("-> [Action] DocumentoAction - doAdjuntarArchivo():String ");

		Map<String,Object> sesion=ActionContext.getContext().getSession();
		Map<String,List<org.osinerg.utils.ArchivoTemporal>> upload=(Map<String,List<org.osinerg.utils.ArchivoTemporal>>) sesion.get(Constantes.SESSION_UPLOAD_LIST);
		Usuario usuario=(Usuario) sesion.get(Constantes.SESSION_USUARIO);

		documentoService.anexarDocumento(usuario, upload, iIdDoc);

		sesion.put(Constantes.SESSION_UPLOAD_LIST, new HashMap<String,List<org.osinerg.utils.ArchivoTemporal>>());

		return Action.SUCCESS;
	}

	/**REN Metodo que llama al eliminar del detalle de la lista de documentos -----------------------------------------------*/
	public String goEliminarArchivo(){
		log.debug("-> [Action] DocumentoAction - goEliminarArchivo():String ");
		
		return Action.SUCCESS;

	}

	/**REN Metodo que se encarga de colocar los archivos seleccionados como inactivos----------------------------------------*/
	public void doEliminarArchivo(){
		log.debug("-> [Action] DocumentoAction - doAdjuntarArchivo():String ");
		
		if(arrIdArchivos != null && arrIdArchivos.length > 0){
			for(Integer idArchivo : arrIdArchivos){
				archivoService.eliminarArchivo(idArchivo);
			}
		}
	}
	
	@SuppressWarnings("unchecked")
	public String upload() {
		log.debug("-> [Action] DocumentoAction - upload():String ");

		if (getIIdDoc() == null) {
			log.error("No se especifico ningun documento");
			return Action.ERROR;
		}

		Map<String, Object> session = ActionContext.getContext().getSession();
		Documento objDocumento = null;
		Documento objNuevoDocumento = null;
		Integer iContador = (Integer) session.get("contador");
		String sRol = (String) session.get("rol");
		String strTempo = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL);
		Usuario objUsuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
		log.debug("ENTRO AL UPLOAD [" + upload + "]");
		fullFileName = ServletActionContext.getServletContext().getRealPath("/") + strTempo + uploadFileName;
		log.debug("uploadFileName [" + uploadFileName + "]");
		log.debug("fullFileName [" + fullFileName + "]");
		File theFile = new File(fullFileName);

		// copiar a uno temporal ... en este caso sera RealPah/upload/ para aprovechar

		try {
			FileUtils.copyFile(upload, theFile);
			ArchivoTemporal at = new ArchivoTemporal(uploadFileName, theFile);
			if (sRol.equals(Constantes.ROL_DIGITALIZADOR)) {
				List<ArchivoTemporal> l = (List<ArchivoTemporal>) session.get("uploaded_list");
				if (l == null) {
					l = new ArrayList<ArchivoTemporal>();
				}
				l.add(at);
				session.put("uploaded_list", l);
			} else if (sRol.equals(Constantes.ROL_USUARIO_FINAL) || sRol.equals(Constantes.ROL_USUARIO_FINAL_STOR)) {
				if (iContador == null) {
					iContador = 1;
				} else {
					iContador++;
				}
				session.put("contador", iContador);
				log.debug("Valor del Contador [" + iContador + "]");
				objDocumento = documentoService.findByIdDocumento(getIIdDoc());
				try {
					archivoService.checkInToAlfresco(objUsuario, at, objDocumento, iContador, false);
				} catch (Exception e) {
					log.error(e.getMessage(), e);
					log.error("El archivo no existe ,subiendo nuevo doc ");
					objNuevoDocumento = new Documento();
					objNuevoDocumento.setTipoDocumento(tipoDocumentoService.findByNombre("Otros"));
					objNuevoDocumento.setPropietario(objUsuario);
					objNuevoDocumento.setExpediente(objDocumento.getExpediente());
					objNuevoDocumento.setAccion(accionService.findByNombre("registrar"));
					objNuevoDocumento.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
					objNuevoDocumento.setFechaAccion(new Date());
					objNuevoDocumento.setFechaCreacion(new Date());
					objNuevoDocumento.setEstado(Constantes.ESTADO_ACTIVO);
					archivoService.uploadToAlfresco(at, objNuevoDocumento, iContador);
					documentoService.saveDocumento(objNuevoDocumento);
					trazabilidadDocumentoService.saveTrazabilidadDocumento(objNuevoDocumento, objUsuario, false, false);
				}
				session.put("uploaded_list", archivoService.getArchivoList(objDocumento.getExpediente().getIdexpediente(), getIIdDoc(), sRol));
			}
			setObjDD(documentoService.getDocumentDetail(getIIdDoc(), sRol));
		} catch (IOException e) {
			log.error("Ocurrio un error al copiar el archivo", e);
			return Action.ERROR;
		}

		return Action.SUCCESS;
	}


	public String editdocumento() throws Exception {
		log.debug("-> [Action] DocumentoAction - editdocumento():String ");

		if (getIIdDocumento() == null || getIIdDocumento() < 1) {
			log.error("No se recibio ID de Documento a ver");
			return Action.ERROR;
		}
		log.debug("Documento a ver con ID [" + getIIdDocumento() + "]");
		setMapSession(ActionContext.getContext().getSession());
		Usuario objUsuario = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		setObjDocumento(documentoService.findByIdDocumento(getIIdDocumento()));
		setBBotonHabilitado(false);
		getMapSession().put("uploaded_list", archivoService.getArchivoList(getObjDocumento().getExpediente().getIdexpediente(), getObjDocumento().getIdDocumento(), objUsuario.getRol().getNombre()));
		if (archivoService.checkEstadoDigitalizacion(getObjDocumento().getIdDocumento()) > 0) {
			setBBotonHabilitado(true);
		}
		return Action.SUCCESS;
	}

	public void limpiarCarpetaTemporalxUsuario(String usuario) {
		log.debug("-> [Action] DocumentoAction - limpiarCarpetaTemporalxUsuario():void ");

		File carpetaTemporal = new File(SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.UPLOAD_CARPETA_TEMPO));
		if (carpetaTemporal.exists() && carpetaTemporal.isDirectory()) {
			String[] archivosTemporales = carpetaTemporal.list();
			File tempDelete = null;
			for (String archivoTemporal : archivosTemporales) {
				if (archivoTemporal.contains("[" + usuario)) {
					log.debug("Archivo temporal a elminar:" + archivoTemporal);
					tempDelete = new File(SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.UPLOAD_CARPETA_TEMPO), archivoTemporal);
					tempDelete.delete();
				}
			}
		}
	}

	/**REN MÈtodo que se activa cuando el usuario final hace click a una fila de la grilla -----------------------------------*/
	@SuppressWarnings("unused")
	public String viewDocUsuarioFinal() {
		log.debug("-> [Action] DocumentoAction - viewDocUsuarioFinal():String ");
        /*
         * wvcarrasco pendiente  20-02-2012
		if (iIdDoc == null || iIdDoc < 1) {
			this.fecFueraHorario = false;
		}else{
			this.fecFueraHorario = true;
		}
		*/

		if (iIdDoc == null || iIdDoc < 1) {
			log.error("No se recibio ningun ID de Documento a ver");
			return Action.ERROR;
		}
		log.debug("Documento a ver con ID [" + iIdDoc + "]");

		mapSession = ActionContext.getContext().getSession();
		Usuario objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		documento = documentoService.findByIdDocumento(iIdDoc);

		if(documento.getConfidencial().equals(Constantes.Si)){
        	List<Integer> permitidos = documentoService.getUsuariosPermitidos(documento.getDocumentoreferencia() != null ? documento.getDocumentoreferencia() : documento.getIdDocumento());
        	if(!permitidos.contains(new BigDecimal(objUsuario.getIdusuario()))){
        		return "sinpermiso";
            }
        }
		
		Integer counttraza= trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).size();
		counttraza = counttraza == null ? 0 : counttraza;
		
		agregar = false;
		
		if(seguimientoXUsuarioService.buscarSeguimiento(objUsuario.getIdusuario(), iIdDoc).isEmpty()){
			agregar = true;
		}
		
		try{
		if(documento.getAutor().getIdusuario().intValue() == objUsuario.getIdusuario().intValue() && counttraza == 1){
			destinatarioIgualRemitente = true;
		}else{
			destinatarioIgualRemitente = false;
		}
		}catch(Exception e){
			e.printStackTrace();
			destinatarioIgualRemitente = false;
		}
		
		int total = trazabilidadDocumentoService.totalCompartidos(objUsuario.getIdusuario(), documento.getPropietario().getIdusuario());

		if (total > 0) {
			ServletActionContext.getRequest().getSession().setAttribute("UsuarioCompartido", documento.getPropietario());
		} else {
			ServletActionContext.getRequest().getSession().setAttribute("UsuarioCompartido", null);
		}

		log.info("detectar  reenvio o aprovacion :" + documento.getAccion().getNombre());
		if (documento.getAccion().getNombre().equals(Constantes.ACCION_PARA_APROBAR)) {
			this.paraAprobar = true;
		} else {
			this.paraAprobar = false;
		}

		Integer traza;
		//Visualizar destinatarios con copia

		 
		//     traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
		//   List<NotificacionxEnumerar> listaNotificacion = notificacionxEnumerarService.buscarLastNotificacionesbyDocumento(iIdDoc, Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
		//   lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(iIdDoc,documento.get);
		String creador= (documento.getAutor() != null ? documento.getAutor().getNombreCompleto() : null);

		if(creador==null){
			creador=Constantes.AUTOR_USUARIO_FINAL;
		}
		if(creador.equals(Constantes.MESA_PARTES) && counttraza==3){
			traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(counttraza-1).getIdtrazabilidaddocumento();

		}
		else{
			if(documento.getDocumentoreferencia() != null){
				/**Es una copia para trabajo----------------------------------------------------------------------------------*/
				traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(documento.getDocumentoreferencia()).get(0).getIdtrazabilidaddocumento();
			}else{
				traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
			}
		}
		lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(iIdDoc,traza);

		StringBuilder cadenaCC = new StringBuilder();
		if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
			for(int i=0; i<lstTrazabilidadCopia.size(); i++){
				if(i!=0) cadenaCC.append(", ");
				cadenaCC.append( lstTrazabilidadCopia.get(i).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(i).getDestinatario().getNombres());
			}
		}
		/*	lstTrazabilidadCopia = trazabilidadcopiaService.buscarPorOrigen(idTrazabilidad, tipoOrigen);
		if(tipoOrigen.equals(Constantes.TIPO_ORIGEN_TRAZADOCUMENTO)){
			idOrigen = trazabilidadDocumentoService.findTrabilidadbyId(idTrazabilidad).getDocumento().getExpediente().getNroexpediente();
		}else {
			idOrigen = Integer.toString(trazabilidadcopiaService.buscarPorId(idTrazabilidad).getIdorigen());
		}
		for(Trazabilidadcopia actual : lstTrazabilidadCopia){
			if(trazabilidadcopiaService.numeroCopias(actual.getIdtrazabilidadcopia(), Constantes.TIPO_ORIGEN_TRAZACOPIA)>0){
				actual.setConCopias(true);
			}else{
				actual.setConCopias(false);
			}
		}*/
		/*if(cadenaCC.length()!=0){
			objDD.setCadenaCC(cadenaCC.toString());	
		}*/

		//this.setDocumento(objDD);


		//objTime.stop();
		//log.debug("Tiempo findByIdDocumento [" + objTime.getElapsedTime() + "]");
		//log.debug("TESTING OPTIMIZAZTION");
		
		Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		suministros = null;
		submotivos = null;
		if (documento != null) {
			//if(documento.getPropietario().equals(usuario)){
			Expediente expediente = documento.getExpediente();
			if (expediente != null) {
				Proceso proceso = expediente.getProceso();
				if (proceso != null) {
					Tipoproceso tipoProceso = proceso.getTipoproceso();
					if (tipoProceso != null) {
						String tipo = tipoProceso.getNombre();
						if (tipo.equals(Constantes.TIPO_PROCESO_INTALIO) && usuario.getRol() == null) {
							return mostrarDocumentoIntalio();
						}

						Integer iIdDocumentoSesion = (Integer) mapSession.get(Constantes.SESSION_IDDOCUMENTO);


						Integer idUsuario = usuario.getIdusuario();
						Map<String, List<ArchivoTemporal>> mapUpload = null;

						Rol rol = usuario.getRol();
						String nombreRol = Constantes.ROL_USUARIO_FINAL;
						if (rol != null) {
							nombreRol = rol.getNombre();
						}
						log.debug("Id Documento en Sesion [" + iIdDocumentoSesion + "]");
						log.debug("Usuario que revisa el documento [viewDoc]:" + usuario.getUsuario());
						if (iIdDocumentoSesion != null && iIdDocumentoSesion.intValue() != iIdDoc.intValue()) {
							log.debug("Removiendo archivos temporales en sesion");
							mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
							limpiarCarpetaTemporalxUsuario(usuario.getUsuario());
						}
						iIdUpload = 1;
						mapSession.put(Constantes.SESSION_IDDOCUMENTO, iIdDoc);
						
						if(documento.getDocumentoreferencia() != null){
							/**Es una copia de apoyo---------------------------------------------------------*/
							objDD = documentoService.getDocumentDetailOptimized(documento.getDocumentoreferencia(), nombreRol);
							Trazabilidadapoyo tapoyo = trazabilidadapoyoService.buscarUltimaDelegacionUsuario(objUsuario.getIdusuario(), iIdDoc);
							if(tapoyo != null){
								objDD.setStrContenido(tapoyo.getTexto() != null ? tapoyo.getTexto() : "");
								objDD.setStrAsunto(tapoyo.getAsunto() != null ? tapoyo.getAsunto() : objDD.getStrAsunto());
								objDD.setStrDestinatario(tapoyo.getDestinatario().getNombres() + " " + tapoyo.getDestinatario().getApellidos());
							}
							
						}else{
							objDD = documentoService.getDocumentDetailOptimized(getIIdDoc(), nombreRol);
							objDD.setStrRazonSocial(documento.getExpediente().getCliente().getNombreRazon());
							
						}
						// si en caso se tienen usuarios con copia @Danna
						if(cadenaCC.length()!=0){
							objDD.setCadenaCC(cadenaCC.toString());	
						}

						setLstRadio(tipoIdentificacionService.getTipoIdentificacionMap());
						// si el usuario que ve el documento no es el
						// propietario del documento, solo puede ver la
						// trazabilidad
						if (UtilOsinerg.noEsPropietario(usuario, documento.getPropietario())) {
							avisopermiso = 1;
						}
						if (nombreRol.equals(Constantes.ROL_USUARIO_FINAL)) {
							Integer idDoc = documento.getDocumentoreferencia() != null ? documento.getDocumentoreferencia() : documento.getIdDocumento();
							mapSession.put(Constantes.SESSION_UPLOAD_LIST, archivoService.getArchivoListPorDocumento(idDoc));
							this.puedeRechazar = expedienteService.puedeRechazar(documento.getExpediente().getIdexpediente());
						}

						if (getAvisopermiso() != null && getAvisopermiso() == 2) {
							setAvisopermiso(1);
						} else {
							log.debug("Estamos retornando a pruebaArch");
							objDD.setIIdDocumento(iIdDoc);
							return Action.SUCCESS;
						}
					}
				}
				//}
				// en este caso, el usuario que desea ver el documento no es el propietario
			} else {
				log.debug("Excecion nulo");

			}
			objDD.setStrAsunto(documento.getExpediente().getAsunto());
			objDD.setIIdDocumento(iIdDoc);
			return Action.SUCCESS;
		}

		if (enVentana != true) {
			enVentana = false;
		}

		return Action.ERROR;
		/*
		 * }catch(Exception e){ e.printStackTrace();
		 * log.error(e.getMessage(),e); return Action.ERROR; }
		 */
	}

	/**REN Ver detalle del documento desde la grilla de busqueda -------------------------------------------------------------*/
	@SuppressWarnings("unused")
	public String viewDoc() {
		log.debug("-> [Action] DocumentoAction - viewDoc():String ");

		if (iIdDoc == null || iIdDoc < 1) {
			log.error("No se recibio ningun ID de Documento a ver");
			return Action.ERROR;
		}
		log.debug("Documento a ver con ID [" + iIdDoc + "]");
		
		documento = documentoService.findByIdDocumento(iIdDoc);
		Usuario usuario = null;
		mapSession = ActionContext.getContext().getSession();
		
		if(deMail){
			HttpServletRequest request = ServletActionContext.getRequest();
			String key = new String(request.getParameter("session"));
			String usuarioEnc = new String(request.getParameter("xxyyxxx"));
			try {
				String usuarioStr = UtilEncrip.decrypt(key, usuarioEnc);
				usuario = usuarioService.findByUsuario(usuarioStr);
			} catch (Exception e) {
				e.printStackTrace();
			}
			if (usuario == null) usuario = documento.getExpediente().getIdpropietario();
			AuthThreadLocalHolder.setUsuario(usuario);
			mapSession.put(Constantes.SESSION_USUARIO, usuario);
		}else{
			usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		}
		
		if (log.isDebugEnabled()) {
			log.debug("deMail [" + deMail + "]");
		}

		mapSession.put("provieneDeMail", deMail ? true : false);
		suministros = null;
		submotivos = null;
		if (documento != null) {
			//if(documento.getPropietario().equals(usuario)){
			Expediente expediente = documento.getExpediente();
			if (expediente != null) {
				Proceso proceso = expediente.getProceso();
				if (proceso != null) {
					Tipoproceso tipoProceso = proceso.getTipoproceso();
					if (tipoProceso != null) {
						String tipo = tipoProceso.getNombre();

						if (tipo.equals(Constantes.TIPO_PROCESO_INTALIO) && usuario.getRol() == null) {
							return mostrarDocumentoIntalio();
						}

						Integer iIdDocumentoSesion = (Integer) mapSession.get(Constantes.SESSION_IDDOCUMENTO);
						// Integer iIdUsuario = (Integer)
						// mapSession.get("idusuario");

						Integer idUsuario = usuario.getIdusuario();
						Map<String, List<ArchivoTemporal>> mapUpload = null;
						/*
						 * if(usuario==null){ log.warn("No hay sesion");
						 * this.mensaje="parent"; return Action.LOGIN; }
						 */
						// String strRol = (String) mapSession.get("rol");
						Rol rol = usuario.getRol();
						String nombreRol = Constantes.ROL_USUARIO_FINAL;
						if (rol != null) {
							nombreRol = rol.getNombre();
						}
						log.debug("Id Documento en Sesion [" + iIdDocumentoSesion + "]");
						log.debug("Usuario que revisa el documento [viewDoc]:" + usuario.getUsuario());
						if (iIdDocumentoSesion != null && iIdDocumentoSesion.intValue() != iIdDoc.intValue()) {
							log.debug("Removiendo archivos temporales en sesion");
							mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
							limpiarCarpetaTemporalxUsuario(usuario.getUsuario());
						}
						iIdUpload = 1;
						mapSession.put(Constantes.SESSION_IDDOCUMENTO, iIdDoc);
						//							Measurement objTime = new Measurement();
						//							objTime.start();
						//							objTime.stop();
						//							log.debug("Tiempo tomado en llenar objDD [" + objTime.getElapsedTime() + "]");
						if(documento.getDocumentoreferencia() != null){
							/**Es una copia de apoyo---------------------------------------------------------*/
							objDD = documentoService.getDocumentDetailOptimized(documento.getDocumentoreferencia(), nombreRol);
							/*Trazabilidadapoyo tapoyo = trazabilidadapoyoService.buscarUltimaDelegacionUsuario(usuario.getIdusuario(), iIdDoc);
							String comentario = tapoyo.getTexto(); 
							if(objDD.getStrContenido() == null){
								objDD.setStrContenido(comentario);
							}else{
								objDD.setStrContenido(comentario+ "<br />" +objDD.getStrContenido());
							}*/
						}else{
							objDD = documentoService.getDocumentDetailOptimized(documento.getIdDocumento(), nombreRol);
						}
						setLstRadio(tipoIdentificacionService.getTipoIdentificacionMap());
						// si el usuario que ve el documento no es el
						// propietario del documento, solo puede ver la
						// trazabilidad
						if (usuario.getIdusuario().intValue() != documento.getPropietario().getIdusuario().intValue()) {
							avisopermiso = 1;
						}
						if (nombreRol.equals(Constantes.ROL_USUARIO_FINAL) || nombreRol.equals(Constantes.ROL_MESA_PARTES)) {
							Integer idDoc = documento.getDocumentoreferencia() != null ? documento.getDocumentoreferencia() : documento.getIdDocumento();
							mapSession.put(Constantes.SESSION_UPLOAD_LIST, archivoService.getArchivoListPorDocumento(idDoc));
							//mapSession.put(Constantes.SESSION_UPLOAD_LIST, archivoService.getArchivoList(documento.getExpediente().getIdexpediente(), documento.getIdDocumento(), nombreRol));
							this.puedeRechazar = expedienteService.puedeRechazar(documento.getExpediente().getIdexpediente());
						}
						if (getAvisopermiso() != null && getAvisopermiso() == 1 && getIIdPro() != null) {
							log.debug("aviso permiso [" + getAvisopermiso() + "]");
							Proceso Objproceso = procesoService.findByIdProceso(getIIdPro());
							log.debug("proceso " + Objproceso);
							if (!documentoService.aplicarJerarquia(usuario, Objproceso, iIdDoc)) {
								String tipacceso = Objproceso.getIdtipoacceso().getCodigo();
								List<Usuario> data;
								// List<Expediente> data2;
								log.debug("Tipo de Acceso [" + tipacceso + "]");
								int alerta = 0;
								if (tipacceso.equals("ProcAcc1")) {
									alerta = 1;
								} else if (tipacceso.equals("ProcAcc2")) {
									/*data=Objproceso.getUsuarioList();
                                    for(Usuario objParticipante : data){
                                    log.debug("Participante [" + objParticipante.getIdusuario() + "] Usuario logeado [" + idUsuario + "]");
                                    if(objParticipante.getIdusuario().intValue() == idUsuario.intValue()){
                                    alerta=1;
                                    break;
                                    }
                                    }*/
									if (documentoService.perteneceAccesoProcAcc2(usuario, Objproceso)) {
										alerta = 1;
									}
								} else if (tipacceso.equals("ProcAcc3")) {
									//Documento objD=documentoService.findByIdDocumento(getIIdDoc());
									if(idUsuario.intValue() == documento.getPropietario().getIdusuario().intValue()){
									//if (documentoService.perteneceAccesoProcAcc3(usuario, documento)) {
										alerta = 1;
									}
								} else if (tipacceso.equals("ProcAcc4")) {
									for (Usuario objParticipante : Objproceso.getUsuarioList1()) {
										log.debug("VIP [" + objParticipante.getIdusuario() + "] Usuario logeado [" + idUsuario + "]");
										if (objParticipante.getIdusuario().intValue() == idUsuario.intValue()) {
											alerta = 1;
											break;
										}
									}
								}
								log.debug("Alerta [" + alerta + "]");
								/*SI EL DOCUMENTO TIENE COMO PROPIETARIO AL USUARIO LOGUEADO PODRA VER EL EXPEDIENTE*/
								if (idUsuario.intValue() == documento.getPropietario().getIdusuario().intValue()) {
									alerta = 1;
								}
								if (alerta == 0) {
									return "sinpermiso";
								}
							}
							objDD.setStrAsunto(documento.getExpediente().getAsunto());
							return Action.SUCCESS;
						}
						if (getAvisopermiso() != null && getAvisopermiso() == 2) {
							setAvisopermiso(1);
						}
						log.debug("objDD.getStrRol() [" + objDD.getStrRol() + "]");
						if (objDD.getStrRol().startsWith(Constantes.ROL_MESA_PARTES)
								|| objDD.getStrRol().startsWith(Constantes.ROL_DIGITALIZADOR)
								|| objDD.getStrRol().startsWith(Constantes.ROL_QAS)) {
							ServletActionContext.getRequest().getSession().setAttribute("documentoSessionQAS", documento);
							ServletActionContext.getRequest().getSession().setAttribute("documentoStorSessionQAS", documento.getDocumentoStor());
							if (objDD.getStrRol().equals(Constantes.ROL_QAS) && tipo.equals(Constantes.TIPO_PROCESO_STOR)) {
								DocumentoStor documentoStor = documento.getDocumentoStor();
								if (documentoStor != null) {
									log.debug("Procesando un Documento Principal STOR - Documento Iniciador de Proceso");
									// Formato STOR - Provisional
									NumberFormat numberFormat = NumberFormat.getInstance(new Locale("us"));
									numberFormat.setMaximumFractionDigits(2);
									Double monto = documentoStor.getMonto();
									log.debug("Monto en java toString(): " + monto.toString());
									sMontoReclamo = (!monto.toString().equalsIgnoreCase("0.0")) ? numberFormat.format(monto) : "0.00";
									objDD.setStrMontoReclamo(sMontoReclamo.replace(",", ""));
									log.debug("Monto: " + sMontoReclamo);
									suministros = documentoStor.getSuministros();
									submotivos = documentoStor.getSubmotivos();
								} else {
									log.debug("Procesando un Documento Adicional - Adjuntando a un expediente stor");
								}
							}
							if (objDD.getStrRol().startsWith(Constantes.ROL_DIGITALIZADOR)) {
								mapUpload = archivoService.obtenerArchivosRechazados(iIdDoc);
								mapSession.put(Constantes.SESSION_UPLOAD_LIST, mapUpload);
								iIdUpload = 2;
							} else if (nombreRol.equals(Constantes.ROL_QAS)) {
								mapSession.put(Constantes.SESSION_UPLOAD_LIST, archivoService.findByIdDocumento(iIdDoc));
							}

							//                            this.digmensaje = parametroService.findByTipoUnico(Constantes.MAX_SIZE_FILE).getValor();
							Long max_file_size = 0L;
							try {
								max_file_size = Long.valueOf(parametroService.findByTipoUnico(Constantes.MAX_SIZE_FILE).getValor());//new Long(ValoresProperties.getProperty("struts.multipart.maxSize", "struts"));
							} catch (NumberFormatException nfe) {
								mapSession.put(Constantes.MENSAJE_UPLOAD, "El tama√±o m√°ximo del archivo configurado es incorrecto, debe ser num√©rico (en bytes)");
								return Action.ERROR;
							} catch (NullPointerException npe) {
								mapSession.put(Constantes.MENSAJE_UPLOAD, "El tama√±o m√°ximo del archivo configurado es incorrecto, debe ser num√©rico (en bytes)");
								return Action.ERROR;
							}
							this.digmensaje = String.valueOf((max_file_size / 1024) / 1024) + " MB.";
							ServletActionContext.getRequest().setAttribute("fechaCreacion", objDD.getFechacreacion());
							nombreCliente = objDD.getStrTipoIdentificacion() + " - " + objDD.getStrNroIdentificacion() + " - " + objDD.getStrRazonSocial();
							return usuario.getRol().getIdperfil().getNombre(); // Se
							// direcciona
							// segun el
							// perfil a un
							// determinado JSP
						} else if (esUsuarioSAS(usuario)) {
							log.info("USUARIO SAS LOGEADO");
							log.info("documento:" + this.getDocumento());

							mapSession.get(Constantes.SESSION_RECURSO);
							//R=perfilService.getMapRecursosPorRoles(usuario.getRoles(),recSesion);
							return Constantes.ROL_USUARIO_FINAL_SAS;

						} else if (tipoProceso.getNombre().equals(Constantes.TIPO_PROCESO_STOR)) {
							if (usuarioService.validarSesionEnIntalio(mapSession)) {
								// Cargar lista de recursosxperfil
								// setMapSessionStor(ActionContext.getContext().getSession());
								Integer idActividad = expediente.getIdactividad().getIdActividad();
								// Integer idPeril =
								// getSrvU().findByIdUsuario(idUsuario).getRol().getIdperfil().
								// getIdperfil();
								// Map<String,Integer> recursoxperfil =
								// getSrvPerfil().getMapRecursoXPerfil(idPeril);
								// log.info("Numero de elementos en recursoxperfil: "
								// +
								// recursoxperfil.size());
								mapSessionStor = actividadService.getMapRecursoXActividad(idActividad);
								// log.info("Buscando recurso del Perfil: "
								// +
								// getSrvU().findByIdUsuario(idUsuario).getRol().getIdperfil().
								// getIdperfil());
								// log.info("Numero de elementos en recursoxperfil: "
								// +
								// recursoxperfil.size());
								log.debug("Numero de elementos en recursoxactividad: " + mapSessionStor.size());
								// Manejo de Mensajes
								String etapaExpediente = expediente.getExpedientestor().getEtapa().getCodigo();
								String estadoExpediente = expediente.getExpedientestor().getEstado().getCodigo();
								log.debug("MANEJO DE MENSAJES ==> ETAPA: " + etapaExpediente + " ESTADO: " + estadoExpediente);
								if (!etapaExpediente.equalsIgnoreCase("traming") || !estadoExpediente.equalsIgnoreCase("anls")) {
									log.debug("BUSCAR ULTIMA TRAZABILIDAD PARA EXPEDIENTE " + expediente.getIdexpediente());
									Trazabilidadexpediente ultimaTrazabilidadExpediente = trazabilidadExpedienteService.findUltimoRegistroByExpediente(expediente.getIdexpediente());
									// Trazabilidadexpediente
									// antepenultimaTrazabilidadExpediente=trazabilidadexpedienteService.findByIdTrazabilidadExpediente(ultimaTrazabilidadExpediente.getIdtrazabilidadexpediente()-2);
									Trazabilidadexpediente antepenultimaTrazabilidadExpediente = trazabilidadExpedienteService.findByNroRegistroByExpediente(expediente.getIdexpediente(), ultimaTrazabilidadExpediente.getNroregistro() - 2);
									ultimaObservacion = ultimaTrazabilidadExpediente.getObservacion();
									mostrarObservacion = ultimaObservacion == null || ultimaObservacion.equalsIgnoreCase("") ? false : true;
									// String rolRemitente =
									// ultimaTrazabilidadExpediente.getRemitente().getRol().
									// getNombre();
									String estadoObservacion = ultimaTrazabilidadExpediente.getExpediente().getExpedientestor().getEstado().getCodigo();
									Usuario usuarioRegistro = trazabilidadExpedienteService.findUltimoRegistroByExpediente(expediente.getIdexpediente()).getRemitente();
									remitenteObservacion = usuarioRegistro.getNombres() + " " + usuarioRegistro.getApellidos();
									Usuario destinatario = ultimaTrazabilidadExpediente.getDestinatario();
									destinatarioObservacion = destinatario.getNombres() + " " + destinatario.getApellidos();
									if (!mostrarObservacion.booleanValue()) {
										log.debug("NO HUBO OBSERVACION EN LA ULTIMA ACCION");
										asuntoObservacion = Constantes.ASUNTO_APROBAR_EXPEDIENTE;
									} else {
										accionObservacion = ultimaTrazabilidadExpediente.getAccion().getNombre();
										String antepenultimaObservacion = antepenultimaTrazabilidadExpediente.getAccion().getNombre();
										log.debug("MOSTRAR OBSERVACION DE " + remitenteObservacion + " ACCION OBSERVACION" + accionObservacion + " ANTEPENULTIMA ACCION: " + antepenultimaObservacion);
										log.debug("IDULTIMATRAZABILIDAD: " + ultimaTrazabilidadExpediente.getIdtrazabilidadexpediente() + " IDANTEPENULTIMATRAZABILIDAD: " + antepenultimaTrazabilidadExpediente.getIdtrazabilidadexpediente());
										if (accionObservacion.equalsIgnoreCase("aprobar") && !estadoObservacion.equalsIgnoreCase("refleg") && !antepenultimaTrazabilidadExpediente.getAccion().getNombre().equalsIgnoreCase("reformulacion tecnica y legal")) {
											log.debug("Primer caso de aprobar");
											asuntoObservacion = Constantes.ASUNTO_APROBAR_EXPEDIENTE;
										} else if (accionObservacion.equalsIgnoreCase("rechazo tecnico")) {
											asuntoObservacion = Constantes.ASUNTO_RECHAZO_TECNICO;
										} else if (accionObservacion.equalsIgnoreCase("rechazo legal")) {
											asuntoObservacion = Constantes.ASUNTO_RECHAZO_LEGAL;
										} else if (accionObservacion.equalsIgnoreCase("rechazo vbst") || accionObservacion.equalsIgnoreCase("rechazo vbsg")) {
											asuntoObservacion = Constantes.ASUNTO_RECHAZO_VB;
										} else if (accionObservacion.equalsIgnoreCase("solicitar cambio sala")) {
											asuntoObservacion = Constantes.ASUNTO_CAMBIO_SALA;
										} else if (accionObservacion.equalsIgnoreCase("rechazo cambio sala")) {
											asuntoObservacion = Constantes.ASUNTO_RECHAZO_CAMBIO_SALA;
										} else if (accionObservacion.equalsIgnoreCase("reformulacion tecnica") || accionObservacion.equalsIgnoreCase("reformulacion tecnica y legal")) {
											asuntoObservacion = Constantes.ASUNTO_REFORMULACION_TECNICA;
										} else if (accionObservacion.equalsIgnoreCase("reformulacion legal")) {
											asuntoObservacion = Constantes.ASUNTO_REFORMULACION_LEGAL;
										} else if (accionObservacion.equalsIgnoreCase("aprobar") && estadoObservacion.equalsIgnoreCase("refleg")) {
											log.debug("Segundo caso de aprobar");
											asuntoObservacion = Constantes.ASUNTO_REFORMULACION_LEGAL;
											accionObservacion = "reformulacion";
											mostrarObservacion = true;
											int idTrazabilidad = ultimaTrazabilidadExpediente.getIdtrazabilidadexpediente().intValue();
											ultimaObservacion = trazabilidadExpedienteService.findByIdTrazabilidadExpediente(idTrazabilidad - 1).getObservacion();
											usuario = trazabilidadExpedienteService.findByIdTrazabilidadExpediente(idTrazabilidad - 1).getRemitente();
											remitenteObservacion = usuario.getNombres() + " " + usuario.getApellidos();
										} else if (accionObservacion.equalsIgnoreCase("aprobar") && antepenultimaTrazabilidadExpediente.getAccion().getNombre().equalsIgnoreCase("reformulacion tecnica y legal")) {
											log.debug("Tercer caso de aprobar");
											asuntoObservacion = Constantes.ASUNTO_APROBAR_EXPEDIENTE;
											ultimaObservacion = "Observacion Legal: " + ultimaObservacion;
											otraObservacion = "Observacion T√©cnica: " + trazabilidadExpedienteService.findByIdTrazabilidadExpediente(ultimaTrazabilidadExpediente.getIdtrazabilidadexpediente() - 1).getObservacion();
										}
									}
								} else {
									// Usuario destinatario =
									// srvU.findByRol("scalif");
									Usuario destinatario = usuarioStorService.getListUsurioStorByRol(Constantes.ROL_USUARIO_SCALIFICADOR_STOR).get(0);
									asuntoObservacion = Constantes.ASUNTO_APROBAR_EXPEDIENTE;
									destinatarioObservacion = destinatario.getNombres() + " " + destinatario.getApellidos();
								}
								return "stor";
							}
							return Constantes.ERROR_INTALIO;
						} else {
							log.debug("Estamos retornando a pruebaArch");

							if (deMail) {
								return "detalleDocEmail";
							}

							return Action.SUCCESS;
						}
					}
				}
				//}
				// en este caso, el usuario que desea ver el documento no es el propietario
			}
			objDD.setStrAsunto(documento.getExpediente().getAsunto());
			return Action.SUCCESS;
		}
		return Action.ERROR;
		/*
		 * }catch(Exception e){ e.printStackTrace();
		 * log.error(e.getMessage(),e); return Action.ERROR; }
		 */
	}

	private String mostrarDocumentoIntalio() {
		log.debug("-> [Action] DocumentoAction - mostrarDocumentoIntalio():String ");

		Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		if (usuario != null) {
			Cliente cliente = documento.getExpediente().getCliente();
			if (cliente.getRazonSocial() != null) {
				nombreCliente = cliente.getRazonSocial();
			} else {
				nombreCliente = cliente.getNombres() + " " + cliente.getApellidoPaterno() + " " + cliente.getApellidoMaterno();
			}
			archivos = archivoService.getArchivoList(documento.getExpediente().getIdexpediente(), documento.getIdDocumento(), null).get("upload1");
			int idExpediente = documento.getExpediente().getIdexpediente();
			urlIntalio = intalioService.getAjaxFormURL(usuario, idExpediente);
			if (urlIntalio != null) {
				return "intalio";
			}
			log.error("No se pudo encontrar la url para el usuario " + usuario + " en el expediente " + documento.getExpediente().getNroexpediente());
		}
		return Action.ERROR;
	}

	private boolean esUsuarioSAS(Usuario usuario) {
		log.debug("-> [Action] DocumentoAction - esUsuarioSAS():boolean ");

		List<Rol> roles = usuario.getRoles();
		for (Rol rol : roles) {
			if (rol.getNombre().equals(Constantes.ROL_USUARIO_SALFE_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_ANALISTA_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_ASESOR_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_SGFE_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_AC_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_AM_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_CA_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_CO_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_DI_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_GA_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_GS_SAS)
					|| rol.getNombre().equals(Constantes.ROL_USUARIO_JU_TR_SAS)) {
				return true;
			}
		}
		return false;
	}


	public String viewDocAdicionales() {
		log.debug("-> [Action] DocumentoAction - viewDocAdicionales():String ");

		try {
			if (idenv != null) {
				Documentoenviado documentoEnviado = documentoenviadoService.findByIddocumentoenviado(idenv);
				
				if(documentoEnviado.getTipoEnvio().equals(Constantes.TIPO_ENVIO_TRANSFERIR)){
					    Trazabilidaddocumento trazdoc = new Trazabilidaddocumento();
					    trazdoc = trazabilidadDocumentoService.findByIdTrazabilidadDocumento(documentoEnviado.getIdTrazabilidadEnvio());
					    iIdDoc = trazdoc.getDocumento().getIdDocumento();
					    log.debug("idEnviado [" + idenv + "] idTrazabilidadDocumento [" + trazdoc.getIdtrazabilidaddocumento() + "] idDocumento [" + iIdDoc + "]");
				}else if(documentoEnviado.getTipoEnvio().equals(Constantes.TIPO_ENVIO_MULTIPLE)){            
                        Trazabilidadapoyo 	trazabilidadapoyo = new Trazabilidadapoyo();	    	   
						trazabilidadapoyo = trazabilidadapoyoService.findByIdTrazabilidadApoyo(documentoEnviado.getIdTrazabilidadEnvio());    	    
			        	iIdDoc = trazabilidadapoyo.getDocumento();
			        	log.debug("idEnviado [" + idenv + "] idTrazabilidadApoyo [" + trazabilidadapoyo.getIdtrazabilidadapoyo() + "] idDocumento [" + iIdDoc + "]");
				}else if(documentoEnviado.getTipoEnvio().equals(Constantes.TIPO_ENVIO_NOTIFICAR)){						
						Notificacion notificacion = new Notificacion();
			        	notificacion = notificacionService.buscarObjPorID(documentoEnviado.getIdTrazabilidadEnvio());
			        	iIdDoc = notificacion.getIddocumento().getIdDocumento();
			        	log.debug("idEnviado [" + idenv + "] idNotificacion [" + notificacion.getIdnotificacion() + "] idDocumento [" + iIdDoc + "]");
			    }	
			}

			if (getIIdNotificacion() != null) {
				setIIdDoc(notificacionService.buscarObjPorID(getIIdNotificacion()).getIddocumento().getIdDocumento());
				log.debug("LOG ID DOC =========== " + this.getIIdDoc());
			}
			// try{
			if (getIIdDoc() == null) {
				log.debug("getIIdDoc()==NULL");
				return Action.ERROR;
			}
			Map<String, Object> session = ActionContext.getContext().getSession();
			Documento objDocumento = documentoService.findByIdDocumento(getIIdDoc());
			if (objDocumento.getExpediente().getIdactividad() != null) {
				setDocumentoStor(true);
			}
			Usuario usuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
			Rol rol = usuario.getRol();
			String nombreRol = null;
			if (rol != null) {
				nombreRol = rol.getNombre();
			}
			setObjDD(documentoService.getDocumentDetail(getIIdDoc(), nombreRol));
			//setObjExpedienteTree(expedienteService.getExpedienteTree(getObjDD().getIIdExpediente()));
/*
			if (!usuario.equals(objDocumento.getPropietario())) {
				avisopermiso = 1;
			}

			//****************
			if (getAvisopermiso() != null && getAvisopermiso() == 1 && getIIdPro() != null) {
				log.debug("aviso permiso [" + getAvisopermiso() + "]");
				Proceso Objproceso = procesoService.findByIdProceso(getIIdPro());
				log.debug("proceso " + Objproceso);
				if (!documentoService.aplicarJerarquia(usuario, Objproceso, iIdDoc)) {
					String tipacceso = Objproceso.getIdtipoacceso().getCodigo();
					List<Usuario> data;
					// List<Expediente> data2;
					log.debug("Tipo de Acceso [" + tipacceso + "]");
					int alerta = 0;
					if (tipacceso.equals("ProcAcc1")) {
						alerta = 1;
					} else if (tipacceso.equals("ProcAcc2")) {
						data = Objproceso.getUsuarioList();
						for (Usuario objParticipante : data) {
							log.debug("Participante [" + objParticipante.getIdusuario() + "] Usuario logeado [" + usuario.getIdusuario() + "]");
							if (objParticipante.getIdusuario().intValue() == usuario.getIdusuario().intValue()) {
								alerta = 1;
								break;
							}
						}
					} else if (tipacceso.equals("ProcAcc3")) {
						Documento objD = documentoService.findByIdDocumento(getIIdDoc());
						if (usuario.getIdusuario().intValue() == objD.getPropietario().getIdusuario().intValue()) {
							alerta = 1;
						}
					} else if (tipacceso.equals("ProcAcc4")) {
						for (Usuario objParticipante : Objproceso.getUsuarioList1()) {
							log.debug("VIP [" + objParticipante.getIdusuario() + "] Usuario logeado [" + usuario.getIdusuario() + "]");
							if (objParticipante.getIdusuario().intValue() == usuario.getIdusuario().intValue()) {
								alerta = 1;
								break;
							}
						}
					}
					/*SI EL DOCUMENTO TIENE COMO PROPIETARIO AL USUARIO LOGUEADO PODRA VER EL EXPEDIENTE*
					//Documento objD=documentoService.findByIdDocumento(getIIdDoc());
					if (usuario.getIdusuario().intValue() == objDocumento.getPropietario().getIdusuario().intValue()) {
						alerta = 1;
					}
					log.debug("Alerta [" + alerta + "]");
					if (alerta == 0) {
						return "sinpermiso";
					}
				}
			}
			//****************
*/
			if (enVentana != true) {
				enVentana = false;
			}

			desactivado = (!trazabilidadDocumentoService.esPrimeraEtapaExpediente(objDocumento.getExpediente().getId()) || objDocumento.getDocumentoreferencia() != null);
			
			return Action.SUCCESS;

		} catch (Exception e) {
			e.printStackTrace();
			log.error(e.getMessage(), e);
			return Action.ERROR;
		}
	}

	public String saveDoc() {
		log.debug("-> [Action] DocumentoAction - saveDoc():String ");

		Usuario objUsuario = null;
		Map<String, Object> session = ActionContext.getContext().getSession();
		objUsuario = (Usuario) session.get(Constantes.SESSION_USUARIO);

		if (objDD != null) {
			DocumentoDetail objAux = objDD;
			objDD = new DocumentoDetail();
			objDD = documentoService.saveDocumentTEMPORAL(objAux, strAcc, iddestinatario, objUsuario, objUsuario.getRol().getNombre(), (String)session.get("nombrePC"));
			cerrar = "OK";

			return Action.SUCCESS;
		}

		return Action.ERROR;
	}

	@SuppressWarnings("unchecked")
	public String registrarDIG() throws Exception {
		log.debug("-> [Action] DocumentoAction - registrarDIG():String ");

		if (iIdDocumento == null) {
			log.error("No se recibio ningun ID Documento");

			return Action.ERROR;
		}

		Map<String, List<ArchivoTemporal>> mapUpload = null;
		Usuario objUsuario = null;

		mapSession = ActionContext.getContext().getSession();
		mapUpload = (Map<String, List<ArchivoTemporal>>) mapSession.get(Constantes.SESSION_UPLOAD_LIST);
		objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);

		if (mapUpload == null) {
			log.info("No hay archivos a subir en el registro del Digitalizador");
		}

		documentoService.registrarDIG(iIdDocumento, mapUpload, objUsuario, this.observacionDigitalizador);

		return Action.SUCCESS;
	}


	public String aprobarQAS() {
		log.debug("-> [Action] DocumentoAction - aprobarQAS():String ");

		setMapSession(ActionContext.getContext().getSession());
		if (objDD == null) {
			log.error("No se recogieron datos del formulario. objDD es null");
			return Action.ERROR;
		}

		Usuario usuario = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		if (log.isDebugEnabled()) {
			log.debug("Proceso seleccionado ID [" + getObjDD().getIIdProceso() + "] Nombre [" + getObjDD().getStrUnidad() + "]\nTipo de Documento seleccionado ID [" + objDD.getIIdTipoDocumento() + "]\nCliente seleccionado ID [" + getObjDD().getIIdCliente() + "] Razon Social [" + getObjDD().getStrResponsable() + "] Tipo de Identicacion [" + getObjDD().getIIdTipoIdentificacion() + "]\nAsunto [" + getObjDD().getStrAsunto() + "]\nAccion a tomar [" + getStrAcc() + "]");
		}
		Rol rol = usuario.getRol();
		if (rol != null && rol.getNombre().equals(Constantes.ROL_QAS)) {
			if (objDocumento != null) {
				Expediente expediente = objDocumento.getExpediente();
				if (expediente != null) {
					Cliente cliente = expediente.getCliente();
					if (cliente != null) {
						if (log.isDebugEnabled()) {
							log.debug("Datos del Cliente personalizado");
							log.debug("Razon Social [" + cliente.getRazonSocial() + "]");
							log.debug("Nombres [" + cliente.getNombres() + "]");
							log.debug("Apellido Paterno [" + cliente.getApellidoPaterno() + "]");
							log.debug("Apellido Materno [" + cliente.getApellidoMaterno() + "]");
							log.debug("Representante Legal [" + cliente.getRepresentanteLegal() + "]");
							log.debug("Direccion Principal [" + cliente.getDireccionPrincipal() + "]");
							String direccionAlternativa = cliente.getDireccionAlternativa();
							if (direccionAlternativa != null) {
								log.debug("Direccion Alternativa [" + direccionAlternativa + "]");
								log.debug("Ubigeo Alternativo [" + cliente.getUbigeoAlternativo().getIddistrito() + "]");
							}
							log.debug("Telefono [" + cliente.getTelefono() + "]");
							log.debug("Correo [" + cliente.getCorreo() + "]");
						}
						objDD.setClienterazonsocial(cliente.getRazonSocial());
						objDD.setClientenombres(cliente.getNombres());
						objDD.setClienteapellidopaterno(cliente.getApellidoPaterno());
						objDD.setClienteapellidomaterno(cliente.getApellidoMaterno());
						objDD.setClienterepresentantelegal(cliente.getRepresentanteLegal());
						objDD.setClientedireccionprincipal(cliente.getDireccionPrincipal());
						if (cliente.getUbigeoPrincipal() != null) {
							objDD.setClienteubigeoprincipal(cliente.getUbigeoPrincipal().getIddistrito());
							log.debug("Ubigeo Principal [" + cliente.getUbigeoPrincipal().getIddistrito() + "]");
						}
						String direccionAlternativa = cliente.getDireccionAlternativa();
						if (direccionAlternativa != null) {
							objDD.setClientedireccionalternativa(direccionAlternativa);
							objDD.setClienteubigeoalternativo(cliente.getUbigeoAlternativo().getIddistrito());
						}
						objDD.setClientetelefono(cliente.getTelefono());
						objDD.setClientecorreo(cliente.getCorreo());
						objDD.setIdSuministros(idSuministros);
						objDD.setIdSubmotivos(idSubmotivos);
						try {
							if (controlDeCalidadService.aprobarDocumento(objDD, usuario, mapSession)) {
								return Action.SUCCESS;
							}
							log.error("Ocurrio un error tratando de aprobar el documento.");
							return Action.ERROR;
						} catch (RemoteException e) {
							e.printStackTrace();
							log.error("Error iniciando proceso en Intalio", e);
							return Action.ERROR;
						} catch (InvalidInputMessageFaultException e) {
							log.error("Parametros pasados al proceso invalidos", e);
							return Action.ERROR;
						} catch (InvalidParticipantTokenFaultException e) {
							log.error("El usuario " + usuario.getUsuario() + " no pudo iniciar sesion en Intalio");
							return Action.ERROR;
						} catch (UnavailableTaskFaultException e) {
							log.error("El proceso seleccionado no se pudo iniciar", e);
							return Action.ERROR;
						} catch (XMLStreamException e) {
							log.error("No se pudo agregar un parametro al iniciar el proceso", e);
							return Action.ERROR;
						}

					}
				}
			}
		}
		log.error("El usuario que intenta aprobar el documento no tiene el rol de Control de Calidad");
		return Action.ERROR;
	}

	
	public String aprobarDocumento_IG(){
		log.debug("-> [Action] DocumentoAction - aprobarDocumento_IG():String ");
		setMapSession(ActionContext.getContext().getSession());		
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		
		if (getSOpcion() == null) {
			log.error("NO HAY OPCION");
			return Action.ERROR;
		}
		if (getArrIdDoc() == null || getArrIdDoc().length < 1) {
			log.error("NO HAY DOCUMENTOS A DERIVAR");
			return Action.ERROR;
		}
		
		iIdUpload = 1;
		log.debug("numero de documentos a derivar:" + getArrIdDoc().length);
		String strCont = "";
		
		log.debug("Tipo de Derivacion [" + getSTipoDerivacion() + "]");
		
		getMapSession().put("arrIdDoc", getArrIdDoc());
		mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
		
		proveidos = proveidoService.buscarPorCodigo(Constantes.CODIGO_PROVEIDO_TRANSFERENCIA);
		
		if (getSTipoDerivacion().equals(Constantes.DERIVAR_NORMAL)) {
			Integer iddoc = getArrIdDoc()[0];
			Integer as = documentoService.findPropietarioByIdDocumento(iddoc).getPropietario().getIdusuario();
			List<String> copia = new ArrayList<String>();
			copia.add("USUARIO_" + as);
			Integer traza;
			conCopia = copia;
			setIIdDoc(iddoc);
			setObjDD(documentoService.getDocumentDetailOptimized(iddoc, null));
			Documento doc = documentoService.findByIdDocumento(iddoc);
			objDD.setStrAccion(doc.getAccion().getNombre());
			objDD.setiIdAccion(doc.getAccion().getIdAccion());
			
			Integer counttraza= trazabilidadDocumentoService.findByMaxtrazabyIddocumento(objDD.getIIdDocumento()).size(); 

			String creador = (doc.getAutor() != null ? doc.getAutor().getNombreCompleto() : null);
			if(creador==null){
				creador=Constantes.AUTOR_USUARIO_FINAL;
			}
			if(creador.equals(Constantes.MESA_PARTES) && counttraza==3){
				traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(objDD.getIIdDocumento()).get(counttraza-1).getIdtrazabilidaddocumento();

			}
			else{
				traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
			}
			lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(objDD.getIIdDocumento(),traza);

			StringBuilder cadenaCC = new StringBuilder();
			if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
				for(int i=0; i<lstTrazabilidadCopia.size(); i++){
					if(i!=0) cadenaCC.append(", ");
					cadenaCC.append( lstTrazabilidadCopia.get(i).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(i).getDestinatario().getNombres());
				}
			}

			objDD.setCadenaCC(cadenaCC.toString());
			
			Date f = getObjDD().getDateFechaLimiteAtencion();
			if (f != null) {
				setFechaEnTexto("El plazo de este documento vence el " + DateUtil.getDia(f) + " " + DateUtil.getDiadeMes(f) + " de " + DateUtil.getMes(f) + " del " + DateUtil.getAnio(f) + " a las " + DateUtil.getHora(f) + " horas.");
			}
			
			if(paraAprobar){
				strCont += "Aprobado";
				Accion acc = accionService.findByNombre(Constantes.ACCION_APROBAR);
				objDD.setStrAccion(Constantes.ACCION_APROBAR);
				objDD.setiIdAccion(acc.getIdAccion());
			}
			
			strCont += "<br />----------------------------------------------<br />"+usuarioSesion.getNombreCompleto()+
			  		" ("+(usuarioSesion.getRoles() != null ? usuarioSesion.getRoles().get(0).getNombre() : "")+")";
			
			getObjDD().setStrContenido(strCont);
			setIIdDoc(getObjDD().getIIdDocumento());
			setTa(strCont);

			Expediente expediente = expedienteService.findPropietarioByIdExpediente(getObjDD().getIIdExpediente());
			Proceso proceso = procesoService.findByIdProceso(getObjDD().getIIdProceso());
			List<Etapa> listaEtapas = etapaService.findEtapabyProceso(getObjDD().getIIdProceso());
			if (listaEtapas != null && listaEtapas.size() > 0) {
				mostrarEtapa = true;
			}
			Integer idPropietario = expediente.getIdpropietario().getIdusuario();
			Usuario responsable = proceso.getResponsable();
			boolean check = false;
			List<Usuario> aCargo = responsable.getUsuariosACargo();
			List<Usuario> participantes = proceso.getUsuarioList();
			for (Usuario u : aCargo) {
				if (participantes.contains(u)) {
					check = true;
					break;
				}
			}
			bResponsable = usuarioSesion.getIdusuario().equals(idPropietario) && aCargo.size() > 0 && check;
			Trazabilidaddocumento objTrazabilidad = trazabilidadDocumentoService.findRemitenteAccionByIddoc(iIdDoc);
			if (Constantes.ACCION_REENVIAR.equals(objTrazabilidad.getAccion().getNombre())) {
				this.paraAprobar = false;
			}

			log.debug("Segun trazabilidad para el Documento con ID [" + iIdDoc + "] el Remitente es [" + objTrazabilidad.getRemitente().getUsuario() + "]");
			objDD.setiIdRemitente(objTrazabilidad.getRemitente().getIdusuario());

			if (log.isDebugEnabled()) {
				log.debug(" iIdUsuario:" + usuarioSesion.getIdusuario() + ", idPropietario:" + idPropietario);
				log.debug(" (iIdUsuario.equals(idPropietario) :" + (usuarioSesion.getIdusuario().equals(idPropietario)));
				log.debug(" resp.getUsuariosACargo()!=null {}", aCargo != null);
				log.debug(" resp.getUsuariosACargo().size():" + aCargo.size());
				log.debug(" responsable:" + bResponsable);
			}
			setOwnerproceso(responsable.getIdusuario().equals(usuarioSesion.getIdusuario()));
			Usuario usuario = null;
			log.debug(" getSOpcion: " + getSOpcion());
			if (getSOpcion().equals(Constantes.RECHAZAR)) {
				log.debug("getSOpcion rechazar ... ");
				Trazabilidaddocumento trazabilidaddocumento = trazabilidadDocumentoService.findByMaxNroRegistro(getIIdDoc(), Constantes.ACCION_ARCHIVAR, null, null);
				if (trazabilidaddocumento.getAccion().getNombre().equalsIgnoreCase(Constantes.ACCION_APROBAR_QAS)) {
					usuario = usuarioService.findByUsuario(Constantes.USUARIO_QAS, trazabilidaddocumento.getRemitente().getUnidad().getSede().getIdsede());
				} else {
					usuario = trazabilidaddocumento.getRemitente();
				}
				setIddestinatario(usuario.getIdusuario());
				mostrarEtapa = false;
				
				Accion accion = accionService.findByNombre(sOpcion);
				objDD.setStrAccion(accion.getNombre());
				objDD.setiIdAccion(accion.getIdAccion());
				
			}
			
		}
		
		return "";
		
	}  
	
	/**REN Metodo llamado cuando se hace click en Derivar en el detalle del documento ----------------------------------------*/
	public String goderivaruser() throws Exception {
		log.debug("-> [Action] DocumentoAction - goderivaruser():String ");
		setMapSession(ActionContext.getContext().getSession());
		
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		
		//if(validarHorarioPermitido(usuarioSesion)){
			mostrarEtapa = false;
			if (getSOpcion() == null) {
				log.error("NO HAY OPCION");
				return Action.ERROR;
			}
			if (getArrIdDoc() == null || getArrIdDoc().length < 1) {
				log.error("NO HAY DOCUMENTOS A DERIVAR");
				return Action.ERROR;
			}
			
			iIdUpload = 1;
			log.debug("numero de documentos a derivar:" + getArrIdDoc().length);
			String strCont = "";
			
			log.debug("Tipo de Derivacion [" + getSTipoDerivacion() + "]");
			
			getMapSession().put("arrIdDoc", getArrIdDoc());
			mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
			
			proveidos = proveidoService.buscarPorCodigo(Constantes.CODIGO_PROVEIDO_TRANSFERENCIA);
			
			if (getSTipoDerivacion().equals(Constantes.DERIVAR_NORMAL)) {
				Integer iddoc = getArrIdDoc()[0];
				Integer as = documentoService.findPropietarioByIdDocumento(iddoc).getPropietario().getIdusuario();
				List<String> copia = new ArrayList<String>();
				copia.add("USUARIO_" + as);
				Integer traza;
				conCopia = copia;
				setIIdDoc(iddoc);
				setObjDD(documentoService.getDocumentDetailOptimized(iddoc, null));
				Documento doc = documentoService.findByIdDocumento(iddoc);
				objDD.setStrAccion(doc.getAccion().getNombre());
				objDD.setiIdAccion(doc.getAccion().getIdAccion());
				
				Integer counttraza= trazabilidadDocumentoService.findByMaxtrazabyIddocumento(objDD.getIIdDocumento()).size(); 
	
				String creador = (doc.getAutor() != null ? doc.getAutor().getNombreCompleto() : null);
				if(creador==null){
					creador=Constantes.AUTOR_USUARIO_FINAL;
				}
				if(creador.equals(Constantes.MESA_PARTES) && counttraza==3){
					traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(objDD.getIIdDocumento()).get(counttraza-1).getIdtrazabilidaddocumento();
	
				}
				else{
					traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
				}
				lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(objDD.getIIdDocumento(),traza);
	
				StringBuilder cadenaCC = new StringBuilder();
				if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
					for(int i=0; i<lstTrazabilidadCopia.size(); i++){
						if(i!=0) cadenaCC.append(", ");
						cadenaCC.append( lstTrazabilidadCopia.get(i).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(i).getDestinatario().getNombres());
					}
				}
	
				objDD.setCadenaCC(cadenaCC.toString());
				
				Date f = getObjDD().getDateFechaLimiteAtencion();
				if (f != null) {
					setFechaEnTexto("El plazo de este documento vence el " + DateUtil.getDia(f) + " " + DateUtil.getDiadeMes(f) + " de " + DateUtil.getMes(f) + " del " + DateUtil.getAnio(f) + " a las " + DateUtil.getHora(f) + " horas.");
				}
				
				if(paraAprobar){
					strCont += "Aprobado";
					//sTipoDerivacion = Constantes.ACCION_APROBAR;
					Accion acc = accionService.findByNombre(Constantes.ACCION_APROBAR);
					objDD.setStrAccion(Constantes.ACCION_APROBAR);
					objDD.setiIdAccion(acc.getIdAccion());
				}
				
				strCont += "<br />----------------------------------------------<br />"+usuarioSesion.getNombreCompleto()+
				  		" ("+(usuarioSesion.getRoles() != null ? usuarioSesion.getRoles().get(0).getNombre() : "")+")";
				
				/*if (getObjDD().getStrContenido() != null) {
					strCont += "<p>----------------Mensaje Original----------------<br />" + getObjDD().getStrContenido()+"</p>";
					log.debug(" texto2: " + strCont);
				}*/
				
				getObjDD().setStrContenido(strCont);
				setIIdDoc(getObjDD().getIIdDocumento());
				setTa(strCont);
	
				Expediente expediente = expedienteService.findPropietarioByIdExpediente(getObjDD().getIIdExpediente());
				Proceso proceso = procesoService.findByIdProceso(getObjDD().getIIdProceso());
				List<Etapa> listaEtapas = etapaService.findEtapabyProceso(getObjDD().getIIdProceso());
				if (listaEtapas != null && listaEtapas.size() > 0) {
					mostrarEtapa = true;
				}
				Integer idPropietario = expediente.getIdpropietario().getIdusuario();
				Usuario responsable = proceso.getResponsable();
				boolean check = false;
				List<Usuario> aCargo = responsable.getUsuariosACargo();
				List<Usuario> participantes = proceso.getUsuarioList();
				for (Usuario u : aCargo) {
					if (participantes.contains(u)) {
						check = true;
						break;
					}
				}
				bResponsable = usuarioSesion.getIdusuario().equals(idPropietario) && aCargo.size() > 0 && check;
				Trazabilidaddocumento objTrazabilidad = trazabilidadDocumentoService.findRemitenteAccionByIddoc(iIdDoc);
				if (Constantes.ACCION_REENVIAR.equals(objTrazabilidad.getAccion().getNombre())) {
					this.paraAprobar = false;
				}
	
				log.debug("Segun trazabilidad para el Documento con ID [" + iIdDoc + "] el Remitente es [" + objTrazabilidad.getRemitente().getUsuario() + "]");
				objDD.setiIdRemitente(objTrazabilidad.getRemitente().getIdusuario());
	
				if (log.isDebugEnabled()) {
					log.debug(" iIdUsuario:" + usuarioSesion.getIdusuario() + ", idPropietario:" + idPropietario);
					log.debug(" (iIdUsuario.equals(idPropietario) :" + (usuarioSesion.getIdusuario().equals(idPropietario)));
					log.debug(" resp.getUsuariosACargo()!=null {}", aCargo != null);
					log.debug(" resp.getUsuariosACargo().size():" + aCargo.size());
					log.debug(" responsable:" + bResponsable);
				}
				setOwnerproceso(responsable.getIdusuario().equals(usuarioSesion.getIdusuario()));
				Usuario usuario = null;
				log.debug(" getSOpcion: " + getSOpcion());
				if (getSOpcion().equals(Constantes.RECHAZAR)) {
					log.debug("getSOpcion rechazar ... ");
					Trazabilidaddocumento trazabilidaddocumento = trazabilidadDocumentoService.findByMaxNroRegistro(getIIdDoc(), Constantes.ACCION_ARCHIVAR, null, null);
					if (trazabilidaddocumento.getAccion().getNombre().equalsIgnoreCase(Constantes.ACCION_APROBAR_QAS)) {
						usuario = usuarioService.findByUsuario(Constantes.USUARIO_QAS, trazabilidaddocumento.getRemitente().getUnidad().getSede().getIdsede());
					} else {
						usuario = trazabilidaddocumento.getRemitente();
					}
					setIddestinatario(usuario.getIdusuario());
					mostrarEtapa = false;
					
					Accion accion = accionService.findByNombre(sOpcion);
					objDD.setStrAccion(accion.getNombre());
					objDD.setiIdAccion(accion.getIdAccion());
					
				}
				
			} /*else if (getSTipoDerivacion().equals(Constantes.DERIVAR_MASIVO)) {
				if (log.isDebugEnabled()) {
					log.debug("DocumentoAction:::goderivaruser");
					log.debug("===================" + getArrIdDoc().length);
					log.debug("Numero de Expedientes a derivar masivamente [" + arrIdDoc.length + "]");
				}
				Documento objDocTemporal = null;
				Integer[] arrDocAntiflujo = new Integer[arrIdDoc.length];
				String sTipoProceso = null;
				int i, j = 0;
				Integer traza2;
				sOpcion = "";
				for (i = 0; i < arrIdDoc.length; i++) {
					objDocTemporal = documentoService.findByIdDocumento(arrIdDoc[i]);
					sTipoProceso = objDocTemporal.getExpediente().getProceso().getTipoproceso().getNombre();
					log.debug("Documento principal recibido con ID [" + arrIdDoc[i] + "] Tipo Proceso [" + sTipoProceso + "]");
					if (sTipoProceso.equalsIgnoreCase(Constantes.TIPO_PROCESO_ANTIFLUJO)) {
						sOpcion += " " + objDocTemporal.getExpediente().getNroexpediente();
						arrDocAntiflujo[j++] = arrIdDoc[i];
					}
	
	
				}
				Integer[] arrDocFinal = new Integer[j];
				j = 0;
				for (i = 0; i < arrDocAntiflujo.length; i++) {
					if (arrDocAntiflujo[i] != null) {
						arrDocFinal[j++] = arrDocAntiflujo[i];
						log.debug("Documento principal a derivar con ID [" + arrDocAntiflujo[i] + "]");
					}
				}
				log.debug("Opcion [" + sOpcion + "]");
				mapSession.put("arrIdDoc", arrDocFinal);
				setIIdDoc(getArrIdDoc()[0]);
	
				setObjDD(documentoService.getDocumentDetail(getIIdDoc(), (String) getMapSession().get("rol")));
				
				//traza2=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).get(0).getIdtrazabilidaddocumento();
	
				Integer counttraza= trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).size(); 
				Documento doc1 = documentoService.findByIdDocumento(getIIdDoc());
				String creador = (doc1.getAutor() != null ? doc1.getAutor().getNombreCompleto() : null);
				if(creador==null){
					creador=Constantes.AUTOR_USUARIO_FINAL;
				}
				if(creador.equals(Constantes.MESA_PARTES) && counttraza==3){
					traza2=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).get(counttraza-1).getIdtrazabilidaddocumento();
	
				}
				else{
					traza2=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).get(0).getIdtrazabilidaddocumento();
				}
				//   lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(objDD.getIIdDocumento(),traza2);
	
				lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(getIIdDoc(),traza2);
	
				StringBuilder cadenaCC = new StringBuilder();
				if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
					for(int t=0; i<lstTrazabilidadCopia.size(); t++){
						if(t!=0) cadenaCC.append(", ");
						cadenaCC.append( lstTrazabilidadCopia.get(t).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(t).getDestinatario().getNombres());
					}
				}
	
				objDD.setCadenaCC(cadenaCC.toString());
				
				strCont = "<br /><br /><br /><p>----------------------------------------------<br />"+usuarioSesion.getNombreCompleto()+
					  "<br />"+(usuarioSesion.getRoles() != null ? usuarioSesion.getRoles().get(0).getNombre() : "")+"</p>";
				
				if (getObjDD().getStrContenido() != null){
					strCont += "<p>----------------Mensaje Original----------------<br />" + getObjDD().getStrContenido()+"</p>";
				}
				getObjDD().setStrAsunto("");
				getObjDD().setStrContenido("");
				setIIdDoc(getObjDD().getIIdDocumento());
				setTa("");
				ProcesoService procExp = this.procesoService;
				Proceso proceso = procExp.findByIdProceso(this.getObjDD().getIIdProceso());
				Integer idUsuario = proceso.getResponsable().getIdusuario();
				setOwnerproceso(idUsuario.equals(usuarioSesion.getIdusuario()));
				return "masivo";
			}*/
	
	
			return Action.SUCCESS;
		/*}else{
			return "errorHorario";
		}*/
	}

	/**REN Llamado cuando un usuario de apoyo hace click en Aprobar o Rechazar. Inicializa el PopUp*/
	public String goDerivarApoyo(){
		log.debug("-> [Action] DocumentoAction - goDerivarApoyo():String ");
		
		setMapSession(ActionContext.getContext().getSession());
		Usuario usuarioSesion = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		
		//if(validarHorarioPermitido(usuarioSesion)){
			mostrarEtapa = false;
	
			String strCont = "<strong>Observaciones :</strong> ";
			iIdUpload = 1;
			
			getMapSession().put("arrIdDoc", getArrIdDoc());
			mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
			sTipoDerivacion = Constantes.DERIVAR_NORMAL;        
	
			iIdDoc = getArrIdDoc()[0];
			objDocumento = documentoService.findByIdDocumento(iIdDoc);
	
			objDD = documentoService.getDocumentDetailOptimized(objDocumento.getDocumentoreferencia(), null);
	
			getObjDD().setStrContenido(strCont);
			setTa(strCont);
	
			//Trazabilidaddocumento traza = trazabilidadDocumentoService.encontrarUltimaTrazabilidadPorDocumento(objDocumento.getDocumentoreferencia());
			Trazabilidadapoyo traza = trazabilidadapoyoService.buscarUltimaDelegacionUsuario(usuarioSesion.getIdusuario(), iIdDoc);
			iddestinatario = traza.getRemitente().getIdusuario();
			sNombres = traza.getRemitente().getNombres() + " " + traza.getRemitente().getApellidos();
	
			return Action.SUCCESS;
		//}else{
		//	return "errorHorario";
		//}
		
	}

	/**REN Llamado cuando un usuario de apoyo hace click en Delegar. Inicializa el PopUp*
	public String goDelegarApoyo(){
		log.debug("-> [Action] DocumentoAction - goDelegarApoyo():String ");

		mapSession = ActionContext.getContext().getSession();
		Usuario usuarioSesion = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		
		//if(validarHorarioPermitido(usuarioSesion)){
			
			mostrarEtapa = false;
	
			if (getArrIdDoc() == null || getArrIdDoc().length < 1) {
				log.error("NO HAY DOCUMENTOS A DERIVAR");
				return Action.ERROR;
			}
			
			String strCont = "<br /><br /><br /><p>----------------------------------------------<br />"+usuarioSesion.getNombreCompleto()+
				  "<br />"+(usuarioSesion.getRoles() != null ? usuarioSesion.getRoles().get(0).getNombre() : "")+"</p>";
	
			iIdUpload = 1;
			mapSession.put("arrIdDoc", getArrIdDoc());
			mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
			sTipoDerivacion = Constantes.DERIVAR_NORMAL;        
	
			iIdDoc = getArrIdDoc()[0];
			objDocumento = documentoService.findByIdDocumento(iIdDoc);
	
			objDD = documentoService.getDocumentDetailOptimized(objDocumento.getDocumentoreferencia(), null);
			objDD.setStrAsunto("Delego Documento: "+objDD.getStrAsunto() != null ? objDD.getStrAsunto() : ""+" ");
	
			//strCont += "<p>--------------- Mensaje Original ---------------</p><p>De : " + objDD.getStrRemitente() + "</p><p>Para : " + objDD.getStrDestinatario() + "</p>" + "<p>CC :"+objDD.getCadenaCC()+" </p><p>Enviado : " + formatoFecha.format(objDD.getStrFecha()) + "</p><p>Asunto : " + objDD.getStrAsunto() + "</p><p>----------------------------------------------</p>";
			if (getObjDD().getStrContenido() != null) {
				strCont += "<p>----------------Mensaje Original----------------<br />" + getObjDD().getStrContenido()+"</p>";
				log.debug(" texto2: " + strCont);
			}
	
			getObjDD().setStrContenido(strCont);
			setTa(strCont);
	
			return Action.SUCCESS;
		//}else{
			//return "errorHorario";
		//}
	}*/

	/**REN abre la ventana para enviar copias de apoyo -----------------------------------------------------------------------*/
	public String goCopiarApoyo(){
		log.debug("-> [Action] DocumentoAction - goCopiarApoyo():String ");
		
		setMapSession(ActionContext.getContext().getSession());
		
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		
		//if(validarHorarioPermitido(usuarioSesion)){
			iIdDoc = getArrIdDoc()[0];    	
			documento = documentoService.findByIdDocumento(iIdDoc);
			iIdPro = documento.getExpediente().getProceso().getIdproceso();
			proveidos = proveidoService.buscarPorCodigo(Constantes.CODIGO_PROVEIDO_TRANSFERENCIA);
			ta = "<br />----------------------------------------------<br />"+usuarioSesion.getNombreCompleto()+
			  " ("+(usuarioSesion.getRoles() != null ? usuarioSesion.getRoles().get(0).getNombre() : "")+")";;
			return Action.SUCCESS;
		//}else{
			//return "errorHorario";
		//}
	}

	/**REN genera las copias de apoyo para los usuarios seleccionados --------------------------------------------------------*/
	public String copiarApoyo(){
		log.debug("-> [Action] DocumentoAction - copiarApoyo():String ");
		log.debug("Sin Plazo"+objDD.getStrSinPlazo());
		mapSession = ActionContext.getContext().getSession();
		Usuario usuario = usuarioService.findByIdUsuario(((Usuario)mapSession.get(Constantes.SESSION_USUARIO)).getIdusuario());
		String nombrePC = (String) mapSession.get("nombrePC");
		/**Copias de Trabajo ----------------------------------------------------------------------------------------*/
		ta = ta != null ? ta.trim() : "";
		Documento documento = documentoService.findByIdDocumento(iIdDoc);
		/*if(documento.getDocumentoreferencia() != null){
			documento.setEstado(Constantes.ESTADO_ATENDER);
			documentoService.saveDocumento(documento);
			
			documento = documentoService.findByIdDocumento(documento.getDocumentoreferencia());
		}*/
				
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		if(apoyo != null && apoyo.length >0){
			Set<Integer> usuariosNotificados = new HashSet<Integer>();
			for(String idUsuario : apoyo){
				if(idUsuario.startsWith("LISTA_")){
					Lista objLista = listaService.findByIdLista(Integer.parseInt(idUsuario.substring(6)));
					String[] txtAcciones = null;
					Integer prioridad = documento.getPrioridad();
						
					if(strAcciones != null){
						for(String fila : strAcciones){
							String[] lista = StringUtil.stringToArray(fila);
							if(lista[0] != null && !lista[0].equals("")){
								if(lista[0].equals(idUsuario)){
									txtAcciones = lista;
									break;
								}
							}
						}
					}
					
					if(strPrioridades != null){
						for(String fila : strPrioridades){
							String[] lista = StringUtil.stringToArray(fila);
							if(lista[0] != null && !lista[0].equals("")){
								if(lista[0].equals(idUsuario)){
									try{
										prioridad = Integer.parseInt(lista[1]);
									}catch(Exception e){
										e.printStackTrace();
									}
									break;
								}
							}
						}
					}
					
					for (Usuario objParticipante : objLista.getParticipanteListaList()) {
						if (!usuariosNotificados.contains(objParticipante.getIdusuario())) {
							usuariosNotificados.add(objParticipante.getIdusuario());
							log.debug("TrazabilidadApoyo a destinatario: "+ objParticipante.getIdusuario());
							documentoService.crearCopiaApoyo(documento, objDD, usuario.getIdusuario(), objParticipante.getIdusuario(), txtAcciones, prioridad, ta, (String)mapSession.get("nombrePC"),fechaLimite.validarHorarioPermitido(usuarioSesion,objParticipante.getIdusuario()));
						}
					}
				}else{
					Integer idApoyo = Integer.parseInt(idUsuario);
					String[] txtAcciones = null;
					Integer prioridad = documento.getPrioridad();
					
					if(strAcciones != null){
						for(String fila : strAcciones){
							String[] lista = StringUtil.stringToArray(fila);
							if(lista[0] != null && !lista[0].equals("")){
								if(Integer.parseInt(lista[0]) == idApoyo.intValue()){
									txtAcciones = lista;
									break;
								}
							}
						}
					}
					
					if(strPrioridades != null){
						for(String fila : strPrioridades){
							String[] lista = StringUtil.stringToArray(fila);
							if(lista[0] != null && !lista[0].equals("")){
								if(Integer.parseInt(lista[0]) == idApoyo.intValue()){
									try{
										prioridad = Integer.parseInt(lista[1]);
									}catch(Exception e){
										e.printStackTrace();
									}
									break;
								}
							}
						}
					}
					log.debug("TrazabilidadApoyo a destinatario: "+ idApoyo);
					documentoService.crearCopiaApoyo(documento, objDD, usuario.getIdusuario(), idApoyo, txtAcciones, prioridad, ta, (String)mapSession.get("nombrePC"),fechaLimite.validarHorarioPermitido(usuarioSesion,idApoyo));
					usuariosNotificados.add(idApoyo);
				}
			}
		    documentoService.archivarDocumento(iIdDoc, usuario, "Archivado por envio multiple", "archivar", nombrePC);
		}
		cerrar = "cerrar";
		return Action.SUCCESS;
	}

	/**REN Manda el documento a uno o varios usuarios, maneja solo las remisiones del documento y no puede mandarse copias ----------*
	public String delegarApoyo(){
		log.debug("-> [Action] DocumentoAction - delegarApoyo():String ");		
		mapSession = ActionContext.getContext().getSession();
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		/**iIdDoc es el Id del documento a delegar ---------------------------------------------------------------------------*/
		/**conCopia contiene los Id de los usuarios a delegar --------------------------------------------------------*/
/**
		log.debug("Delegando el documento a un tercero");
		
		sOpcion = "delegar";
		cerrar = "cerrar";
		
		if(conCopia != null && !conCopia.isEmpty()){
			Documento documento = documentoService.findByIdDocumento(iIdDoc);
			Usuario remitente = documento.getPropietario();			
			for(String  idDest: conCopia){
				documentoService.crearCopiaDelegacion(documento, remitente, Integer.parseInt(idDest), objDD.getStrTexto(), (String)mapSession.get("nombrePC"),fechaLimite.validarHorarioPermitido(usuarioSesion,Integer.parseInt(idDest)));
			}
			
			documento.setEstado(Constantes.ESTADO_ATENDER);
			documentoService.guardarDocumento(documento);
		}else{
			log.debug("No se selecciono un destinatario para la delegacion");
		}
		
		return Action.SUCCESS;
	}*/

	/**REN Devuelve el documento al usuario original, simplemente elimina la copia y crea una notificaciÛn -------------------*/
	public String finalizarApoyo(){
		log.debug("-> [Action] DocumentoAction - finalizarApoyo():String ");
		mapSession = ActionContext.getContext().getSession();
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		/**EnvÌa una notificaciÛn al dueÒo del expediente --------------------------------------------------------------------*/
		/**iddestinatario es el id del Usuario dueÒo del expediente ahora*/

		Documento documento = documentoService.findByIdDocumento(iIdDoc);
		Documento docOriginal = documentoService.findByIdDocumento(documento.getDocumentoreferencia());
		docOriginal.setObservacion(objDD.getStrTexto());

		Map<String, Object> session = ActionContext.getContext().getSession();
		Usuario objUsuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
       /** cuando se responde un documento sucede q busca en trazabilidadapoyo, y solo se actualiza el estado atendido, ahora la fecha de respuesta solo se guarda en Notificacion.*/
		//wvcarrasco 16-11-2011 se crea una trazabilidadapoyo al responder documento dentro de enviarNotificacion
		notificacionService.enviarNotificacion(objUsuario, usuarioService.findByIdUsuario(iddestinatario), docOriginal, Constantes.TIPO_NOTIFICACION_FIN_APOYO, (String)session.get("nombrePC"),fechaLimite.validarHorarioPermitido(usuarioSesion,iddestinatario),documento);
		//wcarrasco 24-10-2011 deprecado  Constantes.ESTADO_CODIGO_CONCLUIDO 
		documentoService.guardarTrazaFinalizarApoyo(iIdDoc, objUsuario.getIdusuario(), Constantes.ESTADO_CODIGO_RESPONDIDO);
		
		
		/**Elimina la copia utilizada ----------------------------------------------------------------------------------------*/
		/**iIdDoc es el id del documento a eliminar*/
		//documentoService.eliminarDocumento(iIdDoc);
		documento.setEstado(Constantes.ESTADO_ATENDER);
		documentoService.guardarDocumento(documento);
		cerrar = "S";

		return Action.SUCCESS;
	}
	
	public String mostrarDerivacionMasiva() throws Exception {
		log.debug("-> [Action] DocumentoAction - mostrarDerivacionMasiva():String ");

		mostrarEtapa = false;
		if (sOpcion == null) {
			log.error("NO HAY OPCION");
			return Action.ERROR;
		}
		if (arrIdDoc == null || arrIdDoc.length < 1) {
			log.error("NO HAY DOCUMENTOS A DERIVAR");
			return Action.ERROR;
		}
		iIdUpload = 1;
		log.debug("numero de documentos a derivar:" + arrIdDoc.length);
		setMapSession(ActionContext.getContext().getSession());
		log.debug("Tipo de Derivacion [" + sTipoDerivacion + "]");
		getMapSession().put("arrIdDoc", arrIdDoc);
		mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());

		if (sTipoDerivacion.equals(Constantes.DERIVAR_MASIVO)) {
			Documento objDocTemporal = null;
			Integer[] arrDocAntiflujo = new Integer[arrIdDoc.length];
			String sTipoProceso = null;
			int i, j = 0;
			Integer traza2;
			sOpcion = "";
			int contProcesoStor=0;
			List<Proceso> dataProceso=procesoService.findbyProcesosStor();
			Proceso procesoTemp=null;
			for (i = 0; i < arrIdDoc.length; i++) {
				objDocTemporal = documentoService.findByIdDocumento(arrIdDoc[i]);
				Proceso proceso=objDocTemporal.getExpediente().getProceso();
				sTipoProceso = proceso.getTipoproceso().getNombre();
				log.debug("Documento principal recibido con ID [" + arrIdDoc[i] + "] Tipo Proceso [" + sTipoProceso + "]");
				if (sTipoProceso.equalsIgnoreCase(Constantes.TIPO_PROCESO_ANTIFLUJO)) {
					sOpcion += " " + objDocTemporal.getTipoDocumento().getNombre() + " - " + objDocTemporal.getNumeroDocumento();
					arrDocAntiflujo[j++] = arrIdDoc[i];
				}

				if(proceso.getNombreIntalio()!=null){
					mensaje="Los documentos seleccionados pertenecen a procesos de BPMS Intalio, no se puede derivar masivamente";
					flagMensaje=false;
					return "masivo";
				}
				else{
					if(objDocTemporal.getDocumentoreferencia() != null){
						mensaje="Uno o mas documentos seleccionados le han sido enviados usando el Envio Multiple, no se puede transferir masivamente los documentos enviados mediante el Envio Multiple";
						flagMensaje=false;
						return "masivo";
					}else{
						flagMensaje=true;
					}
				}
				
				if(isProcesoStor(dataProceso, proceso)){

					if(i==0)
					{
						procesoTemp=proceso;
						contProcesoStor++;
					}
					else{
						if(procesoTemp.getIdproceso()==proceso.getIdproceso()){
							contProcesoStor++;
						}
					}
				}
			}
			if(objDocTemporal!=null){
				iddestinatario=objDocTemporal.getPropietario().getIdusuario();
			}

			if(contProcesoStor==arrIdDoc.length){
				mostrarEtapa = true;
				flagMensaje=true;
			}
			else if(contProcesoStor<arrIdDoc.length && contProcesoStor!=0){
				mensaje="Los documentos seleccionado no se puede derivar masivamente, por NO son todos del proceso Stor";
				flagMensaje=false;
				return "masivo";
			}
			else{
				flagMensaje=true;
			}

			Integer[] arrDocFinal = new Integer[j];
			j = 0;
			for (i = 0; i < arrDocAntiflujo.length; i++) {
				if (arrDocAntiflujo[i] != null) {
					arrDocFinal[j++] = arrDocAntiflujo[i];
					log.debug("Documento principal a derivar con ID [" + arrDocAntiflujo[i] + "]");
				}
			}
			log.debug("Opcion [" + sOpcion + "]");
			mapSession.put("arrIdDoc", arrDocFinal);
			setIIdDoc(getArrIdDoc()[0]);

			setObjDD(documentoService.getDocumentDetail(getIIdDoc(), (String) getMapSession().get("rol")));
			
			Integer counttraza= trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).size(); 
			Documento doc1 = documentoService.findByIdDocumento(getIIdDoc());
			String creador = (doc1.getAutor() != null ? doc1.getAutor().getNombreCompleto() : null);
			if(creador==null){
				creador=Constantes.AUTOR_USUARIO_FINAL;
			}
			if(creador.equals(Constantes.MESA_PARTES) && counttraza==3){
				traza2=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).get(counttraza-1).getIdtrazabilidaddocumento();

			}
			else{
				traza2=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(getIIdDoc()).get(0).getIdtrazabilidaddocumento();
			}
			lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(getIIdDoc(),traza2);
			StringBuilder cadenaCC = new StringBuilder();
			if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
				for(int t=0; i<lstTrazabilidadCopia.size(); t++){
					if(t!=0) cadenaCC.append(", ");
					cadenaCC.append( lstTrazabilidadCopia.get(t).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(t).getDestinatario().getNombres());
				}
			}

			objDD.setCadenaCC(cadenaCC.toString());
			
			String strCont = "<br />----------------------------------------------<br />"+usuarioSesion.getNombreCompleto()+
				  " ("+(usuarioSesion.getRoles() != null ? usuarioSesion.getRoles().get(0).getNombre() : "")+")";;
			getObjDD().setStrAsunto(doc1.getExpediente().getAsunto());
			getObjDD().setStrContenido("");
			setIIdDoc(getObjDD().getIIdDocumento());
			setTa(strCont);
			ProcesoService procExp = this.procesoService;
			Proceso proceso = procExp.findByIdProceso(this.getObjDD().getIIdProceso());
			Integer idUsuario = proceso.getResponsable().getIdusuario();
			setOwnerproceso(idUsuario.equals(usuarioSesion.getIdusuario()));
			return "masivo";
		}


		return Action.SUCCESS;
	}    

	public String gorechazarUser() {
		log.debug("-> [Action] DocumentoAction - gorechazarUser():String ");

		// try{
		// String strCont = null;
		// Map session = ActionContext.getContext().getSession();
		return Action.SUCCESS;
		/*
		 * }catch(Exception e){ log.error(e.getMessage(),e); return
		 * Action.ERROR; }
		 */
	}

	/**REN Metodo para derivar un Documento ---------------------------------------------------------------------------------*/
	@SuppressWarnings({ "unchecked", "rawtypes"})
	public String derivaruser() {
		log.debug("-> [Action] DocumentoAction - derivaruser():String ");
		String[] acciones = StringUtil.stringToArray(strAcc);
		String tipoRetorno = Action.SUCCESS;
		Date fechaLimiteAtencionAnterior = null;
		try {
			log.debug("derivar o rechazar usuario {}", objDD.getStrAccion());
			log.debug("fecha sin plazo : "+ objDD.getStrSinPlazo());
			
			mapSession = ActionContext.getContext().getSession();
			arrIdDoc = (Integer[]) mapSession.get("arrIdDoc");
			String nombrePC = (String)mapSession.get("nombrePC");			
			log.debug("Transfiriendo desde "+nombrePC);
			log.debug("PROBAR DESDE aplicacion : objDD.iIdRemitente"+ objDD.getiIdRemitente() + "objDD.strAsunto"+ objDD.getStrAsunto()+ "objDD.getAprobarIG()"+objDD.getAprobarIG()+ "getIddestinatario()" + getIddestinatario());
			log.debug("objDD.getIIdDocumento()"+objDD.getIIdDocumento()+ "getSTipoDerivacion()"+ getSTipoDerivacion()+ " objDD.strTexto()"+ objDD.getStrTexto()+ "objDD.getStrAccion()"+ objDD.getStrAccion());
			Usuario destinatario = usuarioService.findByIdUsuario(getIddestinatario());
			
			Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
			usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
			
			if(destinatario == null || destinatario.getEstado().equals(String.valueOf(Constantes.ESTADO_INACTIVO))){
				return "errorUsuario";
			}
			/*Etapa objEtapa = null;
			
			if (objExpediente != null && objExpediente.getIdetapa() != null && objExpediente.getIdetapa().getIdetapa() != null) {
				objEtapa = new Etapa();
				objEtapa = etapaService.findByIdetapa(objExpediente.getIdetapa().getIdetapa());
			}
			*/
			
			if (getSTipoDerivacion().equals(Constantes.DERIVAR_NORMAL)) {
				if (objDD.getStrAccion().equals(Constantes.ACCION_REENVIAR)) {
					
					log.debug("DERIVAR_NORMAL");
					
					documento = null;
					Usuario objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
					
					if(strAcciones != null && strAcciones[0] != null){
						getObjDD().setStrContenido(strAcciones[0] + getObjDD().getStrTexto());
					}else{
						getObjDD().setStrContenido(getObjDD().getStrTexto());   
					}

					if (this.paraAprobar) {
						log.debug("Selecciono EL CHECK para Aprobar");
						
						objDD.setStrAccion(Constantes.ACCION_PARA_APROBAR);
					}
					
					log.debug("---------------opcion actual {} ", this.sOpcion);
					
					if (this.sOpcion.equals(Constantes.ACCION_PARA_APROBAR)) {
						
						log.debug("---------------ESTADO - PARA APROBAR ");
						log.debug("Se encuentra en el estado para ser aprobado");
						
						Accion objAccion = null;
						objDD.setStrAccion(Constantes.ACCION_APROBAR);
						
						if (this.paraAprobar) {
							log.debug("Selecciono EL CHECK para Aprobar");
							objDD.setStrAccion(Constantes.ACCION_PARA_APROBAR);
						}
						
						objAccion = accionService.findByNombre(objDD.getStrAccion());
						documento = documentoService.findByIdDocumento(objDD.getIIdDocumento());
						documento.setAccion(objAccion);
						documento.setLeido(Constantes.ESTADO_NO_LEIDO);
						
						log.debug("---------------GUARDANDO TRAZABILIDAD ");
						log.debug("---------------destinatario == remitente => {}", isDestinatarioIgualRemitente());
						/*
						if (!this.isDestinatarioIgualRemitente()) {
							Usuario objDestinatarioAux = usuarioService.findByIdUsuario(objDD.getiIdRemitente());
							log.debug("---------------EJECUTAR SOLO SI EL DESTINATARIO ES DIFERENTE AL REMITENTE ");
							setIddestinatario(objDestinatarioAux.getIdusuario());
							if (this.paraAprobar) {
								log.info("Selecciono el check para Aprobar -ESTADO PARA APROBAR-");
								//  trazabilidadDocumentoService.guardarTrazabilidad(objDocumentoPrincipal, objUsuario, objDestinatarioAux, Constantes.ACCION_APROBAR, objDD.getStrAsunto(), objDD.getStrContenido(), objEtapa);
								objDD.setStrAccion(Constantes.ACCION_PARA_APROBAR);
							} else {
								log.info("NO Selecciono el check para Aprobar -ESTADO PARA APROBAR-");
								trazabilidadDocumentoService.guardarTrazabilidad(documento, objUsuario, objDestinatarioAux, Constantes.ACCION_APROBAR, objDD.getStrAsunto(), objDD.getStrContenido());
								objDD.setStrAccion(Constantes.ACCION_REENVIAR);
							}
						} else {
							getObjDD().setStrAccion(Constantes.ACCION_APROBAR);
							//trazabilidadDocumentoService.guardarTrazabilidad(objDocumentoPrincipal, objUsuario, objDestinatario, objDD.getStrAccion(), objDD.getStrAsunto(), objDD.getStrContenido(), objEtapa);
						}
						 */
						
						log.info("No hay archivos a subir al Alfresco");
						documento = documentoService.derivarDocumento(getObjDD(), objUsuario, getIddestinatario(), sTipoDerivacion, null, conCopia, acciones, documento, nombrePC,true);
						
						/*if (mapUpload == null) {
						} else {
							documento = documentoService.crearDocumentoPorArchivo(getObjDD(), objUsuario, mapUpload, new Boolean(true), true, Constantes.MODULO_USUARIO_FINAL, Constantes.OPCION_DERIVAR, false);
							log.debug("Nuevo Documento Principal con ID [" + documento.getIdDocumento() + "]");
							getObjDD().setIIdDocumento(documento.getIdDocumento());
							documento = documentoService.derivarDocumento(getObjDD(), objUsuario, getIddestinatario(), sTipoDerivacion, null, conCopia, acciones);
						}*/

					} else if (this.sOpcion.equals(Constantes.ACCION_REENVIAR)) {
						log.info("-----------------ESTADO - REENVIAR ");

						Accion objAccion = accionService.findByNombre(objDD.getStrAccion());
						documento = documentoService.findByIdDocumento(objDD.getIIdDocumento());
						fechaLimiteAtencionAnterior = documento.getFechaLimiteAtencion();
						documento.setAccion(objAccion);
						documento.setLeido(Constantes.ESTADO_NO_LEIDO);
						
						documento = documentoService.derivarDocumento(getObjDD(), objUsuario, getIddestinatario(), sTipoDerivacion, null, conCopia, acciones, documento, nombrePC,fechaLimite.validarHorarioPermitido(usuarioSesion,getIddestinatario()));
					}
					
					// Agregado por German Enriquez para que el plazo por defecto
					// sea el limite del proceso
					
					Calendar fechaExpediente = Calendar.getInstance();
					fechaExpediente.setTime(documento.getExpediente().getFechacreacion());
					
					/*Deprecated!!! corregido por wcarrasco al establecer
					 *  getObjDD().setIPlazoDia(diasFaltantes); ahora solo se consideraran el tiempode proceso getObjDD().setIPlazoDia(tiempoProceso);
					 * Calendar hoy = Calendar.getInstance();
					 * int diasPasados = hoy.get(Calendar.DAY_OF_YEAR) - fechaExpediente.get(Calendar.DAY_OF_YEAR);
					int tiempoProceso = procesoService.findByIdProceso(getObjDD().getIIdProceso()).getTiempoatencion().intValue();
					int diasFaltantes = tiempoProceso - diasPasados;*/	
					
					int tiempoProceso = procesoService.findByIdProceso(getObjDD().getIIdProceso()).getTiempoatencion().intValue();
					if (getObjDD().getIPlazoDia() == null && getObjDD().getIPlazoHora() == null) {
						if (getObjDD().getStrFechaLimiteAtencion() != null && getObjDD().getStrFechaLimiteAtencion().equals("")) {
							getObjDD().setIPlazoDia(tiempoProceso);
						}
					}
					
					documento.setLeido(Constantes.ESTADO_NO_LEIDO);		
					documentoService.aplicarPlazosADocumentoPrincipal(getObjDD(), documento, this.bResponsable, getIddestinatario(), null, objUsuario, fechaLimiteAtencionAnterior,fechaLimite.validarHorarioPermitido(usuarioSesion,getIddestinatario()));
					               //aplicarPlazosADocumentoPrincipal(DocumentoDetail objDD, Documento objDocumento, boolean bResponsable, Integer iIdDestinatario, String sOpcion, Usuario objUsuario, Date fechaLimiteAtencionAnterior,Boolean horarioPermitido) {
					//trazabilidadDocumentoService.generarSeguimiento(documento.getExpediente().getIdexpediente());
				} 
				// rechaza el QAS a digitalizador
				else if (objDD.getStrAccion().equals(Constantes.ACCION_RECHAZARQAS)) {
					Documento documento = documentoService.findByIdDocumento(objDD.getIIdDocumento());
					documento.setLeido(Constantes.ESTADO_NO_LEIDO);
					if (documento != null) {
						log.debug("DocumentoAction asunto :" + objDD.getStrAsunto() + " conteido :" + objDD.getStrAsunto());
						documentoService.rechazarDocumento(usuarioSesion, documento, objDD.getStrAsunto(), objDD.getStrTexto(), Constantes.ACCION_RECHAZARQAS, nombrePC);
					}
				} // cuando rechaza el usuario final a QAS
				else if (objDD.getStrAccion().equals(Constantes.ACCION_RECHAZAR)) {
					Documento documento = documentoService.findByIdDocumento(objDD.getIIdDocumento());
					
					documento.setLeido(Constantes.ESTADO_NO_LEIDO);
					if (documento != null) {
						log.debug("DocumentoAction asunto :" + objDD.getStrAsunto() + " conteido :" + objDD.getStrAsunto());
						documentoService.rechazarDocumento(usuarioSesion, documento, objDD.getStrAsunto(), objDD.getStrTexto(), Constantes.ACCION_RECHAZAR, nombrePC);
					}
				} // cuando rechaza el usuario
				else if (objDD.getStrAccion().equals(Constantes.ACCION_RECHAZARUSER)) {
					Documento documento = documentoService.findByIdDocumento(objDD.getIIdDocumento());
					documento.setPrioridad(objDD.getPrioridad());
					documento.setLeido(Constantes.ESTADO_NO_LEIDO);
					if (documento != null) {
						log.debug("DocumentoAction asunto :" + objDD.getStrAsunto() + " conteido :" + objDD.getStrAsunto());
						documentoService.rechazarDocumento(usuarioSesion, documento, objDD.getStrAsunto(), objDD.getStrTexto(), Constantes.ACCION_RECHAZARUSER, nombrePC);
					}
				}else if (objDD.getStrAccion().equals(Constantes.ACCION_APROBAR)) {	
					//tipoRetorno = "errorVisor";
					Documento documento = documentoService.findByIdDocumento(objDD.getIIdDocumento());
					documento.setPrioridad(objDD.getPrioridad());
					documento.setLeido(Constantes.ESTADO_NO_LEIDO);
					if (documento != null) {
						log.debug("DocumentoAction asunto :" + objDD.getStrAsunto() + " contenido :" + objDD.getStrAsunto() +" texto"+ objDD.getStrTexto() );
						documentoService.rechazarDocumento(usuarioSesion, documento, objDD.getStrAsunto(), objDD.getStrTexto(), Constantes.ACCION_APROBAR, nombrePC);
					}
				}
			} else if (getSTipoDerivacion().equals(Constantes.DERIVAR_MASIVO)) {
				log.debug("DERIVAR_MASIVO");
				Documento objDocumentoPrincipal = null;
				Map<String, List<ArchivoTemporal>> mapUpload = null;
				setMapSession(ActionContext.getContext().getSession());
				mapUpload = (Map<String, List<ArchivoTemporal>>) getMapSession().get(Constantes.SESSION_UPLOAD_LIST);
				Usuario objUsuario = null;
				objUsuario = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
				for (int i = 0; i < arrIdDoc.length; i++) {
					log.debug("ID a derivar " + arrIdDoc[i]);
					getObjDD().setIIdDocumento(arrIdDoc[i]);
					getObjDD().setStrContenido(getTa());
					DocumentoDetail objDDD = documentoService.getDocumentDetail(arrIdDoc[i], (String) getMapSession().get("rol"));
					if (mapUpload == null) {
						log.info("No hay archivos a subir al Alfresco");
						objDocumentoPrincipal = documentoService.derivarDocumento(getObjDD(), objUsuario, getIddestinatario(), sTipoDerivacion, objDDD, conCopia, strAcciones, objDocumentoPrincipal, nombrePC,true);
					} else {
						objDocumentoPrincipal = documentoService.crearDocumentoPorArchivo(getObjDD(), objUsuario, mapUpload, new Boolean(true), false, "", "", true);
						log.debug("docPrincipal == " + objDocumentoPrincipal.getNumeroDocumento());
						getObjDD().setIIdDocumento(objDocumentoPrincipal.getIdDocumento());
						objDocumentoPrincipal = documentoService.derivarDocumento(getObjDD(), objUsuario, getIddestinatario(), sTipoDerivacion, objDDD, conCopia, strAcciones, objDocumentoPrincipal, nombrePC,true);
					}
					log.debug("Id del documento principal " + objDocumentoPrincipal.getIdDocumento());
					log.debug("String fecha limete de atension " + getObjDD().getStrFechaLimiteAtencion());
				}
				tipoRetorno = "masivo";
			}

			provieneDeMail = (Boolean) mapSession.get("provieneDeMail");

			if (log.isDebugEnabled()) {
				log.debug("provieneDeMail [" + provieneDeMail + "]");
			}

			if (provieneDeMail != null && provieneDeMail) {
				if (mapSession instanceof org.apache.struts2.dispatcher.SessionMap) {
					mapSession.remove(Constantes.SESSION_ALFRESCO);
					mapSession.remove(Constantes.SESSION_AUDITABLE);
					mapSession.remove(Constantes.SESSION_FORWARD_TO_URL);
					mapSession.remove(Constantes.SESSION_IDDOCUMENTO);
					mapSession.remove(Constantes.SESSION_RECURSO);
					mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
					mapSession.remove(Constantes.SESSION_USUARIO);
					mapSession.remove("provieneDeMail");
					((org.apache.struts2.dispatcher.SessionMap) mapSession).invalidate();
				}
			}

			this.cerrar = "OK";
			return tipoRetorno;
		} catch (Exception e) {
			e.printStackTrace();
			log.error(e.getMessage(), e);

			return Action.ERROR;
		}
	}

	@SuppressWarnings("unchecked")
	public String goSubirRepositorio() throws Exception {
		log.debug("-> [Action] DocumentoAction - goSubirRepositorio():String ");

		// log.debug("texto ingresado [" + getObjDD().getStrTexto() + "]");
		//try{
		setMapSession(ActionContext.getContext().getSession());
		log.debug("UPLOAD TO ALFRESCO ");
		// Documento objDocumentoPrincipal=null;
		Map<String, List<ArchivoTemporal>> mapUpload = null;
		Usuario objUsuario = null;
		setMapSession(ActionContext.getContext().getSession());
		mapUpload = (Map<String, List<ArchivoTemporal>>) getMapSession().get(Constantes.SESSION_UPLOAD_LIST);
		objUsuario = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		DocumentoDetail docdetail = new DocumentoDetail();
		docdetail.setIIdDocumento(this.getIIdDocumento());
		// getObjDD().setStrContenido(getTa());
		if (mapUpload == null) {
			log.info("No hay archivos a subir al Alfresco");
			// objDocumentoPrincipal = getSrvD().derivarUSER(getObjDD(),
			// objUsuario, getIddestinatario());
		} else {
			documentoService.crearDocumentoPorArchivo(docdetail, objUsuario, mapUpload, new Boolean(false), true, Constantes.MODULO_USUARIO_FINAL, Constantes.OPCION_SUBIR_REPOSITORIO, false);
			this.iIdDoc = this.iIdDocumento;
			this.cerrar = "OK";
			return Action.SUCCESS;
		}
		return Action.ERROR;
		/*}catch(Exception e){
        log.error(e.getMessage(),e);
        return Action.ERROR;
        }*/
	}

	public String rechazarqas() throws Exception {
		log.debug("-> [Action] DocumentoAction - rechazarqas():String ");

		if (objDD == null) {
			log.debug("No se recibio documento a rechazar");
			return Action.ERROR;
		}
		log.debug("Documento a rechazar con ID [" + objDD.getIIdDocumento() + "]");
		log.debug("Observacion de rechazo [" + objDD.getSObservacionRechazo() + "]");
		// try{
		Usuario objUsuario = null;
		mapSession = ActionContext.getContext().getSession();
		objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		documentoService.rechazarQAS(objDD.getIIdDocumento(), objDD.getSObservacionRechazo(), objUsuario);
		cerrar = "OK";
		return Action.SUCCESS;
		/*
		 * String sObservacion = null; Usuario objUsuario = null;
		 *
		 * mapSession = ActionContext.getContext().getSession(); objUsuario =
		 * (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		 *
		 * sObservacion = objDD.getStrObservacion(); strAcc = "rechazar"; objDD
		 * = srvD.getDocumentDetail(objDD.getIIdDocumento(),
		 * objUsuario.getUsuario(), objUsuario.getRol().getNombre());
		 * objDD.setStrObservacion(sObservacion);
		 *
		 * return saveDoc();
		 */
		/*
		 * }catch(Exception e){ log.error(e.getMessage(),e); return
		 * Action.ERROR; }
		 */
	}

	public String registrar() throws Exception {
		log.debug("-> [Action] DocumentoAction - registrar():String ");

		log.debug("::: registrarSimple");
		setStrAcc("registrar");
		getObjDD().setIIdProceso(getIdproceso());
		getObjDD().setIIdTipoDocumento(getIdtipodocumento());
		getObjDD().setIIdTipoIdentificacion(getIdtipoidentificacion());
		getObjDD().setIIdCliente(getIdCliente());
		// getObjDD().setStrNroIdentificacion(getNumeroIdentificacion());
		getObjDD().setStrRepresentanteLegal(getStrRepresentanteLegal());
		getObjDD().setIIdDepartamento(getIddepartamento());
		getObjDD().setIIdProvincia(getIdprovincia());
		getObjDD().setIIdDistrito(getIddistrito());
		getObjDD().setIIdCorrentista(getIdcorrentista());
		getObjDD().setCEstado(Constantes.ESTADO_ACTIVO);
		getObjDD().setArrSuministro(getStorsuministro());
		getObjDD().setArrIdSubMotivo(getStoridsubmotivo());
		// getObjDD().setStrNroMesaPartes(strNroMesaPartes)
		// Si no hay expediente, entonces es documento principal
		if (getObjDD().getIIdExpediente() == null) {
			getObjDD().setCPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
		} else {
			getObjDD().setCPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
		}
		log.debug("Documento Principal [" + getObjDD().getCPrincipal() + "]");
		this.fecha = new Date(System.currentTimeMillis());
		String ruta = saveDoc();
		getObjDD().setStrNroMesaPartes("" + (getObjDD().getDoc().getNumeroMesaPartes() != null ? getObjDD().getDoc().getNumeroMesaPartes() : getObjDD().getDoc().getIdDocumento()));
		return ruta;
	}

	/**REN: Este mÈtodo es el "Guardar" cuando se crea un nuevo Expediente en Usuario Final ----------------------------------*/
	@SuppressWarnings("unused")
	public String enviarArchivo() throws Exception {
		log.debug("-> [Action] DocumentoAction - enviarArchivo():String ");
		mapSession = ActionContext.getContext().getSession();
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		try {

			Map<String, Object> session = ActionContext.getContext().getSession();

			if (objDD.getParaAprobar() == null) {
				strAcc = Constantes.ACCION_REGISTRAR;
			} else {
				strAcc = Constantes.ACCION_PARA_APROBAR;
			}

			if(objDD.getConfidencial() == null){
				objDD.setConfidencial(Constantes.No);
			}
			
			log.debug("objd: " + getObjDD());
			getObjDD().setIIdProceso(getIdproceso());
			log.debug("id proceso:" + getIdproceso());
			getObjDD().setIIdTipoDocumento(getIdtipodocumento());
			log.debug("id Idtipodocumento:" + getIdtipodocumento());
			getObjDD().setIIdTipoIdentificacion(getIdtipoidentificacion());
			log.debug("id idtipoidentificacion:" + getIdtipoidentificacion());
			if (sTipoIdentificacion != null) {
				if (getSTipoIdentificacion().equalsIgnoreCase(Constantes.TIPO_IDENTIFICACION_RUC)) {
					getObjDD().setStrRazonSocial(getObjDD().getClienterazonsocial());
					getObjDD().setStrRepresentanteLegal(getObjDD().getClienterepresentantelegal());
				} else {
					getObjDD().setStrRazonSocial(getObjDD().getClientenombres() + " " + getObjDD().getClienteapellidopaterno() + " " + getObjDD().getClienteapellidomaterno());
				}
			}

			getObjDD().setStrDireccionPrincipal(getObjDD().getClientedireccionprincipal());
			getObjDD().setStrDireccionAlternativa(getObjDD().getClientedireccionalternativa());
			getObjDD().setStrTelefonoCliente(getObjDD().getClientetelefono());
			getObjDD().setStrCorreoCliente(getObjDD().getClientecorreo());
			getObjDD().setIIdCliente(getIdCliente());
			getObjDD().setStrNroIdentificacion(getNumeroIdentificacion());
			getObjDD().setStrRepresentanteLegal(getStrRepresentanteLegal());
			getObjDD().setIIdDepartamento(getIddepartamento());
			getObjDD().setIIdProvincia(getIdprovincia());
			getObjDD().setIIdDistrito(getIddistrito());
			if (log.isDebugEnabled()) {
				log.debug("id Idcliente:" + getIdCliente());
				log.debug("id Nroidentificacion:" + getNumeroIdentificacion());
				log.debug("id StrRepresentanteLegal:" + getStrRepresentanteLegal());
				log.debug("id :" + getIddepartamento());
				log.debug("id :" + getIdprovincia());
				log.debug("id :" + getIddistrito());
			}
			getObjDD().setIIdCorrentista(getIdcorrentista());
			getObjDD().setCEstado(Constantes.ESTADO_ACTIVO);
			getObjDD().setStrTipoDocumento(tipoDocumentoService.findByIdTipoDocumento(getIdtipodocumento()).getNombre());
			objDD.setEnumerarDocumento(StringUtil.isEmpty(objDD.getEnumerarDocumento()) ? "N" : objDD.getEnumerarDocumento());
			objDD.setCondestinatarios(getCondestinatarios());
			objDD.setConcopias(getConcopias());

			if (log.isDebugEnabled()) {
				log.debug("Enumerar Documento? [" + objDD.getEnumerarDocumento() + "]");
				log.debug("Numero Documento [" + objDD.getStrNroDocumento() + "]");
				log.debug("Tipo Numeracion [" + objDD.getTipoNumeracion() + "]");
				log.debug("Destinatarios [" + objDD.getCondestinatarios() + "]");
				log.debug("Copias [" + objDD.getConcopias() + "]");
				log.debug("Para Aprobar [" + objDD.getParaAprobar() + "]");
			}

			if (getObjDD().getIIdExpediente() == null) {
				getObjDD().setCPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
			} else {
				getObjDD().setCPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
			}
			log.debug("Documento Principal [" + getObjDD().getCPrincipal() + "]");
			Usuario objUsuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
			log.debug("objUsuario : " + objUsuario.getApellidos() + "c:" + objUsuario.getClave());
			objDD.setIdUsuarioLogeado(objUsuario.getIdusuario());
			String sUsuario = objUsuario.getUsuario();
			log.debug("sUsuario : " + sUsuario);
			String sClave = objUsuario.getClave();
			// String sRol = objUsuario.getRol().getNombre();
			log.debug(" getObjDD().getStrAbreviado():" + getObjDD().getStrAbreviado());
			String sAlias = getObjDD().getStrAbreviado();
			Proceso p = procesoService.findByIdProceso(getObjDD().getIIdProceso());
			sAlias = p.getTipoproceso().getNombre();
			log.debug(" p.getAbreviado():" + p.getTipoproceso().getNombre());
			Integer iIdUsuario = objUsuario.getIdusuario();
			log.debug("id usuario:" + iIdUsuario);
			Usuario origen = usuarioService.findByIdUsuario(iIdUsuario);
			String strRol = Constantes.ROL_USUARIO_FINAL;
			log.debug(" $$$ de guardar iddoc : " + idDocumento);
			objDD.setObjAutor(objUsuario);

			if (getObjDD() != null) {
				objDD = documentoService.saveNuevoDocumentoUserFinal(objDD, session, iddestinatario, idccdestinatario, strAcc, bBandeja, archivopendiente, (String)session.get("nombrePC"));
				/**Copias de Trabajo ----------------------------------------------------------------------------------------*/

				Set<Integer> usuariosNotificados = new HashSet<Integer>();
				usuariosNotificados.add(objDD.getIIdDestinatario());
/*
				if(apoyo != null && apoyo.length >0){
					for(String idUsuario : apoyo){
						if(idUsuario.startsWith("LISTA_")){
							
							Lista objLista = listaService.findByIdLista(Integer.parseInt(idUsuario.substring(6)));

							for (Usuario objParticipante : objLista.getParticipanteListaList()) {
								if (!usuariosNotificados.contains(objParticipante.getIdusuario())) {
									usuariosNotificados.add(objParticipante.getIdusuario());
									documentoService.crearCopiaApoyo(objDD.getDoc(), objParticipante.getIdusuario(), null, 1, "");
								}
							}
						}else{
							Integer idDestinatario = Integer.parseInt(idUsuario);
							if(!usuariosNotificados.contains(idDestinatario)){
								documentoService.crearCopiaApoyo(objDD.getDoc(), idDestinatario, null, 1, "");
								usuariosNotificados.add(idDestinatario);
							}
						}
					}
				}
*/
			} else {
				this.mensaje = "No se encontraron Datos";
			}

			this.cerrar = "ok";
			log.debug("##$ cerrar :" + this.cerrar);
			this.ocultar = "NO";

			setLstRadio(tipoIdentificacionService.getTipoIdentificacionMap());
			log.debug("returning view : " + "nuevoDocumento");
			return Action.SUCCESS;
		} catch (Exception e) {
			return "error";
		}
	}


	public String registrarDocumento() {
		log.debug("-> [Action] DocumentoAction - registrarDocumento():String ");

		Map<String, Object> sesion = ActionContext.getContext().getSession();
		Usuario usuarioSesion = (Usuario) sesion.get(Constantes.SESSION_USUARIO);

		if (objDocumento == null) {
			log.error("No se recibio ningun Documento a registrar");

			return Action.ERROR;
		}

		objDD = new DocumentoDetail();
		strAcc = "registrar";
		objDD.setIIdExpediente(objDocumento.getExpediente().getIdexpediente());
		objDD.setsNroExpediente(objDocumento.getExpediente().getNroexpediente());
		objDD.setIIdProceso(objDocumento.getExpediente().getProceso().getIdproceso());
		objDD.setIIdCliente(objDocumento.getExpediente().getCliente().getIdCliente());

		if (log.isDebugEnabled()) {
			log.debug("Expediente asociado con ID [" + objDocumento.getExpediente().getIdexpediente() + "]");
			log.debug("Expediente asociado con Nro [" + objDocumento.getExpediente().getNroexpediente() + "] SOLO PARA EXPEDIENTES HISTORICOS");
			log.debug("Fecha Documento [" + sFechaDocumento + "]");
			log.debug("Datos del Cliente personalizado");
			log.debug("Razon Social [" + objDocumento.getExpediente().getCliente().getRazonSocial() + "]");
			log.debug("Nombres [" + objDocumento.getExpediente().getCliente().getNombres() + "]");
			log.debug("Apellido Paterno [" + objDocumento.getExpediente().getCliente().getApellidoPaterno() + "]");
			log.debug("Apellido Materno [" + objDocumento.getExpediente().getCliente().getApellidoMaterno() + "]");
			log.debug("Representante Legal [" + objDocumento.getExpediente().getCliente().getRepresentanteLegal() + "]");
			log.debug("Direccion Principal [" + objDocumento.getExpediente().getCliente().getDireccionPrincipal() + "]");
			log.debug("Ubigeo Principal [" + objDocumento.getExpediente().getCliente().getUbigeoPrincipal().getIddistrito() + "]");
			log.debug("Direccion Alternativa [" + objDocumento.getExpediente().getCliente().getDireccionAlternativa() + "]");
			log.debug("Ubigeo Alternativo [" + objDocumento.getExpediente().getCliente().getUbigeoAlternativo().getIddistrito() + "]");
			log.debug("Telefono [" + objDocumento.getExpediente().getCliente().getTelefono() + "]");
			log.debug("Correo [" + objDocumento.getExpediente().getCliente().getCorreo() + "]");
			log.debug("Asunto [" + objDocumento.getExpediente().getAsunto() + "]");
			log.debug("conDestinatarios [" + objDocumento.getCondestinatarios() + "]");
			log.debug("conCopias [" + objDocumento.getConcopias() + "]");

			if (objDocumento.getPropietario() != null) {
				log.debug("propietario del Documento [" + objDocumento.getPropietario().getIdusuario() + "]");
			}
		}

		objDD.setClienterazonsocial(objDocumento.getExpediente().getCliente().getRazonSocial());
		objDD.setClientenombres(objDocumento.getExpediente().getCliente().getNombres());
		objDD.setClienteapellidopaterno(objDocumento.getExpediente().getCliente().getApellidoPaterno());
		objDD.setClienteapellidomaterno(objDocumento.getExpediente().getCliente().getApellidoMaterno());
		objDD.setClienterepresentantelegal(objDocumento.getExpediente().getCliente().getRepresentanteLegal());
		objDD.setClientedireccionprincipal(objDocumento.getExpediente().getCliente().getDireccionPrincipal());
		objDD.setClienteubigeoprincipal(objDocumento.getExpediente().getCliente().getUbigeoPrincipal().getIddistrito());
		objDD.setClientedireccionalternativa(objDocumento.getExpediente().getCliente().getDireccionAlternativa());
		objDD.setClienteubigeoalternativo(objDocumento.getExpediente().getCliente().getUbigeoAlternativo().getIddistrito());
		objDD.setClientetelefono(objDocumento.getExpediente().getCliente().getTelefono());
		objDD.setClientecorreo(objDocumento.getExpediente().getCliente().getCorreo());
		objDD.setIIdTipoDocumento(objDocumento.getTipoDocumento().getIdtipodocumento());
		objDD.setStrNroDocumento(objDocumento.getNumeroDocumento());
		objDD.setEnumerarDocumento(StringUtil.isEmpty(objDD.getEnumerarDocumento()) ? Constantes.GENERAL_N : objDD.getEnumerarDocumento());
		objDD.setINroFolios(objDocumento.getNumeroFolios());
		objDD.setStrAsunto(objDocumento.getExpediente().getAsunto());
		objDD.setUltimoAsunto(objDocumento.getExpediente().getAsunto());
		objDD.setsSumilla(objDocumento.getExpediente().getSumilla());
		objDD.setStrObservacion(objDocumento.getObservacion());
		objDD.setCEstado(Constantes.ESTADO_ACTIVO);
		objDD.setCPrincipal((objDD.getIIdExpediente() == null) ? Constantes.DOCUMENTO_PRINCIPAL : Constantes.DOCUMENTO_NO_PRINCIPAL);
		objDD.setStrFechaDocumento(sFechaDocumento);
		objDD.setFechacreacion(new Date());
		objDD.setCondestinatarios(objDocumento.getCondestinatarios());
		objDD.setConcopias(objDocumento.getConcopias());
		objDD.setIdUsuarioLogeado(usuarioSesion.getIdusuario());
		objDD.setIIdCorrentista(objDocumento.getExpediente().getConcesionario().getIdConcesionario());
		objDD.setArrSuministro(storsuministro);
		objDD.setArrIdSubMotivo(storidsubmotivo);
		objDD.setStrMontoReclamo(sMontoReclamo);
		//creador del documento.
		objDD.setObjAutor(usuarioService.findByIdUsuario(usuarioSesion.getIdusuario()));

		String ruta = this.saveDoc();
		objDD.setStrNroMesaPartes("" + (objDD.getDoc().getNumeroMesaPartes() != null ? objDD.getDoc().getNumeroMesaPartes() : objDD.getDoc().getIdDocumento()));
		Tipodocumento tipo = tipoDocumentoService.findByIdTipoDocumento(objDD.getIIdTipoDocumento());

		if (tipo != null) {
			String codigoTipo = tipo.getCodigo();

			if (codigoTipo != null && codigoTipo.equals(Constantes.TIPO_DOCUMENTO_STOR_APELACION)) {
				Concesionario concesionario = concesionarioService.findByIdConcesionario(objDD.getIIdCorrentista());

				if (concesionario != null) {
					this.setApelacion(true);
				}
			} else {
				this.setApelacion(false);
			}
		} else {
			this.setApelacion(false);
		}

		return ruta;
	}


	public String uploadWithForm() throws Exception {
		log.debug("-> [Action] DocumentoAction - uploadWithForm():String ");

		// try{
		setMapSession(ActionContext.getContext().getSession());
		log.debug("Removiendo archivos adjuntos de la sesion");
		getMapSession().remove(Constantes.SESSION_UPLOAD_LIST);
		return Action.SUCCESS;
		/*
		 * }catch(Exception e){ log.error(e.getMessage(),e); return
		 * Action.ERROR; }
		 */
	}


	public String gobandejanuevoExpediente() throws Exception {
		log.debug("-> [Action] DocumentoAction - gobandejanuevoExpediente():String ");

		// try{
		setMapSession(ActionContext.getContext().getSession());
		log.debug("Removiendo archivos adjuntos de la sesion");
		if (getSFromBandeja() != null && getSFromBandeja().equals("si")) {
			getMapSession().remove("documentotemporal");
		}
		return Action.SUCCESS;
		/*
		 * }catch(Exception e){ log.error(e.getMessage(),e); return
		 * Action.ERROR; }
		 */
	}

	@SuppressWarnings("unchecked")
	public String doUploadWithForm() throws Exception {
		log.debug("-> [Action] DocumentoAction - doUploadWithForm():String ");

		// try{
		Map<String, List<ArchivoTemporal>> mapUpload = null;
		List<DocumentoTemporal> lstDocumentoTemporal = null;
		List<ArchivoTemporal> lstArchivoTemporal = null;
		setMapSession(ActionContext.getContext().getSession());
		mapUpload = (Map<String, List<ArchivoTemporal>>) getMapSession().get(Constantes.SESSION_UPLOAD_LIST);
		lstDocumentoTemporal = (List<DocumentoTemporal>) getMapSession().get("documentotemporal");
		if (mapUpload == null) {
			log.info("No se adjunto ningun archivo");
		} else {
			lstArchivoTemporal = mapUpload.get("upload1");
			log.debug("Archivos adjuntos [" + lstArchivoTemporal.size() + "]");
		}
		DocumentoTemporal objDocumentoTemporal = new DocumentoTemporal();
		objDocumentoTemporal.setIIdTipoDocumento(getObjDocumento().getTipoDocumento().getIdtipodocumento());
		objDocumentoTemporal.setSNroDocumento(getObjDocumento().getNumeroDocumento());
		objDocumentoTemporal.setINroFolios(getObjDocumento().getNumeroFolios());
		// objDocumentoTemporal.setSFechaDocumento(getObjDocumento().get);
		objDocumentoTemporal.setLstArchivo(lstArchivoTemporal);
		if (lstDocumentoTemporal == null) {
			lstDocumentoTemporal = new ArrayList<DocumentoTemporal>();
		}
		log.debug("Numero de Documentos Temporales iniciales [" + lstDocumentoTemporal.size() + "]");
		lstDocumentoTemporal.add(objDocumentoTemporal);
		log.debug("Numero de Documentos Temporales finales [" + lstDocumentoTemporal.size() + "]");
		getMapSession().put("documentotemporal", lstDocumentoTemporal);
		this.cerrar = "OK";
		return Action.SUCCESS;
		/*
		 * }catch(Exception e){ log.error(e.getMessage(),e); return
		 * Action.ERROR; }
		 */
	}

	@SuppressWarnings("unchecked")
	public String saveExpUser() throws Exception {
		log.debug("-> [Action] DocumentoAction - saveExpUser():String ");

		setMapSession(ActionContext.getContext().getSession());
		log.debug("Proceso elegido con ID [" + getObjExpediente().getProceso().getIdproceso() + "]");
		log.debug("Concesionario elegido con ID [" + getObjExpediente().getConcesionario().getIdConcesionario() + "]");
		// try{
		Boolean bFirstOne = true;
		Date datFechaLimite = new Date();
		GregorianCalendar calendar = null;
		List<DocumentoTemporal> lstDocumentoTemporal = null;
		Usuario objUsuario = null;

		lstDocumentoTemporal = (List<DocumentoTemporal>) getMapSession().get("documentotemporal");
		objUsuario = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		Expediente objExp = new Expediente();
		objExp.setIdpropietario(objUsuario);
		objExp.setNroexpediente(expedienteService.getMaxReferencia());
		objExp.setFechacreacion(new Date());
		objExp.setAsunto(getObjExpediente().getAsunto());
		objExp.setEstado('A');
		if (getObjExpediente().getConcesionario().getIdConcesionario() != null) {
			objExp.setConcesionario(getObjExpediente().getConcesionario());
		}
		objExp.setProceso(procesoService.findByIdProceso(getObjExpediente().getProceso().getIdproceso()));
		objExp = expedienteService.saveExpediente(objExp);
		setObjExpediente(objExp);
		calendar = new GregorianCalendar();
		calendar.setGregorianChange(datFechaLimite);
		calendar.set(GregorianCalendar.DAY_OF_YEAR, calendar.get(GregorianCalendar.DAY_OF_YEAR) + objExp.getProceso().getTiempoatencion());
		log.debug("Creando el expediente [" + objExp.getNroexpediente() + "] en Alfresco");

		repositorioService.crearEstructuraExpediente(objUsuario.getUsuario(), objUsuario.getClave(), objExp.getIdexpediente());
		if (lstDocumentoTemporal != null) {
			for (DocumentoTemporal objDT : lstDocumentoTemporal) {
				Accion objAccion = null;
				Tipodocumento objTipodocumento = tipoDocumentoService.findByIdTipoDocumento(objDT.getIIdTipoDocumento());
				Documento objDoc = new Documento();
				objDoc.setTipoDocumento(objTipodocumento);
				objDoc.setPropietario(objUsuario);
				objDoc.setExpediente(objExp);
				objDoc.setFechaAccion(new Date());
				objDoc.setFechaCreacion(new Date());
				objDoc.setEstado(Constantes.ESTADO_ACTIVO);
				objDoc.setNumeroFolios(objDT.getINroFolios());
				objDoc.setNumeroDocumento(objDT.getSNroDocumento());
				objDoc.setAsunto(objExp.getAsunto());
				objDoc.setFechaLimiteAtencion(calendar.getTime());
				// objDoc.setFechadocumento();
				if (bFirstOne) {
					objAccion = accionService.findByNombre(Constantes.ACCION_REENVIAR);
					objDoc.setAccion(objAccion);
					objDoc.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
					bFirstOne = false;
				} else {
					objAccion = accionService.findByNombre(Constantes.ACCION_REGISTRAR);
					objDoc.setAccion(objAccion);
					objDoc.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
				}
				objDoc = documentoService.saveDocumento(objDoc);
				log.debug("Se creo Documento [" + objDoc.getTipoDocumento().getNombre() + " - " + objDoc.getNumeroDocumento() + "] con ID [" + objDoc.getIdDocumento() + "]");
				Integer iContador = 1;
				for (ArchivoTemporal objAT : objDT.getLstArchivo()) {
					try {
						archivoService.checkInToAlfresco(objUsuario, objAT, objDoc, iContador, false);
					} catch (Exception e) {
						log.warn(e.getMessage());
						log.warn("El archivo no existe, subiendo nuevo archivo");
						archivoService.uploadToAlfresco(objAT, objDoc, iContador);
					}
					log.debug("Se creo archivo [" + objAT.getSNombre() + "]");
					iContador++;
				}
				trazabilidadDocumentoService.saveTrazabilidadDocumento(objDoc, objUsuario, false, false);
			}
		}
		return Action.SUCCESS;
	}

	// Parte de Intalio para el usuario final

	public String aprobaruser() throws Exception {
		log.debug("-> [Action] DocumentoAction - aprobaruser():String ");

		Map<String, Object> session = ActionContext.getContext().getSession();
		String usuario = (String) session.get("usuario");
		setObjDD(documentoService.getDocumentDetail(getIIdDoc(), (String) session.get("rol")));
		Usuario origen = (Usuario) session.get("_USUARIO");
		/*** INTALIO - Aprobaciones ***/
		if (usuario.equals("sistemas")) {
			// IntalioTools.completarProcesoSistemas("proyectos");
			setIddestinatario(9);// proyectos
			/********************************************/
			Usuario destino = usuarioService.findByIdUsuario(9);
			if (destino.getEnviocorreo() == '1') {
				procesarEmail(origen, destino);
			}
			/********************************************/
			setStrAcc("derivar");
		} else if (usuario.equals("proyectos")) {
			// IntalioTools.completarProcesoProyectos("Salir");
			setIddestinatario(1);// superuser
			setStrAcc("derivar");
		}
		return saveDoc();
	}

	private void procesarEmail(Usuario Origen, Usuario Destino) {
		log.debug("-> [Action] DocumentoAction - procesarEmail():void ");

		/****** Simular un envio de correo *****/
		String to = Destino.getCorreo();
		String from = Origen.getCorreo();
		String subject = "Notificacion de Siged";
		String msgText = "Ud Tiene un mensaje en su bandeja de siged por favor revicelo que le envia el Sr:" + Origen.getNombres();
		String hostSmtp = "192.168.1.200";
		boolean debug = true;
		getMailService().EnviarEmail(to, from, subject, msgText, hostSmtp, debug);
	}


	public String doDerivarMasivo() {
		log.debug("-> [Action] DocumentoAction - doDerivarMasivo():String ");

		mapSession=ActionContext.getContext().getSession();

		DocumentoMasivo docMas=new DocumentoMasivo();
		docMas.setArrIdDoc((Integer[]) getMapSession().get("arrIdDoc"));
		docMas.setRol((String) mapSession.get("rol"));
		if(objExpediente!=null){
			Etapa etapa=etapaService.findByIdetapa(objExpediente.getIdetapa().getIdetapa());
			docMas.setEtapa(etapa);
		}
		docMas.setAsunto(objDD.getStrAsunto());
		// Remitente
		docMas.setUsuarioRemitente((Usuario) mapSession.get(Constantes.SESSION_USUARIO));
		docMas.setContenido(objDD.getStrTexto());
		docMas.setConCopia(conCopia);
		docMas.setTipoDerivacion(sTipoDerivacion);
		docMas.setParaAprobar(paraAprobar);
		Usuario objDestinatario = usuarioService.findByIdUsuario(iddestinatario);
		docMas.setDestinatario(objDestinatario);
		
		Usuario usuarioSesion = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		usuarioSesion = usuarioService.findByIdUsuario(usuarioSesion.getIdusuario());
		try{
			gestionDocumentos.derivarMasivamente(docMas, (String) mapSession.get("nombrePC"),fechaLimite.validarHorarioPermitido(usuarioSesion,iddestinatario));
		}
		catch (Exception e) {
			log.error("No se derivo masivamente:{}",e.getMessage());
		}
		return Action.SUCCESS;
	}


	public String gorechazar() throws Exception {
		log.debug("-> [Action] DocumentoAction - gorechazar():String ");

		// try{
		Usuario objUsuario = null;
		setMapSession(ActionContext.getContext().getSession());
		objUsuario = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
		setObjDD(documentoService.getDocumentDetail(getIIdDoc(), objUsuario.getRol().getNombre()));
		return Action.SUCCESS;
		/*
		 * }catch(Exception e){ log.error(e.getMessage(),e); return
		 * Action.ERROR; }
		 */
	}


	public String rechazaruser() throws Exception {
		log.debug("-> [Action] DocumentoAction - rechazaruser():String ");

		Map<String, Object> session = ActionContext.getContext().getSession();
		String strObservacion = objDD.getStrObservacion();
		strAcc = "rechazaruser";

		objDD = documentoService.getDocumentDetail(objDD.getIIdDocumento(), (String) session.get("rol"));
		objDD.setStrObservacion(strObservacion);

		/*
        String strUsuario=""; 
        strUsuario = (String) session.get("usuario");
        String password = (String) session.get("clave");
        String participantToken = ClienteProcesoTecnologiaInf.Autenticar(strUsuario, password);
        TaskMetadata data[] = ClienteProcesoTecnologiaInf.ObtenerTareas(participantToken);

        Documento doc = documentoService.findByIdDocumento(getObjDD().getIIdDocumento());
        int nro = doc.getExpediente().getIdexpediente();
        String IdExpediente = String.valueOf(nro);
        String Condicion = "Deprobado";
        String Area = strUsuario;

        ClienteProcesoTecnologiaInf.CTProcesoTecnologiaInf(data, participantToken, IdExpediente, Condicion, Area);
		 */
		return saveDoc();
	}

	public String verDetalleExpediente() throws Exception {
		log.debug("-> [Action] DocumentoAction - verDetalleExpediente():String ");

		// this.mensaje = "";
		try {
			objExpediente = expedienteService.findByIdExpediente(this.iIdExp);
			// Agregado por German Enriquez
			if (documentoStor) {
				setExpedienteStor(expedienteStorService.findByIdExpediente(iIdExp));
				detallesDocumentoStor = new HashMap<String, String>();
				String concesionaria = "---";
				Concesionario cons = getExpedienteStor().getExpediente().getConcesionario();
				if (cons != null) {
					concesionaria = cons.getRazonSocial();
				}
				String sala = "---";
				Sala sa = getExpedienteStor().getSala();
				if (sa != null) {
					sala = sa.getNombre();
				}
				String analista = "---";
				UsuarioStor analistaStor = getExpedienteStor().getAnalista();
				if (analistaStor != null) {
					analista = analistaStor.getUsuario();
				}
				String revtec = "---";
				UsuarioStor revtecStor = getExpedienteStor().getRevisortecnico();
				if (revtecStor != null) {
					revtec = revtecStor.getUsuario();
				}
				String revleg = "---";
				UsuarioStor revlegStor = getExpedienteStor().getRevisorlegal();
				if (revlegStor != null) {
					revleg = revlegStor.getUsuario();
				}
				List<Resolucionjaru> rj = getExpedienteStor().getResolucionjaruList();
				String resolucion = "---";
				String resultado = "---";
				if (rj != null && rj.size() > 0) {
					resolucion = rj.get(0).getNroresolucion();
					resultado = rj.get(0).getResultado().getResultado();
				}
				detallesDocumentoStor.put("concesionaria", concesionaria);
				detallesDocumentoStor.put("sala", sala);
				detallesDocumentoStor.put("analista", analista);
				detallesDocumentoStor.put("revtec", revtec);
				detallesDocumentoStor.put("revleg", revleg);
				detallesDocumentoStor.put("resolucion", resolucion);
				detallesDocumentoStor.put("resultado", resultado);
			}
		} catch (Exception e) {
			log.error("Error obteniendo los detalles del expediente", e);
			// this.mensaje = "Mensaje de Error:" + e.getMessage() +
			// " , Causa :" + e.getCause();
		}
		return Action.SUCCESS;
	}


	public String goAprobarStor() throws Exception {
		log.debug("-> [Action] DocumentoAction - goAprobarStor():String ");

		try {
			Map<String, Object> session = ActionContext.getContext().getSession();
			Usuario usuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
			Rol rol = usuario.getRol();
			String nombreRol = null;
			if (rol != null) {
				nombreRol = rol.getNombre();
			}
			setObjDD(documentoService.getDocumentDetail(getIIdDoc(), nombreRol));
			mapCumpleRequisito.put(1, "SI");
			mapCumpleRequisito.put(2, "NO");
			return Action.SUCCESS;
		} catch (Exception e) {
			log.error(e.getMessage(), e);
			return Action.ERROR;
		}
	}


	public String aprobarStor() throws Exception {
		log.debug("-> [Action] DocumentoAction - aprobarStor():String ");

		try {
			Map<String, Object> session = ActionContext.getContext().getSession();
			Usuario usuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
			Rol rol = usuario.getRol();
			String nombreRol = null;
			if (rol != null) {
				nombreRol = rol.getNombre();
			}
			if (getIdsala() != null) {
				getObjDD().setIIdSala(getIdsala());
			}
			if (getObjDD() == null) {
				setObjDD(documentoService.getDocumentDetail(getIIdDoc(), nombreRol));
			}
			// documentoService.aplicarProcesoStor(getObjDD(), (String)
			// session.get("usuario"), (String) session.get("clave"));
			return Action.SUCCESS;
		} catch (Exception e) {
			log.error(e.getMessage(), e);
			return Action.ERROR;
		}
	}

	public String nuevoDocUser() throws Exception {
		log.debug("-> [Action] DocumentoAction - nuevoDocUser():String ");

		try {
			return Action.SUCCESS;
		} catch (Exception e) {
			log.error(e.getMessage(), e);
			return Action.ERROR;
		}
	}

	public String updateEstadoNotificacion() throws Exception {
		log.debug("-> [Action] DocumentoAction - updateEstadoNotificacion():String ");

		if (iIdNotificacion == null) {
			log.error("No se recibio ID de Notificacion");
			return Action.ERROR;
		}
		try {
			log.debug("Se actualizara Notificacion con ID [" + iIdNotificacion + "]");
			notificacionService.updateEstadoNotificacion(iIdNotificacion, Constantes.ESTADO_LEIDO);
			return Action.NONE;
		} catch (Exception e) {
			log.error(e.getMessage(), e);
			return Action.ERROR;
		}
	}


	public String getNuevoDocumento() {
		log.debug("-> [Action] DocumentoAction - getNuevoDocumento():String ");

		this.fecha = new Date();
		return Action.SUCCESS;
	}

	/**
	 * Retorna true o false indicando si el documento buscado es el unico perteneciente al expediente.
	 * Recibe el documento y el expediente porque no necesariamente el documento seleccionado pertenece al expediente
	 *
	 * @author German Enriquez
	 */
	public String verificarDocumentoUnico() {
		log.debug("-> [Action] DocumentoAction - verificarDocumentoUnico():String ");

		if (iIdDoc == null) {
			log.error("No se especifico ningun documento, no se puede anular.");
			return Action.ERROR;
		}
		if (iIdExp == null) {
			log.error("No se especifico ningun expediente, no se puede anular.");
			return Action.ERROR;
		}
		Expediente expediente = expedienteService.findByIdExpediente(iIdExp);
		if (expediente != null) {
			Documento documento = documentoService.findByIdDocumento(iIdDoc);
			if (documento != null) {
				boolean unico = false;
				//verificamos que el expediente solo tenga un documento y que sea este
				List<Documento> delExpediente = expediente.getDocumentoList();
				if (delExpediente.size() == 1) {
					if (delExpediente.get(0).equals(documento)) {
						unico = true;
					}
				}
				//si el expediente tiene solo un documento, verificamos que no tenga otros documentos referenciados
				List<Documentoxexpediente> referenciados = expediente.getDocumentoxexpedienteList();
				if (unico) {
					if (referenciados.size() > 0) {
						unico = false;
					}
				}
				if (!unico && delExpediente.size() == 0) {
					if (referenciados.size() == 1) {
						if (referenciados.get(0).getDocumentoxexpedientePK().getIddocumento() == documento.getIdDocumento()) {
							unico = true;
						}
					}
				}
				return "" + unico;
			}
			log.error("El id de documento: " + iIdDoc + " no se encontro en la base de datos.");
			return Action.ERROR;
		}
		log.error("El id del expediente: " + iIdExp + " no se encontro en la base de datos.");
		return Action.ERROR;
	}

	public String verificarDocumentoNuevo() {
		log.debug("-> [Action] DocumentoAction - verificarDocumentoNuevo():String ");

		if (iIdDoc == null) {
			log.error("No se especifico ningun documento, no se puede Copiar Referencia.");
			return Action.ERROR;
		}
		if (idExpedienteNuevo == null) {
			log.error("No se especifico ningun expediente nuevo, no se Copiar Referencia.");
			return Action.ERROR;
		}
		Expediente expedienteNuevo = expedienteService.findByIdExpediente(idExpedienteNuevo);
		if (expedienteNuevo != null) {
			Documento documento = documentoService.findByIdDocumento(iIdDoc);
			if (documento != null) {
				boolean unico = false;

				//verificamos que el expediente nuevo no tenga referenciado ya el documento
				List<Documentoxexpediente> referenciados = expedienteNuevo.getDocumentoxexpedienteList();
				for (Documentoxexpediente objDocumentoxExpediente : referenciados) {
					if (objDocumentoxExpediente.getDocumentoxexpedientePK().getIddocumento() == documento.getIdDocumento()) {
						unico = true;
					}
					if (unico == true) {
						return "" + unico;
					}
				}
				return "" + unico;
			}
			log.error("El id de documento: " + iIdDoc + " no se encontro en la base de datos.");
			return Action.ERROR;
		}
		log.error("El id del expediente nuevo: " + idExpedienteNuevo + " no se encontro en la base de datos.");
		return Action.ERROR;
	}

	public String anularDocumento() {
		log.debug("-> [Action] DocumentoAction - anularDocumento():String ");

		/*Usuario usuarioLogeado = null;

		mapSession = ActionContext.getContext().getSession();
		usuarioLogeado = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);*/

		mapSession = ActionContext.getContext().getSession();
		String nombrePC = (String) mapSession.get("nombrePC");
		
		Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		usuario = usuarioService.findByIdUsuario(usuario.getIdusuario());
		
		if (iIdDoc == null) {
			log.error("No se especifico ningun documento, no se puede anular.");
			return Action.ERROR;
		}
		
		Documento documento = documentoService.findByIdDocumento(iIdDoc);
		
		documentoService.anularDocumento(usuario, documento, null, false, null, nombrePC);
		
		/*if (iIdExp == null) {
			log.error("No se especifico ningun expediente, no se puede anular.");
			return Action.ERROR;
		}
		Expediente expediente = expedienteService.findByIdExpediente(iIdExp);
		if (expediente != null) {
			Documento documento = documentoService.findByIdDocumento(iIdDoc);
			if (documento != null) {
				documentoService.anularDocumento(documento, expediente, unico, usuarioLogeado);
				log.info("El documento " + documento.getNumeroDocumento() + " ha sido quitado del expediente " + expediente.getNroexpediente());
				return "true";
			}
			log.error("El id de documento: " + iIdDoc + " no se encontro en la base de datos.");
			return Action.ERROR;
		}
		log.error("El id del expediente: " + iIdExp + " no se encontro en la base de datos.");
		return Action.ERROR;*/
		return "true";
	}
	
	public String atenderDocumento(){
		log.debug("-> [Action] DocumentoAction - atenderDocumento():String ");
		
		mapSession = ActionContext.getContext().getSession();
		String nombrePC = (String) mapSession.get("nombrePC");
		
		Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		usuario = usuarioService.findByIdUsuario(usuario.getIdusuario());
		
		if (iIdDoc == null) {
			log.error("No se especifico ningun documento, no se puede atender.");
			return Action.ERROR;
		}
		
		Documento documento = documentoService.findByIdDocumento(iIdDoc);
		documentoService.atenderDocumento(usuario, documento, null, false, null, nombrePC);

		return "true";
	}

	/**REN: Mover documento a otro expediente ------------------------------------------------*/
	public String cambiarReferenciaDocumento() {
		log.debug("-> [Action] DocumentoAction - cambiarReferenciaDocumento():String ");

		if (iIdDoc == null) {
			log.error("No se especifico ningun documento, no se puede referenciar.");
			return Action.ERROR;
		}
		if (iIdExp == null) {
			log.error("No se especifico ningun expediente origen, no se puede referenciar.");
			return Action.ERROR;
		}
		if (idExpedienteNuevo == null) {
			log.error("No se especifico ningun expediente destino, no se puede referenciar.");
			return Action.ERROR;
		}
		Expediente expedienteNuevo = expedienteService.findByIdExpediente(idExpedienteNuevo);
		if (expedienteNuevo != null) {
			Expediente expediente = expedienteService.findByIdExpediente(iIdExp);
			if (expediente != null) {
				Documento documento = documentoService.findByIdDocumento(iIdDoc);
				if (documento != null) {
					try {
						log.debug("Tipo de busqueda seleccionada {}", tipoBusqueda);
						if (tipoBusqueda == 'C') {
							documentoService.copiarReferencia(documento, expediente, expedienteNuevo, unico);
							log.info("El documento " + documento.getNumeroDocumento() + " ha sido copiado al expediente " + expedienteNuevo.getNroexpediente());
						} else {
							documentoService.cambiarReferencia(documento, expediente, expedienteNuevo, unico);
							log.info("El documento " + documento.getNumeroDocumento() + " ha sido referenciado al expediente " + expedienteNuevo.getNroexpediente());
						}
					} catch (RuntimeException e) {
						log.error(e.getMessage(), e);
						return "false";
					}
					//log.info("El documento "+documento.getNumeroDocumento()+" ha sido referenciado al expediente "+expedienteNuevo.getNroexpediente());

					return "true";
				}
				log.error("El id de documento: " + iIdDoc + " no se encontro en la base de datos.");
				return Action.ERROR;
			}
			log.error("El id del expediente: " + iIdExp + " no se encontro en la base de datos.");
			return Action.ERROR;
		}
		log.error("El id del expediente nuevo: " + expedienteNuevo + " no se encontro en la base de datos.");
		return Action.ERROR;
	}

	public String verificarExistenciaDeArchivoParaCambiarReferencia() {
		log.debug("-> [Action] DocumentoAction - verificarExistenciaDeArchivoParaCambiarReferencia():String ");

		if (iIdDoc == null) {
			log.error("No se especifico ningun documento, no se puede referenciar.");
			return Action.ERROR;
		}
		if (idExpedienteNuevo == null) {
			log.error("No se especifico ningun expediente destino, no se puede referenciar.");
			return Action.ERROR;
		}
		Expediente expedienteNuevo = expedienteService.findByIdExpediente(idExpedienteNuevo);
		if (expedienteNuevo != null) {
			Documento documento = documentoService.findByIdDocumento(iIdDoc);
			if (documento != null) {
				return "" + documentoService.verificarArchivosParaExpedienteNuevo(documento, expedienteNuevo);
			}
			log.error("El id de documento: " + iIdDoc + " no se encontro en la base de datos.");
			return Action.ERROR;
		}
		log.error("El id del expediente nuevo: " + expedienteNuevo + " no se encontro en la base de datos.");
		return Action.ERROR;
	}

	/**
	 * Prepara los valores predeterminados de un expediente partiendo de otro
	 * @author Erik Candela
	 */
	public String loadNuevoExpedienteUF() {
		log.debug("-> [Action] DocumentoAction - loadNuevoExpedienteUF():String ");

		this.objDD = new DocumentoDetail();
		//this.objDD.setsNroExpediente(expedienteService.getMaxReferencia());
		int idExpedienteOrigen = Integer.parseInt(ServletActionContext.getRequest().getParameter("idExpediente").toString());
		this.lstDocumento = documentoService.getDocumentosPorExpediente(idExpedienteOrigen);
		String idProceso = ServletActionContext.getRequest().getParameter("idProceso").toString();
		this.objDD.setIIdProceso(Integer.decode(idProceso));
		return Action.SUCCESS;

	}

	/**
	 * Guarda un nuevo expediente
	 * @author Erik Candela
	 * @throws Exception
	 */
	@SuppressWarnings("unused")
	public String saveNuevoExpedienteUF() {
		log.debug("-> [Action] DocumentoAction - saveNuevoExpedienteUF():String ");

		try {
			Integer[] idsDocumentoPorExpe = new Integer[0];
			setMapSession(ActionContext.getContext().getSession());
			Usuario objUsuarioLogeado = null;
			objUsuarioLogeado = (Usuario) getMapSession().get(Constantes.SESSION_USUARIO);
			//  Registrando el Autor del expediente Actualizacion
			objDD.setObjAutor(objUsuarioLogeado);

			//
			if (idsDocumentoPorExSeleccionados != null && !idsDocumentoPorExSeleccionados.equals("")) {

				String[] idsStr = idsDocumentoPorExSeleccionados.split(",");
				idsDocumentoPorExpe = new Integer[idsStr.length];
				int i = 0;
				for (String idStr : idsStr) {
					idsDocumentoPorExpe[i] = Integer.parseInt(idStr);
					i++;
				}
			}

			if (idDocPrincipalExpediente != null) {

				Usuario propietario = usuarioService.findByIdUsuario(objDD.getIIdDestinatario());
				Proceso proceso = procesoService.findByIdProceso(objDD.getIIdProceso());
				Cliente cliente = clienteService.findByNroIdentificacion(objDD.getStrNroIdentificacion());

				Expediente objExp = new Expediente();
				objExp.setIdpropietario(propietario);
				objExp.setNroexpediente("NOTYET");
				objExp.setFechacreacion(new Date());
				objExp.setCliente(cliente);
				objExp.setEstado(Constantes.ESTADO_ACTIVO);
				objExp.setProceso(proceso);
				objExp.setEstaenflujo(Constantes.ESTAENFLUJO_S);
				objExp.setClientenombres(cliente.getNombres());
				objExp.setClienteapellidopaterno(cliente.getApellidoPaterno());
				objExp.setClienteapellidomaterno(cliente.getApellidoMaterno());
				objExp.setClienterazonsocial(cliente.getRazonSocial());
				objExp.setClienterepresentantelegal(cliente.getRepresentanteLegal());
				objExp.setClientedireccionprincipal(cliente.getDireccionPrincipal());
				if (cliente.getUbigeoPrincipal() != null) {
					objExp.setClienteubigeoprincipal(cliente.getUbigeoPrincipal().getIddistrito());
				}
				objExp.setClientedireccionalternativa(cliente.getDireccionAlternativa());
				if (cliente.getUbigeoAlternativo() != null) {
					objExp.setClienteubigeoalternativo(cliente.getUbigeoAlternativo().getIddistrito());
				}
				objExp.setClientetelefono(cliente.getTelefono());
				objExp.setClientecorreo(cliente.getCorreo());

				//GUARDANDO NUEVO EXPEDIENTE

				Documento documentoGuardado = this.documentoService.doSaveExpedienteUF(objDD, objUsuarioLogeado, objExp, idsDocumentoPorExpe, idDocPrincipalExpediente);
			} else {
				return Action.ERROR;
			}

		} catch (Exception e) {
			log.error(e.getMessage(), e);
			return Action.ERROR;
		}

		return Action.NONE;
	}

	public String viewInfoPrincipal() {
		log.debug("-> [Action] DocumentoAction - viewInfoPrincipal():String ");

		if (iIdDoc == null || iIdDoc < 1) {
			log.error("No se recibio ningun ID de Documento a ver");
			return Action.ERROR;
		}
		log.debug("Documento a ver con ID [" + iIdDoc + "]");

		mapSession = ActionContext.getContext().getSession();
		documento = documentoService.findByIdDocumento(iIdDoc);
		if (documento.getExpediente().getCliente().getTipoIdentificacion().getNombre().compareTo("RUC") == 0) {
			this.objConcesionario = this.concesionarioService.findByRUC(documento.getExpediente().getCliente().getNumeroIdentificacion());
			if (this.objConcesionario == null) {
				this.objConcesionario = new Concesionario();
				this.objConcesionario.setIdConcesionario(0);
			}
		}

		if (documento.getExpediente().getExpedientestor() == null) {
			desactivado = true;
		} else {
			desactivado = false;
		}

		List<Trazabilidaddocumento> listaTrazabilidad = trazabilidadDocumentoService.findByIdDocumento(iIdDoc);

		if (listaTrazabilidad != null && listaTrazabilidad.size() > 0) {
			Usuario objUsuario = listaTrazabilidad.get(0).getRemitente();
			usuarioRegistro = objUsuario.getNombres() + " " + objUsuario.getApellidos();
		}

		Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		Rol rol = usuario.getRol();
		String nombreRol = Constantes.ROL_USUARIO_FINAL;
		if (rol != null) {
			nombreRol = rol.getNombre();
		}

		objDD = documentoService.getDocumentDetailOptimized(getIIdDoc(), nombreRol);
		SimpleDateFormat fechaHora = new SimpleDateFormat("dd/MM/yyy hh:mm aa");
		objDD.setStrFechaAccion(fechaHora.format(documento.getFechaAccion()));

		if (enVentana != true) {
			enVentana = false;
		}

		return Action.SUCCESS;
	}

	public String viewInfoComplementaria() {
		log.debug("-> [Action] DocumentoAction - viewInfoComplementaria():String ");

		if (iIdDoc == null || iIdDoc < 1) {
			log.error("No se recibio ningun ID de Documento a ver");
			return Action.ERROR;
		}
		log.debug("Documento a ver con ID [" + iIdDoc + "]");
		// try{
		mapSession = ActionContext.getContext().getSession();
		documento = documentoService.findByIdDocumento(iIdDoc);

		if (documento.getExpediente().getCliente().getTipoIdentificacion().getNombre().equals(Constantes.TipoDoc_DNI)) {
			StringBuilder nombre = new StringBuilder(documento.getExpediente().getCliente().getNumeroIdentificacion()).append(" - ").append(documento.getExpediente().getCliente().getNombres()).append(" ").append(documento.getExpediente().getCliente().getApellidoPaterno()).append(" ").append(documento.getExpediente().getCliente().getApellidoMaterno());
			remitenteObservacion = nombre.toString();
		} else {
			remitenteObservacion = new StringBuilder(documento.getExpediente().getCliente().getNumeroIdentificacion()).append(" - ").append(documento.getExpediente().getCliente().getRazonSocial()).toString();
		}
		Usuario objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		usuarioLogueado = objUsuario.getNombres() + " " + objUsuario.getApellidos();

		List<Trazabilidaddocumento> listaTrazabilidad = trazabilidadDocumentoService.findByIdDocumento(iIdDoc);

		if (listaTrazabilidad != null && listaTrazabilidad.size() > 0) {
			objUsuario = listaTrazabilidad.get(0).getRemitente();
			usuarioRegistro = objUsuario.getNombres() + " " + objUsuario.getApellidos();
			fechaDerivacion = listaTrazabilidad.get(listaTrazabilidad.size() - 1).getFechacreacion();
			try {
				etapaActual = listaTrazabilidad.get(listaTrazabilidad.size() - 1).getIdetapa().getDescripcion();
			} catch (Exception e) {
				etapaActual = "";
			}
		}

		Expedientestor objExpedienteStor = expedienteStorService.findByIdExpediente(documento.getExpediente().getIdexpediente());
		if (objExpedienteStor != null) {
			this.codSala = (objExpedienteStor.getSala() != null ? objExpedienteStor.getSala().getIdsala().toString() : "");
			this.codEstado = (objExpedienteStor.getEstado() != null ? objExpedienteStor.getEstado().getIdestado().toString() : "");


			Resolucionjaru objResolucionJaru = resolucionJaruService.findByIdExpedienteStor(objExpedienteStor.getIdexpediente());
			if (objResolucionJaru != null) {
				this.codResultado = (objResolucionJaru.getResultado() != null ? objResolucionJaru.getResultado().getIdtiporesultado().toString() : "");
				this.codVocal = (objResolucionJaru.getVocal() != null ? objResolucionJaru.getVocal().getIdvocal().toString() : "");
				this.fechaSesion = objResolucionJaru.getFechasesion();
				this.fechaNotiReclamante = objResolucionJaru.getFechanotificacionreclamante();
				this.fechaNotiConcesionario = objResolucionJaru.getFechanotificacionconcesionario();
				this.numeroResolucion = objResolucionJaru.getNroresolucion();
			}
		}



		return Action.SUCCESS;
	}

	public String goModificarExpediente(){
		log.debug("-> [Action] DocumentoAction - goModificarExpediente():String ");
		objDocumento = documentoService.findByIdDocumento(iIdDoc);
		return Action.SUCCESS;
	}
		
	public void doModificarExpediente(){
		log.debug("-> [Action] DocumentoAction - doModificarExpediente():void ");
		objExpediente = expedienteService.findByIdExpediente(iIdExp);
		objExpediente.setProceso(procesoService.findByIdProceso(idproceso));
		objExpediente.setObservacion(ultimaObservacion);
		objExpediente.setAsunto(asuntoObservacion);
		
		expedienteService.saveExpediente(objExpediente);
	}
	
	public String goModificarDocumento(){
		log.debug("-> [Action] DocumentoAction - goModificarDocumento():String ");
		objDocumento = documentoService.findByIdDocumento(iIdDoc);
		objDD = new DocumentoDetail();
		try{
			objDD.setStrFechaDocumento(new SimpleDateFormat("dd/MM/yyyy").format(objDocumento.getFechaDocumento()));
		}catch(Exception e){
			log.error("No se pudo parsear la fecha "+e.getMessage());
			objDD.setStrFechaDocumento("");
		}
		return Action.SUCCESS;
	}
	
	public void doModificarDocumento(){
		log.debug("-> [Action] DocumentoAction - doModificarDocumento():void ");
		objDocumento = documentoService.findByIdDocumento(iIdDoc);
		objDocumento.setAsunto(asuntoObservacion);
		objDocumento.setObservacion(ultimaObservacion);
		objDocumento.setReferenciados(referencia);
		try{
			objDocumento.setFechaDocumento(new SimpleDateFormat("yyyy-MM-dd").parse(objDD.getStrFechaDocumento()));
		}catch(Exception e){
			log.error("No se pudo parsear la fecha "+e.getMessage());
		}
		
		documentoService.saveDocumento(objDocumento);
	}
	
	public String goBandejaDXE(){
		log.debug("-> [Action] DocumentoAction - goBandejaDXE():String ");
		return "bandeja";
	}
	
	public void guardarSeguimientoUsuario(){
		log.debug("-> [Action] DocumentoAction - guardarSeguimientoUsuario():void ");
		mapSession = ActionContext.getContext().getSession();
		Usuario objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		
		SeguimientoXUsuario seguimiento = new SeguimientoXUsuario();
		seguimiento.setIdDocumento(iIdDoc);
		seguimiento.setIdUsuario(objUsuario.getIdusuario());
		
		if(agregar){
			seguimientoXUsuarioService.guardarSeguimiento(seguimiento);
		}else{
			seguimientoXUsuarioService.eliminarSeguimiento(seguimiento);
		}
		
	}
 
	public String imprimirProveido(){
		log.debug("-> [Action] DocumentoAction - imprimirProveido():String ");
		
		mapSession = ActionContext.getContext().getSession();
		Usuario objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		documento = documentoService.findByIdDocumento(iIdDoc);
		
		Integer traza;
		
		if(sOpcion != null && sOpcion.equals("enviados") && idtrazabilidaddocumento!=null){
			traza = idtrazabilidaddocumento;
		}else{
			if(documento.getDocumentoreferencia() != null){
				/**Es una copia para trabajo----------------------------------------------------------------------------------*/
				traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(documento.getDocumentoreferencia()).get(0).getIdtrazabilidaddocumento();
			}else{
				traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
			}
		}
		
		lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(iIdDoc,traza);

		StringBuilder cadenaCC = new StringBuilder();
		if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
			for(int i=0; i<lstTrazabilidadCopia.size(); i++){
				if(i!=0) cadenaCC.append(", ");
				cadenaCC.append( lstTrazabilidadCopia.get(i).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(i).getDestinatario().getNombres());
			}
		}
		
		suministros = null;
		submotivos = null;
		if (documento != null) {
			Expediente expediente = documento.getExpediente();
			if (expediente != null) {
				Proceso proceso = expediente.getProceso();
				if (proceso != null) {
					Tipoproceso tipoProceso = proceso.getTipoproceso();
					if (tipoProceso != null) {						
						Rol rol = objUsuario.getRol();
						String nombreRol = Constantes.ROL_USUARIO_FINAL;
						if (rol != null) {
							nombreRol = rol.getNombre();
						}
						
						if(documento.getDocumentoreferencia() != null){
							/**Es una copia de apoyo---------------------------------------------------------*/
							objDD = documentoService.getDocumentDetailOptimized(documento.getDocumentoreferencia(), nombreRol);
							Trazabilidadapoyo tapoyo = trazabilidadapoyoService.buscarUltimaDelegacionUsuario(objUsuario.getIdusuario(), iIdDoc);
							String comentario = "";
							if(tapoyo != null){
								comentario = tapoyo.getTexto() != null ? tapoyo.getTexto() : "";
							}
							if(objDD.getStrContenido() == null){
								objDD.setStrContenido(comentario);
							}else{
								objDD.setStrContenido(comentario+ "<br />" +objDD.getStrContenido());
							}
						}else{
							objDD = documentoService.getDocumentDetailOptimized(getIIdDoc(), nombreRol);
						}
						
						if(cadenaCC.length()!=0){
							objDD.setCadenaCC(cadenaCC.toString());	
						}

						archivos = archivoService.getArchivoListPorDocumento(iIdDoc).get("upload1");
						
						if(sOpcion != null && sOpcion.equals("enviados") && idtrazabilidaddocumento!=null){
							Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findTrabilidadbyId(idtrazabilidaddocumento);
							objDD.setStrAsunto(trazabilidad.getAsunto());
							objDD.setStrDestinatario(trazabilidad.getDestinatario().getNombreCompleto());
							objDD.setStrContenido(trazabilidad.getContenido());
						}else if(sOpcion != null && sOpcion.equals("informativos") && iIdNotificacion!=null){							
							Notificacion notificacion = notificacionService.buscarObjPorID(iIdNotificacion);
							objDD.setStrAsunto(notificacion.getAsunto());
							objDD.setStrDestinatario(notificacion.getIdusuario().getNombreCompleto());
							objDD.setStrContenido(notificacion.getContenido());
						}else if(sOpcion != null && sOpcion.equals("multiples") && idTrazabilidadapoyo!=null){
							Trazabilidadapoyo trazapo = new Trazabilidadapoyo();
			            	trazapo = trazabilidadapoyoService.findByIdTrazabilidadApoyo(idTrazabilidadapoyo);
			            	objDD.setStrAsunto(trazapo.getAsunto());
			            	objDD.setStrDestinatario(trazapo.getDestinatario().getNombreCompleto());
			            	objDD.setStrContenido(trazapo.getTexto());
						}
					}
				}				
			} else {
				log.debug("Excecion nulo");

			}
			//objDD.setStrAsunto(documento.getExpediente().getAsunto());
			
			
			
			objDD.setIIdDocumento(iIdDoc);
		}
		return "proveido";
	}
	
	public String generarCargoTicket(){
		cargo = documentoService.obtenerCargo(idDocumento);
		return "cargo";
	}
	
	public String getIdsDocumentoPorExSeleccionados() {
		return idsDocumentoPorExSeleccionados;
	}

	public void setIdsDocumentoPorExSeleccionados(
			String idsDocumentoPorExSeleccionados) {
		this.idsDocumentoPorExSeleccionados = idsDocumentoPorExSeleccionados;
	}

	public Integer getIdDocPrincipalExpediente() {
		return idDocPrincipalExpediente;
	}

	public void setIdDocPrincipalExpediente(Integer idDocPrincipalExpediente) {
		this.idDocPrincipalExpediente = idDocPrincipalExpediente;
	}

	public void setDocumentoService(DocumentoService documentoService) {
		this.documentoService = documentoService;
	}

	public Integer getIIdDoc() {
		return iIdDoc;
	}

	public void setIIdDoc(Integer iIdDoc) {
		this.iIdDoc = iIdDoc;
	}

	public Integer getIIdExp() {
		return iIdExp;
	}

	public void setIIdExp(Integer iIdExp) {
		this.iIdExp = iIdExp;
	}

	public ArchivoPendiente getArchivopendiente() {
		return archivopendiente;
	}

	public void setArchivopendiente(ArchivoPendiente archivopendiente) {
		this.archivopendiente = archivopendiente;
	}

	public List<DestinatarioList> getLstDL() {
		return lstDL;
	}

	public void setLstDL(List<DestinatarioList> lstDL) {
		this.lstDL = lstDL;
	}

	public Map<Integer, Boolean> getMapChkDocumento() {
		return mapChkDocumento;
	}

	public void setMapChkDocumento(Map<Integer, Boolean> mapChkDocumento) {
		this.mapChkDocumento = mapChkDocumento;
	}

	public Map<Integer, String> getMapTipoDocumento() {
		return mapTipoDocumento;
	}

	public void setMapTipoDocumento(Map<Integer, String> mapTipoDocumento) {
		this.mapTipoDocumento = mapTipoDocumento;
	}

	// public Map getMapTipoIdentificacion(){
	// return mapTipoIdentificacion;
	// }
	//
	// public void setMapTipoIdentificacion(Map mapTipoIdentificacion){
	// this.mapTipoIdentificacion=mapTipoIdentificacion;
	// }
	public DocumentoDetail getObjDD() {
		return objDD;
	}

	public void setObjDD(DocumentoDetail objDD) {
		this.objDD = objDD;
	}

	public void setProcesoService(ProcesoService procesoService) {
		this.procesoService = procesoService;
	}

	public void setClienteService(ClienteService clienteService) {
		this.clienteService = clienteService;
	}

	public String getStrAcc() {
		return strAcc;
	}

	public void setStrAcc(String strAcc) {
		this.strAcc = strAcc;
	}

	public void setTipoDocumentoService(TipodocumentoService tipoDocumentoService) {
		this.tipoDocumentoService = tipoDocumentoService;
	}

	public void setTipoIdentificacionService(TipoidentificacionService tipoIdentificacionService) {
		this.tipoIdentificacionService = tipoIdentificacionService;
	}

	public void setActividadService(ActividadService actividadService) {
		this.actividadService = actividadService;
	}

	public void setUsuarioService(UsuarioService usuarioService) {
		this.usuarioService = usuarioService;
	}

	public String getDepartamento() {
		return departamento;
	}

	public void setDepartamento(String departamento) {
		this.departamento = departamento;
	}

	public Integer getIddepartamento() {
		return iddepartamento;
	}

	public void setIddepartamento(Integer iddepartamento) {
		this.iddepartamento = iddepartamento;
	}

	public String getProvincia() {
		return provincia;
	}

	public void setProvincia(String provincia) {
		this.provincia = provincia;
	}

	public Integer getIdprovincia() {
		return idprovincia;
	}

	public void setIdprovincia(Integer idprovincia) {
		this.idprovincia = idprovincia;
	}

	public String getDistrito() {
		return distrito;
	}

	public void setDistrito(String distrito) {
		this.distrito = distrito;
	}

	public Integer getIddistrito() {
		return iddistrito;
	}

	public void setIddistrito(Integer iddistrito) {
		this.iddistrito = iddistrito;
	}

	public String getProceso() {
		return proceso;
	}

	public void setProceso(String proceso) {
		this.proceso = proceso;
	}

	public Integer getIdproceso() {
		return idproceso;
	}

	public void setIdproceso(Integer idproceso) {
		this.idproceso = idproceso;
	}

	public String getCorrentista() {
		return correntista;
	}

	public void setCorrentista(String correntista) {
		this.correntista = correntista;
	}

	public Integer getIdcorrentista() {
		return idcorrentista;
	}

	public void setIdcorrentista(Integer idcorrentista) {
		this.idcorrentista = idcorrentista;
	}

	public String getStrUnidad() {
		return strUnidad;
	}

	public void setStrUnidad(String strUnidad) {
		this.strUnidad = strUnidad;
	}

	public String getStrResponsable() {
		return strResponsable;
	}

	public void setStrResponsable(String strResponsable) {
		this.strResponsable = strResponsable;
	}

	public String getTipodocumento() {
		return tipodocumento;
	}

	public void setTipodocumento(String tipodocumento) {
		this.tipodocumento = tipodocumento;
	}

	public Integer getIdArchivoPendiente() {
		return idArchivoPendiente;
	}

	public void setIdArchivoPendiente(Integer idArchivoPendiente) {
		this.idArchivoPendiente = idArchivoPendiente;
	}

	public Integer getIdtipodocumento() {
		return idtipodocumento;
	}

	public void setIdtipodocumento(Integer idtipodocumento) {
		this.idtipodocumento = idtipodocumento;
	}

	public String getTipoidentificacion() {
		return tipoidentificacion;
	}

	public void setTipoidentificacion(String tipoidentificacion) {
		this.tipoidentificacion = tipoidentificacion;
	}

	public Integer getIdtipoidentificacion() {
		return idtipoidentificacion;
	}

	public void setIdtipoidentificacion(Integer idtipoidentificacion) {
		this.idtipoidentificacion = idtipoidentificacion;
	}

	public String getNumeroIdentificacion() {
		return nroidentificacion;
	}

	public void setNroidentificacion(String nroidentificacion) {
		this.nroidentificacion = nroidentificacion;
	}

	public String getStrRazonSocial() {
		return strRazonSocial;
	}

	public void setStrRazonSocial(String strRazonSocial) {
		this.strRazonSocial = strRazonSocial;
	}

	public String getStrDireccionPrincipal() {
		return strDireccionPrincipal;
	}

	public void setStrDireccionPrincipal(String strDireccionPrincipal) {
		this.strDireccionPrincipal = strDireccionPrincipal;
	}

	public File getUpload() {
		return upload;
	}

	public void setUpload(File upload) {
		this.upload = upload;
	}

	public void setUploadFileName(String uploadFileName) {
		this.uploadFileName = uploadFileName;
	}

	public void setFullFileName(String fullFileName) {
		this.fullFileName = fullFileName;
	}

	public Integer getIddestinatario() {
		return iddestinatario;
	}

	public void setIddestinatario(Integer iddestinatario) {
		this.iddestinatario = iddestinatario;
	}

	public Integer getIdccdestinatario() {
		return idccdestinatario;
	}

	public void setIdccdestinatario(Integer idccdestinatario) {
		this.idccdestinatario = idccdestinatario;
	}

	public Integer getIdPlantilla() {
		return idPlantilla;
	}

	public void setIdPlantilla(Integer idPlantilla) {
		this.idPlantilla = idPlantilla;
	}

	public String getTa() {
		return ta;
	}

	public void setTa(String ta) {
		this.ta = ta;
	}

	public Integer getIdDocumento() {
		return idDocumento;
	}

	public void setIdDocumento(Integer idDocumento) {
		this.idDocumento = idDocumento;
	}

	public void setArchivoService(ArchivoService archivoService) {
		this.archivoService = archivoService;
	}

	public void setExpedienteStorService(ExpedientestorService expedienteStorService) {
		this.expedienteStorService = expedienteStorService;
	}

	public void setRepositorioService(RepositorioService repositorioService) {
		this.repositorioService = repositorioService;
	}

	public void setExpedienteService(ExpedienteService expedienteService) {
		this.expedienteService = expedienteService;
	}

	public String getNrodocumento() {
		return nrodocumento;
	}

	public void setNrodocumento(String nrodocumento) {
		this.nrodocumento = nrodocumento;
	}

	public String getStrRUC() {
		return strRUC;
	}

	public void setStrRUC(String strRUC) {
		this.strRUC = strRUC;
	}

	public String getStrDireccion() {
		return strDireccion;
	}

	public void setStrDireccion(String strDireccion) {
		this.strDireccion = strDireccion;
	}

	public String getStrRepresentanteLegal() {
		return strRepresentanteLegal;
	}

	public void setStrRepresentanteLegal(String strRepresentanteLegal) {
		this.strRepresentanteLegal = strRepresentanteLegal;
	}

	public String getStrCorreoConcesionario() {
		return strCorreoConcesionario;
	}

	public void setStrCorreoConcesionario(String strCorreoConcesionario) {
		this.strCorreoConcesionario = strCorreoConcesionario;
	}

	public String getStrTelefonoCliente() {
		return strTelefonoCliente;
	}

	public void setStrTelefonoCliente(String strTelefonoCliente) {
		this.strTelefonoCliente = strTelefonoCliente;
	}

	public String getStrCorreoCliente() {
		return strCorreoCliente;
	}

	public void setStrCorreoCliente(String strCorreoCliente) {
		this.strCorreoCliente = strCorreoCliente;
	}

	public Integer getIdmotivo() {
		return idmotivo;
	}

	public void setIdmotivo(Integer idmotivo) {
		this.idmotivo = idmotivo;
	}

	public Integer getIdsubmotivo() {
		return idsubmotivo;
	}

	public void setIdsubmotivo(Integer idsubmotivo) {
		this.idsubmotivo = idsubmotivo;
	}

	public String getSubmotivo() {
		return submotivo;
	}

	public void setSubmotivo(String submotivo) {
		this.submotivo = submotivo;
	}

	public Integer getIdsala() {
		return idsala;
	}

	public void setIdsala(Integer idsala) {
		this.idsala = idsala;
	}

	public String getSala() {
		return sala;
	}

	public void setSala(String sala) {
		this.sala = sala;
	}

	public Integer getIdanalista() {
		return idanalista;
	}

	public void setIdanalista(Integer idanalista) {
		this.idanalista = idanalista;
	}

	public String getAnalista() {
		return analista;
	}

	public void setAnalista(String analista) {
		this.analista = analista;
	}

	public ExpedienteTree getObjExpedienteTree() {
		return objExpedienteTree;
	}

	public void setObjExpedienteTree(ExpedienteTree objExpedienteTree) {
		this.objExpedienteTree = objExpedienteTree;
	}

	public boolean isBBandeja() {
		return bBandeja;
	}

	public void setBBandeja(boolean bBandeja) {
		this.bBandeja = bBandeja;
	}

	public Map<Integer, String> getMapCumpleRequisito() {
		return mapCumpleRequisito;
	}

	public void setMapCumpleRequisito(Map<Integer, String> mapCumpleRequisito) {
		this.mapCumpleRequisito = mapCumpleRequisito;
	}

	public Integer getIdCumpleRequisito() {
		return idCumpleRequisito;
	}

	public void setIdCumpleRequisito(Integer idCumpleRequisito) {
		this.idCumpleRequisito = idCumpleRequisito;
	}

	public Integer getIdconcesionario() {
		return idconcesionario;
	}

	public void setIdconcesionario(Integer idconcesionario) {
		this.idconcesionario = idconcesionario;
	}

	public String getConcesionario() {
		return concesionario;
	}

	public void setConcesionario(String concesionario) {
		this.concesionario = concesionario;
	}

	public String getNmotivo() {
		return nmotivo;
	}

	public void setNmotivo(String nmotivo) {
		this.nmotivo = nmotivo;
	}

	public Integer getIdCliente() {
		return idcliente;
	}

	public void setIdcliente(Integer idcliente) {
		this.idcliente = idcliente;
	}

	public List<Tipoidentificacion> getLstRadio() {
		return lstRadio;
	}

	public void setLstRadio(List<Tipoidentificacion> lstRadio) {
		this.lstRadio = lstRadio;
	}

	public String getCerrar() {
		return cerrar;
	}

	public void setCerrar(String cerrar) {
		this.cerrar = cerrar;
	}

	public void setAccionService(AccionService accionService) {
		this.accionService = accionService;
	}

	public PlantillaService getPlantillaService() {
		return plantillaService;
	}

	public void setNotificacionService(NotificacionService notificacionService) {
		this.notificacionService = notificacionService;
	}



	public NotificacionxEnumerarService getNotificacionxEnumerarService() {
		return notificacionxEnumerarService;
	}

	public void setNotificacionxEnumerarService(
			NotificacionxEnumerarService notificacionxEnumerarService) {
		this.notificacionxEnumerarService = notificacionxEnumerarService;
	}

	public void setPlantillaService(PlantillaService plantillaService) {
		this.plantillaService = plantillaService;
	}

	public void setTrazabilidadDocumentoService(TrazabilidaddocumentoService trazabilidadDocumentoService) {
		this.trazabilidadDocumentoService = trazabilidadDocumentoService;
	}

	public boolean isOwnerproceso() {
		return ownerproceso;
	}

	public void setOwnerproceso(boolean ownerproceso) {
		this.ownerproceso = ownerproceso;
	}

	public boolean isBResponsable() {
		return bResponsable;
	}

	public void setBResponsable(boolean responsable) {
		bResponsable = responsable;
	}

	public String[] getStorsuministro() {
		return storsuministro;
	}

	public void setStorsuministro(String[] storsuministro) {
		this.storsuministro = storsuministro;
	}

	public Integer[] getStoridsubmotivo() {
		return storidsubmotivo;
	}

	public void setStoridsubmotivo(Integer[] storidsubmotivo) {
		this.storidsubmotivo = storidsubmotivo;
	}

	public Map<String, Object> getMapSession() {
		return mapSession;
	}

	public void setMapSession(Map<String, Object> mapSession) {
		this.mapSession = mapSession;
	}

	public Integer getIIdDocumento() {
		return iIdDocumento;
	}

	public void setIIdDocumento(Integer iIdDocumento) {
		this.iIdDocumento = iIdDocumento;
	}

	public String getRegresar() {
		return regresar;
	}

	public void setRegresar(String regresar) {
		this.regresar = regresar;
	}

	public Integer getIdenv() {
		return idenv;
	}

	public void setIdenv(Integer idenv) {
		this.idenv = idenv;
	}

	public Integer[] getArrIdDoc() {
		return arrIdDoc;
	}

	public void setArrIdDoc(Integer[] arrIdDoc) {
		this.arrIdDoc = arrIdDoc;
	}

	public String getSTipoDerivacion() {
		return sTipoDerivacion;
	}

	public void setSTipoDerivacion(String sTipoDerivacion) {
		this.sTipoDerivacion = sTipoDerivacion;
	}

	public void setIIdPro(Integer iIdPro) {
		this.iIdPro = iIdPro;
	}

	public Integer getIIdPro() {
		return iIdPro;
	}

	public void setAvisopermiso(Integer avisopermiso) {
		this.avisopermiso = avisopermiso;
	}

	public Integer getAvisopermiso() {
		return avisopermiso;
	}

	public Documento getObjDocumento() {
		return objDocumento;
	}

	public void setObjDocumento(Documento objDocumento) {
		this.objDocumento = objDocumento;
	}

	public Boolean getBBotonHabilitado() {
		return bBotonHabilitado;
	}

	public void setBBotonHabilitado(Boolean bBotonHabilitado) {
		this.bBotonHabilitado = bBotonHabilitado;
	}

	public Expediente getObjExpediente() {
		return objExpediente;
	}

	public void setObjExpediente(Expediente objExpediente) {
		this.objExpediente = objExpediente;
	}

	public String getSFromBandeja() {
		return sFromBandeja;
	}

	public void setSFromBandeja(String sFromBandeja) {
		this.sFromBandeja = sFromBandeja;
	}

	public String getSOpcion() {
		return sOpcion;
	}

	public void setSOpcion(String opcion) {
		sOpcion = opcion;
	}

	public ExpedienteSearch getObjExpedienteSearch() {
		return objExpedienteSearch;
	}

	public void setObjExpedienteSearch(ExpedienteSearch objExpedienteSearch) {
		this.objExpedienteSearch = objExpedienteSearch;
	}

	public List<Documento> getLstDocumento() {
		return lstDocumento;
	}

	public void setLstDocumento(List<Documento> lstDocumento) {
		this.lstDocumento = lstDocumento;
	}

	public Cliente getObjCliente() {
		return objCliente;
	}

	public void setObjCliente(Cliente objCliente) {
		this.objCliente = objCliente;
	}

	public void setTrazabilidadExpedienteService(TrazabilidadexpedienteService trazabilidadExpedienteService) {
		this.trazabilidadExpedienteService = trazabilidadExpedienteService;
	}

	public Boolean getMostrarObservacion() {
		return mostrarObservacion;
	}

	public void setMostrarObservacion(Boolean mostrarObservacion) {
		this.mostrarObservacion = mostrarObservacion;
	}

	public String getRemitenteObservacion() {
		return remitenteObservacion;
	}

	public void setRemitenteObservacion(String remitenteObservacion) {
		this.remitenteObservacion = remitenteObservacion;
	}

	public String getUltimaObservacion() {
		return ultimaObservacion;
	}

	public void setUltimaObservacion(String ultimaObservacion) {
		this.ultimaObservacion = ultimaObservacion;
	}

	public String getOtraObservacion() {
		return otraObservacion;
	}

	public void setOtraObservacion(String otraObservacion) {
		this.otraObservacion = otraObservacion;
	}

	public String getAsuntoObservacion() {
		return asuntoObservacion;
	}

	public void setAsuntoObservacion(String asuntoObservacion) {
		this.asuntoObservacion = asuntoObservacion;
	}

	public String getAccionObservacion() {
		return accionObservacion;
	}

	public void setAccionObservacion(String accionObservacion) {
		this.accionObservacion = accionObservacion;
	}

	public String getDestinatarioObservacion() {
		return destinatarioObservacion;
	}

	public void setDestinatarioObservacion(String destinatarioObservacion) {
		this.destinatarioObservacion = destinatarioObservacion;
	}

	public Integer getIIdUpload() {
		return iIdUpload;
	}

	public void setIIdUpload(Integer iIdUpload) {
		this.iIdUpload = iIdUpload;
	}

	public String getSTipoIdentificacion() {
		return sTipoIdentificacion;
	}

	public void setSTipoIdentificacion(String sTipoIdentificacion) {
		this.sTipoIdentificacion = sTipoIdentificacion;
	}

	public String getSMontoReclamo() {
		return sMontoReclamo;
	}

	public void setSMontoReclamo(String sMontoReclamo) {
		this.sMontoReclamo = sMontoReclamo;
	}

	public String getSFechaDocumento() {
		return sFechaDocumento;
	}

	public void setSFechaDocumento(String sFechaDocumento) {
		this.sFechaDocumento = sFechaDocumento;
	}

	public Integer getIIdNotificacion() {
		return iIdNotificacion;
	}

	public void setIIdNotificacion(Integer iIdNotificacion) {
		this.iIdNotificacion = iIdNotificacion;
	}

	public boolean isDocumentoStor() {
		return documentoStor;
	}

	public void setDocumentoStor(boolean documentoStor) {
		this.documentoStor = documentoStor;
	}

	public Expedientestor getExpedienteStor() {
		return expedienteStor;
	}

	public void setExpedienteStor(Expedientestor expedienteStor) {
		this.expedienteStor = expedienteStor;
	}

	public Map<String, String> getDetallesDocumentoStor() {
		return detallesDocumentoStor;
	}

	public void setDetallesDocumentoStor(Map<String, String> detallesDocumentoStor) {
		this.detallesDocumentoStor = detallesDocumentoStor;
	}

	public Date getFecha() {
		return fecha;
	}

	public void setFecha(Date fecha) {
		this.fecha = fecha;
	}

	public String getFechaEnTexto() {
		return fechaEnTexto;
	}

	public void setFechaEnTexto(String fechaEnTexto) {
		this.fechaEnTexto = fechaEnTexto;
	}

	public String getMensaje() {
		return mensaje;
	}

	public void setMensaje(String mensaje) {
		this.mensaje = mensaje;
	}

	public void setUsuarioStorService(UsuariostorService usuarioStorService) {
		this.usuarioStorService = usuarioStorService;
	}

	public boolean isUnico() {
		return unico;
	}

	public void setUnico(boolean unico) {
		this.unico = unico;
	}

	public int getIdGrid() {
		return idGrid;
	}

	public void setIdGrid(int idGrid) {
		this.idGrid = idGrid;
	}

	public boolean isDeMail() {
		return deMail;
	}

	public void setDeMail(boolean deMail) {
		this.deMail = deMail;
	}

	public void setConcesionarioService(ConcesionarioService concesionarioService) {
		this.concesionarioService = concesionarioService;
	}

	public Integer getIdtrazabilidaddocumento() {
		return idtrazabilidaddocumento;
	}

	public void setIdtrazabilidaddocumento(Integer idtrazabilidaddocumento) {
		this.idtrazabilidaddocumento = idtrazabilidaddocumento;
	}

	public ParametroService getParametroService() {
		return parametroService;
	}

	public void setParametroService(ParametroService parametroService) {
		this.parametroService = parametroService;
	}

	public String getDigmensaje() {
		return digmensaje;
	}

	public void setDigmensaje(String digmensaje) {
		this.digmensaje = digmensaje;
	}

	public Integer getIdExpedienteNuevo() {
		return idExpedienteNuevo;
	}

	public void setIdExpedienteNuevo(Integer idExpedienteNuevo) {
		this.idExpedienteNuevo = idExpedienteNuevo;
	}

	public List<String> getConCopia() {
		return conCopia;
	}

	public void setConCopia(List<String> conCopia) {
		this.conCopia = conCopia;
	}

	public void setControlDeCalidadService(ControlDeCalidadService controlDeCalidadService) {
		this.controlDeCalidadService = controlDeCalidadService;
	}

	public void setIntalioService(IntalioService intalioService) {
		this.intalioService = intalioService;
	}

	public Documento getDocumento() {
		return documento;
	}

	public void setDocumento(Documento documento) {
		this.documento = documento;
	}

	public List<Archivo> getArchivos() {
		return archivos;
	}

	public void setArchivos(List<Archivo> archivos) {
		this.archivos = archivos;
	}

	public String getNombreCliente() {
		return nombreCliente;
	}

	public void setNombreCliente(String nombreCliente) {
		this.nombreCliente = nombreCliente;
	}

	public List<Submotivo> getSubmotivos() {
		return submotivos;
	}

	public void setSubmotivos(List<Submotivo> submotivos) {
		this.submotivos = submotivos;
	}

	public List<Suministro> getSuministros() {
		return suministros;
	}

	public void setSuministros(List<Suministro> suministros) {
		this.suministros = suministros;
	}

	public Integer[] getIdSubmotivos() {
		return idSubmotivos;
	}

	public void setIdSubmotivos(Integer[] idSubmotivos) {
		this.idSubmotivos = idSubmotivos;
	}

	public Integer[] getIdSuministros() {
		return idSuministros;
	}

	public void setIdSuministros(Integer[] idSuministros) {
		this.idSuministros = idSuministros;
	}

	public String getUrlIntalio() {
		return urlIntalio;
	}

	public void setUrlIntalio(String urlIntalio) {
		this.urlIntalio = urlIntalio;
	}

	public char getTipoBusqueda() {
		return tipoBusqueda;
	}

	public void setTipoBusqueda(char tipoBusqueda) {
		this.tipoBusqueda = tipoBusqueda;
	}

	public boolean isDestinatarioIgualRemitente() {
		return destinatarioIgualRemitente;
	}

	public void setDestinatarioIgualRemitente(boolean destinatarioIgualRemitente) {
		this.destinatarioIgualRemitente = destinatarioIgualRemitente;
	}

	public List<String> getCondestinatarios() {
		return condestinatarios;
	}

	public void setCondestinatarios(List<String> condestinatarios) {
		this.condestinatarios = condestinatarios;
	}

	public List<String> getConcopias() {
		return concopias;
	}

	public void setConcopias(List<String> concopias) {
		this.concopias = concopias;
	}

	public EtapaService getEtapaService() {
		return etapaService;
	}

	public void setEtapaService(EtapaService etapaService) {
		this.etapaService = etapaService;
	}

	public boolean isMostrarEtapa() {
		return mostrarEtapa;
	}

	public void setMostrarEtapa(boolean mostrarEtapa) {
		this.mostrarEtapa = mostrarEtapa;
	}

	public Boolean getProvieneDeMail() {
		return provieneDeMail;
	}

	public void setProvieneDeMail(Boolean provieneDeMail) {
		this.provieneDeMail = provieneDeMail;
	}

	public DocumentoEnviadoService getDocumentoenviadoService() {
		return documentoenviadoService;
	}

	public void setDocumentoenviadoService(DocumentoEnviadoService documentoenviadoService) {
		this.documentoenviadoService = documentoenviadoService;
	}

	public String getUsuarioLogueado() {
		return usuarioLogueado;
	}

	public void setUsuarioLogueado(String usuarioLogueado) {
		this.usuarioLogueado = usuarioLogueado;
	}

	public String getEtapaActual() {
		return etapaActual;
	}

	public void setEtapaActual(String etapaActual) {
		this.etapaActual = etapaActual;
	}

	public Date getFechaDerivacion() {
		return fechaDerivacion;
	}

	public void setFechaDerivacion(Date fechaDerivacion) {
		this.fechaDerivacion = fechaDerivacion;
	}

	public String getUsuarioRegistro() {
		return usuarioRegistro;
	}

	public void setUsuarioRegistro(String usuarioRegistro) {
		this.usuarioRegistro = usuarioRegistro;
	}

	public String getCodSala() {
		return codSala;
	}

	public void setCodSala(String codSala) {
		this.codSala = codSala;
	}

	public String getCodEstado() {
		return codEstado;
	}

	public void setCodEstado(String codEstado) {
		this.codEstado = codEstado;
	}

	public Date getFechaSesion() {
		return fechaSesion;
	}

	public void setFechaSesion(Date fechaSesion) {
		this.fechaSesion = fechaSesion;
	}

	public String getCodVocal() {
		return codVocal;
	}

	public void setCodVocal(String codVocal) {
		this.codVocal = codVocal;
	}

	public String getCodResultado() {
		return codResultado;
	}

	public void setCodResultado(String codResultado) {
		this.codResultado = codResultado;
	}

	public String getNumeroResolucion() {
		return numeroResolucion;
	}

	public void setNumeroResolucion(String numeroResolucion) {
		this.numeroResolucion = numeroResolucion;
	}

	public Date getFechaNotiReclamante() {
		return fechaNotiReclamante;
	}

	public void setFechaNotiReclamante(Date fechaNotiReclamante) {
		this.fechaNotiReclamante = fechaNotiReclamante;
	}

	public Date getFechaNotiConcesionario() {
		return fechaNotiConcesionario;
	}

	public void setFechaNotiConcesionario(Date fechaNotiConcesionario) {
		this.fechaNotiConcesionario = fechaNotiConcesionario;
	}

	public ResolucionjaruService getResolucionJaruService() {
		return resolucionJaruService;
	}

	public void setResolucionJaruService(ResolucionjaruService resolucionJaruService) {
		this.resolucionJaruService = resolucionJaruService;
	}

	public boolean isDesactivado() {
		return desactivado;
	}

	public void setDesactivado(boolean desactivado) {
		this.desactivado = desactivado;
	}

	public boolean isEnVentana() {
		return enVentana;
	}

	public void setEnVentana(boolean enVentana) {
		this.enVentana = enVentana;
	}

	/**
	 * @return the mailService
	 */
	public ManejoDeEmailService getMailService() {
		return mailService;
	}

	/**
	 * @param mailService the mailService to set
	 */
	public void setMailService(ManejoDeEmailService mailService) {
		this.mailService = mailService;
	}

	public String getObservacionDigitalizador() {
		return observacionDigitalizador;
	}

	public void setObservacionDigitalizador(String observacionDigitalizador) {
		this.observacionDigitalizador = observacionDigitalizador;
	}

	public Concesionario getObjConcesionario() {
		return objConcesionario;
	}

	public void setObjConcesionario(Concesionario objConcesionario) {
		this.objConcesionario = objConcesionario;
	}


	public TrazabilidadcopiaService getTrazabilidadcopiaService() {
		return trazabilidadcopiaService;
	}

	public void setTrazabilidadcopiaService(
			TrazabilidadcopiaService trazabilidadcopiaService) {
		this.trazabilidadcopiaService = trazabilidadcopiaService;
	}

	public List<Trazabilidadcopia> getLstTrazabilidadCopia() {
		return lstTrazabilidadCopia;
	}

	public void setLstTrazabilidadCopia(List<Trazabilidadcopia> lstTrazabilidadCopia) {
		this.lstTrazabilidadCopia = lstTrazabilidadCopia;
	}

	public String getOrigenDetalleDoc() {
		return origenDetalleDoc;
	}

	public void setOrigenDetalleDoc(String origenDetalleDoc) {
		this.origenDetalleDoc = origenDetalleDoc;
	}

	public boolean isFlagMensaje() {
		return flagMensaje;
	}

	public void setFlagMensaje(boolean flagMensaje) {
		this.flagMensaje = flagMensaje;
	}


	public GestionDocumentos getGestionDocumentos() {
		return gestionDocumentos;
	}

	public void setGestionDocumentos(GestionDocumentos gestionDocumentos) {
		this.gestionDocumentos = gestionDocumentos;
	}

	private boolean isProcesoStor(List<Proceso> procesos,Proceso seleccionado){
		boolean forward=false;

		for (Proceso proceso : procesos) {
			if(proceso.getIdproceso()==seleccionado.getIdproceso())
			{
				forward=true;
				break;
			}
		}

		return forward; 
	}

	public String[] getApoyo() {
		return apoyo;
	}

	public void setApoyo(String[] apoyo) {
		this.apoyo = apoyo;
	}

	public TrazabilidadapoyoService getTrazabilidadapoyoService() {
		return trazabilidadapoyoService;
	}

	public void setTrazabilidadapoyoService(
			TrazabilidadapoyoService trazabilidadapoyoService) {
		this.trazabilidadapoyoService = trazabilidadapoyoService;
	}

	public String[] getStrAcciones() {
		return strAcciones;
	}

	public void setStrAcciones(String[] strAcciones) {
		this.strAcciones = strAcciones;
	}
	public String getsNombres() {
		return sNombres;
	}

	public void setsNombres(String sNombres) {
		this.sNombres = sNombres;
	}

	public String getPuedeRechazar() {
		return puedeRechazar;
	}

	public void setPuedeRechazar(String puedeRechazar) {
		this.puedeRechazar = puedeRechazar;
	}

	public Map<String, String> getUrl() {
		return url;
	}

	public void setUrl(Map<String, String> url) {
		this.url = url;
	}

	public Integer getIdDocumentoSeleccionado() {
		return idDocumentoSeleccionado;
	}

	public void setIdDocumentoSeleccionado(Integer idDocumentoSeleccionado) {
		this.idDocumentoSeleccionado = idDocumentoSeleccionado;
	}

	public boolean isApelacion() {
		return apelacion;
	}

	public void setApelacion(boolean apelacion) {
		this.apelacion = apelacion;
	}

	public void setIIdDoc(String iIdDoc) {
		try {
			this.iIdDoc = new Integer(iIdDoc);
		} catch (Exception ex) {
			log.debug(" iIdDoc is not a number :" + iIdDoc);
			log.error(ex.getMessage(), ex);
		}
	}

	public boolean isParaAprobar() {
		return paraAprobar;
	}

	public void setParaAprobar(boolean paraAprobar) {
		this.paraAprobar = paraAprobar;
	}

	public Map<String, Integer> getMapSessionStor() {
		return mapSessionStor;
	}

	public void setMapSessionStor(Map<String, Integer> mapSessionStor) {
		this.mapSessionStor = mapSessionStor;
	}

	public String getOcultar() {
		return ocultar;
	}

	public void setOcultar(String ocultar) {
		this.ocultar = ocultar;
	}


	public ListaService getListaService() {
		return listaService;
	}


	public void setListaService(ListaService listaService) {
		this.listaService = listaService;
	}


	public String[] getStrPrioridades() {
		return strPrioridades;
	}


	public void setStrPrioridades(String[] strPrioridades) {
		this.strPrioridades = strPrioridades;
	}


	public Integer getiIdDoc() {
		return iIdDoc;
	}


	public void setiIdDoc(Integer iIdDoc) {
		this.iIdDoc = iIdDoc;
	}


	public Integer getiIdPro() {
		return iIdPro;
	}


	public void setiIdPro(Integer iIdPro) {
		this.iIdPro = iIdPro;
	}


	public Integer getiIdExp() {
		return iIdExp;
	}


	public void setiIdExp(Integer iIdExp) {
		this.iIdExp = iIdExp;
	}


	public Integer getiIdNotificacion() {
		return iIdNotificacion;
	}


	public void setiIdNotificacion(Integer iIdNotificacion) {
		this.iIdNotificacion = iIdNotificacion;
	}


	public Integer getiIdDocumento() {
		return iIdDocumento;
	}


	public void setiIdDocumento(Integer iIdDocumento) {
		this.iIdDocumento = iIdDocumento;
	}


	public Integer getIdcliente() {
		return idcliente;
	}


	public ProveidoService getProveidoService() {
		return proveidoService;
	}


	public void setProveidoService(ProveidoService proveidoService) {
		this.proveidoService = proveidoService;
	}


	public List<Proveido> getProveidos() {
		return proveidos;
	}


	public void setProveidos(List<Proveido> proveidos) {
		this.proveidos = proveidos;
	}

	public String getReferencia() {
		return referencia;
	}

	public void setReferencia(String referencia) {
		this.referencia = referencia;
	}

	public SeguimientoXUsuarioService getSeguimientoXUsuarioService() {
		return seguimientoXUsuarioService;
	}

	public void setSeguimientoXUsuarioService(
			SeguimientoXUsuarioService seguimientoXUsuarioService) {
		this.seguimientoXUsuarioService = seguimientoXUsuarioService;
	}

	public boolean isAgregar() {
		return agregar;
	}

	public void setAgregar(boolean agregar) {
		this.agregar = agregar;
	}

	public FechaLimite getFechaLimite() {
		return fechaLimite;
	}

	public void setFechaLimite(FechaLimite fechaLimite) {
		this.fechaLimite = fechaLimite;
	}

	public Integer getIdTrazabilidadapoyo() {
		return idTrazabilidadapoyo;
	}

	public void setIdTrazabilidadapoyo(Integer idTrazabilidadapoyo) {
		this.idTrazabilidadapoyo = idTrazabilidadapoyo;
	}

	public Integer[] getArrIdArchivos() {
		return arrIdArchivos;
	}

	public void setArrIdArchivos(Integer[] arrIdArchivos) {
		this.arrIdArchivos = arrIdArchivos;
	}

	public CargoReporte getCargo() {
		return cargo;
	}

	public void setCargo(CargoReporte cargo) {
		this.cargo = cargo;
	}
	
	
	/***********
	 * wcarrasco
	 */
	
	
    private String funcExtension(String miString){
 	   String  extensionTemp = "";
	       String  extension= "";
	        for (int i=(miString.length()-1);i+1>0;i--) {
	            if(miString.charAt(i)=='.'){	     
	            	break;
	    	    }
	            extensionTemp +=miString.charAt(i); 
	        }			
			for (int i=(extensionTemp.length()-1);i+1>0;i--) {
	            extension +=extensionTemp.charAt(i); 
	        }			     
				return extension;
 	
	}
 
    private Integer compareFechas(Date d1, Date d2){
    	return d1.compareTo(d2); 
    }
	
	public String getInterfazGerente(){
		log.debug("-> [Action] DojoAction - getInterfazGerente():String ");
		log.debug("idDoc"+idDoc);
		String visor = "";
		Integer idDocTemp = 0 ;
		//Integer iIdDoc = 0; 
		iIdDoc= Integer.parseInt(idDoc);
		
		mapSession = ActionContext.getContext().getSession();
		Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		
		if( Integer.parseInt(idDoc) != 0 ){
		

			archivo = archivoService.getArchivoPrincipalPorDocumento(Integer.parseInt(idDoc));
			objDocumento = documentoService.findByIdDocumento(Integer.parseInt(idDoc));
			
			log.info("detectar  reenvio o aprovacion :" + objDocumento.getAccion().getNombre());
			if (objDocumento.getAccion().getNombre().equals(Constantes.ACCION_PARA_APROBAR)) {
				this.paraAprobar = true;
			} else {
				this.paraAprobar = false;
			}
			
			if(archivo == null){
			    log.debug("NO TINENE ARCHIVO PRINCIPAL");
			    List<Archivo> listArchivo = new  ArrayList <Archivo>();  
			    if(objDocumento.getDocumentoreferencia() != null){
			    	idDocTemp = objDocumento.getDocumentoreferencia().intValue();
			    	listArchivo = archivoService.getArchivoListPorDocumentoIG(idDocTemp);
				}else
				{	
			    	listArchivo = archivoService.getArchivoListPorDocumentoIG(Integer.parseInt(idDoc));
				}
				List<Archivo>  listArchivoTemp = new ArrayList <Archivo>();
				for(int i= 0;i <listArchivo.size();i++){				
					Archivo arch = new Archivo();
					arch = listArchivo.get(i);				
					if(funcExtension(arch.getNombreReal().toString()).equals("pdf")){
						listArchivoTemp.add(arch);
					}
				}
				
				if(listArchivoTemp.size() != 0){
					 log.debug("TIENE PDF");
					 Integer n = listArchivoTemp.size();
					 log.debug("n"+n);
					Date matriz[] = new Date [n];			
					for(int i= 0;i <n;i++){
						Archivo arch = new Archivo();
						arch = listArchivoTemp.get(i);
						log.debug("fecha creacion: "+arch.getFechaCreacion());
						matriz[i]= arch.getFechaCreacion();
						log.debug("matriz: "+matriz[i]);
					}			
					Date buffer;
					Integer comparar;
					for(int i = 0; i < matriz.length; i++){
						for(int j = 0; j < i; j++){
							comparar = compareFechas(matriz[i], matriz[j]);
							log.debug("resultado compareFechas "+comparar );
							if( comparar==-1){
								buffer = matriz[j];
								matriz[j] = matriz[i];
								matriz[i] = buffer;
							} 
						}
					}
					log.debug("EL ARCHIVO ANTIGUO ES : "+matriz[0]);
					for(int i=0;i <listArchivoTemp.size();i++){
						Archivo arch = new Archivo();
						arch = listArchivoTemp.get(i);				
						if(compareFechas(arch.getFechaCreacion(), matriz[0])==0){						
							archivo = listArchivoTemp.get(i);
							break;
						}
					}
				}
			}
			if(archivo != null ){
				rutaAlfresco = verArchivoAlfresco(archivo.getRutaAlfresco());			
				log.debug("rutaAlfresco    : "+rutaAlfresco);		
				visor= "verInterfaz";
				PDF = "S";
			}else{
				PDF = "N";
				rutaAlfresco = "No tiene";
				visor= "verInterfaz";
				//visor = "errorVisor";
			}
			
			String strCont = "";
			if (objDocumento != null) {
				if(objDocumento.getPropietario().equals(usuario)){
				Expediente expediente = objDocumento.getExpediente();
				if (expediente != null) {
					Proceso proceso = expediente.getProceso();
					if (proceso != null) {
						Tipoproceso tipoProceso = proceso.getTipoproceso();
						if (tipoProceso != null) {
							String tipo = tipoProceso.getNombre();
							if (tipo.equals(Constantes.TIPO_PROCESO_INTALIO) && usuario.getRol() == null) {
								//return mostrarDocumentoIntalio();
							}
							Integer iIdDocumentoSesion = (Integer) mapSession.get(Constantes.SESSION_IDDOCUMENTO);
							Integer idUsuario = usuario.getIdusuario();
							Map<String, List<ArchivoTemporal>> mapUpload = null;

							Rol rol = usuario.getRol();
							String nombreRol = Constantes.ROL_USUARIO_FINAL;
							if (rol != null) {
								nombreRol = rol.getNombre();
							}
							log.debug("Id Documento en Sesion [" + iIdDocumentoSesion + "]");
							if(objDocumento.getDocumentoreferencia() != null){
								log.debug("pasar por aqui docreferencia ! = null");
								/**Es una copia de apoyo---------------------------------------------------------*/
								objDD = documentoService.getDocumentDetailOptimized(objDocumento.getDocumentoreferencia(), nombreRol);
								Trazabilidadapoyo tapoyo = trazabilidadapoyoService.buscarUltimaDelegacionUsuario(usuario.getIdusuario(), iIdDoc);
								if(tapoyo != null){
									objDD.setStrContenido(tapoyo.getTexto() != null ? tapoyo.getTexto() : "");
									objDD.setStrAsunto(tapoyo.getAsunto() != null ? tapoyo.getAsunto() : objDD.getStrAsunto());
									objDD.setStrDestinatario(tapoyo.getDestinatario().getNombres() + " " + tapoyo.getDestinatario().getApellidos());
								}
								iddestinatario=objDD.getiIdRemitente(); //wvcarrasco 
							    asuntoDD = objDD.getStrAsunto();
							}else{
								log.debug("no tiene documento referencia");								
								objDD = documentoService.getDocumentDetailOptimized(getIIdDoc(), nombreRol);
								objDD.setStrRazonSocial(objDocumento.getExpediente().getCliente().getNombreRazon());
								strCont+= "<br />----------------------------------------------<br />"+usuario.getNombreCompleto()+
								  		" ("+(usuario.getRoles() != null ? usuario.getRoles().get(0).getNombre() : "")+")";
								objDD.setStrContenido(strCont);
								
								iddestinatario=objDD.getiIdRemitente(); //wvcarrasco 
							    asuntoDD = objDD.getStrAsunto();
								
								
							}
							
							
							
							log.debug("Usuario que revisa el documento [viewDoc]:" + usuario.getUsuario());
							if (iIdDocumentoSesion != null && iIdDocumentoSesion.intValue() != Integer.parseInt(idDoc)) {
								log.debug("Removiendo archivos temporales en sesion");
								mapSession.remove(Constantes.SESSION_UPLOAD_LIST);
								limpiarCarpetaTemporalxUsuario(usuario.getUsuario());
							}
							iIdUpload = 1;
							mapSession.put(Constantes.SESSION_IDDOCUMENTO, Integer.parseInt(idDoc));
						
							if (nombreRol.equals(Constantes.ROL_USUARIO_FINAL)) {
								mapSession.put(Constantes.SESSION_UPLOAD_LIST, archivoService.getArchivoListPorDocumento(Integer.parseInt(idDoc)));
								
							}
						}
					}
					}
					// en este caso, el usuario que desea ver el documento no es el propietario
				} else {
					log.debug("Excecion nulo");

				}
			}
			
			
			
			/*****************
			 * Detalle toolbar 
			 */

			log.debug("Documento a ver con ID [" + iIdDoc + "]");
	
			//if(iIdDoc !=0){
	        /*
				if(objDocumento.getConfidencial().equals(Constantes.Si)){
		        	List<Integer> permitidos = documentoService.getUsuariosPermitidos(objDocumento.getDocumentoreferencia() != null ? objDocumento.getDocumentoreferencia() : objDocumento.getIdDocumento());
		        	if(!permitidos.contains(new BigDecimal(usuario.getIdusuario()))){
		        		//return "sinpermiso";
		            }
		        }
				*/
				
				Integer counttraza= trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).size();
				counttraza = counttraza == null ? 0 : counttraza;
				
				log.debug("counttraza"+counttraza);
				agregar = false;
				
				if(seguimientoXUsuarioService.buscarSeguimiento(usuario.getIdusuario(), iIdDoc).isEmpty()){
					agregar = true;
				}
				log.debug("LLEGO AQUI");
				try{
				if(objDocumento.getAutor().getIdusuario().intValue() == usuario.getIdusuario().intValue() && counttraza == 1){
					destinatarioIgualRemitente = true;
				}else{
					destinatarioIgualRemitente = false;
				}
				}catch(Exception e){
					e.printStackTrace();
					destinatarioIgualRemitente = false;
				}
				
				int total = trazabilidadDocumentoService.totalCompartidos(usuario.getIdusuario(), objDocumento.getPropietario().getIdusuario());

				log.debug("total"+total);
				if (total > 0) {
					ServletActionContext.getRequest().getSession().setAttribute("UsuarioCompartido", objDocumento.getPropietario());
				} else {
					ServletActionContext.getRequest().getSession().setAttribute("UsuarioCompartido", null);
				}
				
				Integer traza;
				//Visualizar destinatarios con copia

				 
				//     traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
				//   List<NotificacionxEnumerar> listaNotificacion = notificacionxEnumerarService.buscarLastNotificacionesbyDocumento(iIdDoc, Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
				//   lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(iIdDoc,documento.get);
				String creador= (objDocumento.getAutor() != null ? objDocumento.getAutor().getNombreCompleto() : null);

				if(creador==null){
					creador=Constantes.AUTOR_USUARIO_FINAL;
				}
				if(creador.equals(Constantes.MESA_PARTES) && counttraza==3){
					traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(counttraza-1).getIdtrazabilidaddocumento();

				}
				else{
					if(objDocumento.getDocumentoreferencia() != null){
						//Es una copia para trabajo----------------------------------------------------------------------------------
						traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(objDocumento.getDocumentoreferencia()).get(0).getIdtrazabilidaddocumento();
					}else{
						traza=trazabilidadDocumentoService.findByMaxtrazabyIddocumento(iIdDoc).get(0).getIdtrazabilidaddocumento();
					}
				}
				lstTrazabilidadCopia = trazabilidadcopiaService.buscarUsuarioCopia(iIdDoc,traza);

				StringBuilder cadenaCC = new StringBuilder();
				if(lstTrazabilidadCopia!=null && lstTrazabilidadCopia.size()>0){			
					for(int i=0; i<lstTrazabilidadCopia.size(); i++){
						if(i!=0) cadenaCC.append(", ");
						cadenaCC.append( lstTrazabilidadCopia.get(i).getDestinatario().getApellidos()+" "+lstTrazabilidadCopia.get(i).getDestinatario().getNombres());
					}
				}
				
	       // }

					
			
			
			log.debug("LLEGO AQUI sin problemas");

		}else{
			visor= "errorVisor";
		}
				
		
		return visor;
	}
	

public String verArchivoAlfresco(String sURL) {
		log.debug("-> [Action] DojoAction - verArchivoAlfresco():String ");
		mapSession = ActionContext.getContext().getSession();
		HttpServletRequest request = ServletActionContext.getRequest();
		log.debug("Ruta Archivo Alfresco [" + sURL + "]");
		String ipPublica = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.IP_PUBLICA);
		String dominioPublico = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DOMINIO_PUBLICO);
		String alfrescoHostPublico = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.ALFRESCO_HOST_PUBLICO);
		String forward=alfrescoWebServiceClient.obtenerLinkContenido(sURL);
		try {
			URL urlReq = new URL(HttpUtils.getRequestURL(request).toString());
			log.debug("URL ["+urlReq.toExternalForm()+"] Host ["+urlReq.getHost()+"]");
			
			URL url = new URL(forward);
			if(urlReq.getHost().equals(ipPublica) || urlReq.getHost().equals(dominioPublico)){
				forward = forward.replace(url.getHost(), alfrescoHostPublico);
				log.debug("Reemplazando IP por ["+alfrescoHostPublico+"]");
			}
		} catch (MalformedURLException e) {
			e.printStackTrace();
		}
		return forward;
	}

public String getIdDoc() {
		return idDoc;
	}

	public void setIdDoc(String idDoc) {
		this.idDoc = idDoc;
	}

	public String getRutaAlfresco() {
		return rutaAlfresco;
	}

	public void setRutaAlfresco(String rutaAlfresco) {
		this.rutaAlfresco = rutaAlfresco;
	}

	public Archivo getArchivo() {
		return archivo;
	}

	public void setArchivo(Archivo archivo) {
		this.archivo = archivo;
	}

	public String getPDF() {
		return PDF;
	}

	public void setPDF(String pDF) {
		PDF = pDF;
	}

	public AlfrescoWSService getAlfrescoWebServiceClient() {
		return alfrescoWebServiceClient;
	}

	public void setAlfrescoWebServiceClient(
			AlfrescoWSService alfrescoWebServiceClient) {
		this.alfrescoWebServiceClient = alfrescoWebServiceClient;
	}

	public String getAsuntoDD() {
		return asuntoDD;
	}

	public void setAsuntoDD(String asuntoDD) {
		this.asuntoDD = asuntoDD;
	}
}  
