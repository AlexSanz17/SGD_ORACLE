package org.osinerg.services;

import gob.osinergmin.siged.config.SigedProperties;
import gob.osinergmin.siged.service.AlfrescoWebscriptService;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.reflect.Array;
import java.lang.reflect.InvocationTargetException;
import java.rmi.RemoteException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.persistence.NoResultException;
import javax.servlet.http.HttpServletRequest;
import javax.xml.stream.XMLStreamException;

import org.apache.commons.beanutils.PropertyUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.struts2.ServletActionContext;
import org.osinerg.daos.AuditoriaDAO;
import org.osinerg.daos.DocumentoDAO;
import org.osinerg.daos.DocumentoEnviadoDAO;
import org.osinerg.daos.DocumentostorDAO;
import org.osinerg.daos.ExpedienteDAO;
import org.osinerg.daos.NotificacionxEnumerarDAO;
import org.osinerg.daos.ParametroDAO;
import org.osinerg.daos.ProcesoDAO;
import org.osinerg.daos.ProveidoDAO;
import org.osinerg.daos.RolDAO;
import org.osinerg.daos.SedeDAO;
import org.osinerg.daos.SubmotivoDAO;
import org.osinerg.daos.SuministroDAO;
import org.osinerg.daos.TipodocumentoDAO;
import org.osinerg.daos.TrazabilidadapoyoDAO;
import org.osinerg.dojo.BusquedaAvanzada;
import org.osinerg.dojo.Recurso;
import org.osinerg.dojo.grid.ItemUF;
import org.osinerg.dojo.tree.Nodo;
import org.osinerg.dojo.tree.NodoArbol;
import org.osinerg.pojos.jasper.CargoReporte;
import org.osinerg.siged.service.AlfrescoWSService;
import org.osinerg.utils.ArchivoTemporal;
import org.osinerg.utils.Constantes;
import org.osinerg.utils.DocumentoDetail;
import org.osinerg.utils.DocumentoList;
import org.osinerg.utils.ExpedienteSearch;
import org.osinerg.utils.FechaLimite;
import org.osinerg.utils.StringUtil;
import org.osinerg.utils.template.TemplateUtils;
import org.osinerg.webservice.clientes.intalio.InvalidInputMessageFaultException;
import org.osinerg.webservice.clientes.intalio.InvalidParticipantTokenFaultException;
import org.osinerg.webservice.clientes.intalio.UnavailableTaskFaultException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.support.WebApplicationContextUtils;

import com.btg.osinergmin.siged.domain.Accion;
import com.btg.osinergmin.siged.domain.Archivo;
import com.btg.osinergmin.siged.domain.ArchivoPendiente;
import com.btg.osinergmin.siged.domain.Auditoria;
import com.btg.osinergmin.siged.domain.Cliente;
import com.btg.osinergmin.siged.domain.DiaFestivo;
import com.btg.osinergmin.siged.domain.Distrito;
import com.btg.osinergmin.siged.domain.Documento;
import com.btg.osinergmin.siged.domain.DocumentoAreaFuncional;
import com.btg.osinergmin.siged.domain.DocumentoStor;
import com.btg.osinergmin.siged.domain.Documentoenviado;
import com.btg.osinergmin.siged.domain.Documentoxcliente;
import com.btg.osinergmin.siged.domain.DocumentoxclientePK;
import com.btg.osinergmin.siged.domain.Documentoxexpediente;
import com.btg.osinergmin.siged.domain.DocumentoxexpedientePK;
import com.btg.osinergmin.siged.domain.Etapa;
import com.btg.osinergmin.siged.domain.Expediente;
import com.btg.osinergmin.siged.domain.FilaBandejaUF;
import com.btg.osinergmin.siged.domain.Lista;
import com.btg.osinergmin.siged.domain.Notificacion;
import com.btg.osinergmin.siged.domain.NotificacionxEnumerar;
import com.btg.osinergmin.siged.domain.Numeracion;
import com.btg.osinergmin.siged.domain.Parametro;
import com.btg.osinergmin.siged.domain.Perfil;
import com.btg.osinergmin.siged.domain.Proceso;
import com.btg.osinergmin.siged.domain.Proveido;
import com.btg.osinergmin.siged.domain.Rol;
import com.btg.osinergmin.siged.domain.Sede;
import com.btg.osinergmin.siged.domain.Submotivo;
import com.btg.osinergmin.siged.domain.Suministro;
import com.btg.osinergmin.siged.domain.Tipodocumento;
import com.btg.osinergmin.siged.domain.Tipoproceso;
import com.btg.osinergmin.siged.domain.Trazabilidadapoyo;
import com.btg.osinergmin.siged.domain.Trazabilidaddocumento;
import com.btg.osinergmin.siged.domain.Unidad;
import com.btg.osinergmin.siged.domain.Usuario;
import com.opensymphony.xwork2.ActionContext;

public class DocumentoServiceImpl implements DocumentoService {

	private final Logger log = LoggerFactory.getLogger(DocumentoServiceImpl.class);

	private AuditoriaDAO auditoriaDao;
	private DocumentoDAO documentoDao;
	private DocumentoEnviadoDAO documentoEnviadoDao;
	private DocumentostorDAO documentoStorDao;
	private ParametroDAO parametroDao;
	private ProcesoDAO procesoDao;
	private RolDAO rolDao;
	private SedeDAO sedeDao;
	private SubmotivoDAO submotivoDao;
	private SuministroDAO suministroDao;
	private TipodocumentoDAO tipoDocumentoDao;
	private ProveidoDAO proveidoDAO;
	private TrazabilidadapoyoDAO trazabilidadDocumentoDao;
	private ExpedienteDAO expedienteDAO;
	
	private AccionService accionService;
	private ArchivoService archivoService;
	private ArchivopendienteService srvArchivoPendiente;
	private AuditoriaService auditoriaService;
	private DiafestivoService diaFestivoService;
	private NumeracionService numeracionService;
	private DistritoService distritoService;
	private DocumentoxexpedienteService documentoPorExpedienteService;
	private ExpedienteService expedienteService;
	private ListaService listaService;
	private NotificacionService notificacionService;
	private RepositorioService repositorioService;
	private TrazabilidaddocumentoService trazabilidadDocumentoService;
	private TrazabilidadexpedienteService trazabilidadExpedienteService;
	private UsuarioService usuarioService;
	private UsuariostorService usuarioStorService;
	private TrazabilidadcopiaService trazabilidadcopiaService;
	private FechaLimite fechaLimite;
	private IntalioService intalioService;
	private ManejoDeEmailService mailService;
	private AlfrescoWSService alfrescoWebServiceClient;
	private ClienteService clienteService;
	private DocumentoxclienteService documentoxclienteService;
	private NotificacionxEnumerarDAO notificacionxEnumerarDAO;
	private AlfrescoWebscriptService alfrescoWebscriptClient;
	private TrazabilidadapoyoService trazabilidadapoyoService;
	private EstadoService estadoService;
	private UnidadService unidadService;
	private ParametroService parametroService;
	private Map<String, Object> mapSession;
	private ProcesoService procesoService;
	private GridcolumnaxusuarioService gridColumnaXUsuarioService;
	public Boolean aplicarJerarquia(Usuario objJefe, Proceso objProceso, Integer iIdDocumento) {
		log.debug("-> [Service] DocumentoService - aplicarJerarquia():Boolean ");
		
		List<Usuario> lstSubordinado = null;
		String sTipoAcceso = objProceso.getIdtipoacceso().getCodigo();
		if (sTipoAcceso.equals(Constantes.PROCESO_ACCESO_1)) {
			return true;
		}
		lstSubordinado = usuarioService.findUsuariosByIdJefe(objJefe.getIdusuario());
		if (lstSubordinado != null) {
			for (Usuario objSubordinado : lstSubordinado) {
				if (sTipoAcceso.equals(Constantes.PROCESO_ACCESO_2)) {
					for (Usuario objParticipante : objProceso.getUsuarioList()) {
						if (objParticipante.getIdusuario().intValue() == objSubordinado.getIdusuario().intValue()) {
							return true;
						}
					}
				} else if (sTipoAcceso.equals(Constantes.PROCESO_ACCESO_3)) {
					Documento objDocumento = this.findByIdDocumento(iIdDocumento);
					if (objSubordinado.getIdusuario().intValue() == objDocumento.getPropietario().getIdusuario().intValue()) {
						return true;
					}
				} else if (sTipoAcceso.equals(Constantes.PROCESO_ACCESO_4)) {
					for (Usuario objParticipante : objProceso.getUsuarioList1()) {
						if (objParticipante.getIdusuario().intValue() == objSubordinado.getIdusuario().intValue()) {
							return true;
						}
					}
				}
			}
		}
		return false;
	}

	public Documento buscarDocumentoMasAntiguoPor(Integer iIdExpediente) {
		log.debug("-> [Service] DocumentoService - buscarDocumentoMasAntiguoPor():Documento ");
		
		return documentoDao.buscarDocumentoMasAntiguoPor(iIdExpediente);
	}

	@Override
	@Transactional
	public void anexarDocumento(Integer iIdDocumentoPrincipal, Integer[] arrIdDocumento) {
		log.debug("-> [Service] DocumentoService - anexarDocumento():void ");
		
		Documento objDocumentoPrincipal = this.findByIdDocumento(iIdDocumentoPrincipal);
		log.debug("Se asignaran [" + arrIdDocumento.length + "] documentos al expediente [" + objDocumentoPrincipal.getExpediente().getNroexpediente() + "]");
		for (Integer iIdDocToAnexar : arrIdDocumento) {
			log.debug("Documento a anexar con ID [" + iIdDocToAnexar + "]");
			Documentoxexpediente objDocXExp = new Documentoxexpediente(iIdDocToAnexar, objDocumentoPrincipal.getExpediente().getIdexpediente());
			objDocXExp.setEstado(Constantes.ESTADO_ACTIVO);
			documentoPorExpedienteService.guardarObj(objDocXExp);
			Documento doc = documentoDao.findByIdDocumento(iIdDocToAnexar);
			registrarAuditoriaAnexarDocumento(doc, objDocumentoPrincipal.getExpediente(), Constantes.TA_AnexarUserFinal, Constantes.TM_UserFinal, Constantes.TO_Anexar, "No Seleccionado", "Seleccionado");
			// objDocumentoPrincipal.getExpediente().getDocumentoxexpedienteList(
			// ).add(objDocXExp);
		}
		// this.saveDocumento(objDocumentoPrincipal);
	}

	public Documento clonarDocumento(Documento objDocumento, Usuario objPropietario, Expediente objExpediente) {
		log.debug("-> [Service] DocumentoService - clonarDocumento():Documento ");
		
		Documento objNewDocumento = new Documento();
		objNewDocumento.setIdDocumento(null);
		objNewDocumento.setPrincipal(objDocumento.getPrincipal());
		objNewDocumento.setDelExpediente(objDocumento.getDelExpediente());
		objNewDocumento.setNumeroDocumento(objDocumento.getNumeroDocumento());
		objNewDocumento.setNumeroFolios(objDocumento.getNumeroFolios());
		objNewDocumento.setNumeroCaja(objDocumento.getNumeroCaja());
		objNewDocumento.setNumeroMesaPartes(objDocumento.getNumeroMesaPartes());
		//objNewDocumento.setReferencia(objDocumento.getReferencia());
		objNewDocumento.setAsunto(objDocumento.getAsunto());
		objNewDocumento.setUltimoAsunto(objDocumento.getAsunto());
		objNewDocumento.setContenido(objDocumento.getContenido());
		objNewDocumento.setObservacion(objDocumento.getObservacion());
		objNewDocumento.setFechaDocumento(objDocumento.getFechaDocumento());
		objNewDocumento.setFechaAccion(objDocumento.getFechaAccion());
		objNewDocumento.setPlazo(objDocumento.getPlazo());
		objNewDocumento.setFechaLimiteAtencion(objDocumento.getFechaLimiteAtencion());
		objNewDocumento.setFechaCreacion(new Date());
		objNewDocumento.setEstado(objDocumento.getEstado());
		objNewDocumento.setAccion(objDocumento.getAccion());
		objNewDocumento.setExpediente(objExpediente);
		objNewDocumento.setTipoDocumento(objDocumento.getTipoDocumento());
		objNewDocumento.setPropietario(objPropietario);
		//objNewDocumento.setArchivos(objDocumento.getArchivos());
		return objNewDocumento;
	}

	public Documento findByIdDocumento(Integer iIdDocumento) {
		log.debug("-> [Service] DocumentoService - findByIdDocumento():Documento ");
		
		return documentoDao.findByIdDocumento(iIdDocumento);
	}

	public Documento findPropietarioByIdDocumento(Integer iIdDocumento) {
		log.debug("-> [Service] DocumentoService - findPropietarioByIdDocumento():Documento ");
		
		return documentoDao.findPropietarioByIdDocumento(iIdDocumento);
	}

	/**REN devuelve solo el expediente y el usuario propietario ----------------------------------------------------------*/
	public Documento findDocExpedienteByIdDocumento(Integer iIdDocumento) {
		log.debug("-> [Service] DocumentoService - findDocExpedienteByIdDocumento():Documento ");
		
		return documentoDao.findDocExpedienteByIdDocumento(iIdDocumento);
	}

	public Documento findDocumentoPrincipal(Integer iIdExpediente) {
		log.debug("-> [Service] DocumentoService - findDocumentoPrincipal():Documento ");
		
		return documentoDao.findDocumentoPrincipal(iIdExpediente);
	}

	public DocumentoDetail getExpedienteData(Integer iIdExp) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - getExpedienteData():DocumentoDetail ");
		
		try {
			Expediente objE = expedienteService.findByIdExpediente(iIdExp);
			DocumentoDetail objDD = new DocumentoDetail(objE.getIdexpediente(), objE.getProceso().getIdproceso(), objE.getProceso().getResponsable().getIdusuario(), objE.getProceso().getNombre(), objE.getNroexpediente(), objE.getProceso().getResponsable().getNombres() + " " + objE.getProceso().getResponsable().getApellidos(), objE.getProceso().getResponsable().getUnidad().getNombre());
			if (objE.getConcesionario() != null) {
				objDD.setIIdCorrentista(objE.getConcesionario().getIdConcesionario());
				objDD.setStrRUC(objE.getConcesionario().getRuc());
				objDD.setStrCorrentista(objE.getConcesionario().getRazonSocial());
				objDD.setStrDireccionConcesionario(objE.getConcesionario().getDireccion());
			}
			if (objE.getCliente() != null) {
				objDD.setIIdCliente(objE.getCliente().getIdCliente());
				objDD.setIIdTipoIdentificacion(objE.getCliente().getTipoIdentificacion().getIdtipoidentificacion());
				objDD.setStrDireccionAlternativa(objE.getCliente().getDireccionAlternativa());
				objDD.setStrDireccionPrincipal(objE.getCliente().getDireccionPrincipal());
				objDD.setStrNroIdentificacion(objE.getCliente().getNumeroIdentificacion());
				objDD.setStrRazonSocial(objE.getCliente().getRazonSocial());
				objDD.setStrTipoIdentificacion(objE.getCliente().getTipoIdentificacion().getNombre());
				objDD.setStrRepresentanteLegal(objE.getCliente().getRepresentanteLegal());
				objDD.setIIdDepartamento(objE.getCliente().getUbigeoPrincipal().getProvincia().getDepartamento().getIddepartamento());
				objDD.setStrDepartamento(objE.getCliente().getUbigeoPrincipal().getProvincia().getDepartamento().getNombre());
				objDD.setIIdProvincia(objE.getCliente().getUbigeoPrincipal().getProvincia().getIdprovincia());
				objDD.setStrProvincia(objE.getCliente().getUbigeoPrincipal().getProvincia().getNombre());
				objDD.setIIdDistrito(objE.getCliente().getUbigeoPrincipal().getIddistrito());
				objDD.setStrDistrito(objE.getCliente().getUbigeoPrincipal().getNombre());
				objDD.setStrTelefonoCliente(objE.getCliente().getTelefono());
				objDD.setStrCorreoCliente(objE.getCliente().getCorreo());
			}
			objDD.setStrAbreviado(objE.getProceso().getTipoproceso().getNombre());
			/*
			 * if
			 * (objE.getIdproceso().getAbreviado().equals(Proceso.ABREV_STOR)) {
			 * if (objE.getExpedientestor() != null) { List<Submotivo> lstSM =
			 * objE.getExpedientestor().getSubmotivoList();
			 *
			 * for (Submotivo objSM : lstSM) {
			 * objDD.setIIdMotivo(objSM.getIdmotivo().getIdmotivo());
			 * objDD.setStrMotivo(objSM.getIdmotivo().getDescripcion());
			 * objDD.setIIdSubMotivo(objSM.getIdsubmotivo());
			 * objDD.setStrSubMotivo(objSM.getDescripcion()); } }
			 *
			 * }
			 */
			return objDD;
		} catch (RuntimeException re) {
			log.error("", re);
			return null;
		}
	}

	public Date getFechaLimiteAtencion(Integer idDocumento) {
		log.debug("-> [Service] DocumentoService - getFechaLimiteAtencion():Date ");
		
		Documento doc = documentoDao.findByIdDocumento(idDocumento);
		return doc == null ? null : doc.getFechaLimiteAtencion();
	}

	@Transactional
	@Override
	public DocumentoDetail getDocumentDetailOptimized(Integer iIdDoc, String strRol) {
		log.debug("-> [Service] DocumentoService - getDocumentDetailOptimized():DocumentoDetail ");
		
		Distrito objDistrito = null;
		DocumentoDetail objDocumentoDetail = new DocumentoDetail();

		objDocumentoDetail = documentoDao.findDocumentoDetailBy(iIdDoc);

		if (objDocumentoDetail.getiIdExpedienteClienteUbigeoPrincipal() != null) {
			objDistrito = distritoService.findById(objDocumentoDetail.getiIdExpedienteClienteUbigeoPrincipal());

			objDocumentoDetail.setIIdDistrito(objDistrito.getIddistrito());
			objDocumentoDetail.setStrDistrito(objDistrito.getNombre());
			objDocumentoDetail.setIIdProvincia(objDistrito.getProvincia().getIdprovincia());
			objDocumentoDetail.setStrProvincia(objDistrito.getProvincia().getNombre());
			objDocumentoDetail.setIIdDepartamento(objDistrito.getProvincia().getDepartamento().getIddepartamento());
			objDocumentoDetail.setStrDepartamento(objDistrito.getProvincia().getDepartamento().getNombre());
		}

		if (objDocumentoDetail.getiIdExpedienteClienteUbigeoAlternativo() != null) {
			objDistrito = distritoService.findById(objDocumentoDetail.getiIdExpedienteClienteUbigeoAlternativo());

			objDocumentoDetail.setiIdDistritoAlt(objDistrito.getIddistrito());
			objDocumentoDetail.setsDistritoAlt(objDistrito.getNombre());
			objDocumentoDetail.setiIdProvinciaAlt(objDistrito.getProvincia().getIdprovincia());
			objDocumentoDetail.setsProvinciaAlt(objDistrito.getProvincia().getNombre());
			objDocumentoDetail.setiIdDepartamentoAlt(objDistrito.getProvincia().getDepartamento().getIddepartamento());
			objDocumentoDetail.setsDepartamentoAlt(objDistrito.getProvincia().getDepartamento().getNombre());
		}

		if (strRol != null && strRol.toLowerCase().equals(Constantes.ROL_MESA_PARTES)) {
			objDocumentoDetail.setStrRemitente(objDocumentoDetail.getClienterazonsocial());
		}

		if (archivoService.checkEstadoDigitalizacion(iIdDoc) > 0) {
			objDocumentoDetail.setCDisponible(Constantes.DOCUMENTO_DISPONIBLE);
		} else {
			objDocumentoDetail.setCDisponible(Constantes.DOCUMENTO_NO_DISPONIBLE);
		}

		objDocumentoDetail.setStrRol(strRol);

		return objDocumentoDetail;
	}

	@Override
	public DocumentoDetail getDocumentDetail(Integer iIdDoc, String strRol) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - getDocumentDetail():DocumentoDetail ");
		
		String vacio="";
		Documento objD = documentoDao.findByIdDocumento(iIdDoc);
		Distrito objDistrito = null;
		String sNombre = null;
		String sApellidoPaterno = null;
		String sApellidoMaterno = null;
		log.debug("=================>[Fecha Limite Atencion : " + objD.getFechaLimiteAtencion() + "]");
		Trazabilidaddocumento objT = null;
		if(objD.getDocumentoreferencia() != null){
			/**Es un documento copia para trabajo ----------------------------------------------------------------------------*/
			objT = trazabilidadDocumentoService.findByMaxNroRegistro(objD.getDocumentoreferencia(), Constantes.ACCION_CONSULTAR, null, null);
		}else{
			objT = trazabilidadDocumentoService.findByMaxNroRegistro(objD.getIdDocumento(), Constantes.ACCION_CONSULTAR, null, null);
		}

		log.debug("getAsunto :" + objT.getAsunto());
		DocumentoDetail objDD = new DocumentoDetail(objD.getFechaAccion(), objD.getIdDocumento(), objD.getExpediente().getIdexpediente(), objD.getTipoDocumento().getIdtipodocumento(), objD.getNumeroFolios(), objT.getAsunto(), objD.getNumeroCaja(), objD.getNumeroDocumento(), objD.getObservacion(), objD.getExpediente().getProceso().getNombre(), objD.getExpediente().getNroexpediente(), objD.getExpediente().getProceso().getResponsable().getNombres() + " " + objD.getExpediente().getProceso().getResponsable().getApellidos(), strRol, objD.getTipoDocumento().getNombre(), objD.getExpediente().getProceso().getResponsable().getUnidad().getNombre(), objT.getContenido());
		objDD.setObservacionDocumento(objD.getObservacion());
		objDD.setObservacionDigitalizador(objD.getObservacionDigitalizador());
		if (objDD.getStrProceso().startsWith("OSINERGMIN")) {
			objDD.setIIdResponsable(objD.getExpediente().getIdpropietario().getIdusuario());
			objDD.setStrResponsable(objD.getExpediente().getIdpropietario().getNombres() + " " + objD.getExpediente().getIdpropietario().getApellidos());
		} else {
			objDD.setIIdResponsable(objD.getExpediente().getProceso().getResponsable().getIdusuario());
		}

		log.debug("==================================== objT.getAsunto() : " + objT.getAsunto());
		objDD.setFechacreacion(objD.getFechaCreacion());
		//wcarrasco 04-07-2011	
		
		int tiempoProceso = procesoService.findByIdProceso(objD.getExpediente().getProceso().getIdproceso()).getTiempoatencion().intValue();
		log.debug("asignar Fercha limite : tiempo de proceso");
		Date dNuevaFechaLimiteAtencion = fechaLimite.calcularFechaLimite(tiempoProceso, 0, objD.getPropietario().getIdusuario());
		log.debug("dNuevaFechaLimiteAtencion"+ dNuevaFechaLimiteAtencion);
		objDD.setDateFechaLimiteAtencion(dNuevaFechaLimiteAtencion);

		objDD.setPropietario(objD.getPropietario());
		objDD.setAccion(objD.getAccion());
		objDD.setStrAccion(objD.getAccion().getNombre());
		objDD.setStrNroMesaPartes("" + (objD.getNumeroMesaPartes() != null ? objD.getNumeroMesaPartes() : objD.getIdDocumento()));
		if (objD.getExpediente().getCliente() != null) {
			objDD.setIIdCliente(objD.getExpediente().getCliente().getIdCliente());
			objDD.setIIdTipoIdentificacion(objD.getExpediente().getCliente().getTipoIdentificacion().getIdtipoidentificacion());
			objDD.setStrTipoIdentificacion(objD.getExpediente().getCliente().getTipoIdentificacion().getNombre());
			objDD.setStrNroIdentificacion(objD.getExpediente().getCliente().getNumeroIdentificacion());
			log.debug("Cliente con Nro de Identificacion [" + objDD.getStrNroIdentificacion() + "]");
			if (objDD.getStrTipoIdentificacion().equals(Constantes.TIPO_IDENTIFICACION_RUC)) {
				objDD.setStrRazonSocial(objD.getExpediente().getCliente() != null ? objD.getExpediente().getCliente().getNombreRazon() : "");
			} else if (objDD.getStrTipoIdentificacion().equals(Constantes.TIPO_IDENTIFICACION_DNI) || objDD.getStrTipoIdentificacion().equals(Constantes.TIPO_IDENTIFICACION_OTRO)) {
				sNombre = objD.getExpediente().getClientenombres() != null ? objD.getExpediente().getClientenombres() : objD.getExpediente().getCliente().getNombres()!=null ? objD.getExpediente().getCliente().getNombres() : vacio;
				sApellidoPaterno = objD.getExpediente().getClienteapellidopaterno() != null ? objD.getExpediente().getClienteapellidopaterno() : objD.getExpediente().getCliente().getApellidoPaterno()!=null ? objD.getExpediente().getCliente().getApellidoPaterno(): vacio;
				sApellidoMaterno = objD.getExpediente().getClienteapellidomaterno() != null ? objD.getExpediente().getClienteapellidomaterno() : objD.getExpediente().getCliente().getApellidoMaterno()!=null ? objD.getExpediente().getCliente().getApellidoMaterno(): vacio ;
				objDD.setStrRazonSocial(objD.getExpediente().getCliente() != null ? objD.getExpediente().getCliente().getNombreRazon() : "");
				//objDD.setStrRazonSocial(objDD.getStrRazonSocial().trim());
				objDD.setClientenombres(sNombre);
				objDD.setClienteapellidopaterno(sApellidoPaterno);
				objDD.setClienteapellidomaterno(sApellidoMaterno);
			}
			objDD.setStrRepresentanteLegal(objD.getExpediente().getClienterepresentantelegal() != null ? objD.getExpediente().getClienterepresentantelegal() : objD.getExpediente().getCliente().getRepresentanteLegal());
			objDD.setStrDireccionPrincipal(objD.getExpediente().getClientedireccionprincipal() != null ? objD.getExpediente().getClientedireccionprincipal() : objD.getExpediente().getCliente().getDireccionPrincipal());
			if (objD.getExpediente().getClienteubigeoprincipal() != null) {
				objDistrito = distritoService.findById(objD.getExpediente().getClienteubigeoprincipal());
				objDD.setStrDepartamento(objDistrito.getProvincia().getDepartamento().getNombre());
				objDD.setStrProvincia(objDistrito.getProvincia().getNombre());
				objDD.setStrDistrito(objDistrito.getNombre());
				objDD.setIIdDepartamento(objDistrito.getProvincia().getDepartamento().getIddepartamento());
				objDD.setIIdProvincia(objDistrito.getProvincia().getIdprovincia());
				objDD.setIIdDistrito(objDistrito.getIddistrito());
			} else if (objD.getExpediente().getCliente().getUbigeoPrincipal() != null) {
				objDD.setStrDepartamento(objD.getExpediente().getCliente().getUbigeoPrincipal().getProvincia().getDepartamento().getNombre());
				objDD.setStrProvincia(objD.getExpediente().getCliente().getUbigeoPrincipal().getProvincia().getNombre());
				objDD.setStrDistrito(objD.getExpediente().getCliente().getUbigeoPrincipal().getNombre());
				if (objD.getExpediente().getCliente().getUbigeoPrincipal().getProvincia() != null) {
					objDD.setIIdProvincia(objD.getExpediente().getCliente().getUbigeoPrincipal().getProvincia().getIdprovincia());
					if (objD.getExpediente().getCliente().getUbigeoPrincipal().getProvincia().getDepartamento() != null) {
						objDD.setIIdDepartamento(objD.getExpediente().getCliente().getUbigeoPrincipal().getProvincia().getDepartamento().getIddepartamento());
					}

				}
				objDD.setIIdDistrito(objD.getExpediente().getCliente().getUbigeoPrincipal().getIddistrito());
			}
			objDD.setStrDireccionAlternativa(objD.getExpediente().getClientedireccionalternativa() != null ? objD.getExpediente().getClientedireccionalternativa() : objD.getExpediente().getCliente().getDireccionAlternativa());
			if (objD.getExpediente().getClienteubigeoalternativo() != null) {
				objDistrito = distritoService.findById(objD.getExpediente().getClienteubigeoalternativo());
				objDD.setsDepartamentoAlt(objDistrito.getProvincia().getDepartamento().getNombre());
				objDD.setsProvinciaAlt(objDistrito.getProvincia().getNombre());
				objDD.setsDistritoAlt(objDistrito.getNombre());
				objDD.setiIdDepartamentoAlt(objDistrito.getProvincia().getDepartamento().getIddepartamento());
				objDD.setiIdProvinciaAlt(objDistrito.getProvincia().getIdprovincia());
				objDD.setiIdDistritoAlt(objDistrito.getIddistrito());
			} else if (objD.getExpediente().getCliente().getUbigeoAlternativo() != null) {
				objDD.setsDepartamentoAlt(objD.getExpediente().getCliente().getUbigeoAlternativo().getProvincia().getDepartamento().getNombre());
				objDD.setsProvinciaAlt(objD.getExpediente().getCliente().getUbigeoAlternativo().getProvincia().getNombre());
				objDD.setsDistritoAlt(objD.getExpediente().getCliente().getUbigeoAlternativo().getNombre());
				objDD.setiIdDepartamentoAlt(objD.getExpediente().getCliente().getUbigeoAlternativo().getProvincia().getDepartamento().getIddepartamento());
				objDD.setiIdProvinciaAlt(objD.getExpediente().getCliente().getUbigeoAlternativo().getProvincia().getIdprovincia());
				objDD.setiIdDistritoAlt(objD.getExpediente().getCliente().getUbigeoAlternativo().getIddistrito());
			}
			objDD.setStrTelefonoCliente(objD.getExpediente().getClientetelefono() != null ? objD.getExpediente().getClientetelefono() : objD.getExpediente().getCliente().getTelefono());
			objDD.setStrCorreoCliente(objD.getExpediente().getClientecorreo() != null ? objD.getExpediente().getClientecorreo() : objD.getExpediente().getCliente().getCorreo());
		}
		if (objD.getExpediente().getConcesionario() != null) {
			objDD.setStrCorrentista(objD.getExpediente().getConcesionario().getRazonSocial());
			objDD.setIIdCorrentista(objD.getExpediente().getConcesionario().getIdConcesionario());
			objDD.setStrCorrentista(objD.getExpediente().getConcesionario().getRazonSocial());
			objDD.setStrRUC(objD.getExpediente().getConcesionario().getRuc());
			objDD.setStrDireccionConcesionario(objD.getExpediente().getConcesionario().getDireccion());
			objDD.setStrCorreoConcesionario(objD.getExpediente().getConcesionario().getCorreo());
		}
		objDD.setStrDestinatario(objD.getPropietario().getNombres() + " " + objD.getPropietario().getApellidos());
		objDD.setIIdProceso(objD.getExpediente().getProceso().getIdproceso());
		objDD.setStrAbreviado(objD.getExpediente().getProceso().getTipoproceso().getNombre());
		objDD.setCEstado(objD.getEstado());
		objDD.setCPrincipal(objD.getPrincipal());
		objDD.setSObservacionRechazo(objD.getObservacionRechazo());
		if (objD.getFechaDocumento() != null) {
			objDD.setStrFechaDocumento(new SimpleDateFormat("dd/MM/yyyy").format(objD.getFechaDocumento()));
		} else {
			objDD.setStrFechaDocumento(new SimpleDateFormat("dd/MM/yyyy").format(new Date()));
		}
		if (strRol != null && strRol.toLowerCase().equals(Constantes.ROL_MESA_PARTES)) {
			objDD.setStrRemitente(objD.getExpediente().getCliente().getRazonSocial());
		} else {
			objDD.setStrRemitente(((objT != null && objT.getRemitente() != null) ? objT.getRemitente().getNombres() : "") + " " + (((objT != null && objT.getRemitente() != null) ? objT.getRemitente().getApellidos() : "")));
		}
		if (objT != null && objT.getDestinatario() != null) {
			objDD.setStrDestinatario(objT.getDestinatario().getNombres() + objT.getDestinatario().getApellidos());
		}
		// Seteando la disponibilidad de Aprobar/Rechazar el documento
		//if (archivoService.checkEstadoDigitalizacion(iIdDoc) > 0) {
		objDD.setCDisponible(Constantes.DOCUMENTO_DISPONIBLE);
		/*} else {
            objDD.setCDisponible(Constantes.DOCUMENTO_NO_DISPONIBLE);
        }*/
		// if (strUsuario.equals(Usuario.STOR_SECRETARIO_TECNICO) ||
		// strUsuario.equals(Usuario.STOR_REVISOR_LEGAL)) {
		if (objD.getExpediente().getExpedientestor() != null && objD.getExpediente().getExpedientestor().getSala() != null) {
			objDD.setIIdSala(objD.getExpediente().getExpedientestor().getSala().getIdsala());
			objDD.setStrSala(objD.getExpediente().getExpedientestor().getSala().getNombre());
			//Para validar cuando el ExpedienteStor no tenga guardada la etapa.
			objDD.setIIdEtapa(objD.getExpediente().getExpedientestor().getEtapa() == null ? 0 : objD.getExpediente().getExpedientestor().getEtapa().getIdetapa());
		}
		objDD.setsPropietarioExpediente(objD.getExpediente().getIdpropietario().getNombres() + " " + objD.getExpediente().getIdpropietario().getApellidos());
		objDD.setEstaenflujo(objD.getExpediente().getEstaenflujo());
		objDD.setHistorico(objD.getExpediente().getHistorico() == null ? 'N' : objD.getExpediente().getHistorico());

		return objDD;
	}

	@SuppressWarnings("unused")
	@Override
	@Transactional
	public DocumentoDetail saveDocumentTEMPORAL(DocumentoDetail objDD, String strAcc, Integer iIdDestinatario, Usuario usuario, String strRol, String nombrePC) {
		log.debug("-> [Service] DocumentoService - saveDocumentTEMPORAL():DocumentoDetail ");
		
		Expediente expediente = null;
		Date fecha = null;
		Documento objD = new Documento();

		expediente = expedienteService.prepareExpediente(objDD, usuario);
		objDD.setIIdExpediente(expediente.getIdexpediente());
		objDD.setStrFecha(expediente.getFechacreacion());
		objD.setAutor(objDD.getObjAutor());
		objD.setConfidencial(objDD.getConfidencial());
		//seteando el verdadero destinatario seleccionado
		if (objDD.getIIdDestinatario() != null) {
			log.debug("ID PROPIETARIO = " + objDD.getIIdDestinatario());
			expediente.setIdpropietario(usuarioService.findByIdUsuario(objDD.getIIdDestinatario()));
		}
		// Tomando acciones sobre el Expediente
		Integer iIdUsuario = usuario.getIdusuario();
		Sede objSede = sedeDao.getSedePorUuario(usuario);
		objD.setIdUsuarioLogeado(iIdUsuario);
		if (usuario.getRol() == null) {
			Tipodocumento objTD = null;
			Date datFechaLimite = new Date();
			objD.setFechaCreacion(datFechaLimite);
			//Se toma el USUARIO PROPIETARIO DEL DOCUMENTO para el calculo de la fecha limite
			if (iIdDestinatario == null || iIdDestinatario == 0 && expediente != null) {
				iIdDestinatario = expediente.getIdpropietario().getIdusuario();
			}
			datFechaLimite = fechaLimite.calcularFechaLimite(expediente.getProceso().getTiempoatencion(), 0, iIdDestinatario);
			objD.setFechaLimiteAtencion(datFechaLimite);
			objTD = tipoDocumentoDao.findByIdTipoDocumento(objDD.getIIdTipoDocumento());
			log.debug("Tipo de Documento seleccionado con ID [" + objTD.getIdtipodocumento() + "] Nombre [" + objTD.getNombre() + "]");
			objD.setTipoDocumento(objTD);
			log.debug("seteando el propietario del proceso:" + expediente.getIdpropietario());
			objD.setPropietario(expediente.getIdpropietario());
			objD.setExpediente(expediente);
			objD.setAccion(accionService.findByNombre(strAcc));
			objD.setEstado(objDD.getCEstado());
			objD.setAsunto(objDD.getStrAsunto());
			objD.setUltimoAsunto(objDD.getStrAsunto());
			objD.setEstaEnFlujo(Constantes.ESTAENFLUJO_S);
			objD.setReferenciados(objDD.getStrReferencia());
			
			Object obj = ServletActionContext.getRequest().getSession().getAttribute("UsuarioCompartido");
			if (obj != null) {
				Usuario propietario = (Usuario) obj;
				objD.setRemitente(propietario.getNombres() + " " + propietario.getApellidos());
			} else {
				objD.setRemitente(usuario.getNombres() + " " + usuario.getApellidos());
			}

			objD.setContenido(objDD.getStrContenido());
			objD.setPrincipal(objDD.getCPrincipal());
			log.debug("Documento Principal [" + objDD.getCPrincipal() + "]");
			log.debug("nrodocumento:" + objDD.getStrNroDocumento());
			objD.setNumeroDocumento(objDD.getStrNroDocumento());
			if(!StringUtils.isBlank(objD.getNumeroDocumento())){
				objD.setEnumerado(Constantes.Si);
			}
			objD.setEnumerarDocumento("S".equals(objDD.getEnumerarDocumento()) ? true : false);

			if (objD.getEnumerarDocumento()) {
				objD.setTiponumeracion(objDD.getTipoNumeracion());
			}

			if (log.isDebugEnabled()) {
				log.debug("Enumerar Documento? [" + objD.getEnumerarDocumento() + "] numeroDocumento [" + objD.getNumeroDocumento() + "]");
			}

			objD.setNumeroFolios(objDD.getINroFolios() == null ? 0 : objDD.getINroFolios());
			objD.setNumeroCaja(objDD.getStrNroCaja());
			objD.setObservacion(objDD.getStrObservacion());
			objD.setFechaAccion(new Date());
			objD.setNumeroMesaPartes(objDD.getStrNroMesaPartes());
			
			try {
				// Esto porque asi manda la fecha dojo
				objD.setFechaDocumento(new SimpleDateFormat("yyyy-MM-dd").parse(objDD.getStrFechaDocumento()));
			} catch (ParseException e) {
				log.warn("No se pudo parsear la fecha " + fecha + " al momento de registrar el documento");
			}
			
			//objD.setAutor(objDD.getAutor());

			if (objDD.getIdFirmante() != null) {
				objD.setFirmante(usuarioService.findByIdUsuario(objDD.getIdFirmante()));
				objD.setFirmado(Constantes.No);
			}

			fecha = datFechaLimite;
			objD.setLeido(Constantes.ESTADO_NO_LEIDO);
			objD.setFechaCreacion(new Date());
			objD.setCondestinatarios(objDD.getCondestinatarios());
			objD.setConcopias(objDD.getConcopias());
			if(objD.getEnumerado()==null){
				objD.setEnumerado(Constantes.No);
			}            
			
			if(objD.getPrioridad() == null){
				objD.setPrioridad(1);
			}
			
			this.saveDocumento(objD);
			Trazabilidaddocumento trazdoc = trazabilidadDocumentoService.saveTrazabilidadDocumento(objD, usuarioService.findByIdUsuario(iIdUsuario), true, true);
			//trazabilidad copias desde usuario MP
			List<String> condestinatarios = objD.getCondestinatarios();
			List<String> concopias = objD.getConcopias();
			if (condestinatarios != null && condestinatarios.size() > 0) {
				//aca logica para enviar notificaciones a los destinatarios
				for (String d : condestinatarios) {
					log.debug(" destinatario : " + d);
					if (d.isEmpty()) {
						continue;
					}
					//Si el destinatario es EXTERNO
					if (!d.contains("_")) {
						//Cliente cliente = (Cliente) em.createNamedQuery("Cliente.findByNroidentificacion").setParameter("nroidentificacion", d).getSingleResult();
						Cliente cliente =clienteService.findByNroIdentificacion(d);

					} //Si el destinatario es INTERNO
					else {
						Integer dest = new Integer(d.split("_")[1]);
						//  Usuario destinatario1 = (Usuario) em.createNamedQuery("Usuario.findByIdusuario").setParameter("idusuario", dest).getSingleResult();
						Usuario destinatario1 = (Usuario)usuarioService.findByIdUsuario(dest);

						Accion accionCopia = accionService.findByNombre(Constantes.ACCION_COPIAR);
						//  NotificacionxEnumerar notificacionxEnumerar = new NotificacionxEnumerar(objD.getIdDocumento(), dest, Constantes.TIPO_NOTIFICACION_NUMERACION_DESTINATARIO);
						// em.persist(notificacionxEnumerar);
						//wcarrasco 21-10-2010 falta revisar  al saveDocumentTEMPORAL() La Fecha dia siguiente
						trazabilidadcopiaService.guardarTrazabilidadcopia(trazdoc, usuario, destinatario1,objD ,accionCopia , null, Constantes.TIPO_ORIGEN_TRAZADOCUMENTO, null, nombrePC,true);


					}
				}
			}
			if (concopias != null && concopias.size() > 0) {
				//aca logica para enviar notificaciones a los  copias
				for (String d : concopias) {
					if (d.isEmpty()) {
						continue;
					}
					//Si el destinatario concopia es EXTERNO
					if (!d.contains("_")) {
						Cliente cliente =clienteService.findByNroIdentificacion(d);
						// Documentoxcliente objDocxCli = new Documentoxcliente(new DocumentoxclientePK(objD.getIdDocumento(), cliente.getIdCliente()), Constantes.TIPO_EXTERNO_CONCONPIA);
						//em.persist(objDocxCli);
					} //Si el destinatario concopia es INTERNO
					else {
						Integer dest = new Integer(d.split("_")[1]);
						//  Usuario destinatario2 = (Usuario) em.createNamedQuery("Usuario.findByIdusuario").setParameter("idusuario", dest).getSingleResult();
						Usuario destinatario2 = (Usuario)usuarioService.findByIdUsuario(dest);

						Accion accionCopia = accionService.findByNombre(Constantes.ACCION_COPIAR);


						//  NotificacionxEnumerar notificacionxEnumerar = new NotificacionxEnumerar(objD.getIdDocumento(), dest, Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
						//wcarrasco 21-10-2010 falta revisar  al saveDocumentTEMPORAL() La Fecha dia siguiente
						trazabilidadcopiaService.guardarTrazabilidadcopia(trazdoc, usuario, destinatario2,objD ,accionCopia , null, Constantes.TIPO_ORIGEN_TRAZADOCUMENTO, null, nombrePC,true);
						// em.persist(notificacionxEnumerar);

					}
				}

			}

			objDD.setIIdDocumento(objD.getIdDocumento());
			objDD.setStrReferencia(expediente.getNroexpediente());
			objDD.setStrProceso(expediente.getProceso().getNombre());
			objDD.setStrUnidad(expediente.getIdpropietario().getUnidad().getNombre());
			objDD.setStrResponsable(expediente.getIdpropietario().getNombres() + " " + expediente.getIdpropietario().getApellidos());
			objDD.setStrAbreviado(expediente.getProceso().getTipoproceso().getNombre());
			String nrazon = expediente.getCliente().getNombreRazon();
			objDD.setStrTipoIdentificacion(expediente.getCliente().getTipoIdentificacion().getNombre());
			objDD.setStrRazonSocial(nrazon);
			objDD.setStrNroIdentificacion(expediente.getCliente().getNumeroIdentificacion());
			objDD.setStrDireccionPrincipal(expediente.getCliente().getDireccionPrincipal());
			objDD.setStrDireccionAlternativa(expediente.getCliente().getDireccionAlternativa());
			objDD.setStrTelefonoCliente(expediente.getCliente().getTelefono());
			objDD.setStrCorreoCliente(expediente.getCliente().getCorreo());
			objDD.setStrRepresentanteLegal(expediente.getCliente().getRepresentanteLegal());
			if(trazdoc.getRemitente().getIdusuario() != trazdoc.getDestinatario().getIdusuario()){
				Documentoenviado documentoenviado = new Documentoenviado();
				//wvcarrasco descomentar documentoenviado.setTrazabilidaddocumento(trazdoc);
				documentoenviado.setUsuario(usuario);
				documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
				documentoEnviadoDao.saveDocumento(documentoenviado);
			}
		} else {
			Perfil objPerfil = usuario.getRol().getIdperfil();

			if (log.isDebugEnabled()) {
				log.debug("Sede [" + objSede.getNombre() + "]");
				log.debug("Perfil del usuario [" + objPerfil.getNombre() + "]");
				log.debug("Proceso [" + expediente.getProceso().getIdproceso() + " - " + expediente.getProceso().getNombre() + "]");
			}

			Tipodocumento objTD = null;
			Trazabilidaddocumento objT;
			Date datFechaLimite = new Date();
			Documento objDAux = null;

			if (strAcc == null) {
				log.error("No hay accion a tomar [" + strAcc + "]");
				throw new RuntimeException();
			}

			// Cuando son actualizaciones
			if (objDD.getIIdDocumento() != null) {
				objDAux = documentoDao.findByIdDocumento(objDD.getIIdDocumento());
				objD.setFechaCreacion(objDAux.getFechaCreacion());
				objD.setIdDocumento(objDD.getIIdDocumento());
			} else {
				if (fechaLimite != null) {
					Proceso proceso = expediente.getProceso();

					if (proceso != null && proceso.getTiempoatencion() != null) {
						int destinatario = 0;

						if (iIdDestinatario != null) {
							destinatario = iIdDestinatario.intValue();
						}

						datFechaLimite = fechaLimite.calcularFechaLimite(proceso.getTiempoatencion(), 0, destinatario);
					}
				}

				objD.setFechaCreacion(datFechaLimite);
			}

			if (objDD.getIIdTipoDocumento() != null) {
				log.debug("Tipo de Documento recibido con ID [" + objDD.getIIdTipoDocumento() + "]");
				objTD = tipoDocumentoDao.findByIdTipoDocumento(objDD.getIIdTipoDocumento());
				log.debug("Tipo de Documento seleccionado con ID [" + objTD.getIdtipodocumento() + "] Nombre [" + objTD.getNombre() + "]");
			}

			objD.setTipoDocumento(objTD);

			if (strAcc.equals(Constantes.ACCION_REGISTRAR)) {
				log.debug(" saveDocumentTEMPORAL rol :" + strRol);
				if (objPerfil.getNombre().equals(Constantes.PERFIL_MP)) {
					objD.setPropietario(usuarioService.findByUsuario(Constantes.USUARIO_DIGITALIZADOR, objSede.getIdsede()));
					objD.setNumeroMesaPartes(documentoDao.getSiguienteNumeroMesaPartes());
					objD.setEnumerador(objD.getPropietario());
					objD.setEnumerado(Constantes.Si);
					objD.setFirmado(Constantes.Si);
					Cliente cliente = expediente.getCliente();
					String identificacion = cliente.getTipoIdentificacion().getNombre();
					if (identificacion.equals(Constantes.TIPO_IDENTIFICACION_RUC)) {
						objD.setRemitente(cliente.getRazonSocial());
					} else if (identificacion.equals(Constantes.TIPO_IDENTIFICACION_DNI) || identificacion.equals(Constantes.TIPO_IDENTIFICACION_OTRO)) {
						StringBuilder nombreCompleto = new StringBuilder(cliente.getNombres());

						if (cliente.getApellidoPaterno() != null) {
							nombreCompleto.append(" ");
							nombreCompleto.append(cliente.getApellidoPaterno());
						}

						if (cliente.getApellidoMaterno() != null) {
							nombreCompleto.append(" ");
							nombreCompleto.append(cliente.getApellidoMaterno());
						}

						objD.setRemitente(nombreCompleto.toString());
					}

					if (log.isDebugEnabled()) {
						log.debug("Expediente es nuevo? [" + expediente.isNuevo() + "]");
					}

					objD.setCreaExpediente(expediente.isNuevo() ? 'S' : 'N');
				} else {
					objD.setPropietario(usuario);
				}
			} else if (strAcc.equals(Constantes.ACCION_APROBAR)) {
				objD.setPropietario(usuarioService.findByIdUsuario(iIdDestinatario));
			} else if (strAcc.equals(Constantes.ACCION_REENVIAR)) {
				if (objPerfil.getNombre().equals(Constantes.PERFIL_DIG)) {
					objD.setPropietario(usuarioService.findByUsuario(Constantes.USUARIO_QAS, objSede.getIdsede()));
				} else if (objPerfil.getNombre().equals(Constantes.PERFIL_QAS)) {
					if (expediente.getHistorico() == 'S') {
						Parametro objParametro = parametroDao.findByTipoUnico("idusuariohistorico");

						log.debug("idusuariohistorico [" + objParametro.getValor() + "]");

						objD.setPropietario(usuarioService.findByIdUsuario(Integer.valueOf(objParametro.getValor())));
					} else {
						objD.setPropietario(usuarioService.findByIdUsuario(objDD.getIIdResponsable()));
					}


				} else {
					objD.setPropietario(usuarioService.findByIdUsuario(iIdDestinatario));
				}
			} else if (strAcc.equals(Constantes.ACCION_RECHAZAR)) {
				objD.setPropietario(usuarioService.findByUsuario(Constantes.USUARIO_DIGITALIZADOR, objSede.getIdsede()));
			} else if (strAcc.equals("rechazaruser")) { // FIXME MEJORAR ESTO!
				// Rechazando al usuario anterior, is es el propietario entonces
				// se
				// inhabilita el documento, por ahora se setea a un superusuario
				if (iIdUsuario.equals(objDD.getIIdResponsable())) {
					// Es propietario
					objD.setPropietario(usuarioService.findByRolUnico("superuser"));
				} else {
					// Rechazando al usuario anterior
					objT = trazabilidadDocumentoService.findByMaxNroRegistro(objDD.getIIdDocumento(), Constantes.ACCION_CONSULTAR, null, null);
					objD.setPropietario(objT.getRemitente());
				}
			}
			// Cuando son actualizaciones
			if (objDD.getIIdDocumento() != null) {
				objDAux = documentoDao.findByIdDocumento(objDD.getIIdDocumento());
				objD.setFechaCreacion(objDAux.getFechaCreacion());
				objD.setIdDocumento(objDD.getIIdDocumento());
			} else {
				if (fechaLimite != null) {
					Proceso proceso = expediente.getProceso();
					if (proceso != null && proceso.getTiempoatencion() != null) {
						int destinatario = 0;
						if (iIdDestinatario != null) {
							destinatario = iIdDestinatario.intValue();
						}
						//Se toma el USUARIO PROPIETARIO DEL DOCUMENTO para el calculo de la fecha limite
						if (objD.getPropietario() != null) {
							destinatario = objD.getPropietario().getIdusuario();
						}
						datFechaLimite = fechaLimite.calcularFechaLimite(proceso.getTiempoatencion(), 0, destinatario);
					}
				}
				objD.setFechaCreacion(datFechaLimite);
			}
			objD.setExpediente(expediente);
			boolean copiarfechaLimite = false;
			if (strRol.startsWith(Constantes.ROL_QAS)) {
				copiarfechaLimite = true;
			}
			if (strAcc.equals(Constantes.ACCION_REENVIAR) && objPerfil.getNombre().equals(Constantes.PERFIL_QAS)) {
				copiarfechaLimite = true;
				objD.setAccion(accionService.findByNombre(Constantes.ACCION_APROBAR_QAS));
			} else {
				copiarfechaLimite = false;
				objD.setAccion(accionService.findByNombre(strAcc));
			}
			objD.setEstado(objDD.getCEstado());
			objD.setEstaEnFlujo(Constantes.ESTAENFLUJO_N);
			objD.setAsunto(objDD.getStrAsunto());
			objD.setUltimoAsunto(objDD.getStrAsunto());
			objD.setContenido(objDD.getStrContenido());
			objD.setPrincipal(objDD.getCPrincipal());
			log.debug("Documento Principal [" + objDD.getCPrincipal() + "]");
			log.debug("nrodocumento:" + objDD.getStrNroDocumento());
			objD.setNumeroDocumento(objDD.getStrNroDocumento());
			objD.setNumeroFolios(objDD.getINroFolios() == null ? 0 : objDD.getINroFolios());
			objD.setNumeroCaja(objDD.getStrNroCaja());
			objD.setObservacion(objDD.getStrObservacion());
			objD.setFechaAccion(new Date());
			objD.setNumeroMesaPartes(objDD.getStrNroMesaPartes());
			// FIXME QAS no deberia chancar la informacion que no se modifica en
			// el formulario
			if (objDD.getStrFechaDocumento() != null && objDD.getStrFechaDocumento().length() != 0) {
				SimpleDateFormat formatoDelTexto = null;
				if (strRol.startsWith(Constantes.ROL_MESA_PARTES) || strRol.startsWith(Constantes.ROL_QAS) || strRol.startsWith(Constantes.ROL_USUARIO_FINAL)) {
					formatoDelTexto = new SimpleDateFormat("yyyy-MM-dd HH:mm");
				} else {
					formatoDelTexto = new SimpleDateFormat("dd/MM/yyyy HH:mm");
				}
				try {
					String fechaTemp = objDD.getStrFechaDocumento();
					if (fechaTemp.length() == 10) {
						fechaTemp = fechaTemp + " 00:00";
					}
					fecha = formatoDelTexto.parse(fechaTemp);
				} catch (Exception ex) {
					log.error(ex.getMessage(), ex);
				}
			}
			objD.setFechaDocumento(fecha);
			fecha = null;
			if (objDD.getStrFechaLimiteAtencion() != null) {
				SimpleDateFormat formatoDelTexto = new SimpleDateFormat("yyyy-MM-dd HH:mm");
				try {
					fecha = formatoDelTexto.parse(objDD.getStrFechaLimiteAtencion() + " " + new SimpleDateFormat("HH:mm").format(new Date()));
				} catch (Exception ex) {
					log.error(ex.getMessage(), ex);
				}
			} else {
				if (objDD.getIIdDocumento() == null) {
					fecha = datFechaLimite;
				} else {
					fecha = objDAux.getFechaLimiteAtencion();
				}
			}
			objD.setPlazo(objDD.getStrPlazo());
			objD.setFechaLimiteAtencion(fecha);
			if (strAcc.equals(Constantes.ACCION_REGISTRAR)) {
				objD.setFechaCreacion(new Date());
			}
			if (strRol.startsWith(Constantes.ROL_QAS) && strAcc.equals(Constantes.ACCION_DERIVAR)) {
				// Se crea nuevamente el expediente SOLO SI no existe en
				// Alfresco
				repositorioService.subirArchivosTransformadosARepositorio(objDD.getIIdDocumento(), true);
				log.debug("despues de subir los archivo al repositorio ");
			}
			objD.setCondestinatarios(objDD.getCondestinatarios());
			objD.setConcopias(objDD.getConcopias());
			if(objD.getEnumerado()==null){
				objD.setEnumerado(Constantes.No);
			}
			this.saveDocumento(objD);
			log.debug("Documento creado con ID [" + objD.getIdDocumento() + "] ultimoAsunto [" + objD.getUltimoAsunto() + "]");
			log.debug("Proceso asociado [" + objD.getExpediente().getProceso().getNombre() + "]");
			/*****************************************************************************************************************/
			// Registrando la auditoria del Expediente y Documentos
			/*****************************************************************************************************************/
			if (strRol.startsWith(Constantes.ROL_MESA_PARTES)) {
				registrarAuditoriaMP(expediente, objD, usuario);
			} else if (strRol.startsWith(Constantes.ROL_QAS)) {
				registrarAuditoriaQAS(expediente, objD, usuario, strAcc);
				// registrar notificacion para el duenho del expediente cuando se
				// registra en Mesa de Partes
				if (objDD.getIIdExpediente() != null) {
					if (objD.getPrincipal() == 'S') {
						notificacionService.informarViaNotifAndMail(usuario, objD, Constantes.CONFIGNOTIFMAIL_CREACION_EXPEDIENTE, Constantes.TIPO_NOTIFICACION_DUENO_EXPEDIENTE, nombrePC);
					} else {
						notificacionService.informarViaNotifAndMail(usuario, objD, Constantes.CONFIGNOTIFMAIL_INGRESO_DOCUMENTO_QAS, Constantes.TIPO_NOTIFICACION_NUEVO_DOCUMENTO, nombrePC);
					}
				}
			}
			/*****************************************************************************************************************/
			// /////////////////////////////////////////////////////////
			// Ingresando datos adicionales del proceso STOR - INICIO//
			// /////////////////////////////////////////////////////////
			if (expediente.getProceso().getTipoproceso().getNombre().equals(Constantes.TIPO_PROCESO_STOR) && objDD.getIIdExpediente() == null) {
				log.debug("Registrar datos de STOR");
				this.saveDocumentoStor(objD, objDD);
				// Registrar Trazabilidad expediente para PROCESOS STOR
				Usuario destinatario = usuarioService.findByUsuario(Constantes.USUARIO_DIGITALIZADOR, objSede.getIdsede());
				Accion accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR);
				if (strRol.equals(Constantes.ROL_MESA_PARTES)) {

					log.debug("INGRESO DE DOCUMENTO PRINCIPAL: REGISTRAR TRAZABILIDAD EXPEDIENTE: MP - DIG");
					trazabilidadExpedienteService.saveTrazabilidadExpediente(expediente, usuario, destinatario, accion, objDD.getStrObservacion());

				}
			}
			// //////////////////////////////////////////////////////
			// Ingresando datos adicionales del proceso STOR - FIN//
			// //////////////////////////////////////////////////////
			// / Modificacion David Aranda para los documento enviados :INICIO
			Trazabilidaddocumento trazdoc;
			if (strRol.equals(Constantes.ROL_MESA_PARTES)) {
				trazdoc = trazabilidadDocumentoService.saveTrazabilidadDocumento(objD, usuarioService.findByIdUsuario(iIdUsuario), copiarfechaLimite, true);
			} else {
				trazdoc = trazabilidadDocumentoService.saveTrazabilidadDocumento(objD, usuarioService.findByIdUsuario(iIdUsuario), copiarfechaLimite, false);
			}
			log.debug("Se Registro Trazabilidad Documento de: " + usuario.getUsuario() + " para: " + objD.getPropietario().getUsuario());
			log.debug(" Accion y doc princ o no:" + strAcc + "  , " + objD.getPrincipal());
			if (strAcc.equals(Constantes.ACCION_APROBAR) && objD.getPrincipal() == Constantes.DOCUMENTO_PRINCIPAL) {
				Documentoenviado documentoenviado = new Documentoenviado();
				//wvcarrasco descomentar documentoenviado.setTrazabilidaddocumento(trazdoc);
				documentoenviado.setUsuario(usuario);
				documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
				documentoEnviadoDao.saveDocumento(documentoenviado);
			}

			//trazabilidad copia para usuarios mp
			List<String> condestinatarios = objD.getCondestinatarios();
			List<String> concopias = objD.getConcopias();
			if (condestinatarios != null && condestinatarios.size() > 0) {
				//aca logica para enviar notificaciones a los destinatarios
				for (String d : condestinatarios) {
					log.debug(" destinatario : " + d);
					if (d.isEmpty()) {
						continue;
					}
					//Si el destinatario es EXTERNO
					if (!d.contains("_")) {
						Cliente cliente =clienteService.findByNroIdentificacion(d);
						//Documentoxcliente objDocxCli = new Documentoxcliente(new DocumentoxclientePK(objD.getIdDocumento(), cliente.getIdCliente()), Constantes.TIPO_EXTERNO_DESTINATARIO);
						// em.persist(objDocxCli);


					} //Si el destinatario es INTERNO
					else {
						Integer dest = new Integer(d.split("_")[1]);
						Usuario destinatario1 = (Usuario)usuarioService.findByIdUsuario(dest);
						Accion accionCopia = accionService.findByNombre(Constantes.ACCION_COPIAR);
						//  NotificacionxEnumerar notificacionxEnumerar = new NotificacionxEnumerar(objD.getIdDocumento(), dest, Constantes.TIPO_NOTIFICACION_NUMERACION_DESTINATARIO);
						//  em.persist(notificacionxEnumerar);
						//wcarrasco 21-10-2010 falta revisar  al saveDocumentTEMPORAL() La Fecha dia siguiente
						trazabilidadcopiaService.guardarTrazabilidadcopia(trazdoc, usuario, destinatario1,objD ,accionCopia , null, Constantes.TIPO_ORIGEN_TRAZADOCUMENTO, null, nombrePC,true);


					}
				}
			}
			if (concopias != null && concopias.size() > 0) {
				//aca logica para enviar notificaciones a los  copias
				for (String d : concopias) {
					if (d.isEmpty()) {
						continue;
					}
					//Si el destinatario concopia es EXTERNO
					if (!d.contains("_")) {
						Cliente cliente =clienteService.findByNroIdentificacion(d);
						// Documentoxcliente objDocxCli = new Documentoxcliente(new DocumentoxclientePK(objD.getIdDocumento(), cliente.getIdCliente()), Constantes.TIPO_EXTERNO_CONCONPIA);
						// em.persist(objDocxCli);
					} //Si el destinatario concopia es INTERNO
					else {
						Integer dest = new Integer(d.split("_")[1]);
						//Usuario destinatario2 = (Usuario) em.createNamedQuery("Usuario.findByIdusuario").setParameter("idusuario", dest).getSingleResult();
						Usuario destinatario1 = (Usuario)usuarioService.findByIdUsuario(dest);
						Accion accionCopia = accionService.findByNombre(Constantes.ACCION_COPIAR);


						// NotificacionxEnumerar notificacionxEnumerar = new NotificacionxEnumerar(objD.getIdDocumento(), dest, Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
						//wcarrasco 21-10-2010 falta revisar  al saveDocumentTEMPORAL() La Fecha dia siguiente
						trazabilidadcopiaService.guardarTrazabilidadcopia(trazdoc, usuario, destinatario1,objD ,accionCopia , null, Constantes.TIPO_ORIGEN_TRAZADOCUMENTO, null, nombrePC,true);
						// em.persist(notificacionxEnumerar);

					}
				}

			}
			//

			// / Modificacion David Aranda para los documento enviados :FIN
			// Para mostrar en el resumen
			objDD.setIIdDocumento(objD.getIdDocumento());
			objDD.setStrReferencia(expediente.getNroexpediente());
			objDD.setStrProceso(expediente.getProceso().getNombre());
			objDD.setStrUnidad(expediente.getProceso().getResponsable().getUnidad().getNombre());

			if (expediente.getProceso().getNombre().startsWith("OSINERGMIN")) {
				objDD.setStrResponsable(expediente.getIdpropietario().getNombres() + " " + expediente.getIdpropietario().getApellidos());
			} else {
				objDD.setStrResponsable(expediente.getProceso().getResponsable().getNombres() + " " + expediente.getProceso().getResponsable().getApellidos());
			}

			if (objTD != null) {
				objDD.setStrTipoDocumento(objTD.getNombre());
			}
			objDD.setStrAbreviado(expediente.getProceso().getTipoproceso().getNombre());
			if (expediente.getCliente() != null) {
				objDD.setStrTipoIdentificacion(expediente.getCliente().getTipoIdentificacion().getNombre());
				if (objDD.getStrTipoIdentificacion().equals(Constantes.TIPO_IDENTIFICACION_RUC)) {
					objDD.setStrRazonSocial(expediente.getCliente().getRazonSocial());
				} else {
					objDD.setStrRazonSocial(expediente.getCliente().getNombres() + " " + expediente.getCliente().getApellidoPaterno() + " " + expediente.getCliente().getApellidoMaterno());
				}
				objDD.setStrNroIdentificacion(expediente.getCliente().getNumeroIdentificacion());
				objDD.setStrDireccionPrincipal(expediente.getCliente().getDireccionPrincipal());
				objDD.setStrDireccionAlternativa(expediente.getCliente().getDireccionAlternativa());
				objDD.setStrTelefonoCliente(expediente.getCliente().getTelefono());
				objDD.setStrCorreoCliente(expediente.getCliente().getCorreo());
				objDD.setStrRepresentanteLegal(expediente.getCliente().getRepresentanteLegal());
			}
			if (expediente.getConcesionario() != null) {
				objDD.setStrRUC(expediente.getConcesionario().getRuc());
				objDD.setStrCorrentista(expediente.getConcesionario().getRazonSocial());
				objDD.setStrDireccionConcesionario(expediente.getConcesionario().getDireccion());
				objDD.setStrCorreoConcesionario(expediente.getConcesionario().getCorreo());
			}
		}

		/**Numeracin--------------------------------------------------------------------------------------------------------*/
		if(objD.getEnumerarDocumento() && objD.getTiponumeracion().equals(Constantes.NUMERACION_AUTOMATICA) && objD.getEnumerado().equals(Constantes.No)){
			log.debug("Debe colocarse un nmero automtico al documento");
			objD = guardarDocEnumeradoMP(objD);
			objDD.setStrNroDocumento(objD.getNumeroDocumento());
		}

		objDD.setFechacreacion(expediente.getFechacreacion());
		objDD.setDoc(objD);

		return objDD;
	}

	// public Documento crearDocumentoParaArchivo(Documento objDocumento,Usuario
	// objUsuario,Map<String,List<ArchivoTemporal>> mapUpload){
	/*
	 * Accion objAccion=null; List<ArchivoTemporal> lstArchivoTemporal=null;
	 * objAccion=accionService.findByNombre(Constantes.ACCION_REGISTRAR);
	 * if(mapUpload!=null){ lstArchivoTemporal=mapUpload.get("upload1"); // for
	 * (ArchivoTemporal obj) }
	 */
	/*
	 * return objDocumento; }
	 */
	@Transactional
	public Documento crearDocumentoPorArchivo(DocumentoDetail objDD, Usuario objUsuario, Map<String, List<ArchivoTemporal>> mapUpload, Boolean changePrincipal, boolean quitarCorchete, String modulo, String opcion, boolean masivo) {
		log.debug("-> [Service] DocumentoService - crearDocumentoPorArchivo():Documento ");
		
		Accion objAccion = null;
		Boolean bFirstOne = changePrincipal;
		Documento objDocumentoPrincipal = this.findByIdDocumento(objDD.getIIdDocumento());
		Documento objNuevoDocumentoPrincipal = null;
		List<ArchivoTemporal> lstArchivoTemporal = mapUpload.get("upload1");
		Tipodocumento objTipodocumento = tipoDocumentoDao.findByNombre("Otros");
		if (changePrincipal) {
			objDocumentoPrincipal.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
		}
		objDocumentoPrincipal.setContenido(objDD.getStrContenido());
		objDocumentoPrincipal = this.saveDocumento(objDocumentoPrincipal);
		log.debug("Numero de documentos de contenido  [" + objDD.getStrContenido() + "]");
		int creados = 0;
		if (lstArchivoTemporal != null && (!masivo)) {
			for (ArchivoTemporal objArchivoTemporal : lstArchivoTemporal) {
				try {
					archivoService.checkInToAlfresco(objUsuario, objArchivoTemporal, objDocumentoPrincipal, 1, quitarCorchete);
				} catch (Exception e) {
					Documento objDocumento = new Documento();
					objDocumento.setTipoDocumento(objTipodocumento);
					objDocumento.setNumeroFolios(1);
					objDocumento.setPropietario(objUsuario);
					objDocumento.setExpediente(objDocumentoPrincipal.getExpediente());
					objDocumento.setContenido(objDD.getStrContenido());
					objDocumento.setFechaAccion(new Date());
					objDocumento.setFechaCreacion(new Date());
					objDocumento.setEstado(Constantes.ESTADO_ACTIVO);
					if (bFirstOne) {
						objAccion = accionService.findByNombre(Constantes.ACCION_REENVIAR);
						objDocumento.setAccion(objAccion);
						objDocumento.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
					} else {
						objAccion = accionService.findByNombre(Constantes.ACCION_REGISTRAR);
						objDocumento.setAccion(objAccion);
						objDocumento.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
					}
					objDocumento = this.saveDocumento(objDocumento);
					// auditoria
					if (StringUtils.isNotEmpty(opcion) && StringUtils.isEmpty(modulo)) {
						Auditoria au = new Auditoria();
						au.setCampo("archivo");
						au.setDocumento(objDocumento);
						au.setExpediente(objDocumento.getExpediente());
						au.setFechaAudioria(new Date());
						au.setModulo(modulo);
						au.setNuevoValor(objArchivoTemporal.getSNombre());
						au.setOpcion(opcion);
						au.setTipoAuditoria("registro");
						au.setUsuario(objDocumento.getPropietario().getUsuario());
						auditoriaDao.SaveAuditoria(au);
					}
					log.debug(" ############################## error haciendo checkin ######################## ");
					log.warn(e.getMessage());
					log.warn("El archivo no existe, subiendo nuevo archivo");
					archivoService.uploadToAlfresco(objArchivoTemporal, objDocumento, 1);
					log.debug("Documento creado con ID [" + objDocumento.getIdDocumento() + "] Accion [" + objAccion.getNombre() + "] Adjunto [" + objArchivoTemporal.getSNombre() + "]");
					if (bFirstOne) {
						objNuevoDocumentoPrincipal = objDocumento;
						bFirstOne = false;
					}
					creados++;
				}
			}
		}
		if (creados == 0) {
			objDocumentoPrincipal.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
			objDocumentoPrincipal = this.saveDocumento(objDocumentoPrincipal);
			objNuevoDocumentoPrincipal = objDocumentoPrincipal;
		}
		return objNuevoDocumentoPrincipal;
	}

	public void inactivarDocumentos(Integer iIdExpediente) {
		log.debug("-> [Service] DocumentoService - inactivarDocumentos():void ");
		
		List<Documento> lstDocumento = documentoDao.findByIdExpediente(iIdExpediente);
		if (lstDocumento == null) {
			log.debug("No hay documentos a inactivar del expediente con ID [" + iIdExpediente + "]");
			return;
		}
		log.debug("Lista de documentos a inactivar con size [" + lstDocumento.size() + "]");
		for (Documento objDocumento : lstDocumento) {
			log.debug("ID [" + objDocumento.getIdDocumento() + "] Documento [" + objDocumento.getTipoDocumento().getNombre() + " - " + objDocumento.getNumeroDocumento() + "]");
			objDocumento.setEstado(Constantes.ESTADO_INACTIVO);
			// this.saveDocumento(objDocumento);
		}
	}

	@Transactional
	public Documento saveDocumento(Documento objDocumento) {
		log.debug("-> [Service] DocumentoService - saveDocumento():Documento ");
		
		return documentoDao.saveDocumento(objDocumento);
	}

	@Transactional
	public Documento registrarDocumento(Documento objDocumento) {
		log.debug("-> [Service] DocumentoService - registrarDocumento():Documento ");
		
		return documentoDao.registrarDocumento(objDocumento);
	}

	public List<Documento> buscarLstPor(Integer iIdDocPrincipal, ExpedienteSearch objExpedienteSearch) {
		log.debug("-> [Service] DocumentoService - buscarLstPor():List<Documento> ");
		
		Documento objDocumentoPrincipal = this.findByIdDocumento(iIdDocPrincipal);
		List<Documento> lstDocumento = null;
		log.debug("Expediente a excluir [" + objDocumentoPrincipal.getExpediente().getNroexpediente() + "] con ID [" + objDocumentoPrincipal.getExpediente().getIdexpediente() + "]");
		log.debug("Filtro de Busqueda");
		log.debug("Nro Expediente [" + objExpedienteSearch.getSNroExpediente() + "]");
		log.debug("Nro Documento [" + objExpedienteSearch.getSNroDocumento() + "]");
		log.debug("ID Tipo Documento [" + objExpedienteSearch.getIIdTipoDocumento() + "]");
		log.debug("Nro Caja [" + objExpedienteSearch.getSNroCaja() + "]");
		if (objExpedienteSearch.getIIdTipoDocumento() == null || objExpedienteSearch.getIIdTipoDocumento() == 0) {
			lstDocumento = documentoDao.buscarLstPor(objDocumentoPrincipal.getExpediente().getIdexpediente(), objExpedienteSearch.getSNroExpediente(), objExpedienteSearch.getSNroDocumento(), objExpedienteSearch.getSNroCaja());
		} else {
			lstDocumento = documentoDao.buscarLstPor(objDocumentoPrincipal.getExpediente().getIdexpediente(), objExpedienteSearch.getSNroExpediente(), objExpedienteSearch.getSNroDocumento(), objExpedienteSearch.getSNroCaja(), objExpedienteSearch.getIIdTipoDocumento());
		}
		if (lstDocumento != null) {
			log.debug("Numero de Documentos encontrados [" + lstDocumento.size() + "]");
		} else {
			log.debug("Numero de Documentos encontrados [0]");
		}
		// Usamos el atributo "observacion" para guardar el URL del archivo
		for (Documento objDocumento : lstDocumento) {
			log.debug("Documento [" + objDocumento.getTipoDocumento().getNombre() + " " + objDocumento.getNumeroDocumento() + "] con ID [" + objDocumento.getIdDocumento() + "]");
			log.debug("Numero de archivos adjuntos [" + objDocumento.getArchivos().size() + "]");
			for (Archivo objArchivo : objDocumento.getArchivos()) {
				log.debug("[" + objArchivo.getNombre() + "]");
				if (objArchivo.getRutaAlfresco() != null) {
					objArchivo.setSURL(alfrescoWebServiceClient.obtenerLinkContenido(objArchivo.getRutaAlfresco()));
				}
				log.debug("URL [" + objArchivo.getSURL() + "]");
			}
		}
		return lstDocumento;
	}

	public List<Documento> buscarLstDocumentoPor(char cEstado, char cPrincipal, Integer iIdPropietario) {
		log.debug("-> [Service] DocumentoService - buscarLstDocumentoPor(char, char, Integer):List<Documento> ");
		
		log.debug("Estado [" + cEstado + "]");
		log.debug("Principal [" + cPrincipal + "]");
		log.debug("Propietario [" + iIdPropietario + "]");
		return documentoDao.buscarLstDocumentoPor(cEstado, cPrincipal, iIdPropietario);
	}

	public List<Documento> buscarLstDocumentoPor(char cPrincipal, Integer idReponsable) {
		log.debug("-> [Service] DocumentoService - buscarLstDocumentoPor(char, Integer):List<Documento> ");
		
		log.debug("Principal [" + cPrincipal + "]");
		log.debug("Responsable [" + idReponsable + "]");
		return documentoDao.buscarLstDocumentoPor(cPrincipal, idReponsable);
	}

	@SuppressWarnings("rawtypes")
	public List findDocumentos(Usuario objUsuario) {
		log.debug("-> [Service] DocumentoService - findDocumentos():List ");
		
		List<Documento> lstDocumento = null;
		Perfil perfil = null;
		Rol rol = objUsuario.getRol();
		if (rol != null) {
			perfil = rol.getIdperfil();
		}
		if (perfil != null) {
			Sede objSede = sedeDao.getSedePorUuario(objUsuario);
			// El rol MP es lector de los documentos de Digitalizador
			if (perfil.getNombre().equals(Constantes.PERFIL_MP)) {
				Rol dig = rolDao.encontrarPorNombre(Constantes.ROL_DIGITALIZADOR);
				Integer idRol = null;
				if (dig != null) {
					idRol = dig.getIdrol();
				}
				// la accion para los documentos creados en mesa de partes es
				// REGISTRAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				lstDocumento = documentoDao.findByIdPropietario(null, idRol, null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, 0);
			} else if (perfil.getNombre().equals(Constantes.PERFIL_DIG)) {
				// la accion para los documentos registrados es REGISTRAR y
				// RECHAZAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				int accion2 = accionService.findByNombre(Constantes.ACCION_RECHAZARQAS).getIdAccion();
				lstDocumento = documentoDao.findByIdPropietario(null, rol.getIdrol(), null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, accion2);
			} else if (perfil.getNombre().equals(Constantes.PERFIL_QAS)) {
				// la accion para los documentos digitalizados es DIGITALIZAR y
				// RECHAZAR\
				Accion acciondata = accionService.findByNombre(Constantes.ACCION_DIGITALIZAR);
				int accion = acciondata.getIdAccion();
				int accion2 = accionService.findByNombre(Constantes.ACCION_RECHAZAR).getIdAccion();
				lstDocumento = documentoDao.findByIdPropietario(null, rol.getIdrol(), null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, accion2);
			}
		} else {
			lstDocumento = documentoDao.findByIdPropietario(objUsuario.getIdusuario(), null, null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, null, null, 0, 0);

		}
		// log.debug(" findDocumentos hora fin : "+new Date()) ;
		return lstDocumento;
	}

	@SuppressWarnings("rawtypes")
	public List findDocumentosUsuarioFinal(Usuario objUsuario, boolean enviados) {
		log.debug("-> [Service] DocumentoService - findDocumentosUsuarioFinal():List ");
		
		return documentoDao.findByDataUF(objUsuario.getIdusuario(), enviados,true);
	}
	@SuppressWarnings("rawtypes")
	public List findDocumentosXExpediente(Usuario objUsuario, Integer idDocumento, boolean enviados){
		log.debug("-> [Service] DocumentoService - findDocumentosXExpediente():List ");
		
		return documentoDao.findFilasDXE(objUsuario.getIdusuario(), idDocumento, enviados);
	}
	
	@SuppressWarnings("rawtypes")
	public List findDocumentosAtendidosUsuarioFinal(Usuario objUsuario) {
		log.debug("-> [Service] DocumentoService - findDocumentosAtendidosUsuarioFinal():List ");
		
		return documentoDao.findByDataAttendedUF(objUsuario.getIdusuario());
	}

	@SuppressWarnings("rawtypes")
	public List findDocumentosAtendidosUsuarioFinal(Usuario objUsuario, BusquedaAvanzada objFiltro) {
		log.debug("-> [Service] DocumentoService - findDocumentosAtendidosUsuarioFinal():List ");
		
		return documentoDao.findByDataAttendedUF(objUsuario.getIdusuario(), objFiltro);
	}
	
	@SuppressWarnings("rawtypes")
	public List findByDataUFWithoutSharedInbox(Integer iIdUsuario) {
		log.debug("-> [Service] DocumentoService - findByDataUFWithoutSharedInbox():List ");
		
		return documentoDao.findByDataUFWithoutSharedInbox(iIdUsuario);

	}
	public Integer findCantDocumentos(Usuario objUsuario) {
		log.debug("-> [Service] DocumentoService - findCantDocumentos():Integer ");
		
		Integer lstDocumento = 0;
		Perfil perfil = null;
		Rol rol = objUsuario.getRol();
		if (rol != null) {
			perfil = rol.getIdperfil();
		}
		if (perfil != null) {
			Sede objSede = sedeDao.getSedePorUuario(objUsuario);
			// El rol MP es lector de los documentos de Digitalizador
			if (perfil.getNombre().equals(Constantes.PERFIL_MP)) {
				Rol dig = rolDao.encontrarPorNombre(Constantes.ROL_DIGITALIZADOR);
				Integer idRol = null;
				if (dig != null) {
					idRol = dig.getIdrol();
				}
				// la accion para los documentos creados en mesa de partes es
				// REGISTRAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				lstDocumento = documentoDao.findCantByIdPropietario(null, idRol, null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, 0);
			} else if (perfil.getNombre().equals(Constantes.PERFIL_DIG)) {
				// la accion para los documentos registrados es REGISTRAR y
				// RECHAZAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				int accion2 = accionService.findByNombre(Constantes.ACCION_RECHAZAR).getIdAccion();
				lstDocumento = documentoDao.findCantByIdPropietario(null, rol.getIdrol(), null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, accion2);
			} else if (perfil.getNombre().equals(Constantes.PERFIL_QAS)) {
				// la accion para los documentos digitalizados es DIGITALIZAR y
				// RECHAZAR\
				Accion acciondata = accionService.findByNombre(Constantes.ACCION_DIGITALIZAR);
				int accion = acciondata.getIdAccion();
				int accion2 = accionService.findByNombre(Constantes.ACCION_RECHAZAR).getIdAccion();
				lstDocumento = documentoDao.findCantByIdPropietario(null, rol.getIdrol(), null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, accion2);
			}
		} else {
			lstDocumento = documentoDao.findCantByIdPropietario(objUsuario.getIdusuario(), null, null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, null, null, 0, 0);
		}
		// log.debug(" findDocumentos hora fin : "+new Date()) ;
		return lstDocumento;
	}

	public Integer findCantDocumentosRecibidos(Usuario objUsuario) {
		log.debug("-> [Service] DocumentoService - findCantDocumentosRecibidos():Integer ");
		
		Integer lstDocumento = 0;
		lstDocumento = documentoDao.findCantDocumentosRecibidos(objUsuario.getIdusuario(), Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL);
		return lstDocumento;
	}

	public Integer findCantMisExpedientes(Usuario objUsuario) {
		log.debug("-> [Service] DocumentoService - findCantMisExpedientes():Integer ");
		
		Integer cantidad = 0;
		cantidad = documentoDao.findCantMisExpedientes(objUsuario.getIdusuario(), Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL);
		return cantidad;
	}

	public List<Documento> findCantidadDocumentos(Usuario objUsuario) {
		log.debug("-> [Service] DocumentoService - findCantidadDocumentos():List<Documento> ");
		
		List<Documento> lstDocumento = null;
		Perfil perfil = null;
		Rol rol = objUsuario.getRol();
		if (rol != null) {
			perfil = rol.getIdperfil();
		}
		if (perfil != null) {
			Sede objSede = objUsuario.getUnidad().getSede();
			// El rol MP es lector de los documentos de Digitalizador
			if (perfil.getNombre().equals(Constantes.PERFIL_MP)) {
				Rol dig = rolDao.encontrarPorNombre(Constantes.ROL_DIGITALIZADOR);
				Integer idRol = null;
				if (dig != null) {
					idRol = dig.getIdrol();
				}
				// la accion para los documentos creados en mesa de partes es
				// REGISTRAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				lstDocumento = documentoDao.findByIdPropietario(null, idRol, null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, 0);
			} else if (perfil.getNombre().equals(Constantes.PERFIL_DIG)) {
				// la accion para los documentos registrados es REGISTRAR y
				// RECHAZAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				int accion2 = accionService.findByNombre(Constantes.ACCION_RECHAZAR).getIdAccion();
				lstDocumento = documentoDao.findByIdPropietario(null, rol.getIdrol(), null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, accion2);
			} else if (perfil.getNombre().equals(Constantes.PERFIL_QAS)) {
				// la accion para los documentos digitalizados es DIGITALIZAR y
				// RECHAZAR\
				Accion acciondata = accionService.findByNombre(Constantes.ACCION_DIGITALIZAR);
				int accion = acciondata.getIdAccion();
				int accion2 = accionService.findByNombre(Constantes.ACCION_RECHAZAR).getIdAccion();
				lstDocumento = documentoDao.findByIdPropietario(null, rol.getIdrol(), null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, "todo", objSede.getIdsede(), accion, accion2);
			}
		} else {
			lstDocumento = documentoDao.findByIdPropietario(objUsuario.getIdusuario(), null, null, Constantes.ESTADO_ACTIVO, Constantes.DOCUMENTO_PRINCIPAL, null, null, 0, 0);
		}
		// log.debug(" findDocumentos hora fin : "+new Date()) ;
		return lstDocumento;
	}

	public List<Documento> findDocumentosPorNumerar(Usuario objUsuario, Expediente expediente) {
		log.debug("-> [Service] DocumentoService - findDocumentosPorNumerar():List<Documento> ");
		
		List<Documento> lstDocumento = null;
		lstDocumento = documentoDao.findDocumentosPorNumerar(objUsuario, expediente);
		return lstDocumento;
	}

	public List<Documento> findDocumentosPorFirmar(Usuario objUsuario, Expediente expediente) {
		log.debug("-> [Service] DocumentoService - findDocumentosPorFirmar():List<Documento> ");
		
		List<Documento> lstDocumento = null;
		lstDocumento = documentoDao.findDocumentosPorFirmar(objUsuario, expediente);
		return lstDocumento;
	}

	@Transactional
	private Documento guardarDocEnumerados(Documento objDocumento){
		log.debug("-> [Service] DocumentoService - guardarDocEnumerados():Documento ");
		
		Usuario usuario = null;

		if (objDocumento.getIdUsuarioLogeado() != null) {
			usuario = documentoDao.findUsuarioById(objDocumento.getIdUsuarioLogeado());
		}

		Unidad unid = ((usuario != null && usuario.getUnidad() != null) ? usuario.getUnidad() : objDocumento.getPropietario() != null ? objDocumento.getPropietario().getUnidad() : objDocumento.getExpediente().getProceso().getResponsable().getUnidad());
		Integer idtipodoc = objDocumento.getTipoDocumento().getIdtipodocumento();
		log.debug("objDocumento.getNumeroDocumento():" + objDocumento.getNumeroDocumento());
		log.debug("objDocumento.getEnumerarDocumento():" + objDocumento.getEnumerarDocumento());

		List<String> condestinatarios = objDocumento.getCondestinatarios();
		List<String> concopias = objDocumento.getConcopias();
		boolean enumerarDocumento = objDocumento.getEnumerarDocumento();

		if (objDocumento.getIdDocumento() == null) {

			while (unid != null && StringUtils.isBlank(objDocumento.getNumeroDocumento()) && objDocumento.getEnumerarDocumento()) {

				if (objDocumento.getTiponumeracion().equals("A")) {
					Integer idunidad = unid.getIdunidad();

					try {

						//Numeracion num = (Numeracion) em.createNamedQuery("Numeracion.findByIdnumeracion").setParameter("idunidad", idunidad).setParameter("idtipodocumento", idtipodoc).getSingleResult();
						Numeracion num = numeracionService.findById(idunidad, idtipodoc);
						if (StringUtils.isBlank(objDocumento.getNumeroDocumento())) {
							objDocumento.setNumeroDocumento(num.formatearNumero());
							num.setNumeroactual(num.getNumeroactual() + 1);
							//em.merge(num);
							numeracionService.guardarObj(num);
							unid = null;

						}

					} catch (NoResultException nre) {
						log.warn("No se encontro numeracion para idTipoDocumento [" + idtipodoc + "] idUnidad [" + idunidad + "]");
						unid = unid.getDependencia();
						log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
					} catch (Exception ex) {
						log.error(ex.getMessage(), ex);
					}

				} else if (objDocumento.getTiponumeracion() != null
						&& objDocumento.getTiponumeracion().equals(Constantes.TIPO_NUMERACION_SIN_NUMERACION)
						&& StringUtils.isBlank(objDocumento.getNumeroDocumento())) {

					objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);

				} else if (objDocumento.getTiponumeracion() != null
						&& objDocumento.getTiponumeracion().equals(Constantes.TIPO_NUMERACION_MANUAL)
						&& StringUtils.isBlank(objDocumento.getNumeroDocumento())) {

					objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);
				}
			}

			// logica para setear Nro Folios
			if (objDocumento.getNumeroFolios() == 0) {
				objDocumento.setNumeroFolios(1);
			}

			if (StringUtils.isBlank(objDocumento.getNumeroDocumento())) {
				objDocumento.setNumeroDocumento("." + Constantes.NRODCUMENTO_SIN_NUMERO);
			}

			objDocumento.setDelExpediente(Constantes.DOCUMENTO_DEL_EXPEDIENTE);

			//em.persist(objDocumento); // Nuevo
			objDocumento.setEnumerado(Constantes.Si);
			objDocumento.setAutor(objDocumento.getPropietario());
			documentoDao.guardarDocumento(objDocumento);
			log.debug(" .. " + objDocumento.getIdDocumento());

			if (condestinatarios != null && condestinatarios.size() > 0) {
				//aca logica para enviar notificaciones a los destinatarios
				for (String d : condestinatarios) {
					log.debug(" destinatario : " + d);
					if (d.isEmpty()) {
						continue;
					}
					//Si el destinatario es EXTERNO
					if (!d.contains("_")) {
						//Cliente cliente = (Cliente) em.createNamedQuery("Cliente.findByNroidentificacion").setParameter("nroidentificacion", d).getSingleResult();
						Cliente cliente = clienteService.findByNroIdentificacion(d);
						Documentoxcliente objDocxCli = new Documentoxcliente(new DocumentoxclientePK(objDocumento.getIdDocumento(), cliente.getIdCliente()), Constantes.TIPO_EXTERNO_DESTINATARIO);
						//em.persist(objDocxCli);
						documentoxclienteService.guardarObj(objDocxCli);

					} //Si el destinatario es INTERNO
					else {
						Integer dest = new Integer(d.split("_")[1]);
						//Usuario destinatario = (Usuario) em.createNamedQuery("Usuario.findByIdusuario").setParameter("idusuario", dest).getSingleResult();
						Usuario destinatario = usuarioService.findByIdUsuario(dest);
						if (enumerarDocumento) {
							Notificacion noti = getNotificacionDestinatario(objDocumento, destinatario, new Date(), Constantes.ESTADO_ACTIVO);
							//em.persist(noti);
							notificacionService.saveNotificacion(noti);
							mailService.ChaskiMail(Constantes.CONFIGNOTIFMAIL_ENUMERACION_DESTINATARIO, objDocumento.getPropietario(), destinatario, objDocumento);

						} else {
							NotificacionxEnumerar notificacionxEnumerar = new NotificacionxEnumerar(objDocumento.getIdDocumento(), dest, Constantes.TIPO_NOTIFICACION_NUMERACION_DESTINATARIO);
							//em.persist(notificacionxEnumerar);
							notificacionxEnumerarDAO.guardar(notificacionxEnumerar);
						}
					}
				}
			}
			if (concopias != null && concopias.size() > 0) {
				//aca logica para enviar notificaciones a los  copias
				for (String d : concopias) {
					if (d.isEmpty()) {
						continue;
					}
					//Si el destinatario concopia es EXTERNO
					if (!d.contains("_")) {
						//Cliente cliente = (Cliente) em.createNamedQuery("Cliente.findByNroidentificacion").setParameter("nroidentificacion", d).getSingleResult();
						Cliente cliente = clienteService.findByNroIdentificacion(d);
						Documentoxcliente objDocxCli = new Documentoxcliente(new DocumentoxclientePK(objDocumento.getIdDocumento(), cliente.getIdCliente()), Constantes.TIPO_EXTERNO_CONCONPIA);
						//em.persist(objDocxCli);
						documentoxclienteService.guardarObj(objDocxCli);
					} //Si el destinatario concopia es INTERNO
					else {
						Integer dest = new Integer(d.split("_")[1]);
						//Usuario destinatario = (Usuario) em.createNamedQuery("Usuario.findByIdusuario").setParameter("idusuario", dest).getSingleResult();
						Usuario destinatario = usuarioService.findByIdUsuario(dest);
						if (enumerarDocumento) {

							Notificacion noti = getNotificacionCopia(objDocumento, destinatario, new Date(), Constantes.ESTADO_ACTIVO);
							//em.persist(noti);
							notificacionService.saveNotificacion(noti);
							mailService.ChaskiMail(Constantes.CONFIGNOTIFMAIL_ENUMERACION_COPIA, objDocumento.getPropietario(), destinatario, objDocumento);
						} else {

							NotificacionxEnumerar notificacionxEnumerar = new NotificacionxEnumerar(objDocumento.getIdDocumento(), dest, Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
							//em.persist(notificacionxEnumerar);
							notificacionxEnumerarDAO.guardar(notificacionxEnumerar);
						}
					}
				}

			}

		} else {
			/* la numeracion ya no es totalmente automatica  */


			while (unid != null && (StringUtils.isBlank(objDocumento.getNumeroDocumento()) || objDocumento.getEnumerado().equals(Constantes.No))) {

				Integer idunidad = unid.getIdunidad();

				try {
					if (log.isDebugEnabled()) {
						log.debug("Buscando numeracion con idunidad [" + idunidad + "] idtipodocumento [" + idtipodoc + "]");
					}
					/*
                    List<Numeracion> listaNum = em.createQuery("SELECT n FROM Numeracion n " +
                    		"WHERE " +
                    		"n.unidad.idunidad = :idunidad and " +
                    		"n.tipodocumento.idtipodocumento = :idtipodocumento")
                    		.setParameter("idunidad", idunidad)
                    		.setParameter("idtipodocumento", idtipodoc)
                    		.getResultList();
					 */
					List<Numeracion> listaNum=numeracionService.findAllUnidadAndTipoDoc(idunidad,idtipodoc);

					if (listaNum != null && listaNum.size() > 0 && listaNum.get(0).getTiponumeracion() != null) {

						log.debug("StringUtils.isBlank(objDocumento.getNumeroDocumento() ): " + StringUtils.isBlank(objDocumento.getNumeroDocumento()));
						log.debug("objDocumento.getNumeroDocumento().equals(.+Constantes.NRODCUMENTO_SIN_NUMERO) :" + objDocumento.getNumeroDocumento().equals("." + Constantes.NRODCUMENTO_SIN_NUMERO));

						if (listaNum.get(0).getTiponumeracion().toString().equals(Constantes.TIPO_NUMERACION_AUTOMATICA)) {

							objDocumento.setNumeroDocumento(listaNum.get(0).formatearNumero());
							listaNum.get(0).setNumeroactual(listaNum.get(0).getNumeroactual() + 1);
							//em.merge(listaNum.get(0));
							numeracionService.guardarObj(listaNum.get(0));
							unid = null;

						} else if (listaNum.get(0).getTiponumeracion().toString().equals(Constantes.TIPO_NUMERACION_SIN_NUMERACION)
								&& (StringUtils.isBlank(objDocumento.getNumeroDocumento())
										|| objDocumento.getNumeroDocumento().equals("." + Constantes.NRODCUMENTO_SIN_NUMERO))) {
							objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);
							break;

						} else if (listaNum.get(0).getTiponumeracion().toString().equals(Constantes.TIPO_NUMERACION_MANUAL)
								&& (StringUtils.isBlank(objDocumento.getNumeroDocumento())
										|| objDocumento.getNumeroDocumento().equals("." + Constantes.NRODCUMENTO_SIN_NUMERO))) {

							objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);
							break;
						}

					} else {
						log.info("No hay resultado para la numeracion idtipodoc:" + idtipodoc + " idunidad:" + idunidad);
						unid = unid.getDependencia();
						log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
					}
				} catch (NoResultException nre) {
					log.warn("No se encontro numeracion para idTipoDocumento [" + idtipodoc + "] idUnidad [" + idunidad + "]");
					unid = unid.getDependencia();
					log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
				} catch (Exception ex) {
					log.error(ex.getMessage(), ex);
				}
			}


			if (StringUtils.isBlank(objDocumento.getNumeroDocumento())) {
				objDocumento.setNumeroDocumento("." + Constantes.NRODCUMENTO_SIN_NUMERO);
			}

			//em.merge(objDocumento); // Actualizacion
			objDocumento.setEnumerado(Constantes.Si);
			objDocumento.setAutor(objDocumento.getPropietario());
			documentoDao.updateDocumento(objDocumento);
			// em.refresh(objDocumento);
			if (enumerarDocumento) {

				/*List<NotificacionxEnumerar> destinatarios = em.createNamedQuery("NotificacionxEnumerar.findByAll")
                		.setParameter("iddocumento", objDocumento.getIdDocumento()) //.setParameter("idusuario", objDocumento.getFirmante().getIdusuario())
                        .setParameter("tiponotificacion", Constantes.TIPO_NOTIFICACION_NUMERACION_DESTINATARIO).getResultList();
				 */
				List<NotificacionxEnumerar> destinatarios=notificacionxEnumerarDAO.findByDocumento(objDocumento, Constantes.TIPO_NOTIFICACION_NUMERACION_DESTINATARIO);

				//aca logica para enviar notificaciones a los destinatarios NotificacionxEnumerarPK
				for (NotificacionxEnumerar d : destinatarios) {
					Usuario destinatario = d.getUsuario();
					Notificacion noti = getNotificacionDestinatario(objDocumento, destinatario, new Date(), Constantes.ESTADO_ACTIVO);
					//em.persist(noti);
					notificacionService.saveNotificacion(noti);
					mailService.ChaskiMail(Constantes.CONFIGNOTIFMAIL_ENUMERACION_DESTINATARIO, objDocumento.getPropietario(), destinatario, objDocumento);
					//em.refresh(noti);
				}

				/*List<NotificacionxEnumerar> copias = em.createNamedQuery("NotificacionxEnumerar.findByAll")
                		.setParameter("iddocumento", objDocumento.getIdDocumento()) //.setParameter("idusuario", objDocumento.getFirmante().getIdusuario())
                        .setParameter("tiponotificacion", Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA)
                        .getResultList();*/

				List<NotificacionxEnumerar> copias=notificacionxEnumerarDAO.findByDocumento(objDocumento, Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
				//aca logica para enviar notificaciones a los destinatarios
				for (NotificacionxEnumerar d : copias) {
					Usuario destinatario = d.getUsuario();
					Notificacion noti = getNotificacionCopia(objDocumento, destinatario, new Date(), Constantes.ESTADO_ACTIVO);
					//em.persist(noti);
					notificacionService.saveNotificacion(noti);
					mailService.ChaskiMail(Constantes.CONFIGNOTIFMAIL_ENUMERACION_COPIA, objDocumento.getPropietario(), destinatario, objDocumento);
				}


			}

		}
		return objDocumento;
	}

	/**REN: Enumera y guarda pero no notifica, para uso en mesa de parte -----------------------------------------------------*/
	@Transactional
	private Documento guardarDocEnumeradoMP(Documento objDocumento){
		log.debug("-> [Service] DocumentoService - guardarDocEnumeradoMP():Documento ");
		
		Usuario usuario = null;

		if (objDocumento.getIdUsuarioLogeado() != null) {
			usuario = documentoDao.findUsuarioById(objDocumento.getIdUsuarioLogeado());
		}

		Unidad unid = ((usuario != null && usuario.getUnidad() != null) ? usuario.getUnidad() : objDocumento.getPropietario() != null ? objDocumento.getPropietario().getUnidad() : objDocumento.getExpediente().getProceso().getResponsable().getUnidad());
		Integer idtipodoc = objDocumento.getTipoDocumento().getIdtipodocumento();
		log.debug("objDocumento.getNumeroDocumento():" + objDocumento.getNumeroDocumento());
		log.debug("objDocumento.getEnumerarDocumento():" + objDocumento.getEnumerarDocumento());

		if (objDocumento.getIdDocumento() == null) {

			while (unid != null && StringUtils.isBlank(objDocumento.getNumeroDocumento()) && objDocumento.getEnumerarDocumento()) {

				if (objDocumento.getTiponumeracion().equals("A")) {
					Integer idunidad = unid.getIdunidad();

					try {

						//Numeracion num = (Numeracion) em.createNamedQuery("Numeracion.findByIdnumeracion").setParameter("idunidad", idunidad).setParameter("idtipodocumento", idtipodoc).getSingleResult();
						Numeracion num = numeracionService.findById(idunidad, idtipodoc);
						if (StringUtils.isBlank(objDocumento.getNumeroDocumento())) {
							objDocumento.setNumeroDocumento(num.formatearNumero());
							num.setNumeroactual(num.getNumeroactual() + 1);
							//em.merge(num);
							numeracionService.guardarObj(num);
							unid = null;

						}

					} catch (NoResultException nre) {
						log.warn("No se encontro numeracion para idTipoDocumento [" + idtipodoc + "] idUnidad [" + idunidad + "]");
						unid = unid.getDependencia();
						log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
					} catch (Exception ex) {
						log.error(ex.getMessage(), ex);
					}

				} else if (objDocumento.getTiponumeracion() != null
						&& objDocumento.getTiponumeracion().equals(Constantes.TIPO_NUMERACION_SIN_NUMERACION)
						&& StringUtils.isBlank(objDocumento.getNumeroDocumento())) {

					objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);

				} else if (objDocumento.getTiponumeracion() != null
						&& objDocumento.getTiponumeracion().equals(Constantes.TIPO_NUMERACION_MANUAL)
						&& StringUtils.isBlank(objDocumento.getNumeroDocumento())) {

					objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);
				}
			}

			// logica para setear Nro Folios
			if (objDocumento.getNumeroFolios() == 0) {
				objDocumento.setNumeroFolios(1);
			}

			if (StringUtils.isBlank(objDocumento.getNumeroDocumento())) {
				objDocumento.setNumeroDocumento("." + Constantes.NRODCUMENTO_SIN_NUMERO);
			}

			objDocumento.setDelExpediente(Constantes.DOCUMENTO_DEL_EXPEDIENTE);

			objDocumento.setEnumerado(Constantes.Si);
			documentoDao.guardarDocumento(objDocumento);
			log.debug(" .. " + objDocumento.getIdDocumento());

		} else {
			/* la numeracion ya no es totalmente automatica  */

			while (unid != null && (StringUtils.isBlank(objDocumento.getNumeroDocumento()) || objDocumento.getEnumerado().equals(Constantes.No))) {

				Integer idunidad = unid.getIdunidad();

				try {
					if (log.isDebugEnabled()) {
						log.debug("Buscando numeracion con idunidad [" + idunidad + "] idtipodocumento [" + idtipodoc + "]");
					}

					List<Numeracion> listaNum=numeracionService.findAllUnidadAndTipoDoc(idunidad,idtipodoc);

					if (listaNum != null && listaNum.size() > 0 && listaNum.get(0).getTiponumeracion() != null) {

						log.debug("StringUtils.isBlank(objDocumento.getNumeroDocumento() ): " + StringUtils.isBlank(objDocumento.getNumeroDocumento()));
						log.debug("objDocumento.getNumeroDocumento().equals(.+Constantes.NRODCUMENTO_SIN_NUMERO) :" + objDocumento.getNumeroDocumento().equals("." + Constantes.NRODCUMENTO_SIN_NUMERO));

						if (listaNum.get(0).getTiponumeracion().toString().equals(Constantes.TIPO_NUMERACION_AUTOMATICA)) {

							objDocumento.setNumeroDocumento(listaNum.get(0).formatearNumero());
							listaNum.get(0).setNumeroactual(listaNum.get(0).getNumeroactual() + 1);
							numeracionService.guardarObj(listaNum.get(0));
							unid = null;

						} else if (listaNum.get(0).getTiponumeracion().toString().equals(Constantes.TIPO_NUMERACION_SIN_NUMERACION)
								&& (StringUtils.isBlank(objDocumento.getNumeroDocumento())
										|| objDocumento.getNumeroDocumento().equals("." + Constantes.NRODCUMENTO_SIN_NUMERO))) {
							objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);
							break;

						} else if (listaNum.get(0).getTiponumeracion().toString().equals(Constantes.TIPO_NUMERACION_MANUAL)
								&& (StringUtils.isBlank(objDocumento.getNumeroDocumento())
										|| objDocumento.getNumeroDocumento().equals("." + Constantes.NRODCUMENTO_SIN_NUMERO))) {

							objDocumento.setNumeroDocumento(Constantes.NRODCUMENTO_SIN_NUMERO);
							break;
						}

					} else {
						log.info("No hay resultado para la numeracion idtipodoc:" + idtipodoc + " idunidad:" + idunidad);
						unid = unid.getDependencia();
						log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
					}
				} catch (NoResultException nre) {
					log.warn("No se encontro numeracion para idTipoDocumento [" + idtipodoc + "] idUnidad [" + idunidad + "]");
					unid = unid.getDependencia();
					log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
				} catch (Exception ex) {
					log.error(ex.getMessage(), ex);
				}
			}


			if (StringUtils.isBlank(objDocumento.getNumeroDocumento())) {
				objDocumento.setNumeroDocumento("." + Constantes.NRODCUMENTO_SIN_NUMERO);
			}

			objDocumento.setEnumerado(Constantes.Si);
			documentoDao.updateDocumento(objDocumento);

		}
		return objDocumento;
	}

	/**REN Numera los documentos de Word con el nmero generado ---------------------------------------------------------------*/
	@Override
	public boolean numerarDocumentoFisico(Usuario usuario, Documento documento, int whatToDo) {
		log.debug("-> [Service] DocumentoService - numerarDocumentoFisico():boolean ");
		
		log.debug("Numerando documentos fisicos");
		List<Archivo> archivos = archivoService.findLstByIdDocumento(documento.getIdDocumento());

		if (archivos != null && archivos.size() > 0) {
			for (Archivo archivoObj : archivos) {
				if (archivoObj.getNombreArchivo().endsWith(".doc") || archivoObj.getNombreArchivo().endsWith(".DOC")) {
					String rutaAlfresco = repositorioService.obtenerRutaExpediente(documento.getExpediente());
					String archivo = archivoObj.getNombreArchivo();
					String rutaDestino = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL_ALFRESCO);

					if (!rutaDestino.endsWith("/")) {
						rutaDestino += "/";
					}

					if (!rutaAlfresco.endsWith("/")) {
						rutaAlfresco += "/";
					}

					if (alfrescoWebServiceClient.descargarArchivo(rutaAlfresco, archivo, rutaDestino)) {
						log.debug("Se guardo el archivo {} en la ruta {}", archivo, rutaDestino);
						Map<String, Object> campos = new HashMap<String, Object>();

						campos.put("BOOKMARK", "osinumero");
						campos.put("TEXTO", documento.getNumeroDocumento());
						File fisico = new File(rutaDestino + archivo);
						log.debug("Inicio de la modificacion del Template");
						boolean resp = TemplateUtils.modifyDocument(fisico.getAbsolutePath(), campos, whatToDo);
						log.debug("Termino de la modificacion del Template");

						if (resp) {
							log.info("Se enumero el documento fisico {}", documento.getNumeroDocumento());
							String urlCompleteSpaceExpediente = repositorioService.obtenerRutaCompletaExpediente(documento.getExpediente());
							alfrescoWebscriptClient.modificarContenidoArchivo(usuario, fisico, urlCompleteSpaceExpediente, archivo);
						}

						fisico.delete();
						log.info("Eliminado el archivo " + rutaDestino + archivo);

						if (!resp) {
							return resp;
						}
					}
				}
			}
		}

		return true;
	}

	@Override
	public boolean firmarDocumentoFisico(Usuario usuario, Documento documento, int whatToDo) {
		log.debug("-> [Service] DocumentoService - firmarDocumentoFisico():boolean ");
		
		List<Archivo> archivos = documento.getArchivos();

		if (archivos != null && archivos.size() > 0) {
			for (Archivo archivoObj : archivos) {
				if (archivoObj.getNombreArchivo().endsWith(".doc") || archivoObj.getNombreArchivo().endsWith(".DOC")) {
					String rutaAlfresco = repositorioService.obtenerRutaExpediente(documento.getExpediente());
					String archivo = archivoObj.getNombreArchivo();
					String rutaDestino = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL_ALFRESCO);

					if (!rutaDestino.endsWith("/")) {
						rutaDestino += "/";
					}

					if (!rutaAlfresco.endsWith("/")) {
						rutaAlfresco += "/";
					}

					if (alfrescoWebServiceClient.descargarArchivo(rutaAlfresco, archivo, rutaDestino)) {
						File fisico = new File(rutaDestino + archivo);
						Map<String, Object> metadataFirma = this.getMetadataFirma(documento, rutaDestino + archivo);
						boolean resp = TemplateUtils.modifyDocument(fisico.getAbsolutePath(), metadataFirma, whatToDo);

						if (resp) {
							log.info("El documento fue modificado con una firma");
							String urlCompleteSpaceExpediente = repositorioService.obtenerRutaCompletaExpediente(documento.getExpediente());
							alfrescoWebscriptClient.modificarContenidoArchivo(usuario, fisico, urlCompleteSpaceExpediente, archivo);
						}

						fisico.delete();

						if (metadataFirma != null) {
							File firmaDigital = (File) metadataFirma.get("file");

							if (firmaDigital != null) {
								firmaDigital.delete();
							}
						}

						log.info("Eliminado el archivo " + rutaDestino + archivo);

						if (!resp) {
							return resp;
						}
					}
				}
			}
		}

		return true;
	}

	@Override
	public Map<String, Object> getMetadataFirma(Documento documento, String rutaArchivo) {
		log.debug("-> [Service] DocumentoService - getMetadataFirma():Map<String, Object> ");
		
		byte[] firmaDigitalData = null;
		File fFirmaDigital = null;
		Map<String, Object> metadataFirma = new HashMap<String, Object>();
		Parametro bookmarkFirma = parametroDao.findByTipoUnico(Constantes.PARAMETRO_TIPO_BOOKMARKFIRMA);
		Usuario firmante = documento.getFirmante();
		StringBuilder sbRutaFirmaDigital = new StringBuilder(SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL_ALFRESCO)).append("/firmaDigital");

		if (firmante == null) {
			log.info("No se inserto firma en el archivo [" + rutaArchivo + "] pues no hay firmante para el documento [" + documento.getIdDocumento() + "]");

			return null;
		}

		if (log.isDebugEnabled()) {
			log.debug("Firmante [" + firmante.getUsuario() + "]");
		}

		if ((firmaDigitalData = documentoDao.getFirmaDigital(firmante)) == null) {
			log.info("No se inserto firma en el archivo [" + rutaArchivo + "] pues no hay firma digital en la BD asociado al firmante [" + firmante.getUsuario() + "]");

			return null;
		}

		FileOutputStream fos = null;
		try {
			fFirmaDigital = new File(sbRutaFirmaDigital.toString());
			fos = new FileOutputStream(fFirmaDigital);
			fos.write(firmaDigitalData);
		} catch (IOException ioe) {
			log.error(ioe.getMessage(), ioe);

			return null;
		} finally {
			if (fos != null) {
				try {
					fos.close();
				} catch (IOException ex) {
				}
			}
		}

		metadataFirma.put("file", fFirmaDigital);
		metadataFirma.put("bookmarkFirma", bookmarkFirma.getValor());
		metadataFirma.put("rutaArchivo", rutaArchivo);
		metadataFirma.put("rutaFirmaDigital", sbRutaFirmaDigital.toString());

		return metadataFirma;
	}

	public List<DocumentoList> getDocumentList(List<Documento> lstD, String strRol) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - getDocumentList():List<DocumentoList> ");
		
		try {
			List<DocumentoList> lstDL = new ArrayList<DocumentoList>();
			Trazabilidaddocumento objT;
			for (Documento objD : lstD) {
				DocumentoList objDL = new DocumentoList(objD.getIdDocumento(), (objD.getExpediente() != null && objD.getExpediente().getAsunto() != null ? objD.getExpediente().getAsunto() : objD.getAsunto()), (objD.getTipoDocumento() != null && objD.getTipoDocumento().getNombre() != null ? objD.getTipoDocumento().getNombre() : objD.getNombreTipoDocumento()) + " - " + (objD.getNumeroDocumento() != null ? objD.getNumeroDocumento() : objD.getNroexpediente()));
				if (objD.getExpediente() != null && objD.getExpediente().getConcesionario() != null) {
					objDL.setStrCorrentista(objD.getExpediente().getConcesionario().getRazonSocial());
				}
				objDL.setStrFecha(objD.getFechaAccion());
				if (objD.getExpediente() != null) {
					objDL.setExpediente(objD.getExpediente());
				}
				objT = trazabilidadDocumentoService.findByMaxNroRegistro(objD.getIdDocumento(), Constantes.ACCION_CONSULTAR, null, null);
				if (strRol.equals(Constantes.ROL_MESA_PARTES) && objD.getExpediente() != null) {
					objDL.setStrRemitente(objD.getExpediente().getCliente().getRazonSocial());
				} else {
					objDL.setStrRemitente(objT.getRemitente().getNombres() + " " + objT.getRemitente().getApellidos());
				}
				objDL.setSAccion(objD.getAccion().getNombre());
				lstDL.add(objDL);
			}
			return lstDL;
		} catch (RuntimeException re) {
			log.error("", re);
			return null;
		}
	}

	@Override
	public List<DocumentoList> getDocuments(Usuario usuario, char habilitado) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - getDocuments():List<DocumentoList> ");
		
		try {
			List<Documento> lstD;
			String sTempo = null;
			Usuario objUsuario = usuarioService.findByIdUsuario(usuario.getIdusuario());
			Perfil objPerfil = (objUsuario.getRol() != null ? objUsuario.getRol().getIdperfil() : usuario.getRol().getIdperfil());
			Sede objSede = objUsuario.getUnidad().getSede();
			if (objPerfil.getNombre().equals(Constantes.PERFIL_MP) || objPerfil.getNombre().equals(Constantes.PERFIL_DIG) || objPerfil.getNombre().equals(Constantes.PERFIL_QAS)) {
				sTempo = "todo";
			}
			// El rol MP es lector de los documentos de Digitalizador
			if (objPerfil.getNombre().equals(Constantes.PERFIL_MP)) {
				// la accion para los documentos de mesa de partes es REGISTRAR
				int accion = accionService.findByNombre(Constantes.ACCION_REGISTRAR).getIdAccion();
				lstD = documentoDao.findByIdPropietario(null, null, Constantes.ROL_DIGITALIZADOR, habilitado, Constantes.DOCUMENTO_PRINCIPAL, sTempo, objSede.getIdsede(), accion, 0);
			} else {
				lstD = documentoDao.findByIdPropietario(usuario.getIdusuario(), null, null, habilitado, Constantes.DOCUMENTO_PRINCIPAL, sTempo, objSede.getIdsede(), 0, 0);
			}
			return this.getDocumentList(lstD, objPerfil.getNombre());
		} catch (RuntimeException re) {
			log.error(re.getMessage(), re);
			return null;
		}
	}

	public String fillContenido(DocumentoDetail objDD) {
		log.debug("-> [Service] DocumentoService - fillContenido():String ");
		
		try {
			String contenido = "Ud. ha registrado un " + objDD.getStrTipoDocumento() + " Nro. " + objDD.getStrNroDocumento() + " el dia " + objDD.getStrFecha() + " de " + objDD.getStrRemitente() + ", referente al proceso " + objDD.getStrProceso() + ".\n\r"; 
			if(!objDD.getCodProceso().equals(Constantes.CODIGO_COMUNICACIONES_INT)){
				contenido += "El cliente " + objDD.getStrRazonSocial() + " se identifica con " + objDD.getStrTipoIdentificacion() + ": " + objDD.getStrNroIdentificacion() + " y direcci&oacute;n domiciliaria " + objDD.getStrDireccionPrincipal() + ".";
			}
			return contenido; 
		} catch (RuntimeException re) {
			log.error("", re);
			return null;
		}
	}

	@Override
	@Transactional
	public void rechazarQAS(Integer iIdDocumento, String sObservacion, Usuario objRemitente) {
		log.debug("-> [Service] DocumentoService - rechazarQAS():void ");
		
		try {
			Accion objAccion = null;
			Documento objDocumento = null;
			Usuario objUsuario = usuarioService.findByIdUsuario(objRemitente.getIdusuario());
			Sede objSede = objUsuario.getUnidad().getSede();
			//Sede objSede = unidadService.buscarObjPor(objRemitente.getUnidad().getIdunidad()).getSede();
			objAccion = accionService.findByNombre(Constantes.ACCION_RECHAZARQAS);
			objDocumento = this.findByIdDocumento(iIdDocumento);
			// Actualizando datos del documento
			objDocumento.setPropietario(usuarioService.findByUsuario(Constantes.USUARIO_DIGITALIZADOR, objSede.getIdsede()));
			objDocumento.setRemitente(objRemitente.getNombres() + " " + objRemitente.getApellidos());
			objDocumento.setAccion(objAccion);
			objDocumento.setObservacionRechazo(sObservacion);
			objDocumento.setFechaAccion(new Date());
			objDocumento = this.saveDocumento(objDocumento);

			if (objDocumento.getArchivos() != null) {
				for (Archivo archivo : objDocumento.getArchivos()) {
					//archivo.setEstadoDigitalizacion(Archivo.ESTADO_DISPONIBLE);
					if (archivo.getEstadoDigitalizacion() != Constantes.ARCHIVO_ESTADO_DIGITALIZACION_INACTIVO) {
						archivo.setEstadoDigitalizacion(Constantes.ARCHIVO_ESTADO_DIGITALIZACION_RECHAZADO);
					}
					archivoService.saveArchivo(archivo);
				}
			}

			// Grabando trazabilidad
			trazabilidadDocumentoService.saveTrazabilidadDocumento(objDocumento, objRemitente, false, false);
			//archivoService.updateEstadoByDocumento(iIdDocumento, Constantes.ARCHIVO_ESTADO_DIGITALIZACION_RECHAZADO);
			log.debug("Documento rechazado correctamente");
			log.debug("Nuevo propietario [" + objDocumento.getPropietario().getNombres() + " " + objDocumento.getPropietario().getApellidos() + "]");
		} catch (RuntimeException re) {
			log.error("", re);
		}
	}

	@Deprecated //usar el metodo sobrecargado
	@Override
	@Transactional
	public void registrarDIG(Integer iIdDocumento, Map<String, List<ArchivoTemporal>> mapUpload, Usuario objRemitente) {
		log.debug("-> [Service] DocumentoService - registrarDIG():void DEPRECATED");
		
		Accion objAccion = accionService.findByNombre(Constantes.ACCION_DIGITALIZAR);
		Documento objDocumento = this.findByIdDocumento(iIdDocumento);
		List<ArchivoTemporal> lstArchivoTemporal = null;
		Sede objSede = sedeDao.getSedePorUuario(objRemitente);

		if (mapUpload != null) {
			log.debug("Trabajando con upload2 - Archivos rechazados");
			lstArchivoTemporal = mapUpload.get("upload2");
			log.debug("Inactivando archivos del Documento con ID [" + iIdDocumento + "]");
			archivoService.updateEstadoByDocumento(iIdDocumento, Constantes.ARCHIVO_ESTADO_DIGITALIZACION_INACTIVO);

			if (lstArchivoTemporal != null) {
				for (ArchivoTemporal objArchivoTemporal : lstArchivoTemporal) {
					Archivo objArchivo = null;
					objArchivo = archivoService.findByCriteria(iIdDocumento, objArchivoTemporal.getFArchivo().getName());
					log.debug("Reactivando archivo [" + objArchivoTemporal.getFArchivo().getName() + "] con ID [" + objArchivo.getIdArchivo() + "]");
					archivoService.updateEstadoByArchivo(objArchivo.getIdArchivo(), Constantes.ARCHIVO_ESTADO_DIGITALIZACION_YES);
				}
			}

			log.debug("Trabajando con upload1 - Nuevos archivos");
			lstArchivoTemporal = mapUpload.get("upload1");

			if (lstArchivoTemporal != null) {
				log.debug("Numero de archivos a mover [" + lstArchivoTemporal.size() + "]");
				// Grabando los archivos temporales a la Base de Datos. Nueva
				// carpeta : IrisPDFIn
				archivoService.saveArhivoFromSessionToDB(lstArchivoTemporal, objDocumento, objRemitente);
			} else {
				log.warn("No hay archivos nuevos");
			}
		}

		objDocumento.setPropietario(usuarioService.findByUsuario(Constantes.USUARIO_QAS, objSede.getIdsede()));
		objDocumento.setRemitente(objRemitente.getNombres() + " " + objRemitente.getApellidos());
		objDocumento.setAccion(objAccion);
		objDocumento.setFechaAccion(new Date());
		this.saveDocumento(objDocumento);
		trazabilidadDocumentoService.saveTrazabilidadDocumento(objDocumento, objRemitente, false, false);
		log.info("Documento registrado desde DIG. Nuevo propietario [" + objDocumento.getPropietario().getNombres() + " " + objDocumento.getPropietario().getApellidos() + "]");
		// Registrar Trazabilidad Expediente
		Usuario objDestinatario = usuarioService.findByUsuario(Constantes.USUARIO_QAS, objSede.getIdsede());

		if (objDocumento.getExpediente().getProceso().getTipoproceso().getNombre().equalsIgnoreCase("stor")) {
			char tipoDocumento = documentoDao.findByIdDocumento(iIdDocumento).getPrincipal();
			log.debug("Tipo de Documento [" + tipoDocumento + "]");
			if (tipoDocumento == 'S') {
				log.debug("REGISTRAR TRAZABILIDAD EXPEDIENTE: DIG - QAS");
				trazabilidadExpedienteService.saveTrazabilidadExpediente(objDocumento.getExpediente(), objRemitente, objDestinatario, objAccion, "");
			} else {
				log.debug("INGRESO DE DOCUMENTO ADICIONAL: NO SE REGISTRA TRAZABILIDAD EXPEDIENTE");
			}
		}
	}

	@Override
	@Transactional
	public void registrarDIG(Integer iIdDocumento, Map<String, List<ArchivoTemporal>> mapUpload, Usuario objRemitente, String observacionDIG) {
		log.debug("-> [Service] DocumentoService - registrarDIG():void ");
				
		Accion objAccion = accionService.findByNombre(Constantes.ACCION_DIGITALIZAR);
		Documento objDocumento = this.findByIdDocumento(iIdDocumento);
		List<ArchivoTemporal> lstArchivoTemporal = null;
		Sede objSede = sedeDao.getSedePorUuario(objRemitente);

		if (mapUpload != null) {
			log.debug("Trabajando con upload2 - Archivos rechazados");
			lstArchivoTemporal = mapUpload.get("upload2");
			log.debug("Inactivando archivos del Documento con ID [" + iIdDocumento + "]");
			archivoService.updateEstadoByDocumento(iIdDocumento, Constantes.ARCHIVO_ESTADO_DIGITALIZACION_INACTIVO);

			if (lstArchivoTemporal != null) {
				for (ArchivoTemporal objArchivoTemporal : lstArchivoTemporal) {
					Archivo objArchivo = null;
					objArchivo = archivoService.findByCriteria(iIdDocumento, objArchivoTemporal.getFArchivo().getName());
					log.debug("Reactivando archivo [" + objArchivoTemporal.getFArchivo().getName() + "] con ID [" + objArchivo.getIdArchivo() + "]");
					archivoService.updateEstadoByArchivo(objArchivo.getIdArchivo(), Constantes.ARCHIVO_ESTADO_DIGITALIZACION_YES);
				}
			}

			log.debug("Trabajando con upload1 - Nuevos archivos");
			lstArchivoTemporal = mapUpload.get("upload1");

			if (lstArchivoTemporal != null) {
				log.debug("Numero de archivos a mover [" + lstArchivoTemporal.size() + "]");
				// Grabando los archivos temporales a la Base de Datos. Nueva
				// carpeta : IrisPDFIn
				archivoService.saveArhivoFromSessionToDB(lstArchivoTemporal, objDocumento, objRemitente);
			} else {
				log.warn("No hay archivos nuevos");
			}
		}

		objDocumento.setPropietario(usuarioService.findByUsuario(Constantes.USUARIO_QAS, objSede.getIdsede()));
		objDocumento.setRemitente(objRemitente.getNombres() + " " + objRemitente.getApellidos());
		objDocumento.setAccion(objAccion);
		objDocumento.setFechaAccion(new Date());
		objDocumento.setObservacionDigitalizador(observacionDIG);
		this.saveDocumento(objDocumento);
		trazabilidadDocumentoService.saveTrazabilidadDocumento(objDocumento, objRemitente, false, false);
		log.info("Documento registrado desde DIG. Nuevo propietario [" + objDocumento.getPropietario().getNombres() + " " + objDocumento.getPropietario().getApellidos() + "]");
		// Registrar Trazabilidad Expediente
		Usuario objDestinatario = usuarioService.findByUsuario(Constantes.USUARIO_QAS, objSede.getIdsede());

		if (objDocumento.getExpediente().getProceso().getTipoproceso().getNombre().equalsIgnoreCase("stor")) {
			char tipoDocumento = documentoDao.findByIdDocumento(iIdDocumento).getPrincipal();
			log.debug("Tipo de Documento [" + tipoDocumento + "]");
			if (tipoDocumento == 'S') {
				log.debug("REGISTRAR TRAZABILIDAD EXPEDIENTE: DIG - QAS");
				trazabilidadExpedienteService.saveTrazabilidadExpediente(objDocumento.getExpediente(), objRemitente, objDestinatario, objAccion, "");
			} else {
				log.debug("INGRESO DE DOCUMENTO ADICIONAL: NO SE REGISTRA TRAZABILIDAD EXPEDIENTE");
			}
		}
	}

	public List<Archivo> getArchivoList(Integer iIdDoc) {
		log.debug("-> [Service] DocumentoService - getArchivoList():List<Archivo> ");
		
		Map<String, List<Archivo>> archivos = archivoService.findByIdDocumento(iIdDoc);
		if (archivos != null) {
			return archivos.get("upload1");
		}
		return null;
	}

	@Transactional
	public void aplicarPlazosADocumentoPrincipal(DocumentoDetail objDD, Documento objDocumento, boolean bResponsable, Integer iIdDestinatario, String sOpcion, Usuario objUsuario, Date fechaLimiteAtencionAnterior,Boolean horarioPermitido) {
		log.debug("-> [Service] DocumentoService - aplicarPlazosADocumentoPrincipal():void ");
		
		Date dNuevaFechaLimiteAtencion = new Date();
		
		Integer iPlazoDia = (objDD.getIPlazoDia() == null) ? 0 : objDD.getIPlazoDia();
		Integer iPlazoHora = (objDD.getIPlazoHora() == null) ? 0 : objDD.getIPlazoHora();
		SimpleDateFormat formatDate = new SimpleDateFormat("yyyy-MM-dd HH:mm");
		log.debug("Plazo Dia [" + iPlazoDia + "] Hora [" + iPlazoHora + "] Fecha Limite Atencion [" + objDD.getStrFechaLimiteAtencion() + "]");

		// Se solicito validar el remitente al momento de derivar. Si se deriva al remitente, persiste la fehca limite anterior
		log.debug("iId Remitente [" + objUsuario.getIdusuario() + "] Nuevo propietario [" + objDocumento.getPropietario().getIdusuario() + "]");

		if (   objUsuario.getIdusuario() != objDocumento.getPropietario().getIdusuario().intValue()) {			
			// Modificado por Germn Enrquez
			// calculo por dias
			
			if(objDD.getStrSinPlazo().equals(Constantes.SIN_PLAZO)){
				log.debug("transferir sin Plazo");
				objDocumento.setPlazo(0);
				objDocumento.setFechaLimiteAtencion(null);
				
			}else{
				if (objDD.getStrFechaLimiteAtencion() != null && !objDD.getStrFechaLimiteAtencion().equals("")) {
					log.debug("calculo con fecha ");
					Date fechaActual = new Date(0);
					objDocumento.setPlazo(0);
					Calendar base = Calendar.getInstance();
					log.debug("fechaActual"+fechaActual);
					try {
						// Deprecated!!! corregido por Germn Enrquez					
						fechaActual = formatDate.parse(objDD.getStrFechaLimiteAtencion() + " " + base.get(Calendar.HOUR_OF_DAY) + ":" + base.get(Calendar.MINUTE) + ":" + base.get(Calendar.SECOND));
						
						//corregido wcarrasco;					
						dNuevaFechaLimiteAtencion = fechaLimite.calcularFechaLimite(fechaActual,iIdDestinatario);

						objDocumento.setFechaLimiteAtencion(dNuevaFechaLimiteAtencion);
					} catch (ParseException e) {
						log.error("Error parseando la fecha: " + fechaActual.toString(), e);
					}
				} else {
					log.debug("calculo con horas");
					dNuevaFechaLimiteAtencion = fechaLimite.calcularFechaLimite(iPlazoDia, iPlazoHora, iIdDestinatario);
					objDocumento.setPlazo(0);
					// objDocumento.setPlazo(iPlazoHora);
					if (sOpcion != null && sOpcion.equals(Constantes.RECHAZAR)) {
					} else {
						objDocumento.setFechaLimiteAtencion(dNuevaFechaLimiteAtencion);
					}

				}// fin de calculo por dias
				
			}
			
			
		}else{//cuando un usuario se deriva a si mismo un documento
			objDocumento.setFechaLimiteAtencion(fechaLimiteAtencionAnterior);
		}
		log.debug(" Nueva Fecha Limite Atencion [" + objDocumento.getFechaLimiteAtencion() + "]");
		log.debug("VALOR DE FLAG RESPONSABLE: " + bResponsable);

		objDD.setDelegado(false);

		if (bResponsable) {
			if (iIdDestinatario != null) {
				Usuario usu = usuarioService.findByIdUsuario(iIdDestinatario);
				Expediente objE = objDocumento.getExpediente();
				objE.setIdpropietario(usu);
				expedienteService.saveExpediente(objE);
			}
		}

		
        Trazabilidaddocumento trazdoc = trazabilidadDocumentoService.findByMaxNroRegistro(objDocumento.getIdDocumento(), "derivar", null, null);     
        trazdoc.setFechalimiteatencion(objDocumento.getFechaLimiteAtencion());

        	saveDocumento(objDocumento);	

						
		if(horarioPermitido == false){			
		        log.debug("Transferir fuera de horario ");
		        dNuevaFechaLimiteAtencion = new Date();
			    dNuevaFechaLimiteAtencion = fechaLimite.fechaFueraHorarioHabil(dNuevaFechaLimiteAtencion,iIdDestinatario);			    			
				objDocumento.setFechaAccion(dNuevaFechaLimiteAtencion);
				trazdoc.setFechacreacion(dNuevaFechaLimiteAtencion);	
		}		

			trazabilidadDocumentoService.saveTrazabilidadDocumento(trazdoc);	

		
		
	}

	public String[] obtenerListaFeriados() {
		log.debug("-> [Service] DocumentoService - obtenerListaFeriados():String[] ");
		
		SimpleDateFormat formatDateHHmm = new SimpleDateFormat("yyyy-MM-dd HH:mm");
		String[] theStringArray = null;
		List<String> theStrings = new ArrayList<String>();
		List<DiaFestivo> arrFeriadoss = diaFestivoService.ViewAll();
		for (int i = 0; i < arrFeriadoss.size(); i++) {
			DiaFestivo busdiafestivo = arrFeriadoss.get(i);
			theStrings.add(formatDateHHmm.format(busdiafestivo.getFechanolaborable()));
			theStringArray = theStrings.toArray((String[]) Array.newInstance(java.lang.String.class, theStrings.size()));
		}
		return theStringArray;
	}

	@Transactional
	public void aplicarPlazosADocumentoPrincipalOLd(DocumentoDetail objDD, Documento objDocumento, boolean bResponsable, Integer iIdDestinatario) {
		log.debug("-> [Service] DocumentoService - aplicarPlazosADocumentoPrincipalOLd():void ");
		
		Calendar calendar = new GregorianCalendar();
		Date fecha = null;
		Date trialTime = new Date();
		Integer iPlazoDia = (objDD.getIPlazoDia() == null) ? 0 : objDD.getIPlazoDia();
		Integer iPlazoHora = (objDD.getIPlazoHora() == null) ? 0 : objDD.getIPlazoHora();
		SimpleDateFormat formatoFecha = new SimpleDateFormat("yyyy-MM-dd");
		String sFechaLimiteAtencion = objDD.getStrFechaLimiteAtencion();
		log.debug("Plazo Dia [" + iPlazoDia + "] Hora [" + iPlazoHora + "] Fecha Limite Atencion [" + sFechaLimiteAtencion + "]");
		// /////////////////////////////////////////////////
		// String arrFeriados[] = {"01/05/2009"}; //Llenar este arreglo haciendo
		// un query a la tabla DIA FESTIVO con la condicion de la REGION
		// String arrFeriados[]=null;
		// Date
		// dNuevaFechaLimiteAtencion=Calculator.getEarliestNonExcludedDate(iPlazoDia,iPlazoHora,new
		// Date(),null,arrFeriados);
		// /////////////////////////////////////////////////
		calendar.setTime(trialTime);
		if (!sFechaLimiteAtencion.equals("")) {
			log.debug("calculo con fecha ");
			objDD.setStrPlazo(0);
		} else {
			log.debug("calculo con horas");
			int horasxdia = (iPlazoDia * 24) + iPlazoHora;
			String fechaInicio = formatoFecha.format(calendar.getTime());
			calendar.add(Calendar.HOUR_OF_DAY, horasxdia);
			String fechaFinal = formatoFecha.format(calendar.getTime());
			String diasNoAbiles = this.diasNoLaborables(fechaInicio, fechaFinal);
			// String diasNoAbiles = "0";
			log.debug("diasNoLaborables== " + diasNoAbiles);
			if (!diasNoAbiles.equals("0")) {
				log.debug("si");
				int horasLaborables = horasxdia + (Integer.parseInt(diasNoAbiles) * 24);
				Calendar fechaLinAten = new GregorianCalendar();
				fechaLinAten.setTime(trialTime);
				fechaLinAten.add(Calendar.HOUR_OF_DAY, horasLaborables);
				objDD.setStrPlazo(horasxdia);
				log.debug("numero de horas " + horasxdia);
				objDD.setStrFechaLimiteAtencion(formatoFecha.format(fechaLinAten.getTime()));
				log.debug("fecha de plazo " + formatoFecha.format(fechaLinAten.getTime()));
			} else {
				log.debug("no");
				log.debug("numro de horas " + horasxdia);
				objDD.setStrPlazo(horasxdia);
				log.debug("fecha de plazo " + formatoFecha.format(calendar.getTime()));
				objDD.setStrFechaLimiteAtencion(formatoFecha.format(calendar.getTime()));
				log.debug("final de calculo");
			}
		}
		SimpleDateFormat formatoDelTexto = new SimpleDateFormat("yyyy-MM-dd HH:mm");
		try {
			fecha = formatoDelTexto.parse(objDD.getStrFechaLimiteAtencion() + " " + new SimpleDateFormat("HH:mm").format(new Date()));
		} catch (Exception ex) {
			log.error(ex.getMessage(), ex);
		}
		objDocumento.setPlazo(objDD.getStrPlazo());
		objDocumento.setFechaLimiteAtencion(fecha);
		// Inicio Modificacion - Responsable: Victor Soria
		log.debug("VALOR DE FLAG RESPONSABLE: " + bResponsable);
		objDD.setDelegado(false);
		if (bResponsable) {
			if (iIdDestinatario != null) {
				Usuario usu = usuarioService.findByIdUsuario(iIdDestinatario);
				Expediente objE = objDocumento.getExpediente();
				// objDD.setDelegado(true);
				// objDD.setUsuarioDelegado(usu);
				objE.setIdpropietario(usu);
				expedienteService.saveExpediente(objE);
			}
		}
		/*
		 * if (objDD.isDelegado()) { //Expediente objEAux =
		 * getDao().findByIdExpediente(objDD.getiidex);
		 * objE.setIdpropietario(objDD.getUsuarioDelegado()); } else { if
		 * (objDD.getIIdExpediente() != null) { Expediente objEAux =
		 * getDao().findByIdExpediente(objDD.getIIdExpediente());
		 * objE.setIdpropietario(objEAux.getIdpropietario()); } }
		 */
		// Fin modificacion
		this.saveDocumento(objDocumento);
	}

	@SuppressWarnings("unused")
	@Transactional
	public void aplicarProcesoStor(DocumentoDetail objDD, Usuario objUsuario, String strAccion) throws Exception {
		log.debug("-> [Service] DocumentoService - aplicarProcesoStor():void ");
		
		Boolean bAplicarProceso = true;
		Documento objD = documentoDao.findByIdDocumento(objDD.getIIdDocumento());
		Expediente objExpediente = null;
		String strUsuarioIntalio = Constantes.PROCESO_USUARIO_STOR + objUsuario.getUsuario();
		String sCodigoProceso = null;
		//try{
			log.debug("** Intentando aplicar proceso STOR **");
			if (objD == null) {
				log.error("El Documento con ID [" + objDD.getIIdDocumento() + "] es [" + objD + "]");
				throw new RuntimeException();
			}
			objExpediente = objD.getExpediente();
			log.debug("Expediente asociado con ID [" + objExpediente.getIdexpediente() + "] Nro Expediente [" + objExpediente.getNroexpediente() + "]");
			// sTipoProceso = objD.getExpediente().getProceso().getNombre();
			log.debug("Id de Proceso - en data ObjDD: " + objDD.getIIdProceso());
			sCodigoProceso = procesoDao.findByIdProceso(objDD.getIIdProceso()).getCodigo();
			log.debug("Codigo de Proceso [" + sCodigoProceso + "]");
			if (sCodigoProceso == null) {
				log.error("No existe codigo asignado al proceso");
				bAplicarProceso = false;
			}
			Usuario objU = null;
			// if (objUsuario.getRol().getIdperfil().getNombre().equals("qas"))
			// {
			Rol rol = objUsuario.getRol();
			if (rol != null) {
				if (rol.getNombre().equals(Constantes.ROL_QAS)) {
					// actualizarDatosAdicionalesDocStor(objD, strAccion);
					char tipoDocumento = objD.getPrincipal();
					log.debug("Tipo de Documento [" + tipoDocumento + "]");
					switch (tipoDocumento) {
					case 'S':
						objU = objD.getExpediente().getProceso().getResponsable();
						log.debug("Propietario al iniciar Proceso STOR: " + objU.getUsuario());
						Accion objAccion = accionService.findByNombre(Constantes.ACCION_REGISTRAR);
						trazabilidadExpedienteService.saveTrazabilidadExpediente(objExpediente, objUsuario, objU, objAccion, "");
						log.debug("Se Registro Trazabilidad de QAS a Scalificador");
						log.debug("Posible Observacion: " + objDD.getStrObservacion());
						break;
					case 'N':
						log.debug("INGRESO DE UN DOCUMENTO ADICIONAL - NO SE CREARA UNA NUEVA INSTANCIA EN INTALIO");
						objU = objD.getExpediente().getIdpropietario();
						log.debug("Propietario al adjuntar documento a un Proceso STOR existente: " + objU.getUsuario());
						break;
					}
				}
			}
			objD.setPropietario(objU); // Nuevo propietario
			this.saveDocumento(objD);
			// trazabilidadDocumentoService.saveTrazabilidadDocumento(objD,
			// objUsuario);
			/*
			 * }catch(RuntimeException e){ bAplicarProceso=false;
			 * log.error(e.getMessage(),e); }
			 */
			log.debug("APLICAR PROCESO STOR [" + bAplicarProceso + "]");
			if (bAplicarProceso) {
				// if
				// (objUsuario.getRol().getIdperfil().getNombre().equals("qas"))
				// {
				if (rol != null) {
					if (rol.getNombre().equals(Constantes.ROL_QAS)) {
						char tipoDocumento = objD.getPrincipal();
						String sTipoExpediente = null;
						if (sCodigoProceso.equalsIgnoreCase(Constantes.PROCESO_STOR_CODIGO_APELACION)) {
							sTipoExpediente = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.INTALIO_PROCESO_STOR_TIPOEXP_APELACION);
						} else if (sCodigoProceso.equalsIgnoreCase(Constantes.PROCESO_STOR_CODIGO_MEDIDACAUTELAR)) {
							sTipoExpediente = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.INTALIO_PROCESO_STOR_TIPOEXP_CAUTELAR);
						} else if (sCodigoProceso.equalsIgnoreCase(Constantes.PROCESO_STOR_CODIGO_QUEJA)) {
							sTipoExpediente = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.INTALIO_PROCESO_STOR_TIPOEXP_QUEJA);
						}
						switch (tipoDocumento) {
						case 'S':
							strUsuarioIntalio = "siged\\" + objUsuario.getUsuario();
							List<Usuario> calificadores = usuarioStorService.getListUsurioStorByRol(Constantes.ROL_USUARIO_SCALIFICADOR_STOR);
							if (calificadores.size() == 1) {
								Usuario userSCalificador = calificadores.get(0);
								String strUserSCalificador = "stor\\" + userSCalificador.getUsuario();
								log.debug("INGRESO DE DOCUMENTO PRINCIPAL - SE CREARA NUEVA INSTANCIA EN INTALIO");
								log.debug("Usuario Intalio [" + strUsuarioIntalio + "]");
								log.debug("Clave [" + objUsuario.getClave() + "]");
								log.debug("Expediente con ID [" + objExpediente.getIdexpediente() + "]");
								log.debug("Tipo de Expediente [" + sTipoExpediente + "]");
								// Actualizar Datos de Stor al antes de iniciar el
								// proceso
								actualizarDatosAdicionalesDocStor(objD, strAccion);
							} else {
								log.error("No se pudo iniciar el proceso STOR debido a que no existe ningun (o mas de un) usuario con el rol de Supervisor Calificador");
							}
							break;
						case 'N':
							log.debug("INGRESO DE UN DOCUMENTO ADICIONAL - NO SE CREARA UNA NUEVA INSTANCIA EN INTALIO");
							break;
						}
					}
				}
			}
	}

	@SuppressWarnings({ "unused", "rawtypes" })
	@Transactional
	@Override
	public Documento derivarDocumento(DocumentoDetail objDD, Usuario objRemitente, Integer iIdDestinatario, String sTipoDerivacion, DocumentoDetail objDDD, List<String> conCopia, String[] strAcciones, Documento documento, String nombrePC,Boolean horarioPermitido) {
		log.debug("-> [Service] DocumentoService - derivarDocumento():Documento ");
		
		Accion objAccion = null;
		Usuario objDestinatario = null;
		Trazabilidaddocumento trazdoc = new Trazabilidaddocumento();
		
		log.debug(" derivar accion : " + objDD.getStrAccion());
		
		objAccion = accionService.findByNombre(objDD.getStrAccion());
		
		if (documento.getContenido() == null) {
			documento.setContenido(objDD.getStrTexto());
		}
		
		documento.getExpediente();
			
		String asunto = null;
		String contenido = null;
		
		if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_NORMAL)) {
			asunto = objDD.getStrAsunto();
			contenido = objDD.getStrContenido();
		} else if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_MASIVO)) {
			asunto = documento.getAsunto();
			String strAux = "<br><br><br><br><br><br>";
			strAux += "<p>--------------- Mensaje Original ---------------</p> " 
				+ "<p>De : " + objDDD.getStrRemitente() + "</p>" 
				+ "<p>Para : " + objDDD.getStrDestinatario() + "</p>" 
				+ "<p>CC : " + "</p>" 
				+ "<p>Enviado : " + objDDD.getStrFecha() + "</p>" 
				+ "<p>Enviado : " + objDDD.getStrAsunto() + "</p>" 
				+ "<p>----------------------------------------------</p>";
			contenido = objDD.getStrTexto() + strAux + " " + this.fillContenido(objDDD);
		}
		
		objDestinatario = usuarioService.findByIdUsuario(iIdDestinatario);
		
		log.debug("asunto:" + objDD.getStrAsunto());
		
		/*List<Documento> documentosExpediente = new ArrayList<Documento>();
		lstDocumento = documentoDao.getDocumentosPorExpediente(objExpediente.getIdexpediente());
		Documento ultimo = lstDocumento.get(0);
		Calendar ultimoDocumento = Calendar.getInstance();
		ultimoDocumento.setTime(ultimo.getFechaCreacion());*/
		/*
		for (Documento doc : lstDocumento) {
			doc.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
			Calendar actual = Calendar.getInstance();
			actual.setTime(doc.getFechaCreacion());
			if (actual.compareTo(ultimoDocumento) > 0) {
				ultimo = doc;
			}
			documentosExpediente.add(doc);
		}
		
		ultimo.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
		*/
		// Derivar todos los documentos del expediente al destinatario

		if ((!documento.getAccion().getNombre().equals(Constantes.ACCION_DIGITALIZAR)) || (documento.getPropietario().getRol() == null))
		{
			documento.setPropietario(objDestinatario);
			documento.setRemitente(objRemitente.getNombres() + " " + objRemitente.getApellidos());
			documento.setAccion(objAccion);

			if (documento.getPrincipal() == Constantes.DOCUMENTO_PRINCIPAL) {
				
				if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_NORMAL)) {
					
					if (documento.getAsunto() == null) {
						documento.setAsunto(asunto);
					}
					if (documento.getContenido() == null) {
						documento.setContenido(contenido);
					}

					documento.setUltimoAsunto(objDD.getStrAsunto());
					
				} else if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_MASIVO)) {
					String strAux = "<br><br><br><br><br><br>";
					strAux += "<p>--------------- Mensaje Original ---------------</p> " + 
					"<p>De : " + objDDD.getStrRemitente() + "</p>" + "<p>Para : " + objDDD.getStrDestinatario() + "</p>" + 
					"<p>CC : " + "</p>" + 
					"<p>Enviado : " + objDDD.getStrFecha() + "</p>" + 
					"<p>Enviado : " + objDDD.getStrAsunto() + "</p>" + 
					"<p>----------------------------------------------</p>";
					if (documento.getContenido() == null) {
						documento.setContenido(objDD.getStrTexto() + strAux + " " + this.fillContenido(objDDD));
					}
				}
				
				documento.setEstadoAlarma('V');
			}
			documento.setFechaAccion(new Date());
		}
		
		documento.setLeido(Constantes.ESTADO_NO_LEIDO);
		documento.setPrioridad(objDD.getPrioridad());
		
		int iDia = documento.getExpediente().getProceso() != null ? documento.getExpediente().getProceso().getTiempoatencion() : 0;
		int iHora = 0;
		if(objDD.getIPlazoDia()!=null)
			iDia = objDD.getIPlazoDia();
		if(objDD.getIPlazoHora()!=null)
			iHora = objDD.getIPlazoDia();
		int iUsuario = documento.getPropietario().getIdusuario(); 
		log.debug(""+documento.getPropietario().getIdusuario());
		Date dFecha = fechaLimite.calcularFechaLimite(iDia,iHora,iUsuario);
		log.debug("fecha Limite atencion documento  antes"+documento.getFechaLimiteAtencion());
		documento.setFechaLimiteAtencion(dFecha);
		log.debug("fecha Limite atencion documento  tiempo atencion despues"+documento.getFechaLimiteAtencion());
		documento = this.saveDocumento(documento);

		log.debug("Generando trazabilidad ID Documento [" + documento.getIdDocumento() + "]");

		if (!documento.getAccion().getNombre().equals(Constantes.ACCION_DIGITALIZAR))   
		{
			trazdoc = trazabilidadDocumentoService.saveTrazabilidadDocumento(documento, objRemitente, iDia, iHora, objDD.getStrFechaLimiteAtencion(), asunto, contenido, strAcciones, nombrePC,horarioPermitido,objDD.getStrSinPlazo());

			Documentoenviado documentoenviado = new Documentoenviado();
			documentoenviado.setIdTrazabilidadEnvio(trazdoc.getIdtrazabilidaddocumento());
			documentoenviado.setUsuario(objRemitente);
			documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
			documentoenviado.setTipoEnvio(""+Constantes.TIPO_ENVIO_TRANSFERIR);
			documentoEnviadoDao.saveDocumento(documentoenviado);

			registrarDerivacionAuditoriaDocumento(documento, objRemitente, objDestinatario, Constantes.TA_DerivarUserFinal, Constantes.TM_UserFinal, objAccion.getNombre().equals(Constantes.TO_Derivar) ? Constantes.TO_Derivar : objAccion.getNombre());
		}

		// Registrando las notificaciones

		documento.setPropietario(objDestinatario);
		
		int iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_REENVIAR;
		int iCCEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_CCREENVIAR;

		if (objAccion.getNombre().equals(Constantes.ACCION_PARA_APROBAR)) {
			iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_PORAPROBAR;
			iCCEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_CCPORAPROBAR;
		} else if (objAccion.getNombre().equals(Constantes.ACCION_APROBAR)) {
			iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_APROBAR;
			iCCEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_CCAPROBAR;
		}

		Set usuariosNotificados = notificacionService.informarViaNotifAndMail(objRemitente, documento, iEvento, Constantes.TIPO_NOTIFICACION_DERIVACION, nombrePC);
		Usuario usuarioReceptor = new Usuario();

		if (conCopia != null) {
			Accion accionCopia = accionService.findByNombre(Constantes.ACCION_COPIAR);
			//int cont = 0;
			for (String sID : conCopia) {
				//cont++;
				if (!StringUtil.isEmpty(sID)) {
					log.debug("Working with ID [" + sID + "]");

					if (sID.startsWith("LISTA")) {
						Integer iID = Integer.valueOf(sID.substring(sID.indexOf("_") + 1));
						Lista objLista = listaService.findByIdLista(iID);

						log.debug("Working with Lista [" + objLista.getNombre() + "]");

						for (Usuario objParticipante : objLista.getParticipanteListaList()) {
							//No se ha enviado notificacion a ese usuario
							if (!usuariosNotificados.contains(objParticipante) && iIdDestinatario.intValue() != iID.intValue()) {
								//wcarrasco 19-10-2010 falta revisar  al derivarDocumento La Fecha Notificacion
								notificacionService.enviarNotificacion(objRemitente, objParticipante, documento, Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA, nombrePC,horarioPermitido, null);
								mailService.ChaskiMail(iCCEvento, objRemitente, objParticipante, documento);
							} //Ya se envio notificacion a ese usuario, modificar el tipo de notificacion a derivacionconcopia
							else {
								notificacionService.updateTipoNotificacion(documento.getIdDocumento(), objParticipante.getIdusuario(), Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA);
							}
						}
					} else {
						Integer iID = Integer.valueOf(sID);
						usuarioReceptor = usuarioService.findByIdUsuario(iID);
						//No se ha enviado notificacion a ese usuario
						if (log.isDebugEnabled()) {
							log.debug("iIdDestinatario [" + iIdDestinatario + "] iID [" + iID + "]");
						}
						//trazabilidadcopiaService.guardarTrazabilidadcopia(trazdoc.getIdtrazabilidaddocumento(), objRemitente, usuarioReceptor, ultimo, accionCopia, objEtapa, Constantes.TIPO_ORIGEN_TRAZADOCUMENTO);
						if (!usuariosNotificados.contains(usuarioReceptor) && iIdDestinatario.intValue() != iID.intValue()) {
							//wcarrasco 19-10-2010 falta revisar  al derivarDocumento La Fecha Notificacion
							notificacionService.enviarNotificacion(objRemitente, usuarioReceptor, documento, Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA, nombrePC,horarioPermitido,null);
							mailService.ChaskiMail(iCCEvento, objRemitente, usuarioReceptor, documento);
						} //Ya se envio notificacion a ese usuario, modificar el tipo de notificacion a derivacionconcopia
						else {
							notificacionService.updateTipoNotificacion(documento.getIdDocumento(), usuarioReceptor.getIdusuario(), Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA);
						}
					}
				}
			}
		}
		log.debug("Nuevo propietario [" + documento.getPropietario().getNombres() + " " + documento.getPropietario().getApellidos() + "]");
		return documento;
	}

	/**
	 * Deriva un documento dado perteneciente a un usuario hacia otro
	 *
	 * @param documento
	 * 			el documento a derivar
	 * @param remitente
	 * 			el propietario del documento
	 * @param destinatario
	 * 			quien recibe el documento
	 * @author German Enriquez
	 */
	@Override
	@Transactional
	public Documento derivarDocumento(Documento documento, Usuario remitente, Usuario destinatario, String nombrePC) {
		log.debug("-> [Service] DocumentoService - derivarDocumento():Documento ");
		
		return derivarDocumento(documento, remitente, destinatario, null, null, nombrePC);
	}

	@Transactional
	public Documento rechazarDocumentoOpcional(Documento documento, Usuario remitente, Usuario destinatario, String nombrePC) {
		log.debug("-> [Service] DocumentoService - rechazarDocumentoOpcional():Documento ");
		
		return rechazarDocumentoOpcional(documento, remitente, destinatario, null, null, nombrePC);
	}

	/**
	 * Deriva un documento dado perteneciente a un usuario hacia otro. Permite derivar un documento con copia a otros usuarios o con copia a un
	 * conjunto de listas de usuarios.
	 *
	 * @param documento
	 * 			el documento a derivar
	 * @param remitente
	 * 			el propietario del documento
	 * @param destinatario
	 * 			quien recibe el documento
	 * @param conCopia
	 * 			la lista de usuarios a los que les llegara la copia del documento
	 * @param listaConCopia
	 * 			conjunto de listas de usuarios a los que les llegara la copia del documento
	 * @author German Enriquez
	 */
	@Transactional
	@Override
	public Documento derivarDocumento(Documento documento, Usuario remitente, Usuario destinatario, List<Usuario> conCopia, List<Lista> listaConCopia, String nombrePC) {
		log.debug("-> [Service] DocumentoService - derivarDocumento():Documento ");
		
		if (documento != null) {
			if (remitente != null) {
				if (destinatario != null) {
					if (documento.getPropietario().equals(remitente)) {
						Expediente expediente = documento.getExpediente();
						if (expediente != null) {
							List<Documento> documentosExpediente = expediente.getDocumentoList();
							// Ponemos como documento principal al mas reciente
							Documento ultimo = documentosExpediente.get(0);
							Calendar ultimoDocumento = Calendar.getInstance();
							ultimoDocumento.setTime(ultimo.getFechaCreacion());
							for (Documento doc : documentosExpediente) {
								doc.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
								Calendar actual = Calendar.getInstance();
								actual.setTime(doc.getFechaCreacion());
								if (actual.compareTo(ultimoDocumento) > 0) {
									ultimo = doc;
								}
							}
							ultimo.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
							// Derivar todos los documentos del expediente al
							// destinatariO
							Accion accion = accionService.findByNombre(Constantes.ACCION_REENVIAR);
							for (Documento documentoAMover : documentosExpediente) {
								documentoAMover.setPropietario(destinatario);
								Object obj = ServletActionContext.getRequest().getSession().getAttribute("UsuarioCompartido");
								if (obj != null) {
									Usuario propietario = (Usuario) obj;
									documentoAMover.setRemitente(propietario.getNombres() + " " + propietario.getApellidos());
								} else {
									documentoAMover.setRemitente(remitente.getNombres() + " " + remitente.getApellidos());
								}
								documentoAMover.setAccion(accion);
								if (documentoAMover.esDocumentoPrincipal()) {
									documentoAMover.setEstadoAlarma('V');
								}
								documentoAMover.setFechaAccion(new Date());
								documentoAMover = saveDocumento(documentoAMover);
								log.debug("Generando trazabilidad Nro Expediente [" + expediente.getNroexpediente() + "] ID Documento [" + documentoAMover.getIdDocumento() + "]");
								Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.guardarTrazabilidad(documentoAMover, remitente, destinatario, accion, nombrePC);
								
								trazabilidadExpedienteService.guardarTrazabilidad(expediente, remitente, destinatario, accion, "");
								if (documentoAMover.esDocumentoPrincipal()) {
									Documentoenviado documentoenviado = new Documentoenviado();
									//wvcarrasco descomentar documentoenviado.setTrazabilidaddocumento(trazabilidad); 
									documentoenviado.setIdTrazabilidadEnvio(trazabilidad.getIdtrazabilidaddocumento());
									documentoenviado.setTipoEnvio(""+Constantes.TIPO_ENVIO_TRANSFERIR);
									documentoenviado.setUsuario(remitente);
									documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
									documentoEnviadoDao.saveDocumento(documentoenviado);
								}
								registrarDerivacionAuditoriaDocumento(documentoAMover, remitente, destinatario, Constantes.TA_DerivarUserFinal, Constantes.TM_UserFinal, Constantes.ACCION_REENVIAR);
							}
							// Registrando las notificaciones
							notificacionService.informarViaNotifAndMail(remitente, ultimo, Constantes.CONFIGNOTIFMAIL_INGRESO_DOCUMENTO_USERFINAL, Constantes.TIPO_NOTIFICACION_DERIVACION, nombrePC);
							if (conCopia != null) {
								for (Usuario usuario : conCopia) {
									//wcarrasco 19-10-2010 falta revisar  al derivarDocumento La Fecha Notificacion
									notificacionService.enviarNotificacion(remitente, usuario, ultimo, Constantes.TIPO_NOTIFICACION_DERIVACION, nombrePC,true,null);
								}
							}
							if (listaConCopia != null) {
								for (Lista lista : listaConCopia) {
									List<Usuario> participantes = lista.getParticipanteListaList();
									for (Usuario usuario : participantes) {
										//wcarrasco 19-10-2010 falta revisar  al derivarDocumento La Fecha Notificacion
										notificacionService.enviarNotificacion(remitente, usuario, ultimo, Constantes.TIPO_NOTIFICACION_DERIVACION, nombrePC,true, null);
									}
								}
							}
							log.info("El documento " + documento + " fue derivado satisfactoriamente por el usuario " + remitente + " hacia el destinatario " + destinatario);
							return ultimo;
						}
						log.error("El documento no pertenece a un expediente. ABORTAR!!!!");
						return null;
					}
					log.error("El usuario " + remitente + " no es propietario del documento " + documento + ", no se deriva el documento.");
					return null;
				}
				log.error("Se debe especificar un destinatario.");
				return null;
			}
			log.error("Se debe especificar un remitente.");
			return null;
		}
		log.error("Se debe especificar un documento a derivar.");
		return null;
	}

	@Transactional
	public Documento rechazarDocumentoOpcional(Documento documento, Usuario remitente, Usuario destinatario, List<Usuario> conCopia, List<Lista> listaConCopia, String nombrePC) {
		log.debug("-> [Service] DocumentoService - rechazarDocumentoOpcional():Documento ");
		
		if (documento != null) {
			if (remitente != null) {
				if (destinatario != null) {
					if (documento.getPropietario().equals(remitente)) {
						Expediente expediente = documento.getExpediente();
						if (expediente != null) {
							List<Documento> documentosExpediente = expediente.getDocumentoList();
							// Ponemos como documento principal al mas reciente
							Documento ultimo = documentosExpediente.get(0);
							Calendar ultimoDocumento = Calendar.getInstance();
							ultimoDocumento.setTime(ultimo.getFechaCreacion());
							for (Documento doc : documentosExpediente) {
								doc.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
								Calendar actual = Calendar.getInstance();
								actual.setTime(doc.getFechaCreacion());
								if (actual.compareTo(ultimoDocumento) > 0) {
									ultimo = doc;
								}
							}
							ultimo.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
							// Derivar todos los documentos del expediente al
							// destinatario
							Accion accion = accionService.findByNombre(Constantes.ACCION_RECHAZAR);
							for (Documento documentoAMover : documentosExpediente) {
								documentoAMover.setPropietario(destinatario);
								Object obj = ServletActionContext.getRequest().getSession().getAttribute("UsuarioCompartido");
								if (obj != null) {
									Usuario propietario = (Usuario) obj;
									documentoAMover.setRemitente(propietario.getNombres() + " " + propietario.getApellidos());
								} else {
									documentoAMover.setRemitente(remitente.getNombres() + " " + remitente.getApellidos());
								}
								documentoAMover.setAccion(accion);
								if (documentoAMover.esDocumentoPrincipal()) {
									documentoAMover.setEstadoAlarma('V');
								}
								documentoAMover.setFechaAccion(new Date());
								documentoAMover = saveDocumento(documentoAMover);
								log.debug("Generando trazabilidad Nro Expediente [" + expediente.getNroexpediente() + "] ID Documento [" + documentoAMover.getIdDocumento() + "]");
								Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.guardarTrazabilidad(documentoAMover, remitente, destinatario, accion, nombrePC);
								
								trazabilidadExpedienteService.guardarTrazabilidad(expediente, remitente, destinatario, accion, "");
								if (documentoAMover.esDocumentoPrincipal()) {
									Documentoenviado documentoenviado = new Documentoenviado();
									//wvcarrasco descomentar documentoenviado.setTrazabilidaddocumento(trazabilidad);
									documentoenviado.setUsuario(remitente);
									documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
									documentoEnviadoDao.saveDocumento(documentoenviado);
								}
								registrarDerivacionAuditoriaDocumento(documentoAMover, remitente, destinatario, Constantes.TA_DerivarUserFinal, Constantes.TM_UserFinal, Constantes.ACCION_RECHAZAR);
							}
							// Registrando las notificaciones
							notificacionService.informarViaNotifAndMail(remitente, ultimo, Constantes.CONFIGNOTIFMAIL_INGRESO_DOCUMENTO_USERFINAL, Constantes.TIPO_NOTIFICACION_RECHAZO, nombrePC);
							if (conCopia != null) {
								for (Usuario usuario : conCopia) {
									//wcarrasco 19-10-2010 falta revisar  al rechazarDocumentoOpcional La Fecha Notificacion
									notificacionService.enviarNotificacion(remitente, usuario, ultimo, Constantes.TIPO_NOTIFICACION_RECHAZO, nombrePC,true,null);
								}
							}
							if (listaConCopia != null) {
								for (Lista lista : listaConCopia) {
									List<Usuario> participantes = lista.getParticipanteListaList();
									for (Usuario usuario : participantes) {
										//wcarrasco 19-10-2010 falta revisar  al rechazarDocumentoOpcional La Fecha Notificacion
										notificacionService.enviarNotificacion(remitente, usuario, ultimo, Constantes.TIPO_NOTIFICACION_RECHAZO, nombrePC,true,null);
									}
								}
							}
							log.info("El documento " + documento + " fue rechazado satisfactoriamente por el usuario " + remitente + " hacia el destinatario " + destinatario);
							return ultimo;
						}
						log.error("El documento no pertenece a un expediente. ABORTAR!!!!");
						return null;
					}
					log.error("El usuario " + remitente + " no es propietario del documento " + documento + ", no se deriva el documento.");
					return null;
				}
				log.error("Se debe especificar un destinatario.");
				return null;
			}
			log.error("Se debe especificar un remitente.");
			return null;
		}
		log.error("Se debe especificar un documento a derivar.");
		return null;
	}

	@Transactional
	public void saveDocumentoStor(Documento objD, DocumentoDetail objDD) {
		log.debug("-> [Service] DocumentoService - saveDocumentoStor():void ");
		
		DocumentoStor objDS = new DocumentoStor();
		List<Submotivo> lstSubMotivo = null;
		List<Suministro> lstSuministro = null;
		Suministro objSuministro = null;
		objDS.setDocumento(objD);
		objDS.setIdDocumento(objD.getIdDocumento());
		if (objDD.getStrMontoReclamo() != null && !objDD.getStrMontoReclamo().equals("")) {
			log.debug("Monto antes de Pasar a Float [" + objDD.getStrMontoReclamo() + "]");
			log.debug("Monto como Float: " + Float.valueOf(objDD.getStrMontoReclamo()));
			log.debug("Monto como Double:" + Double.valueOf(objDD.getStrMontoReclamo()));
			objDS.setMonto(Double.valueOf(objDD.getStrMontoReclamo()));
		} else {
			log.debug("No se Ingreso Monto, Asignar Monto 0.00");
			objDS.setMonto(Double.valueOf("0.00"));
		}
		if (objDD.getArrSuministro() != null) {
			lstSuministro = new ArrayList<Suministro>();
			for (String sSuministro : objDD.getArrSuministro()) {
				if (!sSuministro.equals("")) {
					objSuministro = new Suministro();
					objSuministro.setDocumentostor(objDS);
					objSuministro.setNrosuministro(sSuministro);
					lstSuministro.add(objSuministro);
				}
			}
			objDS.setSuministros(lstSuministro);
		}
		if (objDD.getArrIdSubMotivo() != null) {
			lstSubMotivo = new ArrayList<Submotivo>();
			for (Integer iIdSubMotivo : objDD.getArrIdSubMotivo()) {
				if (iIdSubMotivo != null) {
					lstSubMotivo.add(submotivoDao.findByIdSubmotivo(iIdSubMotivo));
				}
			}
			objDS.setSubmotivos(lstSubMotivo);
		}
		DocumentoStor objDSAux = documentoStorDao.findByIdDocumentoStor(objD.getIdDocumento());
		if (objDSAux == null) {
			documentoStorDao.saveDocumentoStor(objDS);
		}
	}

	/**
	 * Devuelve los documentos que tienen notificacion amarilla.
	 *
	 * @author German Enriquez
	 */
	@Transactional(propagation = Propagation.REQUIRED, readOnly = true)
	public List<Documento> obtieneDocumentosNotificacionAmarilla() {
		log.debug("-> [Service] DocumentoService - obtieneDocumentosNotificacionAmarilla():List<Documento> ");
		
		double notificacionAmarilla = 0.5;
		double notificacionRoja = 0.75;
		log.warn(" obtieneDocumentosNotificacionAmarilla ");
		List<Proceso> listaProcesos = procesoDao.findPorcentajesProcesos();

		//		Parametro amarilla=parametroDao.findByTipoUnico(Constantes.PARAMETRO_NOTIFICACION_AMARILLA);
		//		if(amarilla!=null){
		//			notificacionAmarilla=Double.parseDouble(amarilla.getValor());
		//		}
		//		else{
		//			log.warn("No se encontro el parametro " + Constantes.PARAMETRO_NOTIFICACION_AMARILLA + ". El valor por defecto es: " + notificacionAmarilla);
		//		}
		//		Parametro roja=parametroDao.findByTipoUnico(Constantes.PARAMETRO_NOTIFICACION_ROJA);
		//		if(roja!=null){
		//			notificacionRoja=Double.parseDouble(roja.getValor());
		//		}
		//		else{
		//			log.warn("No se encontro el parametro " + Constantes.PARAMETRO_NOTIFICACION_ROJA + ". El valor por defecto es: " + notificacionRoja);
		//		}


		List<Documento> todos = documentoDao.getTodos();
		List<Documento> documentos = new ArrayList<Documento>();
		Calendar hoy = Calendar.getInstance();
		for (Documento doc : todos) {
			Date limite = doc.getFechaLimiteAtencion();
			Date accion = doc.getFechaAccion();
			Integer idProceso = doc.getExpediente().getProceso().getIdproceso();

			for (Proceso objProceso : listaProcesos) {
				if (objProceso.getIdproceso().toString().equals(idProceso.toString())) {
					if (objProceso.getPorcentajealertaA() != null && !objProceso.getPorcentajealertaA().equals("")) {
						notificacionAmarilla = Double.parseDouble(objProceso.getPorcentajealertaA());
					}
					if (objProceso.getPorcentajealertaR() != null && !objProceso.getPorcentajealertaR().equals("")) {
						notificacionRoja = Double.parseDouble(objProceso.getPorcentajealertaR());
					}
				}
			}
			if (limite != null && accion != null) {
				Calendar fechaLimite = Calendar.getInstance();
				Calendar fechaAccion = Calendar.getInstance();
				fechaLimite.setTime(limite);
				fechaAccion.setTime(accion);
				int atencionAccion = fechaLimite.get(Calendar.DAY_OF_YEAR) - fechaAccion.get(Calendar.DAY_OF_YEAR);
				int atencionHoy = fechaLimite.get(Calendar.DAY_OF_YEAR) - hoy.get(Calendar.DAY_OF_YEAR);
				double index = 1d - (double) atencionHoy / atencionAccion;
				if (notificacionAmarilla < index && index < notificacionRoja) {
					documentos.add(doc);
				}
			}
		}
		return documentos;
	}

	/**
	 * Devuelve los documentos que tienen notificacion roja.
	 *
	 * @author German Enriquez
	 */
	@Transactional(propagation = Propagation.REQUIRED, readOnly = true)
	public List<Documento> obtieneDocumentosNotificacionRoja() {
		log.debug("-> [Service] DocumentoService - obtieneDocumentosNotificacionRoja():List<Documento> ");
		
		List<Proceso> listaProcesos = procesoDao.findPorcentajesProcesos();

		double notificacionRoja = 0.75;
		//		Parametro roja=parametroDao.findByTipoUnico(Constantes.PARAMETRO_NOTIFICACION_ROJA);
		//		if(roja!=null){
		//			notificacionRoja=Double.parseDouble(roja.getValor());
		//		}
		//		else{
		//			log.warn("No se encontro el parametro " + Constantes.PARAMETRO_NOTIFICACION_ROJA + ". El valor por defecto es: " + notificacionRoja);
		//		}
		List<Documento> todos = documentoDao.getTodos();
		List<Documento> documentos = new ArrayList<Documento>();
		Calendar hoy = Calendar.getInstance();
		for (Documento doc : todos) {
			Date limite = doc.getFechaLimiteAtencion();
			Date accion = doc.getFechaAccion();
			Integer idProceso = doc.getExpediente().getProceso().getIdproceso();

			for (Proceso objProceso : listaProcesos) {
				if (objProceso.getIdproceso().toString().equals(idProceso.toString())) {
					if (objProceso.getPorcentajealertaR() != null && !objProceso.getPorcentajealertaR().equals("")) {
						notificacionRoja = Double.parseDouble(objProceso.getPorcentajealertaR());
						break;
					}

				}
			}

			if (limite != null && accion != null) {
				Calendar fechaLimite = Calendar.getInstance();
				Calendar fechaAccion = Calendar.getInstance();
				fechaLimite.setTime(limite);
				fechaAccion.setTime(accion);
				int atencionAccion = fechaLimite.get(Calendar.DAY_OF_YEAR) - fechaAccion.get(Calendar.DAY_OF_YEAR);
				int atencionHoy = fechaLimite.get(Calendar.DAY_OF_YEAR) - hoy.get(Calendar.DAY_OF_YEAR);
				double index = 1d - (double) atencionHoy / atencionAccion;
				if (index > notificacionRoja) {
					documentos.add(doc);
				}
			}
		}
		return documentos;
	}

	public String diasNoLaborables(String fechaInicio, String fechaFinal) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - diasNoLaborables():String ");
		
		try {
			return documentoDao.diasNoLaborables(fechaInicio, fechaFinal);
		} catch (RuntimeException re) {
			log.error("", re);
			return null;
		}
	}

	public String calculaFechaLimite(String sDiaLimiteAtencion, String shorasLimiteAtencion) {
		log.debug("-> [Service] DocumentoService - calculaFechaLimite():String ");
		
		log.debug("dia: " + sDiaLimiteAtencion);
		log.debug("hora: " + shorasLimiteAtencion);
		/*
		 * SimpleDateFormat formatoFecha = new SimpleDateFormat("yyyy-MM-dd");
		 * Date trialTime = new Date(); Calendar calendar = new
		 * GregorianCalendar(); calendar.setTime(trialTime);
		 *
		 * if (!sFechaLimiteAtencion.equals("")) {
		 * log.debug("calculo con fecha "); getObjDD().getDoc().setPlazo(0);
		 * getObjDD().setStrFechaLimiteAtencion(sFechaLimiteAtencion); } else {
		 * log.debug("calculo con horas"); int horasxdia = (sDiaLimiteAtencion
		 * 24) + shorasLimiteAtencion; String fechaInicio =
		 * formatoFecha.format(calendar.getTime());
		 * calendar.add(Calendar.HOUR_OF_DAY, horasxdia); String fechaFinal =
		 * formatoFecha.format(calendar.getTime()); String diasNoAbiles =
		 * getSrvD().diasNoLaborables(fechaInicio, fechaFinal);
		 * log.debug("diasNoLaborables== " + diasNoAbiles); if
		 * (!diasNoAbiles.equals("0")) { log.debug("si"); int horasLaborables =
		 * horasxdia + (Integer.parseInt(diasNoAbiles) 24); Calendar
		 * fechaLinAten = new GregorianCalendar();
		 * fechaLinAten.setTime(trialTime);
		 * fechaLinAten.add(Calendar.HOUR_OF_DAY, horasLaborables);
		 * getObjDD().setStrPlazo(horasxdia); log.debug("numero de horas " +
		 * horasxdia);
		 * getObjDD().setStrFechaLimiteAtencion(formatoFecha.format(fechaLinAten
		 * .getTime())); log.debug("fecha de plazo " +
		 * formatoFecha.format(fechaLinAten.getTime()));
		 *
		 * } else { log.debug("no"); log.debug("numro de horas " + horasxdia);
		 * getObjDD().setStrPlazo(horasxdia); log.debug("fecha de plazo " +
		 * formatoFecha.format(calendar.getTime()));
		 * getObjDD().setStrFechaLimiteAtencion
		 * (formatoFecha.format(calendar.getTime()));
		 * log.debug("final de calculo"); } }
		 */
		return shorasLimiteAtencion;
	}

	/**REN Mtodo encargado de guardar el documento adjunto y subir los adjuntos a Alfresco ------------------------------*/
	@Transactional
	@Override
	public Documento subirConMetadata(Usuario usuario, Map<String, List<ArchivoTemporal>> mapUpload, Integer idDocumento, Documento objDocumento, DocumentoDetail objDD, String versionar, Integer[] fversionar) {
		log.debug("-> [Service] DocumentoService - subirConMetadata():Documento ");
		
		Documento ref = null;
		//try{
		log.debug("### dosubirConMetadata");
		// FIXME esta logica pertenece al action
		Documento principal = this.findByIdDocumento(idDocumento);
		List<ArchivoTemporal> lstArchivoTemporal = null;
		log.debug(" ####  fversionar:" + versionar);
		if (mapUpload == null) {
			log.info("No se adjunto ningun archivo");
		} else {
			lstArchivoTemporal = mapUpload.get("upload2");
			log.debug("Archivos adjuntos [" + lstArchivoTemporal.size() + "]");
			
		if (log.isDebugEnabled()) {
			for (int i = 0; fversionar != null && i < fversionar.length; i++) {
				log.debug(" ####  fversionar:" + "[" + i + "]:" + fversionar[i]);
			}
		}
		List<ArchivoTemporal> newArchivosTemporal = new ArrayList<ArchivoTemporal>();
		if (versionar.equalsIgnoreCase("" + true)) {
			// si es que hay algunarhcivo para versionar
			for (ArchivoTemporal objArchivoTemporal : lstArchivoTemporal) {
				try {
					archivoService.checkInToAlfresco(usuario, objArchivoTemporal, principal, 1, true);
				} catch (Exception e) {
					log.warn(" no se pudo  versionar:" + objArchivoTemporal.getFArchivo().getName());
					newArchivosTemporal.add(objArchivoTemporal);
				}
			}
			lstArchivoTemporal = newArchivosTemporal;
		}
		}
		
		/*if (lstArchivoTemporal.size() > 0) {*/
			Usuario propietario = usuarioService.findByIdUsuario(principal.getPropietario().getIdusuario());
			Tipodocumento tipodo = objDocumento.getTipoDocumento();
			String fecha = objDD.getStrFechaDocumento();
			Documento objDocumentoTemporal = objDocumento;
			objDocumentoTemporal.setAsunto(objDocumento.getAsunto());
			objDocumentoTemporal.setUltimoAsunto(objDocumento.getAsunto());
			Object obj = ServletActionContext.getRequest().getSession().getAttribute("UsuarioCompartido");
			if (obj != null) {
				Usuario p = (Usuario) obj;
				objDocumentoTemporal.setRemitente(p.getNombres() + " " + p.getApellidos());
			} else {
				objDocumentoTemporal.setRemitente(propietario.getNombres() + " " + propietario.getApellidos());
			}
			objDocumentoTemporal.setNumeroDocumento(objDocumento.getNumeroDocumento());
			objDocumentoTemporal.setNumeroFolios(1);
			objDocumentoTemporal.setTiponumeracion(objDocumento.getTiponumeracion());
			objDocumentoTemporal.setExpediente(principal.getExpediente());
			objDocumentoTemporal.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
			objDocumentoTemporal.setPropietario(propietario);
			objDocumentoTemporal.setAccion(accionService.findByNombre(Constantes.ACCION_REGISTRAR));
			objDocumentoTemporal.setCondestinatarios(objDocumento.getCondestinatarios());
			objDocumentoTemporal.setConcopias(objDocumento.getConcopias());
			objDocumentoTemporal.setTiponumeracion(objDocumento.getTiponumeracion());
			objDocumentoTemporal.setEnumerador(usuario);
			objDocumentoTemporal.setFirmado(Constantes.No);
			objDocumentoTemporal.setEnumerado(Constantes.No);
			objDocumentoTemporal.setEnumerarDocumento(objDocumento.getEnumerarDocumento());
			
			try {
				// Esto porque asi manda la fecha dojo
				objDocumentoTemporal.setFechaDocumento(new SimpleDateFormat("yyyy-MM-dd").parse(fecha));
			} catch (ParseException e) {
				log.warn("No se pudo parsear la fecha " + fecha + " al momento de registrar el documento");
			}
			objDocumentoTemporal.setFechaAccion(new Date());
			objDocumentoTemporal.setFechaCreacion(new Date());
			objDocumentoTemporal.setEstado(Constantes.ESTADO_ACTIVO);
			objDocumentoTemporal.setEstaEnFlujo(Constantes.ESTAENFLUJO_S);
			objDocumentoTemporal.setTipoDocumento(tipodo);

		if(lstArchivoTemporal != null && lstArchivoTemporal.size() > 0){
			objDocumentoTemporal.setNumeroFolios(lstArchivoTemporal.size());
		}else{
			objDocumentoTemporal.setNumeroFolios(1);
		}

			objDocumentoTemporal.setIdUsuarioLogeado(usuario.getIdusuario());
			objDocumentoTemporal.setAutor(propietario);

			Unidad unid = principal.getExpediente().getProceso().getResponsable().getUnidad();
			if (objDocumentoTemporal.getTiponumeracion().equals("A") && objDocumentoTemporal.getEnumerado().equals(Constantes.No) && objDocumento.getEnumerarDocumento()){
				while(unid != null){
					Integer idunidad = propietario.getUnidad().getIdunidad();
					try {
						Numeracion num = numeracionService.findById(idunidad, tipodo.getIdtipodocumento());
						if (StringUtils.isBlank(objDocumentoTemporal.getNumeroDocumento())) {
							objDocumentoTemporal.setNumeroDocumento(num.formatearNumero());
							num.setNumeroactual(num.getNumeroactual() + 1);
							numeracionService.guardarObj(num);
							unid = null;
						}
					} catch (NoResultException nre) {
						//log.warn("No se encontro numeracion para idTipoDocumento [" + idtipodoc + "] idUnidad [" + idunidad + "]");
						unid = unid.getDependencia();
						log.info("Se buscara en la unidad [" + (unid != null ? unid.getNombre() : "null") + "]");
					} catch (Exception ex) {
						unid = null;
						log.error(ex.getMessage(), ex);
					}
				}
			}

			if(objDocumentoTemporal.getFirmante() != null && objDocumentoTemporal.getFirmante().getIdusuario() == null){
				objDocumentoTemporal.setFirmante(null);
			}
			
			ref = objDocumentoTemporal;
			objDocumentoTemporal = this.saveDocumento(objDocumentoTemporal);
		ref.setAccion(accionService.findByNombre(Constantes.ACCION_PARA_APROBAR));

			registrarAuditoriaDocumento(usuario, objDocumentoTemporal, Constantes.TO_AdjuntarMetadata, Constantes.TM_UserFinal, Constantes.TO_Registrar);
			trazabilidadDocumentoService.saveTrazabilidadDocumento(objDocumentoTemporal, propietario, false, true);
			// int nrfolios=0;
		if(lstArchivoTemporal!= null && lstArchivoTemporal.size() > 0){
			int y = 1;
			List<Archivo> archivosSubidos = new ArrayList<Archivo>();
			for (ArchivoTemporal arch : lstArchivoTemporal) {
				log.debug(" hay archivos para upload : " + y);
				Archivo file = archivoService.guardarArchivoTemporal(arch, objDocumentoTemporal, y++, usuario);
				//aca recien puedo numerar...
				registrarAuditoriaArchivos(usuario, objDocumentoTemporal, arch, Constantes.TO_AdjuntarMetadata, Constantes.TM_UserFinal, Constantes.TO_Registrar);
				archivosSubidos.add(file);
			}
			repositorioService.subirArchivosTransformadosARepositorio(objDocumentoTemporal.getIdDocumento(), false);
			ref.setArchivos(archivosSubidos);
/*Numera documentos en Open Office
			if (objDocumento.getEnumerarDocumento()) {
				log.debug("Numeramos documentos adjuntos");
				if (objDocumentoTemporal != null && !archivosSubidos.isEmpty()) {
					this.numerarDocumentoFisico(usuario, objDocumentoTemporal, Integer.valueOf(Constantes.DO_ENUMERAR));
				}
			}*/
		}	
		/*
		} else {
			ref = principal;
		}
		}catch(ParseException e){
        log.error(e.getMessage(),e);
        }*/
		return ref;
	}

	/**REN Metodo encargado de anexar archivos a un documento ya existente ---------------------------------------------------*/
	@Transactional
	@Override
	public Documento anexarDocumento (Usuario usuario, Map<String, List<ArchivoTemporal>> mapUpload, Integer idDocumento) {
		log.debug("-> [Service] DocumentoService - anexarDocumento():Documento ");
		
		Documento documento = this.findByIdDocumento(idDocumento);
		if(documento.getDocumentoreferencia() != null){
			documento = this.findByIdDocumento(documento.getDocumentoreferencia());
		}
		List<ArchivoTemporal> lstArchivoTemporal = null;

		if (mapUpload == null) {
			log.info("No se adjunto ningun archivo");
		} else {
			lstArchivoTemporal = mapUpload.get("upload2");
			log.debug("Archivos adjuntos [" + lstArchivoTemporal.size() + "]");
		}

		if (lstArchivoTemporal.size() > 0) {
			int y = 1;
			List<Archivo> archivosSubidos = new ArrayList<Archivo>();
			for (ArchivoTemporal arch : lstArchivoTemporal) {
				log.debug(" hay archivos para upload : " + y);
				Archivo file = archivoService.guardarArchivoTemporal(arch, documento, y++, usuario);
				registrarAuditoriaArchivos(usuario, documento, arch, Constantes.TO_AdjuntarMetadata, Constantes.TM_UserFinal, Constantes.TO_Registrar);
				archivosSubidos.add(file);
			}
			repositorioService.subirArchivosTransformadosARepositorio(documento, archivosSubidos, false);
		}
		return documento;
	}

	public Integer getDocumentosPrincipalesNoLeidos(Integer iIdUsuario) {
		log.debug("-> [Service] DocumentoService - getDocumentosPrincipalesNoLeidos():Integer ");
		
		return documentoDao.getDocumentosPrincipalesNoLeidos(iIdUsuario);
	}

	@Transactional
	public Documento updateLeido(Integer iIdDocumento, Usuario remitente) {
		log.debug("-> [Service] DocumentoService - updateLeido():Documento ");
		
		Documento documento = this.findByIdDocumento(iIdDocumento);
		
		/*if(documento.getLeido()!= null && documento.getLeido().equals('N')){
			Usuario destinatario = null; 			
			if(documento.getDocumentoreferencia() != null){
				//Es una copia de apoyo
				Trazabilidaddocumento traza = trazabilidadDocumentoService.encontrarUltimaTrazabilidadPorDocumento(documento.getDocumentoreferencia());
				destinatario = traza.getDestinatario();
			}else{
				Trazabilidaddocumento traza = trazabilidadDocumentoService.encontrarUltimaTrazabilidadPorDocumento(documento.getIdDocumento());
				destinatario = traza.getRemitente();
			}
			
			//log.debug("Se enviar el correo a "+destinatario.getNombreCompleto());
			
			//mailService.ChaskiMail(Constantes.CONFIGNOTIFMAIL_LECTURA_EXPEDIENTE, remitente, destinatario, documento);
		}*/
		
		documento.setLeido('S');

		documento = this.saveDocumento(documento);
		
		return documento;
	}

	@Transactional
	private void registrarAuditoriaMP(Expediente expediente, Documento documento, Usuario usuario) {
		log.debug("-> [Service] DocumentoService - registrarAuditoriaMP():void ");
		
		/*******************************************************/
		// Registrando la auditoria del Expediente
		/*******************************************************/
		Auditoria ObjAuditoriaExpediente = new Auditoria();
		ObjAuditoriaExpediente.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaExpediente.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaExpediente.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaExpediente.setFechaAudioria(new Date());
		ObjAuditoriaExpediente.setUsuario(usuario.getUsuario());
		ObjAuditoriaExpediente.setCampo("Nro Expediente");
		ObjAuditoriaExpediente.setNuevoValor(expediente.getNroexpediente());
		ObjAuditoriaExpediente.setExpediente(expediente);
		auditoriaDao.SaveAuditoria(ObjAuditoriaExpediente);
		/*******************************************************/
		// Registrando la auditoria del Proceso
		/*******************************************************/
		Auditoria ObjAuditoriaProceso = new Auditoria();
		ObjAuditoriaProceso.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaProceso.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaProceso.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaProceso.setFechaAudioria(new Date());
		ObjAuditoriaProceso.setUsuario(usuario.getUsuario());
		ObjAuditoriaProceso.setCampo("Proceso");
		ObjAuditoriaProceso.setNuevoValor(expediente.getProceso().getNombre());
		ObjAuditoriaProceso.setExpediente(expediente);
		auditoriaDao.SaveAuditoria(ObjAuditoriaProceso);
		/*******************************************************/
		// Registrando la auditoria del Area Destino
		/*******************************************************/
		Auditoria ObjAuditoriaAD = new Auditoria();
		ObjAuditoriaAD.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaAD.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaAD.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaAD.setFechaAudioria(new Date());
		ObjAuditoriaAD.setUsuario(usuario.getUsuario());
		ObjAuditoriaAD.setCampo("Area Destino");
		ObjAuditoriaAD.setNuevoValor(expediente.getProceso().getResponsable().getUnidad().getNombre());
		ObjAuditoriaAD.setExpediente(expediente);
		auditoriaDao.SaveAuditoria(ObjAuditoriaAD);
		/*******************************************************/
		// Registrando la auditoria del Destinatario
		/*******************************************************/
		Auditoria ObjAuditoriaDestinatario = new Auditoria();
		ObjAuditoriaDestinatario.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaDestinatario.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaDestinatario.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaDestinatario.setFechaAudioria(new Date());
		ObjAuditoriaDestinatario.setUsuario(usuario.getUsuario());
		ObjAuditoriaDestinatario.setCampo("Destinatario");
		ObjAuditoriaDestinatario.setExpediente(expediente);
		ObjAuditoriaDestinatario.setNuevoValor(expediente.getProceso().getResponsable().getNombres() + " - " + expediente.getProceso().getResponsable().getApellidos());
		auditoriaDao.SaveAuditoria(ObjAuditoriaDestinatario);
		/*************************************************************************************************/
		// Registrando la Auditoria del Tipo Documento
		/**************************************************************************************************/
		Auditoria ObjAuditoriaTD = new Auditoria();
		ObjAuditoriaTD.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaTD.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaTD.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaTD.setFechaAudioria(new Date());
		ObjAuditoriaTD.setUsuario(usuario.getUsuario());
		ObjAuditoriaTD.setCampo("Tipo Documento");
		ObjAuditoriaTD.setNuevoValor(documento.getTipoDocumento().getNombre());
		ObjAuditoriaTD.setFechaAudioria(new Date());
		ObjAuditoriaTD.setUsuario(usuario.getUsuario());
		ObjAuditoriaTD.setExpediente(documento.getExpediente());
		ObjAuditoriaTD.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaTD);
		/*******************************************************/
		// Registrando la Auditoria del Nro Documento
		/*******************************************************/
		Auditoria ObjAuditoriaNroDoc = new Auditoria();
		ObjAuditoriaNroDoc.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaNroDoc.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaNroDoc.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaNroDoc.setFechaAudioria(new Date());
		ObjAuditoriaNroDoc.setUsuario(usuario.getUsuario());
		ObjAuditoriaNroDoc.setCampo("Nro Documento");
		ObjAuditoriaNroDoc.setNuevoValor(documento.getNumeroDocumento());
		ObjAuditoriaNroDoc.setFechaAudioria(new Date());
		ObjAuditoriaNroDoc.setUsuario(usuario.getUsuario());
		ObjAuditoriaNroDoc.setExpediente(documento.getExpediente());
		ObjAuditoriaNroDoc.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaNroDoc);
		/*******************************************************/
		// Registrando la Auditoria Nro Folio de Documento
		/*******************************************************/
		Auditoria ObjAuditoriaNroFolio = new Auditoria();
		ObjAuditoriaNroFolio.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaNroFolio.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaNroFolio.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaNroFolio.setFechaAudioria(new Date());
		ObjAuditoriaNroFolio.setUsuario(usuario.getUsuario());
		ObjAuditoriaNroFolio.setCampo("Nro Folio");
		ObjAuditoriaNroFolio.setNuevoValor(String.valueOf(documento.getNumeroFolios()));
		ObjAuditoriaNroFolio.setFechaAudioria(new Date());
		ObjAuditoriaNroFolio.setUsuario(usuario.getUsuario());
		ObjAuditoriaNroFolio.setExpediente(documento.getExpediente());
		ObjAuditoriaNroFolio.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaNroFolio);
		/*******************************************************/
		// Registrando la Auditoria Asunto del Documento
		/*******************************************************/
		Auditoria ObjAuditoriaAsuntoDoc = new Auditoria();
		ObjAuditoriaAsuntoDoc.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaAsuntoDoc.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaAsuntoDoc.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaAsuntoDoc.setFechaAudioria(new Date());
		ObjAuditoriaAsuntoDoc.setUsuario(usuario.getUsuario());
		ObjAuditoriaAsuntoDoc.setCampo("Asunto");
		ObjAuditoriaAsuntoDoc.setNuevoValor(documento.getAsunto());
		ObjAuditoriaAsuntoDoc.setFechaAudioria(new Date());
		ObjAuditoriaAsuntoDoc.setUsuario(usuario.getUsuario());
		ObjAuditoriaAsuntoDoc.setExpediente(documento.getExpediente());
		ObjAuditoriaAsuntoDoc.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaAsuntoDoc);
		/*******************************************************/
		// Registrando la Auditoria Fecha del Documento
		/*******************************************************/
		Auditoria ObjAuditoriaFecha = new Auditoria();
		ObjAuditoriaFecha.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaFecha.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaFecha.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaFecha.setFechaAudioria(new Date());
		ObjAuditoriaFecha.setUsuario(usuario.getUsuario());
		ObjAuditoriaFecha.setCampo("Fecha del Documento");
		ObjAuditoriaFecha.setNuevoValor(String.valueOf(documento.getFechaDocumento()));
		ObjAuditoriaFecha.setFechaAudioria(new Date());
		ObjAuditoriaFecha.setUsuario(usuario.getUsuario());
		ObjAuditoriaFecha.setExpediente(documento.getExpediente());
		ObjAuditoriaFecha.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaFecha);
		/*******************************************************/
		// Registrando la Auditoria Tipo Doc Cliente
		/*******************************************************/
		Auditoria ObjAuditoriaTDC = new Auditoria();
		ObjAuditoriaTDC.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaTDC.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaTDC.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaTDC.setFechaAudioria(new Date());
		ObjAuditoriaTDC.setUsuario(usuario.getUsuario());
		ObjAuditoriaTDC.setCampo("Tipo Doc Identidad");
		ObjAuditoriaTDC.setNuevoValor(documento.getExpediente().getCliente().getTipoIdentificacion().getNombre());
		ObjAuditoriaTDC.setFechaAudioria(new Date());
		ObjAuditoriaTDC.setUsuario(usuario.getUsuario());
		ObjAuditoriaTDC.setExpediente(documento.getExpediente());
		ObjAuditoriaTDC.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaTDC);
		/*******************************************************/
		// Registrando la Auditoria Nro Doc Cliente
		/*******************************************************/
		Auditoria ObjAuditoriaNdocClient = new Auditoria();
		ObjAuditoriaNdocClient.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaNdocClient.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaNdocClient.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaNdocClient.setFechaAudioria(new Date());
		ObjAuditoriaNdocClient.setUsuario(usuario.getUsuario());
		ObjAuditoriaNdocClient.setCampo("Nro Doc Identidad");
		ObjAuditoriaNdocClient.setNuevoValor(documento.getExpediente().getCliente().getNumeroIdentificacion());
		ObjAuditoriaNdocClient.setFechaAudioria(new Date());
		ObjAuditoriaNdocClient.setUsuario(usuario.getUsuario());
		ObjAuditoriaNdocClient.setExpediente(documento.getExpediente());
		ObjAuditoriaNdocClient.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaNdocClient);
		/*******************************************************/
		// Registrando la Auditoria Observaciones
		/*******************************************************/
		Auditoria ObjAuditoriaObservaciones = new Auditoria();
		ObjAuditoriaObservaciones.setTipoAuditoria(Constantes.TA_RegistrarNvoDoc_MP);
		ObjAuditoriaObservaciones.setModulo(Constantes.TM_MesaPartes);
		ObjAuditoriaObservaciones.setOpcion(Constantes.TO_Registrar);
		ObjAuditoriaObservaciones.setFechaAudioria(new Date());
		ObjAuditoriaObservaciones.setUsuario(usuario.getUsuario());
		ObjAuditoriaObservaciones.setCampo("Observaciones");
		ObjAuditoriaObservaciones.setNuevoValor(documento.getObservacion());
		ObjAuditoriaObservaciones.setFechaAudioria(new Date());
		ObjAuditoriaObservaciones.setUsuario(usuario.getUsuario());
		ObjAuditoriaObservaciones.setExpediente(documento.getExpediente());
		ObjAuditoriaObservaciones.setDocumento(documento);
		auditoriaDao.SaveAuditoria(ObjAuditoriaObservaciones);
	}

	@Transactional
	private void registrarAuditoriaQAS(Expediente expediente, Documento documento, Usuario usuario, String strAcc) {
		log.debug("-> [Service] DocumentoService - registrarAuditoriaQAS():void ");
		
		Documento docSessionQAS = (Documento) ServletActionContext.getRequest().getSession().getAttribute("documentoSessionQAS");
		/*******************************************************/
		// Registrando la auditoria del Proceso
		/*******************************************************/
		Auditoria ObjAuditoriaProceso = new Auditoria();
		ObjAuditoriaProceso.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaProceso.setModulo(Constantes.TM_QAS);
		ObjAuditoriaProceso.setOpcion(strAcc);
		ObjAuditoriaProceso.setFechaAudioria(new Date());
		ObjAuditoriaProceso.setUsuario(usuario.getUsuario());
		ObjAuditoriaProceso.setCampo("Proceso");
		ObjAuditoriaProceso.setNuevoValor(expediente.getProceso().getNombre());
		ObjAuditoriaProceso.setExpediente(expediente);
		ObjAuditoriaProceso.setDocumento(documento);
		if (docSessionQAS.getExpediente().getProceso().getNombre().equals(expediente.getProceso().getNombre()) == false) {
			ObjAuditoriaProceso.setAntiguoValor(docSessionQAS.getExpediente().getProceso().getNombre());
			ObjAuditoriaProceso.setExpediente(expediente);
			// auditoriaDao.SaveAuditoria(ObjAuditoriaProceso);
		}
		auditoriaService.SaveAuditoria(ObjAuditoriaProceso);
		// auditoriaDao.SaveAuditoria(ObjAuditoriaProceso);
		/*******************************************************/
		// Registrando la auditoria de la numero de mesa
		/*******************************************************/
		Auditoria ObjAuditoriaNroMesa = new Auditoria();
		ObjAuditoriaNroMesa.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaNroMesa.setModulo(Constantes.TM_QAS);
		ObjAuditoriaNroMesa.setOpcion(strAcc);
		ObjAuditoriaNroMesa.setFechaAudioria(new Date());
		ObjAuditoriaNroMesa.setUsuario(usuario.getUsuario());
		ObjAuditoriaNroMesa.setCampo("Nro de Caja");
		ObjAuditoriaNroMesa.setExpediente(expediente);
		ObjAuditoriaNroMesa.setDocumento(documento);
		if (documento.getNumeroCaja() != null) {
			int estado = documento.getNumeroCaja().compareTo("");
			if (estado != 0) {
				ObjAuditoriaNroMesa.setNuevoValor(documento.getNumeroCaja());
				auditoriaService.SaveAuditoria(ObjAuditoriaNroMesa);
				// auditoriaDao.SaveAuditoria(ObjAuditoriaNroMesa);
			}
		}
		/*******************************************************/
		// Registrando la auditoria del Tipo Documento Cliente
		/*******************************************************/
		Auditoria ObjAuditoriaTDC = new Auditoria();
		ObjAuditoriaTDC.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaTDC.setModulo(Constantes.TM_QAS);
		ObjAuditoriaTDC.setOpcion(strAcc);
		ObjAuditoriaTDC.setFechaAudioria(new Date());
		ObjAuditoriaTDC.setUsuario(usuario.getUsuario());
		ObjAuditoriaTDC.setCampo("Tipo Doc Identidad");
		ObjAuditoriaTDC.setExpediente(expediente);
		ObjAuditoriaTDC.setDocumento(documento);
		ObjAuditoriaTDC.setNuevoValor(expediente.getCliente().getTipoIdentificacion().getNombre());
		if (docSessionQAS.getExpediente().getCliente().getTipoIdentificacion().getNombre().equals(expediente.getCliente().getTipoIdentificacion().getNombre()) == false) {
			ObjAuditoriaTDC.setAntiguoValor(docSessionQAS.getExpediente().getCliente().getTipoIdentificacion().getNombre());
			ObjAuditoriaTDC.setDocumento(documento);
			// auditoriaDao.SaveAuditoria(ObjAuditoriaTDC);
		}
		auditoriaService.SaveAuditoria(ObjAuditoriaTDC);
		// auditoriaDao.SaveAuditoria(ObjAuditoriaTDC);
		/*******************************************************/
		// Registrando la auditoria del Nro Documento Cliente
		/*******************************************************/
		Auditoria ObjAuditoriaNroDocCliente = new Auditoria();
		ObjAuditoriaNroDocCliente.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaNroDocCliente.setModulo(Constantes.TM_QAS);
		ObjAuditoriaNroDocCliente.setOpcion(strAcc);
		ObjAuditoriaNroDocCliente.setFechaAudioria(new Date());
		ObjAuditoriaNroDocCliente.setUsuario(usuario.getUsuario());
		ObjAuditoriaNroDocCliente.setDocumento(documento);
		ObjAuditoriaNroDocCliente.setExpediente(expediente);
		ObjAuditoriaNroDocCliente.setCampo("Nro Doc Identidad");
		ObjAuditoriaNroDocCliente.setNuevoValor(expediente.getCliente().getNumeroIdentificacion());
		if (docSessionQAS.getExpediente().getCliente().getNumeroIdentificacion().equals(expediente.getCliente().getNumeroIdentificacion()) == false) {
			ObjAuditoriaNroDocCliente.setAntiguoValor(docSessionQAS.getExpediente().getCliente().getNumeroIdentificacion());
			ObjAuditoriaNroDocCliente.setDocumento(documento);
			ObjAuditoriaNroDocCliente.setExpediente(expediente);
			// auditoriaDao.SaveAuditoria(ObjAuditoriaNroDocCliente);
		}
		auditoriaService.SaveAuditoria(ObjAuditoriaNroDocCliente);
		// auditoriaDao.SaveAuditoria(ObjAuditoriaNroDocCliente);
	}

	@Transactional
	private void registrarAuditoriaAdicionalStor(DocumentoStor docStor, Usuario usuario, String strAcc) {
		log.debug("-> [Service] DocumentoService - registrarAuditoriaAdicionalStor():void ");
		
		int idDocumentoSesion = ((DocumentoStor) ServletActionContext.getRequest().getSession().getAttribute("documentoStorSessionQAS")).getIdDocumento();
		DocumentoStor docSessionQAS = documentoStorDao.findByIdDocumentoStor(idDocumentoSesion);
		/*******************************************************/
		// Registrando la auditoria de Suministro
		/*******************************************************/
		Auditoria ObjAuditoriaSuminitro = new Auditoria();
		ObjAuditoriaSuminitro.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaSuminitro.setModulo(Constantes.TM_QAS);
		ObjAuditoriaSuminitro.setOpcion(strAcc);
		ObjAuditoriaSuminitro.setFechaAudioria(new Date());
		ObjAuditoriaSuminitro.setUsuario(usuario.getUsuario());
		ObjAuditoriaSuminitro.setDocumento(docStor.getDocumento());
		ObjAuditoriaSuminitro.setCampo("Suministro");
		List<Suministro> listaSuministros = docStor.getSuministros();
		String strSuministros = listaSuministros.toString();
		ObjAuditoriaSuminitro.setNuevoValor(strSuministros);
		if (docSessionQAS.getSuministros().equals(listaSuministros) == false) {
			List<Suministro> listaSuministrosOld = docSessionQAS.getSuministros();
			String strSuministrosOld = listaSuministrosOld.toString();
			ObjAuditoriaSuminitro.setAntiguoValor(strSuministrosOld);
		}
		auditoriaService.SaveAuditoria(ObjAuditoriaSuminitro);
		/*******************************************************/
		// Registrando la auditoria de Motivo y SubMotivo
		/*******************************************************/
		Auditoria ObjAuditoriaMotivo = new Auditoria();
		ObjAuditoriaMotivo.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaMotivo.setModulo(Constantes.TM_QAS);
		ObjAuditoriaMotivo.setOpcion(strAcc);
		ObjAuditoriaMotivo.setFechaAudioria(new Date());
		ObjAuditoriaMotivo.setUsuario(usuario.getUsuario());
		ObjAuditoriaMotivo.setDocumento(docStor.getDocumento());
		ObjAuditoriaMotivo.setCampo("Motivo - SubMotivo");
		List<Submotivo> listaSubMotivos = docStor.getSubmotivos();
		StringBuilder strSubMotivosNuevos = new StringBuilder("");
		for (int i = 0; i < listaSubMotivos.size(); ++i) {
			Submotivo objSubMotivo = listaSubMotivos.get(i);
			strSubMotivosNuevos.append("[");
			strSubMotivosNuevos.append(objSubMotivo.getMotivo().toString());
			strSubMotivosNuevos.append("-");
			strSubMotivosNuevos.append(objSubMotivo.toString());
			strSubMotivosNuevos.append("] ");
		}
		ObjAuditoriaMotivo.setNuevoValor(strSubMotivosNuevos.toString());
		if (docSessionQAS.getSubmotivos().equals(listaSubMotivos) == false) {
			List<Submotivo> listaSubMotivosOld = docSessionQAS.getSubmotivos();
			StringBuilder strSubMotivosOld = new StringBuilder("");
			for (int i = 0; i < listaSubMotivosOld.size(); ++i) {
				Submotivo objSubMotivo = listaSubMotivosOld.get(i);
				strSubMotivosOld.append("[");
				strSubMotivosOld.append(objSubMotivo.getMotivo().toString());
				strSubMotivosOld.append("-");
				strSubMotivosOld.append(objSubMotivo.toString());
				strSubMotivosOld.append("] ");
			}
			ObjAuditoriaMotivo.setAntiguoValor(strSubMotivosOld.toString());
		}
		auditoriaService.SaveAuditoria(ObjAuditoriaMotivo);
		/*******************************************************/
		// Registrando la auditoria de Monto de Reclamo
		/*******************************************************/
		Auditoria ObjAuditoriaMontoReclamo = new Auditoria();
		ObjAuditoriaMontoReclamo.setTipoAuditoria(Constantes.TA_AccionQAS);
		ObjAuditoriaMontoReclamo.setModulo(Constantes.TM_QAS);
		ObjAuditoriaMontoReclamo.setOpcion(strAcc);
		ObjAuditoriaMontoReclamo.setFechaAudioria(new Date());
		ObjAuditoriaMontoReclamo.setUsuario(usuario.getUsuario());
		ObjAuditoriaMontoReclamo.setDocumento(docStor.getDocumento());
		ObjAuditoriaMontoReclamo.setCampo("Monto de Reclamo");
		if (docStor.getMonto() != null ? false : true) {
			log.debug("Monto LLego como NULL");
		}
		if (docSessionQAS.getMonto() != null ? true : false) {
			log.debug("Monto en docSesionQAS:" + docSessionQAS.getMonto());
		} else {
			log.debug("Monto en docSesionQAS is NULL");
		}
		ObjAuditoriaMontoReclamo.setNuevoValor(docStor.getMonto() != null ? docStor.getMonto().toString() : null);
		if (docSessionQAS.getMonto().equals(docStor.getMonto()) == false) {
			ObjAuditoriaMontoReclamo.setAntiguoValor(docSessionQAS.getMonto().toString());
			log.debug("Se Registr Auditoria para Monto en proceso Stor");
		}
		auditoriaService.SaveAuditoria(ObjAuditoriaMontoReclamo);
	}


	@Transactional
	private void registrarAuditoriaAnexarDocumento(Documento doc, Expediente expediente, String tipoauditoria, String modulo, String opcion, String antiguoValor, String nuevoValor) {
		log.debug("-> [Service] DocumentoService - registrarAuditoriaAnexarDocumento():void ");
		
		/*******************************************************/
		// Registrando la auditoria del Expediente
		/*******************************************************/
		Map<String, Object> session = ActionContext.getContext().getSession();
		Usuario usuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
		/*******************************************************/
		// Registrando la auditoria del Expediente
		/*******************************************************/
		Auditoria ObjAuditoriaArchivo = new Auditoria();
		ObjAuditoriaArchivo.setTipoAuditoria(tipoauditoria);
		ObjAuditoriaArchivo.setModulo(modulo);
		ObjAuditoriaArchivo.setOpcion(opcion);
		ObjAuditoriaArchivo.setFechaAudioria(new Date());
		ObjAuditoriaArchivo.setUsuario(usuario.getUsuario());
		ObjAuditoriaArchivo.setCampo("Seleccionado");
		ObjAuditoriaArchivo.setAntiguoValor(antiguoValor);
		ObjAuditoriaArchivo.setNuevoValor(nuevoValor);
		ObjAuditoriaArchivo.setExpediente(expediente);
		ObjAuditoriaArchivo.setDocumento(doc);
		auditoriaService.SaveAuditoria(ObjAuditoriaArchivo);
		// auditoriaDao.SaveAuditoria(ObjAuditoriaArchivo);
	}

	@Transactional
	public void registrarDerivacionAuditoriaDocumento(Documento doc, Usuario remitente, Usuario destinatario, String tipoauditoria, String modulo, String opcion) {
		log.debug("-> [Service] DocumentoService - registrarDerivacionAuditoriaDocumento():void ");
		
		/*******************************************************/
		// Registrando la auditoria del Expediente
		/*******************************************************/
		/*******************************************************/
		// Registrando la Auditoria del Nro Documento
		/*******************************************************/
		Auditoria ObjAuditoriaND = new Auditoria();
		ObjAuditoriaND.setTipoAuditoria(tipoauditoria);
		ObjAuditoriaND.setModulo(modulo);
		ObjAuditoriaND.setOpcion(opcion);
		ObjAuditoriaND.setFechaAudioria(new Date());
		ObjAuditoriaND.setUsuario(remitente.getUsuario());
		ObjAuditoriaND.setCampo("Propietario");
		ObjAuditoriaND.setAntiguoValor(remitente.getUsuario());
		ObjAuditoriaND.setNuevoValor(destinatario.getUsuario());
		ObjAuditoriaND.setExpediente(doc.getExpediente());
		ObjAuditoriaND.setDocumento(doc);
		auditoriaService.SaveAuditoria(ObjAuditoriaND);
		// auditoriaDao.SaveAuditoria(ObjAuditoriaND);
	}

	@Transactional
	private void registrarAuditoriaArchivos(Usuario usuario, Documento doc, ArchivoTemporal archivo, String tipoauditoria, String modulo, String opcion) {
		log.debug("-> [Service] DocumentoService - registrarAuditoriaArchivos():void ");
		
		//Registrando la auditoria del Expediente
		/*******************************************************/
		Auditoria ObjAuditoriaArchivo = new Auditoria();
		ObjAuditoriaArchivo.setTipoAuditoria(tipoauditoria);
		ObjAuditoriaArchivo.setModulo(modulo);
		ObjAuditoriaArchivo.setOpcion(opcion);
		ObjAuditoriaArchivo.setFechaAudioria(new Date());
		ObjAuditoriaArchivo.setUsuario(usuario.getUsuario());
		ObjAuditoriaArchivo.setCampo("Archivo");
		ObjAuditoriaArchivo.setNuevoValor(archivo.getSNombre());
		ObjAuditoriaArchivo.setExpediente(doc.getExpediente());
		ObjAuditoriaArchivo.setDocumento(doc);
		auditoriaService.SaveAuditoria(ObjAuditoriaArchivo);
	}

	@Transactional
	private void registrarAuditoriaDocumento(Usuario usuario, Documento doc, String tipoauditoria, String modulo, String opcion) {
		log.debug("-> [Service] DocumentoService - registrarAuditoriaDocumento():void ");
		
		/*******************************************************/
		// Registrando la auditoria del Expediente
		/*******************************************************/
		if(doc.getFirmante() == null || doc.getFirmante().getIdusuario() == null){
			doc.setFirmante(null);
		}
		Auditoria ObjAuditoriaExpediente = new Auditoria();
		ObjAuditoriaExpediente.setTipoAuditoria(tipoauditoria);// Constantes.
		// TA_RegistrarNvoDoc_UserFinal
		ObjAuditoriaExpediente.setModulo(modulo);// Constantes.TM_UserFinal
		ObjAuditoriaExpediente.setOpcion(opcion);// Constantes.TO_Registrar
		ObjAuditoriaExpediente.setFechaAudioria(new Date());
		ObjAuditoriaExpediente.setUsuario(usuario.getUsuario());
		ObjAuditoriaExpediente.setCampo("Nro Expediente");
		ObjAuditoriaExpediente.setNuevoValor(doc.getExpediente().getNroexpediente());
		ObjAuditoriaExpediente.setExpediente(doc.getExpediente());
		auditoriaService.SaveAuditoria(ObjAuditoriaExpediente);
		/*******************************************************/
		// Registrando la auditoria del Proceso
		/*******************************************************/
		Auditoria ObjAuditoriaProceso = new Auditoria();
		ObjAuditoriaProceso.setTipoAuditoria(tipoauditoria);
		ObjAuditoriaProceso.setModulo(modulo);
		ObjAuditoriaProceso.setOpcion(opcion);
		ObjAuditoriaProceso.setFechaAudioria(new Date());
		ObjAuditoriaProceso.setUsuario(usuario.getUsuario());
		ObjAuditoriaProceso.setCampo("Proceso");
		ObjAuditoriaProceso.setNuevoValor(doc.getExpediente().getProceso().getNombre());
		ObjAuditoriaProceso.setExpediente(doc.getExpediente());
		auditoriaService.SaveAuditoria(ObjAuditoriaProceso);
		/*************************************************************************************************/
		// Registrando la Auditoria del Tipo Documento
		/**************************************************************************************************/
		Auditoria ObjAuditoriaTD = new Auditoria();
		ObjAuditoriaTD.setTipoAuditoria(tipoauditoria);
		ObjAuditoriaTD.setModulo(modulo);
		ObjAuditoriaTD.setOpcion(opcion);
		ObjAuditoriaTD.setFechaAudioria(new Date());
		ObjAuditoriaTD.setUsuario(usuario.getUsuario());
		ObjAuditoriaTD.setCampo("Tipo Documento");
		ObjAuditoriaTD.setNuevoValor(doc.getTipoDocumento().getNombre());
		ObjAuditoriaTD.setExpediente(doc.getExpediente());
		ObjAuditoriaTD.setDocumento(doc);
		auditoriaService.SaveAuditoria(ObjAuditoriaTD);
		/*******************************************************/
		// Registrando la Auditoria del Nro Documento
		/*******************************************************/
		Auditoria ObjAuditoriaND = new Auditoria();
		ObjAuditoriaND.setTipoAuditoria(tipoauditoria);
		ObjAuditoriaND.setModulo(modulo);
		ObjAuditoriaND.setOpcion(opcion);
		ObjAuditoriaND.setFechaAudioria(new Date());
		ObjAuditoriaND.setUsuario(usuario.getUsuario());
		ObjAuditoriaND.setCampo("Nro Documento");
		ObjAuditoriaND.setNuevoValor(doc.getNumeroDocumento());
		ObjAuditoriaND.setExpediente(doc.getExpediente());
		ObjAuditoriaND.setDocumento(doc);
		auditoriaService.SaveAuditoria(ObjAuditoriaND);
	}


	@Transactional
	private void actualizarDatosAdicionalesDocStor(Documento doc, String strAccion) {
		log.debug("-> [Service] DocumentoService - actualizarDatosAdicionalesDocStor():void ");
		
		//FIXME esta logica es del action!!!!!!!
		HttpServletRequest request = ServletActionContext.getRequest();
		Map<String, Object> session = ActionContext.getContext().getSession();
		/************************************************************/
		// Actualizando los Subministros
		/************************************************************/
		for (int i = 0; i < doc.getDocumentoStor().getSuministros().size(); i++) {
			String suministro = request.getParameter("idSuministro" + i);
			if (suministro != null && !suministro.equals("")) {
				Suministro objSum = new Suministro();
				objSum.setDocumentostor(doc.getDocumentoStor());
				Integer idsuministro = Integer.parseInt(suministro);
				objSum.setIdsuministro(idsuministro);
				String nrosuministro = request.getParameter("nrosuministro" + i);
				objSum.setNrosuministro(nrosuministro);
				suministroDao.saveSuministro(objSum);
			} else {
				log.warn("El indice " + i + " de la lista de suministros del documento stor no cuenta con una correspondencia en el jsp.");
			}
		}
		/************************************************************/
		// Actualizando los SubMotivos
		/************************************************************/
		WebApplicationContext wac = WebApplicationContextUtils.getWebApplicationContext(request.getSession().getServletContext());
		SubmotivoDAO submotivoDAO = (SubmotivoDAO) wac.getBean("submotivoDAO");
		// MotivoDAO motivoDao=(MotivoDAO)wac.getBean("motivoDAO");
		List<Submotivo> dataSubMotivo = new ArrayList<Submotivo>();
		// List<Motivo> dataMotivo=new ArrayList<Motivo>();
		for (int j = 0; j < doc.getDocumentoStor().getSubmotivos().size(); j++) {
			String chkEstado = request.getParameter("chkEstado" + j);
			if (chkEstado == null) {
				String idSubmotivo = request.getParameter("SubMotivoSelect" + j);
				if (idSubmotivo != null && !idSubmotivo.equals("")) {
					// Integer
					// idmotivo=Integer.parseInt(request.getParameter("MotivoSelect"+j));
					Integer idSubMotivo = Integer.parseInt(idSubmotivo);
					// Motivo motivo=motivoDao.findByIdmotivo(idmotivo);
					Submotivo submotivo = submotivoDAO.findByIdSubmotivo(idSubMotivo);
					// dataMotivo.add(motivo);
					dataSubMotivo.add(submotivo);
				} else {
					log.warn("El submotivo con indice " + j + " del documento stor no tiene una correspondencia ne el jsp.");
				}
			}
		}
		DocumentostorDAO docStorSev = (DocumentostorDAO) wac.getBean("documentostorDAO");
		DocumentoStor objDS = doc.getDocumentoStor();
		/*
		 * if(request.getParameter("monto").length()!=0){
		 * log.debug("Corrigindo MONTO NULO");
		 */
		String montoRequest = request.getParameter("monto");
		// montoRequest = montoRequest.replace(".", "");
		// montoRequest = montoRequest.replace(",", ".");
		montoRequest = montoRequest.trim();
		log.debug("Longitud de String desde Request:" + montoRequest.length() + " Valor de monto desde Request: " + montoRequest);
		// Double monto = Double.parseDouble(monto1!=null?monto1:"0");
		// Double monto = Double.parseDouble(monto1);
		Double monto = ((montoRequest.length() != 0) ? Double.parseDouble(montoRequest) : null);
		objDS.setMonto(monto);
		/*
		 * }else{ Float monto = Float.parseFloat("0"); objDS.setMonto(monto); }
		 */
		objDS.setSubmotivos(dataSubMotivo);
		docStorSev.saveDocumentoStor(objDS);
		/* REGISTRANDO LA AUDITORIA PARA DATOS ADICIONALES DE STOR */
		this.registrarAuditoriaAdicionalStor(objDS, ((Usuario) session.get(Constantes.SESSION_USUARIO)), strAccion);
	}

	/**
	 * Rechaza un documento de antiflujo
	 *
	 * @param documento
	 *            el documento a rechazar
	 * @author German Enriquez
	 */
	@Transactional
	@Override
	public void rechazarDocumento(Usuario remitente, Documento documento, String nombrePC) {
		log.debug("-> [Service] DocumentoService - rechazarDocumento():void ");
		
		rechazarDocumento(remitente, documento, documento.getAsunto(), documento.getContenido(), documento.getAccion().getNombre(), nombrePC);
	}

	/**
	 * Rechaza un documento de antiflujo
	 *
	 * @param documento
	 *            el documento a rechazar
	 * @author German Enriquez
	 */
	@Transactional
	@Override
	public void rechazarDocumento(Usuario remitente, Documento documento, String asunto, String contenido, String accion, String nombrePC) {
		log.debug("-> [Service] DocumentoService - rechazarDocumento():void ");
		
		// supuestamente aca no cambia el documento debido a que es un rechazo,
		// por eso la trazabilidad de este documento es la que se debe buscar
		Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findByMaxNroRegistro(documento.getIdDocumento(), null, null, null);
		if (trazabilidad != null) {
			//el destinatario del rechazo es el remitente de la derivacion
			Usuario destinatario = trazabilidad.getRemitente();
			//el remitente es el usuario que tiene el documento
			documento.setPropietario(destinatario);
			/*Object obj = ServletActionContext.getRequest().getSession().getAttribute("UsuarioCompartido");
			if (obj != null) {
				Usuario p = (Usuario) obj;
				documento.setRemitente(p.getNombres() + " " + p.getApellidos());
			} else {*/
				documento.setRemitente(remitente.getNombres() + " " + remitente.getApellidos());
			//}
			documento.setUltimoAsunto(asunto);
			Accion idaccion = accionService.findByNombre(accion);
			documento.setAccion(idaccion);

			if (Constantes.ACCION_RECHAZAR.equals(accion)) {
				documento.setEstaEnFlujo(Constantes.ESTAENFLUJO_N);
			}
			// Trazabilidaddocumento anterior=null;
			try {
				trazabilidadDocumentoService.getTrazabilidadAnterior(trazabilidad);
			} catch (Exception e) {
				log.warn(" no hay traza previa ");
			}

			/*
			 * if(anterior!=null){
			 * documento.setFechaLimiteAtencion(anterior.getFechalimiteatencion
			 * ()); }else{
			 *
			 * }
			 */
			documento.setFechaAccion(new Date());
			documento = documentoDao.saveDocumento(documento);
			
			trazabilidad = trazabilidadDocumentoService.guardarTrazabilidad(documento, remitente, destinatario, idaccion, asunto, contenido, nombrePC);
			
			int iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_RECHAZAR;
			
			if(Constantes.ACCION_APROBAR.equals(accion)){
				iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_APROBAR;
				
				Documentoenviado documentoenviado = new Documentoenviado();
				documentoenviado.setIdTrazabilidadEnvio(trazabilidad.getIdtrazabilidaddocumento());
				documentoenviado.setUsuario(remitente);
				documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
				documentoenviado.setTipoEnvio(Constantes.TIPO_ENVIO_TRANSFERIR);
				documentoEnviadoDao.saveDocumento(documentoenviado);
			}
			/*Expediente expediente = documento.getExpediente();

			if (expediente != null) {
				/*
                expediente.setAsunto(documento.getAsunto());
                expediente.setContenido(documento.getContenido());
				 *
				Proceso proceso = expediente.getProceso();
				if (proceso != null) {
					//si el usuario que rechaza es responsable del expediente y el que recibira el documento
					//es responsable del proceso, el responsable del expediente sera este ultimo
					if (expediente.getIdpropietario().equals(remitente) && proceso.getResponsable().equals(destinatario)) {
						expediente.setIdpropietario(destinatario);
					}

				}

				List<Documento> documentosQueSeVanARechazar = expediente.getDocumentoList();
				//log.debug("asdfg asunto :" + asunto + " conteido :" + contenido);
				for (Documento documentoArrechazado : documentosQueSeVanARechazar) {
					// le guardo la trazbilidad a todos los documentos
					if (documentoArrechazado.getPrincipal() == Constantes.DOCUMENTO_PRINCIPAL) {
						Documento docMasAntiguo = documentoDao.buscarDocumentoMasAntiguoPor(expediente.getIdexpediente());
						Date fecalimite = docMasAntiguo.getFechaLimiteAtencion();
						documentoArrechazado.setFechaLimiteAtencion(fecalimite);
					}

					if (documentoArrechazado.getArchivos() != null) {
						log.info("Cambiando el estado a [" + documentoArrechazado.getArchivos().size() + "] Archivo(s)");

						for (Archivo archivo : documentoArrechazado.getArchivos()) {
							//archivo.setEstadoDigitalizacion(Archivo.ESTADO_DISPONIBLE);
							if (archivo.getEstadoDigitalizacion() != Constantes.ARCHIVO_ESTADO_DIGITALIZACION_INACTIVO) {
								archivo.setEstadoDigitalizacion(Constantes.ARCHIVO_ESTADO_DIGITALIZACION_RECHAZADO);
							}
							archivoService.saveArchivo(archivo);
						}
					}

					//if(documento.getIdDocumento().intValue()!=documentoArrechazado.getIdDocumento().intValue() ){}
					trazabilidadDocumentoService.guardarTrazabilidad(documentoArrechazado, remitente, destinatario, idaccion, asunto, contenido);
				}

				if (Constantes.ACCION_RECHAZAR.equals(accion)) {
					expediente.setEstaenflujo(Constantes.ESTAENFLUJO_N);
				}

				expedienteService.saveExpediente(expediente);
			}*/
			//trazabilidadDocumentoService.guardarTrazabilidad(documento,remitente,destinatario,Constantes.ACCION_RECHAZAR,asunto,contenido);
			//trazabilidadDocumentoService.generarSeguimiento(documento.getExpediente().getIdexpediente());
			
			notificacionService.informarViaNotifAndMail(remitente, documento, iEvento, Constantes.TIPO_NOTIFICACION_RECHAZO, nombrePC);
			
			//trazabilidadExpedienteService.guardarTrazabilidad(expediente, remitente, destinatario, idaccion, "");
			log.info("Se rechazo el documento " + documento + " satisfactoriamente");
		} else {
			log.warn("No se encontro ninguna trazabilidad para el documento " + documento.getNumeroDocumento() + ". No se rechazara el documento");
		}
	}
	
	/**
	 * 
	 *
	 */
	@Transactional
	@Override
	public void despacharDocumento_IG(Documento documento, String asunto,
			String contenido, String accion, String nombrePC , Integer idDestinatario) {
		log.debug("-> [Service] DocumentoService - rechazarDocumento():void ");
		
		
		if(documento.getDocumentoreferencia() ==null ){
			// supuestamente aca no cambia el documento debido a que es un despachar,
			// por eso la trazabilidad de este documento es la que se debe buscar
			Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findByMaxNroRegistro(documento.getIdDocumento(), null, null, null);
			if (trazabilidad != null) {
				
				String strCont = contenido;
				strCont += "<br />______________________________________________<br />"+ trazabilidad.getContenido();
				//documento.setFechaAccion(new Date());
				documento.setDespachado(Constantes.ESTADO_DESPACHADO);
				documento = documentoDao.saveDocumento(documento);
				trazabilidad.setContenido(strCont);
				trazabilidad = trazabilidadDocumentoService.updateTrazabilidadDocumento(trazabilidad);
				log.info("Se despachado el documento " + documento + " satisfactoriamente");
			} else {
				log.warn("No se encontro ninguna trazabilidad para el documento " + documento.getNumeroDocumento() + ". No se rechazara el documento");
			}	
		}else{
			 log.info("Entro despachar un multiple" + documento + " satisfactoriamente");
			 Trazabilidadapoyo trazaApoyo = trazabilidadapoyoService.buscarUltimaDelegacionUsuario(idDestinatario, documento.getIdDocumento());			
			 String strCont = contenido;
				strCont += "<br />______________________________________________<br />"+ trazaApoyo.getTexto();
				//documento.setFechaAccion(new Date());
				documento.setDespachado(Constantes.ESTADO_DESPACHADO);
				documento = documentoDao.saveDocumento(documento);
				trazaApoyo.setTexto(strCont); 
				trazaApoyo = trazabilidadapoyoService.guardar(trazaApoyo);
				log.info("Se despachado el documento " + documento + " satisfactoriamente");
		}
	}

	/**
	 * Anula o quita la referencia a un documento para el expediente dado.
	 *
	 * @param documento
	 * 			El documento a anular
	 * @param expediente
	 * 			El expediente que contiene el documento
	 * @param unico
	 * 			Indica si el documento es el unico perteneciente al documento
	 */
	@Transactional
	@Override
	public void anularDocumento(Usuario remitente, Documento documento, Expediente expediente, boolean unico, Usuario usuarioLogeado, String nombrePC) {
		log.debug("-> [Service] DocumentoService - anularDocumento():void ");
		
		/*List<Documentoxexpediente> referenciados = expediente.getDocumentoxexpedienteList();
		List<Documentoxexpediente> nueva = new ArrayList<Documentoxexpediente>();
		boolean anulado = false;
		if (referenciados != null && referenciados.size() > 0) {
			for (Documentoxexpediente ref : referenciados) {
				if (ref.getDocumentoxexpedientePK().getIddocumento() != documento.getIdDocumento()) {
					nueva.add(ref);
				} else {
					anulado = true;
				}
			}
		}
		//el documento no es referenciado
		if (!anulado) {
			if (documento.esDocumentoPrincipal()) {
				Documento reciente = documentoDao.getDocumentoMasReciente(expediente.getIdexpediente(), documento.getIdDocumento());
				if (reciente != null) {
					reciente.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
					documentoDao.saveDocumento(reciente);
				}
			}*/
		
			documento.setEstado(Constantes.ESTADO_ANULADO);
			//wcarrasco 24-10-2011 actualiza fechaAccion 
			documento.setFechaAccion(new Date());
			documentoDao.updateDocumento(documento);
		
			if(documento.getDocumentoreferencia() == null){
			trazabilidadDocumentoService.guardarTrazabilidad(documento, remitente, documento.getPropietario(), Constantes.ACCION_ANULAR, "Anulado el documento : "+documento.getNumeroDocumento(), documento.getObservacion(), nombrePC);				   
			}else{
				
				try{
					
					Trazabilidadapoyo tapoyo = new Trazabilidadapoyo();
					tapoyo.setAccion(accionService.findByNombre(Constantes.ACCION_ANULAR));
					tapoyo.setDestinatario(documento.getPropietario());
					tapoyo.setRemitente(remitente);
					tapoyo.setFechacreacion(new Date());
					tapoyo.setDocumento(documento.getIdDocumento());
					Trazabilidadapoyo tapoyoorigen =  trazabilidadapoyoService.buscarUltimaDelegacionUsuario(documento.getPropietario().getIdusuario(), documento.getIdDocumento());
					if(tapoyoorigen != null && tapoyoorigen.getTrazabilidad() != null){
						Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findTrabilidadbyId(tapoyoorigen.getTrazabilidad().getIdtrazabilidaddocumento());
						tapoyo.setTrazabilidad(trazabilidad);
						tapoyo.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_ANULADO));
						tapoyo.setTexto(documento.getObservacion() != null ? documento.getObservacion() : "");
						tapoyo.setAsunto("Anulando documento "+documento.getNumeroDocumento());
						tapoyo.setNombrePC(nombrePC);
						tapoyo.setFechalimiteatencion(tapoyo.getFechacreacion());
						trazabilidadapoyoService.guardar(tapoyo);
					}else{
						log.debug("No se encontro traza de apoyo");
					}
				}catch(Exception e){
					log.debug("No se ha podido guardar la traza del documento delegado");
					e.printStackTrace();
				}
				
			}
			
			
			
			//else{queda pendiente donde se va guardar la trazabilidad para otros documentos anulados para documento.getDocumentoreferencia() != null, asi como en el archivar se guardo en trazabilidad apoyo }
			
			
			/*
			for (Archivo archivo : documento.getArchivos()) {
				if (log.isDebugEnabled()) {
					log.debug("Anulando archivo [" + archivo.getRutaAlfresco() + "]");
				}

				archivo.setEstadoDigitalizacion(Constantes.ESTADO_INACTIVO);
				archivoService.saveArchivo(archivo);
				repositorioService.eliminarNodo(usuarioLogeado.getUsuario(), usuarioLogeado.getClave(), archivo.getRutaAlfresco());
			}
		} else {
			expediente.setDocumentoxexpedienteList(nueva);
			expedienteService.saveExpediente(expediente);
		}
		//si es el unico documento del expediente, anulamos el expediente
		if (unico) {
			expediente.setEstado(Constantes.ESTADO_ANULADO);
			expedienteService.saveExpediente(expediente);
		}*/
	}
	
	/**
	 * 
	 */
	@Transactional
	@Override
	public void atenderDocumento(Usuario remitente, Documento documento, Expediente expediente, boolean unico, Usuario usuarioLogeado, String nombrePC) {
		log.debug("-> [Service] DocumentoService - atenderDocumento():void ");

			documento.setEstado(Constantes.ESTADO_ATENDER);
			//wcarrasco 24-10-2011 actualiza fechaAccion 
			documento.setFechaAccion(new Date());
			documentoDao.updateDocumento(documento);
		
			if(documento.getDocumentoreferencia() == null){
			trazabilidadDocumentoService.guardarTrazabilidad(documento, remitente, documento.getPropietario(), Constantes.ACCION_ATENDER, "Atender el documento : "+documento.getNumeroDocumento(), documento.getObservacion(), nombrePC);				   
			}else{
				
				try{
					
					Trazabilidadapoyo tapoyo = new Trazabilidadapoyo();
					tapoyo.setAccion(accionService.findByNombre(Constantes.ACCION_ATENDER));
					tapoyo.setDestinatario(documento.getPropietario());
					tapoyo.setRemitente(remitente);
					tapoyo.setFechacreacion(new Date());
					tapoyo.setDocumento(documento.getIdDocumento());
					Trazabilidadapoyo tapoyoorigen =  trazabilidadapoyoService.buscarUltimaDelegacionUsuario(documento.getPropietario().getIdusuario(), documento.getIdDocumento());
					if(tapoyoorigen != null && tapoyoorigen.getTrazabilidad() != null){
						Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findTrabilidadbyId(tapoyoorigen.getTrazabilidad().getIdtrazabilidaddocumento());
						tapoyo.setTrazabilidad(trazabilidad);
						tapoyo.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_ATENDER));
						tapoyo.setTexto(documento.getObservacion() != null ? documento.getObservacion() : "");
						tapoyo.setAsunto("Atencion del documento "+documento.getNumeroDocumento());
						tapoyo.setNombrePC(nombrePC);
						tapoyo.setFechalimiteatencion(tapoyo.getFechacreacion());
						trazabilidadapoyoService.guardar(tapoyo);
					}else{
						log.debug("No se encontro traza de apoyo");
					}
				}catch(Exception e){
					log.debug("No se ha podido guardar la traza del documento delegado");
					e.printStackTrace();
				}
				
			}
			
			//else{queda pendiente donde se va guardar la trazabilidad para otros documentos anulados para documento.getDocumentoreferencia() != null, asi como en el archivar se guardo en trazabilidad apoyo }
			
	}
	
	@Override
	public List<Documento> busquedaDocumentoSimple(String asunto, Usuario usuario) {
		log.debug("-> [Service] DocumentoService - busquedaDocumentoSimple():List<Documento> ");
		
		if (asunto != null) {
			try{
				asunto = "%"+asunto.toLowerCase()+"%";
				List<Documento> documentos = documentoDao.busquedaRapidaDocumento(asunto);
				List<Documento> salida = new ArrayList<Documento>();
				
				Unidad funcional = usuario.getUnidad();
				while(funcional.getDependencia() != null){
					funcional = funcional.getDependencia();
				}
				
				for(Documento doc : documentos){
					Unidad funcionalDoc = doc.getAutor().getUnidad();
					while(funcionalDoc.getDependencia() != null){
						funcionalDoc = funcionalDoc.getDependencia();
					}
					
					if(funcional.getIdunidad().intValue() == funcionalDoc.getIdunidad().intValue()){
						salida.add(doc);
					}
					
				}
				
				return salida;
			}catch(Exception e){
				e.printStackTrace();
				return null;
			}
		}
		return null;
	}

	@SuppressWarnings("deprecation")
	@Override
	public List<DocumentoAreaFuncional> busquedaDocumentoAreaFuncionalSimple(String campo) {
		log.debug("-> [Service] DocumentoService - busquedaDocumentoAreaFuncionalSimple():List<DocumentoAreaFuncional> ");
		
		if (campo != null) {
			campo = campo.toLowerCase();
			String asuntoDocumento = "%"+campo+"%";
			String asuntoExpediente = "%"+campo+"%";			
			Date fechaDesde = null;
			Date fechaHasta = null;
			Integer IdAreaFuncional;			
			SimpleDateFormat fechita = new SimpleDateFormat("dd/MM/yyyy");
			
			mapSession = ActionContext.getContext().getSession();
			Usuario usuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
			usuario = usuarioService.findByIdUsuario(usuario.getIdusuario());
			Integer idAreaUsuario = usuario.getUnidad().getIdunidad();
			
			Unidad unidad = new Unidad();
			unidad= unidadService.buscarObjPor(Integer.parseInt(idAreaUsuario.toString().trim()));
			if(unidad.getDependencia() != null){
				IdAreaFuncional= unidad.getDependencia().getIdunidad();	
			}else{
				IdAreaFuncional=null;
			}
			
			try {					
				List<Parametro> resultadoFechaBusquedaRapida  = parametroService.findAll();	
				for(Parametro parametro: resultadoFechaBusquedaRapida ){
					if(parametro.getTipo().equals(Constantes.PARAMETRO_TIPO_FECHA_DESDE_BUSQUEDA_RAPIDA)){				
						fechaDesde= fechita.parse(parametro.getValor().toString().trim());
					}
					if(parametro.getTipo().equals(Constantes.PARAMETRO_TIPO_FECHA_HASTA_BUSQUEDA_RAPIDA)){
						fechaHasta= fechita.parse(parametro.getValor().toString().trim());
						fechaHasta.setHours(24);
						fechaHasta.setMinutes(0);
						fechaHasta.setSeconds(0);
					}					
				}
				log.debug("busquedaDocumentoAreaFuncionalSimple(Campo)  "+ "Fecha Desde: "+ fechaDesde +"Fecha Hasta: " +fechaHasta);
				
			} catch (ParseException e) {
				e.printStackTrace();
			}			
			log.debug("busquedaDocumentoAreaFuncionalSimple(Campo)  "+ "asuntoDocumento "+ asuntoDocumento +"asuntoExpediente: " +asuntoExpediente+"idAreaUsuario: "+idAreaUsuario+"IdAreaFuncional: "+IdAreaFuncional+"");
			return documentoDao.busquedaDocumento(asuntoDocumento, asuntoExpediente, fechaDesde, fechaHasta,idAreaUsuario,IdAreaFuncional,"OR");
			}
		return null;
	}
	
	@Deprecated
	/** usar el metodo sobrecargado*/
	@Override
	public List<Documento> busquedaDocumentoAvanzada(boolean alfresco, String contenido, String numeroDocumento, String numeroMesaPartes, String asuntoDocumento, String numeroExpediente, String asuntoExpediente, String estadoExpediente, String concesionario, String cliente, String proceso, String propietario, String areaDestino, String tipoDocumento, String fechaDocumentoDesde, String fechaDocuentoHasta, String fechaExpedienteDesde, String fechaExpedienteHasta, String operador) {
		log.debug("-> [Service] DocumentoService - busquedaDocumentoAvanzada():List<Documento> ");
		
		// para buscar por contenido, es necesario haber iniciado sesion en alfresco.
		// alfresco devolvera los id de documento que contienen el texto buscado,
		// luego habra que incorporar esos documentos a la busqueda normal
				
		List<Integer> idDocumentos = null;
		if (contenido != null && !contenido.equals("")) {
			if (alfresco) {
				idDocumentos = repositorioService.busquedaIdDocumentos(contenido.toLowerCase(), null);
			}
		}
		if (numeroDocumento != null && numeroDocumento.equals("")) {
			numeroDocumento = null;
		}
		if (numeroMesaPartes != null && numeroMesaPartes.equals("")) {
			numeroMesaPartes = null;
		}
		if (asuntoDocumento != null && asuntoDocumento.equals("")) {
			asuntoDocumento = null;
		}
		if (numeroExpediente != null && numeroExpediente.equals("")) {
			numeroExpediente = null;
		}
		if (asuntoExpediente != null && asuntoExpediente.equals("")) {
			asuntoExpediente = null;
		}
		if (estadoExpediente != null && estadoExpediente.equals("")) {
			estadoExpediente = null;
		}
		if (concesionario != null && concesionario.equals("")) {
			concesionario = null;
		}
		if (cliente != null && cliente.equals("")) {
			cliente = null;
		}
		if (proceso != null && proceso.equals("")) {
			proceso = null;
		}
		if (propietario != null && propietario.equals("")) {
			propietario = null;
		}
		if (areaDestino != null && areaDestino.equals("")) {
			areaDestino = null;
		}
		if (tipoDocumento != null && tipoDocumento.equals("")) {
			tipoDocumento = null;
		}
		if (fechaDocumentoDesde != null && fechaDocumentoDesde.equals("")) {
			fechaDocumentoDesde = null;
		}
		if (fechaDocuentoHasta != null && fechaDocuentoHasta.equals("")) {
			fechaDocuentoHasta = null;
		}
		if (fechaExpedienteDesde != null && fechaExpedienteDesde.equals("")) {
			fechaExpedienteDesde = null;
		}
		if (fechaExpedienteHasta != null && fechaExpedienteHasta.equals("")) {
			fechaExpedienteHasta = null;
		}

		if (numeroDocumento != null) {
			numeroDocumento = "%" + numeroDocumento.toLowerCase() + "%";
		}
		if (numeroMesaPartes != null) {
			numeroMesaPartes = "%" + numeroMesaPartes.toLowerCase() + "%";
			;
		}
		if (asuntoDocumento != null) {
			asuntoDocumento = "%" + asuntoDocumento.toLowerCase() + "%";
			;
		}
		if (numeroExpediente != null) {
			numeroExpediente = "%" + numeroExpediente.toLowerCase() + "%";
			;
		}
		if (asuntoExpediente != null) {
			asuntoExpediente = "%" + asuntoExpediente.toLowerCase() + "%";
			;
		}
		if (estadoExpediente != null) {
			estadoExpediente = "%" + estadoExpediente.toLowerCase() + "%";
			;
		}
		if (concesionario != null) {
			concesionario = "%" + concesionario.toLowerCase() + "%";
			;
		}
		if (cliente != null) {
			cliente = "%" + cliente.toLowerCase() + "%";
			;
		}
		if (proceso != null) {
			proceso = "%" + proceso.toLowerCase() + "%";
			;
		}
		if (propietario != null) {
			propietario = "%" + propietario.toLowerCase() + "%";
			;
		}
		if (areaDestino != null) {
			areaDestino = "%" + areaDestino.toLowerCase() + "%";
			;
		}
		if (tipoDocumento != null) {
			tipoDocumento = "%" + tipoDocumento.toLowerCase() + "%";
			;
		}
		SimpleDateFormat formato = Constantes.FORAMATEADOR_FECHA;
		Date documentoDesde = null;
		Date documentoHasta = null;
		Date expedienteDesde = null;
		Date expedienteHasta = null;
		if (fechaDocumentoDesde != null) {
			try {
				documentoDesde = formato.parse(fechaDocumentoDesde);
			} catch (ParseException e) {
			}
		}
		if (fechaDocuentoHasta != null) {
			try {
				documentoHasta = formato.parse(fechaDocuentoHasta);
			} catch (ParseException e) {
			}
		}
		if (fechaExpedienteDesde != null) {
			try {
				expedienteDesde = formato.parse(fechaExpedienteDesde);
			} catch (ParseException e) {
			}
		}
		if (fechaExpedienteHasta != null) {
			try {
				expedienteHasta = formato.parse(fechaExpedienteHasta);
			} catch (ParseException e) {
			}
		}
		return documentoDao.busquedaDocumento(idDocumentos, numeroDocumento, numeroMesaPartes, asuntoDocumento, numeroExpediente, asuntoExpediente, estadoExpediente, concesionario, cliente, proceso, propietario, areaDestino, tipoDocumento, documentoDesde, documentoHasta, expedienteDesde, expedienteHasta, operador);
	}

	@SuppressWarnings("deprecation")
	public List<Documento> busquedaDocumentoAvanzada(String contenido,
			String numeroDocumento, String numeroMesaPartes, String asuntoDocumento,
			String numeroExpediente, String asuntoExpediente, String estadoExpediente,
			String concesionario, String cliente, String proceso, String propietario,
			String areaDestino, String tipoDocumento, String fechaDocumentoDesde,
			String fechaDocuentoHasta, String fechaExpedienteDesde, String fechaExpedienteHasta,
			String nroSuministro, String operador, String areaOrigen, String areaAutor) {
		
		log.debug("-> [Service] DocumentoService - busquedaDocumentoAvanzada():List<Documento> ");
		
		// para buscar por contenido, es necesario haber iniciado sesion en alfresco.
		// alfresco devolvera los id de documento que contienen el texto buscado,
		// luego habra que incorporar esos documentos a la busqueda normal
		List<Integer> idDocumentos = null;
		if (contenido != null && !contenido.equals("")) {
			idDocumentos = repositorioService.busquedaIdDocumentos(contenido.toLowerCase(), null);
		}
		if (numeroDocumento != null && numeroDocumento.equals("")) {
			numeroDocumento = null;
		}
		if (numeroMesaPartes != null && numeroMesaPartes.equals("")) {
			numeroMesaPartes = null;
		}
		if (asuntoDocumento != null && asuntoDocumento.equals("")) {
			asuntoDocumento = null;
		}
		if (numeroExpediente != null && numeroExpediente.equals("")) {
			numeroExpediente = null;
		}
		if (asuntoExpediente != null && asuntoExpediente.equals("")) {
			asuntoExpediente = null;
		}
		if (estadoExpediente != null && (estadoExpediente.equals("")) || estadoExpediente.equals("%")) {
			estadoExpediente = null;
		}
		if (concesionario != null && concesionario.equals("")) {
			concesionario = null;
		}
		if (cliente != null && cliente.equals("")) {
			cliente = null;
		}
		if (proceso != null && proceso.equals("")) {
			proceso = null;
		}
		if (propietario != null && propietario.equals("")) {
			propietario = null;
		}
		if (areaDestino != null && areaDestino.equals("")) {
			areaDestino = null;
		}
		if (areaOrigen != null && areaOrigen.equals("")) {
			areaOrigen = null;
		}
		if (areaAutor != null && areaAutor.equals("")) {
			areaAutor = null;
		}
		if (tipoDocumento != null && tipoDocumento.equals("")) {
			tipoDocumento = null;
		}
		if (nroSuministro != null && nroSuministro.equals("")) {
			nroSuministro = null;
		}
		if (fechaDocumentoDesde != null && fechaDocumentoDesde.equals("")) {
			fechaDocumentoDesde = null;
		}
		if (fechaDocuentoHasta != null && fechaDocuentoHasta.equals("")) {
			fechaDocuentoHasta = null;
		}
		if (fechaExpedienteDesde != null && fechaExpedienteDesde.equals("")) {
			fechaExpedienteDesde = null;
		}
		if (fechaExpedienteHasta != null && fechaExpedienteHasta.equals("")) {
			fechaExpedienteHasta = null;
		}

		//formar para el like
		if (numeroDocumento != null) {
			numeroDocumento = "%" + numeroDocumento.toUpperCase() + "%";
		}
		if (numeroMesaPartes != null) {
			numeroMesaPartes = "%" + numeroMesaPartes.toUpperCase() + "%";
		}
		if (asuntoDocumento != null) {
			asuntoDocumento = "%" + asuntoDocumento.toUpperCase() + "%";
		}
		if (numeroExpediente != null) {
			numeroExpediente = "%" + numeroExpediente.toUpperCase() + "%";
		}
		if (asuntoExpediente != null) {
			asuntoExpediente = "%" + asuntoExpediente.toUpperCase() + "%";
		}
		if (estadoExpediente != null) {
			estadoExpediente = estadoExpediente.toUpperCase();
		}
		if (concesionario != null) {
			concesionario = "%" + concesionario.toUpperCase() + "%";
		}
		if (cliente != null) {
			cliente = "%" + cliente.toUpperCase() + "%";
		}
		//        if (proceso != null) {
		//            proceso = "%" + proceso.toUpperCase() + "%";
		//        }
		if (propietario != null) {
			propietario = "%" + propietario.toUpperCase() + "%";
		}
		//        if (areaDestino != null) {
		//            areaDestino = "%" + areaDestino.toUpperCase() + "%";
		//        }
		//        if (tipoDocumento != null) {
		//            tipoDocumento = "%" + tipoDocumento.toUpperCase() + "%";
		//        }
		if (nroSuministro != null) {
			nroSuministro = "%" + nroSuministro.toUpperCase() + "%";
		}
		SimpleDateFormat formato = Constantes.FORAMATEADOR_FECHA;
		Date documentoDesde = null;
		Date documentoHasta = null;
		Date expedienteDesde = null;
		Date expedienteHasta = null;
		if (fechaDocumentoDesde != null) {
			try {
				documentoDesde = formato.parse(fechaDocumentoDesde);
				documentoDesde.setHours(0);
				documentoDesde.setMinutes(0);
				documentoDesde.setSeconds(0);
			} catch (ParseException e) {
			}
		}
		if (fechaDocuentoHasta != null) {
			try {
				documentoHasta = formato.parse(fechaDocuentoHasta);
				documentoHasta.setHours(23);
				documentoHasta.setMinutes(59);
				documentoHasta.setSeconds(59);
			} catch (ParseException e) {
			}
		}
		if (fechaExpedienteDesde != null) {
			try {
				expedienteDesde = formato.parse(fechaExpedienteDesde);
				expedienteDesde.setHours(0);
				expedienteDesde.setMinutes(0);
				expedienteDesde.setSeconds(0);
			} catch (ParseException e) {
			}
		}
		if (fechaExpedienteHasta != null) {
			try {
				expedienteHasta = formato.parse(fechaExpedienteHasta);
				expedienteHasta.setHours(23);
				expedienteHasta.setMinutes(59);
				expedienteHasta.setSeconds(59);
			} catch (ParseException e) {
			}
		}
		return documentoDao.busquedaDocumento(idDocumentos, numeroDocumento,
				numeroMesaPartes, asuntoDocumento, numeroExpediente, asuntoExpediente,
				estadoExpediente, concesionario, cliente, proceso, propietario,
				areaDestino, tipoDocumento, documentoDesde, documentoHasta,
				expedienteDesde, expedienteHasta, nroSuministro, operador, areaOrigen, areaAutor);
	}

	@Override
	public List<Documento> getDocumentosPorExpediente(int idExpediente) {
		log.debug("-> [Service] DocumentoService - getDocumentosPorExpediente():List<Documento> ");
		
		return documentoDao.getDocumentosPorExpediente(idExpediente);
	}

	public List<Documento> getDocumentosNoConfidencialesPorExpediente(int idExpediente){
		log.debug("-> [Service] DocumentoService - getDocumentosNoConfidencialesPorExpediente():List<Documento> ");
		
		return documentoDao.getDocumentosNoConfidencialesPorExpediente(idExpediente);
	}
	
	/**
	 * Cambia la referencia para un documento de un expediente a otro
	 *
	 * @author German Enriquez
	 * @throws Exception
	 */
	@Transactional
	@Override
	public void cambiarReferencia(Documento documento, Expediente expediente, Expediente expedienteNuevo, boolean unico) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - cambiarReferencia():void ");
		
		documento.setExpediente(expedienteNuevo);
		documentoDao.updateDocumento(documento);
		// actualizamos los archivos en alfresco
		/*List<Archivo> archivos = documento.getArchivos();
		if (archivos != null) {
			//String rutaAlfresco=Constantes.RUTA_PADRE_ALFRESCO+expediente.getNroexpediente();
			String rutaAlfresco = repositorioService.obtenerRutaExpediente(expediente);
			String rutaDestino = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL_ALFRESCO);
			if (!rutaDestino.endsWith("/")) {
				rutaDestino += "/";
			}
			if (!rutaAlfresco.endsWith("/")) {
				rutaAlfresco += "/";
			}
			for (Archivo archivo : archivos) {
				// primero descargamos el archivo
				log.debug("rutaAlfrescoOrigen {}", rutaAlfresco);
				String nombreArchivo = archivo.getNombreArchivo();
				if (alfrescoWebServiceClient.descargarArchivo(rutaAlfresco, nombreArchivo, rutaDestino)) {
					log.debug("Se descargo correctamente el archivo {}", archivo);
					// intentamos subir el archivo a alfresco
					//String ruta=Constantes.RUTA_PADRE_ALFRESCO+expedienteNuevo.getNroexpediente();
					String ruta = repositorioService.obtenerRutaExpediente(expedienteNuevo);
					File subir = new File(rutaDestino + nombreArchivo);
					Map<String, String> propiedades = repositorioService.obtenerMetadata(documento);
					boolean archivoCreado = alfrescoWebServiceClient.subirArchivo(ruta, subir, subir.getName(), propiedades);
					// borramos el archivo luego de subir
					subir.delete();
					if (archivoCreado) {
						StringBuilder sbRutaNueva = new StringBuilder();

						log.info("Se subio correctamente el archivo " + ruta + nombreArchivo);
						String rutaAntigua = archivo.getRutaAlfresco();
						String[] partes = rutaAntigua.split(expediente.getNroexpediente());

						if (log.isDebugEnabled()) {
							for (int i = 0; i < partes.length; i++) {
								log.debug("parte {} - {}", i, partes[i]);
							}
						}

						sbRutaNueva.append(partes[0]).append(expedienteNuevo.getNroexpediente()).append(partes[1]);
						log.debug("rutaAlfrescoDestino {}", sbRutaNueva.toString());
						archivo.setRutaAlfresco(sbRutaNueva.toString());
						archivoService.saveArchivo(archivo);
					} else {
						log.error("No se pudo subir el archivo " + nombreArchivo);
						throw new RuntimeException("No se pudo subir el archivo a Alfresco");
					}
				}
			}
		}*/
		/*
		List<Documentoxexpediente> referenciados = expediente.getDocumentoxexpedienteList();
		List<Documentoxexpediente> nueva = new ArrayList<Documentoxexpediente>();
		List<Documentoxexpediente> referenciasNuevas = expedienteNuevo.getDocumentoxexpedienteList();
		if (referenciasNuevas == null) {
			referenciasNuevas = new ArrayList<Documentoxexpediente>();
		}
		boolean referenciado = false;
		if (referenciados != null && referenciados.size() > 0) {
			for (Documentoxexpediente ref : referenciados) {
				if (ref.getDocumentoxexpedientePK().getIddocumento() != documento.getIdDocumento()) {
					nueva.add(ref);
				} else {
					referenciado = true;
					referenciasNuevas.add(ref);
				}
			}
		}
		//el documento pertenece al expediente
		if (!referenciado) {
			if (documento.esDocumentoPrincipal()) {
				Documento reciente = documentoDao.getDocumentoMasReciente(expediente.getIdexpediente(), documento.getIdDocumento());
				if (reciente != null) {
					reciente.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
					documentoDao.saveDocumento(reciente);
				}
				documento.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
			}
			documento.setExpediente(expedienteNuevo);
			documentoDao.saveDocumento(documento);
			// actualizamos los archivos en alfresco
			List<Archivo> archivos = documento.getArchivos();
			if (archivos != null) {
				//String rutaAlfresco=Constantes.RUTA_PADRE_ALFRESCO+expediente.getNroexpediente();
				String rutaAlfresco = repositorioService.obtenerRutaExpediente(expediente);
				String rutaDestino = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL_ALFRESCO);
				if (!rutaDestino.endsWith("/")) {
					rutaDestino += "/";
				}
				if (!rutaAlfresco.endsWith("/")) {
					rutaAlfresco += "/";
				}
				for (Archivo archivo : archivos) {
					// primero descargamos el archivo
					log.debug("rutaAlfrescoOrigen {}", rutaAlfresco);
					String nombreArchivo = archivo.getNombreArchivo();
					if (alfrescoWebServiceClient.descargarArchivo(rutaAlfresco, nombreArchivo, rutaDestino)) {
						log.debug("Se descargo correctamente el archivo {}", archivo);
						// intentamos subir el archivo a alfresco
						//String ruta=Constantes.RUTA_PADRE_ALFRESCO+expedienteNuevo.getNroexpediente();
						String ruta = repositorioService.obtenerRutaExpediente(expedienteNuevo);
						File subir = new File(rutaDestino + nombreArchivo);
						Map<String, String> propiedades = repositorioService.obtenerMetadata(documento);
						boolean archivoCreado = alfrescoWebServiceClient.subirArchivo(ruta, subir, subir.getName(), propiedades);
						// borramos el archivo luego de subir
						subir.delete();
						if (archivoCreado) {
							StringBuilder sbRutaNueva = new StringBuilder();

							log.info("Se subio correctamente el archivo " + ruta + nombreArchivo);
							String rutaAntigua = archivo.getRutaAlfresco();
							String[] partes = rutaAntigua.split(expediente.getNroexpediente());

							if (log.isDebugEnabled()) {
								for (int i = 0; i < partes.length; i++) {
									log.debug("parte {} - {}", i, partes[i]);
								}
							}

							sbRutaNueva.append(partes[0]).append(expedienteNuevo.getNroexpediente()).append(partes[1]);
							log.debug("rutaAlfrescoDestino {}", sbRutaNueva.toString());
							archivo.setRutaAlfresco(sbRutaNueva.toString());
							archivoService.saveArchivo(archivo);
						} else {
							log.error("No se pudo subir el archivo " + nombreArchivo);
							throw new RuntimeException("No se pudo subir el archivo a Alfresco");
						}
					}
				}
			}
		} else {
			expediente.setDocumentoxexpedienteList(nueva);
			expedienteService.saveExpediente(expediente);
			expedienteNuevo.setDocumentoxexpedienteList(referenciasNuevas);
			expedienteService.saveExpediente(expedienteNuevo);
		}*/
		//si es el unico documento del expediente, anulamos el expediente
		if (unico) {
			expediente.setEstado(Constantes.ESTADO_ANULADO);
			expedienteService.saveExpediente(expediente);
		}
	}

	/**
	 * Agrega la referencia de un documento a otro expediente
	 *
	 *  @author Jenny
	 * @throws Exception
	 */
	@Transactional
	@Override
	public void copiarReferencia(Documento documento, Expediente expediente, Expediente expedienteNuevo, boolean unico) throws RuntimeException {

		log.debug("-> [Service] DocumentoService - copiarReferencia():void ");
		
		//Expediente expedienteNuevo2 = expedienteService.findByIdExpediente(expedienteNuevo.getIdexpediente());

		/*Creacion de la nueva Referencia para el documento*/
		DocumentoxexpedientePK documentoxexpedientePK = new DocumentoxexpedientePK(documento.getIdDocumento(), expedienteNuevo.getIdexpediente());
		Documentoxexpediente referenciaNueva = new Documentoxexpediente(documentoxexpedientePK, Constantes.ESTADO_ACTIVO);
		documentoPorExpedienteService.guardarObj(referenciaNueva);
		//		
		//		/*Envio de notificaciones*/
		//		Usuario remitente=documento.getPropietario();
		//		notificacionService.enviarNotificacion(remitente,expedienteNuevo.getProceso().getResponsable(),documento,Constantes.TIPO_NOTIFICACION_REFERENCIA_DOCUMENTO);
		//		if(expedienteNuevo.getProceso().getResponsable()!= expedienteNuevo.getDocumentoPrincipal().getPropietario()){
		//			notificacionService.enviarNotificacion(remitente,expedienteNuevo.getDocumentoPrincipal().getPropietario(),documento,Constantes.TIPO_NOTIFICACION_REFERENCIA_DOCUMENTO);	
		//		}	
		//		Usuario remitente=(Usuario) sesion.get(Constantes.SESSION_USUARIO);
		Usuario remitente = documento.getPropietario();
		log.info("El usuario logueado es " + remitente.getApellidos() + " " + remitente.getNombres());
		//Usuario remitente =(Usuario) mapSession.get(Constantes.SESSION_USUARIO);

		//		/*Colocando el nuevo expediente en el documento para poder obtener datos en el proceso de envio de notificacion*/
		//		documento.setExpediente(expedienteNuevo);
		/*Envio de notificaciones al responsable del proceso y propietario del documento principal del expediente nuevo*/
		notificacionService.enviarNotificacion(remitente, expedienteNuevo.getDocumentoPrincipal().getPropietario(), documento, Constantes.TIPO_NOTIFICACION_REFERENCIA_DOCUMENTO, expedienteNuevo);
		if (!expedienteNuevo.getDocumentoPrincipal().getPropietario().getIdusuario().equals(expediente.getProceso().getResponsable().getIdusuario())) {
			notificacionService.enviarNotificacion(remitente, expediente.getProceso().getResponsable(), documento, Constantes.TIPO_NOTIFICACION_REFERENCIA_DOCUMENTO, expedienteNuevo);
		}
		log.info("El usuario logueado es " + remitente.getApellidos() + " " + remitente.getNombres());
		//Usuario remitente =(Usuario) mapSession.get(Constantes.SESSION_USUARIO);

		//		/*Colocando el nuevo expediente en el documento para poder obtener datos en el proceso de envio de notificacion*/
		//		documento.setExpediente(expedienteNuevo);
		//		/*Envio de notificaciones al responsable del proceso y propietario del documento principal del expediente nuevo*/
		//		notificacionService.enviarNotificacion(remitente, expedienteNuevo.getDocumentoPrincipal().getPropietario(), documento, Constantes.TIPO_NOTIFICACION_REFERENCIA_DOCUMENTO);
		//		if(expedienteNuevo.getDocumentoPrincipal().getPropietario().getIdusuario()!=expediente.getProceso().getResponsable().getIdusuario()){
		//			notificacionService.enviarNotificacion(remitente, expediente.getProceso().getResponsable(), documento, Constantes.TIPO_NOTIFICACION_REFERENCIA_DOCUMENTO);
		//		}		
	}

	/**
	 * Indica si existe al menos un archivo en el expediente al cual se movera
	 * el documento que tenga el mismo nombre que alguno de los archivos del
	 * documento que se esta moviendo.
	 *
	 * @return <strong>true</strong> si no hay archivos con el mismo nombre
	 *         <strong>false</strong> en otro caso
	 * @author German Enriquez
	 */
	@Override
	public boolean verificarArchivosParaExpedienteNuevo(Documento documento, Expediente expedienteNuevo) {
		log.debug("-> [Service] DocumentoService - verificarArchivosParaExpedienteNuevo():boolean ");
		
		List<Documento> documentos = expedienteNuevo.getDocumentoList();
		if (documentos != null) {
			for (Documento doc : documentos) {
				List<Archivo> archivos = doc.getArchivos();
				if (archivos != null) {
					for (Archivo arch : archivos) {
						List<Archivo> aMover = documento.getArchivos();
						if (aMover != null) {
							for (Archivo archivo : aMover) {
								if (arch.getNombreArchivo().equals(archivo.getNombreArchivo())) {
									return false;
								}
							}
						}
					}
				}
			}
		}
		return true;
	}

	/**
	 * Guardar Nuevo Expediente Apartir de uno ya existente
	 *
	 * @author Erik Candela
	 * @throws Exception
	 */
	@Transactional
	@Override
	public Documento doSaveExpedienteUF(DocumentoDetail objDD, Usuario objUsuarioLogeado, Expediente objExp, Integer[] idsDocumentoPorExSeleccionados, Integer idDocPrincipalExpediente) {
		log.debug("-> [Service] DocumentoService - doSaveExpedienteUF():Documento ");
		
		log.info("EXITO AL VALIDAR SESION EN ALFRESCO");

		Documento docPrincipal = this.findByIdDocumento(idDocPrincipalExpediente);
		Expediente expedienteOriginal = docPrincipal.getExpediente();
		//GregorianCalendar calendar=null;

		log.info("CREANDO NUEVO EXPEDIENTE");
		objExp = expedienteService.saveExpediente(objExp);
		objExp.setNroexpediente(expedienteService.generateNroExpediente(objExp.getIdexpediente(), objExp.getProceso().getProduccion()));
		objExp.setAsunto(expedienteOriginal.getAsunto());
		objExp = expedienteService.saveExpediente(objExp);
		Calendar fechaLimite = Calendar.getInstance();
		fechaLimite.add(Calendar.DATE, objExp.getProceso().getTiempoatencion());

		/*
        calendar=new GregorianCalendar();
        calendar.setGregorianChange(datFechaLimite);
        calendar.set(GregorianCalendar.DAY_OF_YEAR,calendar.get(GregorianCalendar.DAY_OF_YEAR)+objExp.getProceso().getTiempoatencion());
		 */
		log.debug("Creando el expediente [" + objExp.getNroexpediente() + "] en Alfresco , CON ID : " + objExp.getIdexpediente());
		repositorioService.crearEstructuraExpediente(objUsuarioLogeado.getUsuario(), objUsuarioLogeado.getClave(), objExp.getIdexpediente());



		List<Archivo> archivos = docPrincipal.getArchivos();


		log.info("CLONANDO DOCUMENTO PRINCIPAL EXISTENTE");

		Documento nuevoDocPrincipal = this.clonarDocumento(docPrincipal, objExp.getIdpropietario(), objExp);
		nuevoDocPrincipal.setFechaAccion(new Date());
		nuevoDocPrincipal.setFechaCreacion(new Date());
		nuevoDocPrincipal.setLeido(Constantes.ESTADO_NO_LEIDO);
		//nuevoDocPrincipal.setProceso(proceso);
		nuevoDocPrincipal.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
		nuevoDocPrincipal.setEstado(Constantes.ESTADO_ACTIVO);
		nuevoDocPrincipal.setEstaEnFlujo(Constantes.ESTAENFLUJO_S);

		// autor del documento 
		nuevoDocPrincipal.setAutor(objDD.getObjAutor());

		Object obj = ServletActionContext.getRequest().getSession().getAttribute("UsuarioCompartido");
		if (obj != null) {
			Usuario p = (Usuario) obj;
			nuevoDocPrincipal.setRemitente(p.getNombres() + " " + p.getApellidos());
		} else {
			nuevoDocPrincipal.setRemitente(objUsuarioLogeado.getNombres() + " " + objUsuarioLogeado.getApellidos());
		}
		nuevoDocPrincipal.setFechaLimiteAtencion(fechaLimite.getTime());
		log.info("CREANDO EL NUEVO DOCUMENTO PRINCIPAL");
		nuevoDocPrincipal = this.saveDocumento(nuevoDocPrincipal);

		log.info("COPIANDO ARCHIVOS A NUEVO DOCUMENTO PRINCIPAL");

		this.copiarArchivosToNuevoDocumento(archivos, expedienteOriginal, objExp, nuevoDocPrincipal);

		log.info("REFERENCIANDO DOCUMENTOS AL EXPEDIENTE" + idsDocumentoPorExSeleccionados.length);

		if (idsDocumentoPorExSeleccionados != null && idsDocumentoPorExSeleccionados.length != 0) {
			this.anexarDocumento(nuevoDocPrincipal.getIdDocumento(), idsDocumentoPorExSeleccionados);
		}

		log.info("TRAZABILIDAD A NUEVO DOCUMENTO PRINCIPAL");
		trazabilidadDocumentoService.saveTrazabilidadDocumento(nuevoDocPrincipal, objExp.getIdpropietario(), true, true);

		log.info("FINALIZO............");
		return nuevoDocPrincipal;
	}

	/**
	 * Copia la referencia para un documento de un expediente a otro
	 *
	 * @author Erik Candela
	 * @throws Exception
	 */
	@Transactional
	@Override
	public void copiarArchivosToNuevoDocumento(List<Archivo> archivos, Expediente expediente, Expediente expedienteNuevo, Documento documentoDestino) throws RuntimeException {
		log.debug("-> [Service] DocumentoService - copiarArchivosToNuevoDocumento():void ");
		
		if (archivos != null) {

			//String rutaAlfresco=Constantes.RUTA_PADRE_ALFRESCO+expediente.getNroexpediente();
			String rutaAlfresco = repositorioService.obtenerRutaExpediente(expediente);
			String rutaDestino = SigedProperties.getProperty(SigedProperties.SigedPropertyEnum.DIRECTORIO_TEMPORAL_ALFRESCO);
			if (!rutaDestino.endsWith("/")) {
				rutaDestino += "/";
			}
			if (!rutaAlfresco.endsWith("/")) {
				rutaAlfresco += "/";
			}
			Archivo nuevoArchivo;
			for (Archivo archivo : archivos) {

				// primero descargamos el archivo
				String nombreArchivo = archivo.getNombreArchivo();
				if (alfrescoWebServiceClient.descargarArchivo(rutaAlfresco, nombreArchivo, rutaDestino)) {
					log.debug("Se descargo correctamente el archivo " + archivo);
					// intentamos subir el archivo a alfresco
					//String ruta=Constantes.RUTA_PADRE_ALFRESCO+expedienteNuevo.getNroexpediente();
					String ruta = repositorioService.obtenerRutaExpediente(expedienteNuevo);
					File subir = new File(rutaDestino + nombreArchivo);
					Map<String, String> propiedades = repositorioService.obtenerMetadata(documentoDestino);
					boolean archivoCreado = alfrescoWebServiceClient.subirArchivo(ruta, subir, subir.getName(), propiedades);

					if (archivoCreado) {
						log.info("Se subio correctamente el archivo " + ruta + "/" + nombreArchivo);
						String rutaAntigua = archivo.getRutaAlfresco();
						String[] partes = rutaAntigua.split("/");
						String rutaNueva = partes[0] + "/" + expedienteNuevo.getNroexpediente() + "/" + partes[2];
						nuevoArchivo = new Archivo();
						nuevoArchivo.setFechaCreacion(new Date());
						nuevoArchivo.setNombre(nombreArchivo);
						nuevoArchivo.setSURL(archivo.getSURL());
						nuevoArchivo.setRutaArchivoPdf(archivo.getRutaArchivoPdf());
						nuevoArchivo.setEstadoDigitalizacion(archivo.getEstadoDigitalizacion());
						nuevoArchivo.setDescripcion(archivo.getDescripcion());
						nuevoArchivo.setRutaAlfresco(rutaNueva);
						nuevoArchivo.setDocumento(documentoDestino);
						archivoService.saveArchivo(nuevoArchivo);
					} else {
						log.error("No se pudo subir el archivo " + nombreArchivo);
						throw new RuntimeException("No se pudo subir el archivo a Alfresco");
					}
				}
			}
		}


	}

	/**REN Guarda el nuevo documento creado en Usuario Final -----------------------------------------------------------------*/
	@SuppressWarnings({ "unchecked" })
	@Override
	@Transactional
	public DocumentoDetail saveNuevoDocumentoUserFinal(DocumentoDetail documentoDetail, Map<String, Object> session, Integer iddestinatario, Integer idccdestinatario, String strAcc, boolean bBandeja, ArchivoPendiente archivoPendiente, String nombrePC) throws RemoteException, InvalidInputMessageFaultException, InvalidParticipantTokenFaultException, UnavailableTaskFaultException, XMLStreamException, Exception {
		log.debug("-> [Service] DocumentoService - saveNuevoDocumentoUserFinal():DocumentoDetail ");
		
		DocumentoDetail objDD = null;
		Expediente expediente = null;

		try {
			DocumentoDetail objAux = documentoDetail;

			Usuario objUsuario = (Usuario) session.get(Constantes.SESSION_USUARIO);
			objUsuario = usuarioService.findByIdUsuario(objUsuario.getIdusuario());
			String strRol = Constantes.ROL_USUARIO_FINAL;
			Integer iIdUsuario = objUsuario.getIdusuario();
			Integer idDocumento = null;

			if (log.isDebugEnabled()) {
				log.debug("ID FIRMANTE [" + objAux.getIdFirmante() + "]");
				log.debug("AUTOR [" + objAux.getAutor() + "]");
			}

			objDD = this.saveDocumentTEMPORAL(objAux, strAcc, 2, objUsuario, strRol, nombrePC);
			// Derivaciones manuales de los usuarios finales
			if (strRol.equals(Constantes.ROL_USUARIO_FINAL)) {
				// Hay usuario para enviar una copia del documento
				log.debug("idccdestinatario:" + idccdestinatario);
				if (idccdestinatario != null) {
					strAcc = Constantes.ACCION_REENVIAR;
					objAux.setIIdDocumento(null);
					this.saveDocumentTEMPORAL(objAux, Constantes.ACCION_REENVIAR, idccdestinatario, objUsuario, strRol, nombrePC);
				}
				log.debug("VALOR DE BANDEJA: " + bBandeja);
				if (bBandeja) {
					strAcc = Constantes.ACCION_REENVIAR;
					objAux.setIIdDocumento(null);
					this.saveDocumentTEMPORAL(objAux, strAcc, iIdUsuario, objUsuario, strRol, nombrePC);
				}
			}

			idDocumento = objDD.getDoc().getIdDocumento();
			if (idDocumento != null && idDocumento.intValue() != 0) {
				String ruta = (String) session.get("rutaArchivo");
				log.debug(" $$$ entro : " + ruta);
				File file = null;
				if (ruta != null) {
					file = new File(ruta);
				}
				Archivo archivo = new Archivo();
				Documento doc = this.findByIdDocumento(idDocumento);
				String asunt = (String) session.get("asunto");
				if (asunt != null) {
					doc.setAsunto(asunt);
				}
				doc.setIdUsuarioLogeado(objUsuario.getIdusuario());
				doc = this.saveDocumento(doc);
				archivo.setEstadoDigitalizacion(Archivo.ESTADO_DISPONIBLE);
				archivo.setFechaCreacion(new Date());
				archivo.setDocumento(doc);
				String nombre[] = null;
				if (ruta != null) {
					nombre = ruta.replace(File.separator, "&").split("&");
				}

				expediente = doc.getExpediente();
				expediente.setEstaenflujo(Constantes.ESTAENFLUJO_S);
				expediente = expedienteService.saveExpediente(expediente);

				Map<String, List<ArchivoTemporal>> mapUpload = (Map<String, List<ArchivoTemporal>>) session.get(Constantes.SESSION_UPLOAD_LIST);
				if (mapUpload != null) {
					List<ArchivoTemporal> l = mapUpload.get("upload2");
					log.debug(" %% antes de guardar temporal size : " + l.size());
					Iterator<ArchivoTemporal> i = l.iterator();
					int y = 1;
					List<Archivo> archivosSubidos = new ArrayList<Archivo>();
					while (i.hasNext()) {
						log.debug(" %% entro en iteracuion: " + y);
						ArchivoTemporal arch = i.next();
						log.debug(" %% uploaded antes de grabar : " + y);
						Archivo item = archivoService.guardarArchivoTemporal(arch, objDD.getDoc(), y++, objUsuario);
						log.debug(" %% uploaded despues de grabar : " + y);
						archivosSubidos.add(item);
					}
					repositorioService.subirArchivosTransformadosARepositorio(objDD.getDoc().getIdDocumento(), false);
					/* Numera Cambios en Open Office
					 * if (objDD.getEnumerarDocumento() != null && objDD.getEnumerarDocumento().equals("S")) {
						log.debug("Numeramos documentos adjuntos");
						if (doc != null && !archivosSubidos.isEmpty()) {
							this.numerarDocumentoFisico(objUsuario, doc, Integer.valueOf(Constantes.DO_ENUMERAR));
						}
					}*/
				} else {
					log.info(" No hay archivos del upload para subir ... ");
				}

				if (file != null && file.exists()) {
					ArchivoTemporal archt = null;
					if (ruta != null && nombre != null && file != null) {
						if (log.isDebugEnabled()) {
							log.debug(" %% antes de  subirArchivosTransformadosARepositorio ");
							log.debug(" ## doc.getIdDocumento() " + objDD.getDoc().getIdDocumento());
							log.debug("c  : " + file.getName() + "  nombre2:" + nombre[nombre.length - 1]);
						}
						archt = new ArchivoTemporal(nombre[nombre.length - 1], file);
					}
					if (archt != null) {
						archivoService.guardarArchivoTemporal(archt, objDD.getDoc(), objDD.getDoc().getIdDocumento(), objUsuario);
					}

					repositorioService.subirArchivosTransformadosARepositorio(objDD.getDoc().getIdDocumento(), false);
					log.debug(" %% despues de  subirArchivosTransformadosARepositorio ");

					if (archivoPendiente != null && archivoPendiente.getIdArchivoPendiente() != null) {
						srvArchivoPendiente.deleteArchivopendiente(archivoPendiente.getIdArchivoPendiente());
					}
				}

				//                if (doc.getPrincipal() == 'S') {
				//                    notificacionService.informarViaNotifAndMail(objUsuario, doc, Constantes.CONFIGNOTIFMAIL_CREACION_EXPEDIENTE, Constantes.TIPO_NOTIFICACION_DUENO_EXPEDIENTE);
				//                } else {
				//                    notificacionService.informarViaNotifAndMail(objUsuario, doc, Constantes.CONFIGNOTIFMAIL_INGRESO_DOCUMENTO_USERFINAL, Constantes.TIPO_NOTIFICACION_NUEVO_DOCUMENTO);
				//                }

				notificacionService.informarViaNotifAndMail(objUsuario, doc, Constantes.CONFIGNOTIFMAIL_CREACION_EXPEDIENTE, Constantes.TIPO_NOTIFICACION_DUENO_EXPEDIENTE, nombrePC);

				objDD.setStrNroDocumento(doc.getNumeroDocumento());
				Proceso proceso = expediente.getProceso();
				objDD.setCodProceso(proceso.getCodigo());
				if (proceso != null) {
					Tipoproceso tipo = proceso.getTipoproceso();
					if (tipo != null) {
						String tipoProceso = tipo.getNombre();
						if (tipoProceso.equals(Constantes.TIPO_PROCESO_INTALIO)) {
							if (!intalioService.iniciarProceso(objUsuario, doc.getPropietario(), expediente.getProceso().getNombreIntalio(), expediente.getIdexpediente())) {
								throw new RuntimeException("No se pudo iniciar el proceso en Intalio");
							}
							log.info("Se inicio satisfactoriamente el proceso " + expediente.getProceso().getNombreIntalio() + " en Intalio");
						}
					}
				}
			}
			return objDD;
		} catch (RemoteException e) {
			log.error("No se pudo conectar al webservice", e);
			return null;
		} catch (InvalidInputMessageFaultException e) {
			log.error("Parametros ingresados no validos", e);
			return null;
		} catch (InvalidParticipantTokenFaultException e) {
			log.error("Error al iniciar sesion en intalio", e);
			return null;
		} catch (XMLStreamException e) {
			log.error("No se pudo generar la url", e);
			return null;
		} catch (UnavailableTaskFaultException e) {
			log.error("La tarea buscada no ha sido encontrada", e);
			return null;
		} catch (Exception e) {
			log.error(e.getMessage(), e);

			if (expediente != null) {
				log.warn("Se procede a eliminar el space [" + expediente.getNroexpediente() + "]");
				repositorioService.eliminarEstructuraExpediente(expediente);
			}

			throw e;
		}
	}

	public List<Recurso> getCountDocuments(Usuario usuario) {
		log.debug("-> [Service] DocumentoService - getCountDocuments():List<Recurso> ");
		
		try {
			return documentoDao.getCountDocuments(usuario);
		} catch (Exception e) {
			log.error(e.getMessage(), e);
			e.printStackTrace();
			return new ArrayList<Recurso>();
		}
	}

	@Override
	@Transactional
	public void guardarDocumento(Documento documento) {
		log.debug("-> [Service] DocumentoService - guardarDocumento():void ");
		
		try {
			documentoDao.guardarDocumento(documento);
		} catch (Exception e) {
			log.error(e.getMessage(), e);
		}
	}

	public boolean perteneceAccesoProcAcc3(Usuario u, Documento d) {
		log.debug("-> [Service] DocumentoService - perteneceAccesoProcAcc3():boolean ");
		
		boolean forward = false;

		List<Integer> data = trazabilidadDocumentoService.findLstUsuarioDelProcAcc3(d);
		for (Integer id : data) {
			if (u.getIdusuario().equals(id)) {
				forward = true;
			}
		}
		return forward;
	}

	public boolean perteneceAccesoProcAcc2(Usuario u, Proceso p) {
		log.debug("-> [Service] DocumentoService - perteneceAccesoProcAcc2():boolean ");
		
		boolean forward = false;

		List<Integer> data = trazabilidadDocumentoService.findLstUsuarioDelProcAcc2(p);
		for (Integer id : data) {
			if (u.getIdusuario().equals(id)) {
				forward = true;
			}
		}
		return forward;
	}

	private Notificacion getNotificacionDestinatario(Documento objDocumento, Usuario destinatario, Date fecha, char estado) {
		log.debug("-> [Service] DocumentoService - getNotificacionDestinatario():Notificacion ");
		
		Notificacion noti = new Notificacion();
		noti.setEstado(estado);
		noti.setIdusuario(destinatario);
		noti.setIddocumento(objDocumento);
		noti.setFechanotificacion(fecha);
		noti.setTiponotificacion(Constantes.TIPO_NOTIFICACION_NUMERACION_DESTINATARIO);
		noti.setAsunto("Enumeracion de Documento ");
		noti.setContenido(destinatario.getNombres() + " " + destinatario.getApellidos() + ":<br /><br/>"
				+ "Se le notifica que "
				+ " <strong>" + objDocumento.getPropietario().getNombres() + " " + objDocumento.getPropietario().getApellidos()
				+ "</strong>, ha realizado la numeracion del del documento  " + objDocumento.getTipoDocumento() + " "
				+ objDocumento.getNumeroDocumento() + " perteneciente al expediente "
				+ "<strong>" + objDocumento.getExpediente().getNroexpediente() + "</strong>");
		noti.setLeido(Constantes.ESTADO_NO_LEIDO);

		return noti;
	}

	private Notificacion getNotificacionCopia(Documento objDocumento, Usuario destinatario, Date fecha, char estado) {
		log.debug("-> [Service] DocumentoService - getNotificacionCopia():Notificacion ");
		
		Notificacion noti = new Notificacion();
		noti.setEstado(estado);
		noti.setIdusuario(destinatario);
		noti.setIddocumento(objDocumento);
		noti.setFechanotificacion(fecha);
		noti.setTiponotificacion(Constantes.TIPO_NOTIFICACION_NUMERACION_DOCUMENTOCONCOPIA);
		noti.setAsunto("Enumeracion de Documento ");
		noti.setContenido(destinatario.getNombres() + " " + destinatario.getApellidos() + ":<br /><br/>"
				+ "Se le notifica que "
				+ " <strong>" + objDocumento.getPropietario().getNombres() + " " + objDocumento.getPropietario().getApellidos()
				+ "</strong>, ha realizado la numeracion del del documento  " + objDocumento.getTipoDocumento() + " "
				+ objDocumento.getNumeroDocumento() + " perteneciente al expediente "
				+ "<strong>" + objDocumento.getExpediente().getNroexpediente() + "</strong>");
		noti.setLeido(Constantes.ESTADO_NO_LEIDO);

		return noti;
	}

	@Override
	@Transactional
	public List<Documento> modifyDocuments(Usuario usuario, Map<Integer, Integer> documentsToModify) {
		log.debug("-> [Service] DocumentoService - modifyDocuments():List<Documento> ");
		
		List<Documento> lstDocumento = new ArrayList<Documento>();

		for (Integer idDocumento : documentsToModify.keySet()) {
			Documento documento = this.findByIdDocumento(idDocumento);
			Integer whatToDo = documentsToModify.get(idDocumento);

			switch (whatToDo.intValue()) {
			case Constantes.DO_ENUMERAR:
				documento.setEnumerador(documento.getPropietario());
				documento.setIdUsuarioLogeado(documento.getPropietario().getIdusuario());
				documento = guardarDocEnumerados(documento);
				lstDocumento.add(documento);
/*numera documentos en Open Office
				if (!numerarDocumentoFisico(usuario, documento, whatToDo.intValue())) {
					throw new RuntimeException("No se pudo enumerar fisicamente el archivo");
				}
*/
				break;
			case Constantes.DO_FIRMAR:
				if (firmarDocumentoFisico(usuario, documento, whatToDo.intValue())) {
					documento.setFirmado(Constantes.Si);
					documentoDao.guardarDocumento(documento);
					lstDocumento.add(documento);
				} else {
					throw new RuntimeException("No se pudo firmar fisicamente el archivo");
				}

				break;
			case Constantes.DO_ENUMERAR_FIRMAR:
				documento.setEnumerador(documento.getPropietario());
				documento.setIdUsuarioLogeado(documento.getPropietario().getIdusuario());
				documento = guardarDocEnumerados(documento);
/*Numera documentos en Open Office
				if (!numerarDocumentoFisico(usuario, documento, Constantes.DO_ENUMERAR)) {
					throw new RuntimeException("No se pudo enumerar fisicamente el archivo");
				}
*/
				if (firmarDocumentoFisico(usuario, documento, Constantes.DO_FIRMAR)) {
					documento.setFirmado(Constantes.Si);
					documentoDao.guardarDocumento(documento);
					lstDocumento.add(documento);
				} else {
					throw new RuntimeException("No se pudo firmar fisicamente el archivo");
				}

				break;
			}
		}

		return lstDocumento;
	}
	public Documento aprobarDocumentoMasivo(Documento docAntiguo, Documento docNuevo, List<String> conCopia, Etapa objEtapa){
		log.debug("-> [Service] DocumentoService - aprobarDocumentoMasivo():Documento ");
		
		return null;
	}

	@SuppressWarnings({ "unused", "rawtypes" })
	public Documento aprobarDocumentoMasivo(DocumentoDetail objDD, Usuario objRemitente, Integer iIdDestinatario, String sTipoDerivacion, DocumentoDetail objDDD, List<String> conCopia, String nombrePC,Boolean horarioPermitido){
		log.debug("-> [Service] DocumentoService - aprobarDocumentoMasivo():Documento ");
		
		Accion objAccion = null;
		Documento objDocumentoPrincipal = null;
		Expediente objExpediente = null;
		List<Documento> lstDocumento = null;
		Usuario objDestinatario = null;
		Trazabilidaddocumento trazdoc = new Trazabilidaddocumento();
		log.debug(" derivar accion : " + objDD.getStrAccion());
		objAccion = accionService.findByNombre(objDD.getStrAccion());
		objDocumentoPrincipal = this.findByIdDocumento(objDD.getIIdDocumento());
		if (objDocumentoPrincipal.getContenido() == null) {
			objDocumentoPrincipal.setContenido(objDD.getStrTexto());
		}

		log.debug("princpal:" + objDocumentoPrincipal.getPrincipal());
		objExpediente = objDocumentoPrincipal.getExpediente();
		/*objExpediente.setIdetapa(objEtapa);
		if (objExpediente.getExpedientestor() != null) {
			objExpediente.getExpedientestor().setEtapa(objEtapa);
		}*/
		expedienteService.saveExpediente(objExpediente);
		String asunto = null;
		String contenido = null;
		if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_NORMAL)) {
			asunto = objDD.getStrAsunto();
			contenido = objDD.getStrTexto();
		} else if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_MASIVO)) {
			asunto = objExpediente.getDocumentoPrincipal().getAsunto();
			String strAux = "<br><br><br><br><br><br>";
			strAux += "<p>--------------- Mensaje Original ---------------</p> " 
				+ "<p>De : " + objDDD.getStrRemitente() + "</p>" 
				+ "<p>Para : " + objDDD.getStrDestinatario() + "</p>" 
				+ "<p>CC : " + "</p>" 
				+ "<p>Enviado : " + objDDD.getStrFecha() + "</p>" 
				+ "<p>Enviado : " + objDDD.getStrAsunto() + "</p>" 
				+ "<p>----------------------------------------------</p>";
			contenido = objDD.getStrTexto() + strAux + " " + this.fillContenido(objDDD);
		}
		objDestinatario = usuarioService.findByIdUsuario(iIdDestinatario);
		log.debug("asunto:" + objDD.getStrAsunto());
		List<Documento> documentosExpediente = new ArrayList<Documento>();
		lstDocumento = documentoDao.getDocumentosPorExpediente(objExpediente.getIdexpediente());
		Documento ultimo = lstDocumento.get(0);
		Calendar ultimoDocumento = Calendar.getInstance();
		ultimoDocumento.setTime(ultimo.getFechaCreacion());
		for (Documento doc : lstDocumento) {
			doc.setPrincipal(Constantes.DOCUMENTO_NO_PRINCIPAL);
			Calendar actual = Calendar.getInstance();
			actual.setTime(doc.getFechaCreacion());
			if (actual.compareTo(ultimoDocumento) > 0) {
				ultimo = doc;
			}
			documentosExpediente.add(doc);
		}
		ultimo.setPrincipal(Constantes.DOCUMENTO_PRINCIPAL);
		// Derivar todos los documentos del expediente al destinatario
		for (Documento objDocumentoAMover : documentosExpediente) {
			// Actualizando datos del documento
			/*Si el documento aun esta en mp/dig/qas no cambiar los datos del documento*/
			/* if ((!objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_APROBAR)
                    && !objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_DIGITALIZAR))
                    || (objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_APROBAR)
                    && objDocumentoAMover.getPropietario().getRol() == null))*/ 
			//
			//@Danna Incidencia 135 no se guarda la trabalidad de todos los documentos cuadno es aprobar
			//

			if ((!objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_DIGITALIZAR))
					|| (objDocumentoAMover.getPropietario().getRol() == null))

			{
				objDocumentoAMover.setPropietario(objDestinatario);
				objDocumentoAMover.setRemitente(objRemitente.getNombres() + " " + objRemitente.getApellidos());
				objDocumentoAMover.setAccion(objAccion);
				if (objDocumentoAMover.getPrincipal() == Constantes.DOCUMENTO_PRINCIPAL) {
					if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_NORMAL)) {
						// David says:segun jona el asunto de los documentos no cambia
						// a menos de que este sea nuevo  :P
						if (objDocumentoAMover.getAsunto() == null) {
							objDocumentoAMover.setAsunto(objDD.getStrAsunto());
						}
						if (objDocumentoAMover.getContenido() == null) {
							objDocumentoAMover.setContenido(objDD.getStrTexto());
						}

						objDocumentoAMover.setUltimoAsunto(objDD.getStrAsunto());
					} else if (sTipoDerivacion.equalsIgnoreCase(Constantes.DERIVAR_MASIVO)) {
						String strAux = "<br><br><br><br><br><br>";
						strAux += "<p>--------------- Mensaje Original ---------------</p> " + "<p>De : " + objDDD.getStrRemitente() + "</p>" + "<p>Para : " + objDDD.getStrDestinatario() + "</p>" + "<p>CC : " + "</p>" + "<p>Enviado : " + objDDD.getStrFecha() + "</p>" + "<p>Enviado : " + objDDD.getStrAsunto() + "</p>" + "<p>----------------------------------------------</p>";
						if (objDocumentoAMover.getContenido() == null) {
							objDocumentoAMover.setContenido(objDD.getStrTexto() + strAux + " " + this.fillContenido(objDDD));
						}
					}
					objDocumentoAMover.setEstadoAlarma('V');
				}
				objDocumentoAMover.setFechaAccion(new Date());
			}
			objDocumentoAMover.setLeido(Constantes.ESTADO_NO_LEIDO);
			objDocumentoAMover = this.saveDocumento(objDocumentoAMover);
			log.debug("Generando trazabilidad Nro Expediente [" + objExpediente.getNroexpediente() + "] ID Documento [" + objDocumentoAMover.getIdDocumento() + "]");
			// / Modificacion David Aranda para los documento enviados :INICIO

			/*Si el documento aun esta en mp/dig/qas no cambiar datos ni guardar trazabilidad*/
			/*if (!objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_APROBAR)
                    && !objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_DIGITALIZAR)) */
			//
			//@Danna Incidencia 135 no se guarda la trabalidad de todos los documentos cuadno es aprobar
			//

			if (!objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_DIGITALIZAR))   
			{
				trazdoc = trazabilidadDocumentoService.saveTrazabilidadDocumento(objDocumentoAMover, objRemitente, objDD.getIPlazoDia(), objDD.getIPlazoHora(), objDD.getStrFechaLimiteAtencion(), asunto, contenido, null, nombrePC,horarioPermitido,"revisar sin plazo?");
				// Trazabilidaddocumento trazdoc =
				// trazabilidadDocumentoService.saveTrazabilidadDocumento(objD,
				// usuarioService.findByIdUsuario(iIdUsuario));
				// log.debug(" Accion y doc princ o no:" + strAcc + "  , " +
				// objD.getPrincipal());
				if (objDocumentoAMover.getPrincipal() == Constantes.DOCUMENTO_PRINCIPAL) {
					Documentoenviado documentoenviado = new Documentoenviado();
					//wvcarrasco descomentar documentoenviado.setTrazabilidaddocumento(trazdoc);
					documentoenviado.setUsuario(objRemitente);
					documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
					documentoEnviadoDao.saveDocumento(documentoenviado);
				}
				registrarDerivacionAuditoriaDocumento(objDocumentoAMover, objRemitente, objDestinatario, Constantes.TA_DerivarUserFinal, Constantes.TM_UserFinal, objAccion.getNombre().equals(Constantes.TO_Derivar) ? Constantes.TO_Derivar : objAccion.getNombre());
			}

			/**Cambio de Renzo para enumerar todos los documentos al aprobar el expediente---------------------------------------------------*
            if(objDocumentoAMover.getAccion().getNombre().equals(Constantes.ACCION_APROBAR)){
            log.debug("Numeramos todos los documentos");
            lstDocumento=objExpediente.getDocumentoList();
            List<Integer> idDocumentos = new ArrayList<Integer>();
            for(Documento doc : lstDocumento){
            idDocumentos.add(doc.getIdDocumento());
            }
            numerarDocumentos(objRemitente, idDocumentos);
            }*/
			// / Modificacion David Aranda para los documento enviados :FIN
		}
		// Registrando las notificaciones
		ultimo.setPropietario(objDestinatario);
		int iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_REENVIAR;
		int iCCEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_CCREENVIAR;

		if (objAccion.getNombre().equals(Constantes.ACCION_PARA_APROBAR)) {
			iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_PORAPROBAR;
			iCCEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_CCPORAPROBAR;
		} else if (objAccion.getNombre().equals(Constantes.ACCION_APROBAR)) {
			iEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_APROBAR;
			iCCEvento = Constantes.CONFIGNOTIFMAIL_DOCUMENTO_CCAPROBAR;
		}

		Set usuariosNotificados = notificacionService.informarViaNotifAndMail(objRemitente, ultimo, iEvento, Constantes.TIPO_NOTIFICACION_DERIVACION, nombrePC);
		Usuario usuarioReceptor = new Usuario();

		if (conCopia != null) {
			Accion accionCopia = accionService.findByNombre(Constantes.ACCION_COPIAR);
			for (String sID : conCopia) {
				if (!StringUtil.isEmpty(sID)) {
					log.debug("Working with ID [" + sID + "]");

					if (sID.startsWith("LISTA")) {
						Integer iID = Integer.valueOf(sID.substring(sID.indexOf("_") + 1));
						Lista objLista = listaService.findByIdLista(iID);

						log.debug("Working with Lista [" + objLista.getNombre() + "]");

						for (Usuario objParticipante : objLista.getParticipanteListaList()) {
							//No se ha enviado notificacion a ese usuario
							if (!usuariosNotificados.contains(objParticipante) && iIdDestinatario.intValue() != iID.intValue()) {
								//wcarrasco 19-10-2010 falta revisar  al aprobarDocumentoMasivo La Fecha Notificacion
								notificacionService.enviarNotificacion(objRemitente, objParticipante, ultimo, Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA, nombrePC,true, null);
								mailService.ChaskiMail(iCCEvento, objRemitente, objParticipante, ultimo);
							} //Ya se envio notificacion a ese usuario, modificar el tipo de notificacion a derivacionconcopia
							else {
								notificacionService.updateTipoNotificacion(ultimo.getIdDocumento(), objParticipante.getIdusuario(), Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA);
							}
						}
					} else {
						Integer iID = Integer.valueOf(sID);
						usuarioReceptor = usuarioService.findByIdUsuario(iID);
						//No se ha enviado notificacion a ese usuario
						if (log.isDebugEnabled()) {
							log.debug("iIdDestinatario [" + iIdDestinatario + "] iID [" + iID + "]");
						}
						//trazabilidadcopiaService.guardarTrazabilidadcopia(trazdoc.getIdtrazabilidaddocumento(), objRemitente, usuarioReceptor, ultimo, accionCopia, objEtapa, Constantes.TIPO_ORIGEN_TRAZADOCUMENTO);
						if (!usuariosNotificados.contains(usuarioReceptor) && iIdDestinatario.intValue() != iID.intValue()) {
							//wcarrasco 19-10-2010 falta revisar  al aprobarDocumentoMasivo La Fecha Notificacion
							notificacionService.enviarNotificacion(objRemitente, usuarioReceptor, ultimo, Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA, nombrePC,true, null);
							mailService.ChaskiMail(iCCEvento, objRemitente, usuarioReceptor, ultimo);
						} //Ya se envio notificacion a ese usuario, modificar el tipo de notificacion a derivacionconcopia
						else {
							notificacionService.updateTipoNotificacion(ultimo.getIdDocumento(), usuarioReceptor.getIdusuario(), Constantes.TIPO_NOTIFICACION_DERIVACIONCONCOPIA);
						}
					}
				}
			}
		}
		log.debug("Nuevo propietario [" + ultimo.getPropietario().getNombres() + " " + ultimo.getPropietario().getApellidos() + "]");
		// return objDocumentoPrincipal;
		return ultimo;    	
	}

	/**Crea copias de apoyo tomando como base un documento original ya existente ---------------------------------------------*/
	@Transactional
	public void crearCopiaApoyo(Documento doc, DocumentoDetail objDD, int idRemitente, int idDestinatario, String[] acciones, Integer prioridad, String mensaje, String nombrePC,Boolean horarioPermitido){
		log.debug("-> [Service] DocumentoService - crearCopiaApoyo():void ");
		
		Documento newDoc = new Documento();
		try {
			PropertyUtils.copyProperties(newDoc, doc);
		} catch (IllegalAccessException e) {
			e.printStackTrace();
		} catch (InvocationTargetException e) {
			e.printStackTrace();
		} catch (NoSuchMethodException e) {
			e.printStackTrace();
		}
		Usuario remitente = usuarioService.findByIdUsuario(idRemitente);
		Usuario destinatario = usuarioService.findByIdUsuario(idDestinatario);
		newDoc.setPropietario(destinatario);
		newDoc.setDocumentoreferencia(doc.getDocumentoreferencia() != null ? doc.getDocumentoreferencia() : new Integer(doc.getIdDocumento()));
		newDoc.setIdDocumento(null);
		newDoc.setArchivos(null);
		newDoc.setLeido('N');
		newDoc.setPrioridad(prioridad);
		newDoc.setFechaAccion(new Date());
		
		log.debug("Documento guardado, guardando traza de apoyo");

		Accion accionApoyo = accionService.findByNombre(Constantes.ACCION_APOYO);
		Trazabilidadapoyo tapoyo = new Trazabilidadapoyo();
		tapoyo.setAccion(accionApoyo);
		tapoyo.setDestinatario(destinatario);
		tapoyo.setRemitente(remitente);
		tapoyo.setAsunto(objDD != null ? objDD.getStrAsunto().toUpperCase() : "");
		Date fechaFueraHorario = new Date();
		if(horarioPermitido == false){	
	        log.debug("Enviar Multiple:goCopiarApoyo  fuera de horario ");		    
		    fechaFueraHorario = fechaLimite.fechaFueraHorarioHabil(fechaFueraHorario,destinatario.getIdusuario().intValue());
	    }
		
		Trazabilidaddocumento trazabilidad = new Trazabilidaddocumento();
		trazabilidad.setDestinatario(destinatario);
		log.debug("Sin plazo :"+ objDD.getStrSinPlazo());
		trazabilidad = trazabilidadDocumentoService.aplicarPlazosADocumento(trazabilidad, objDD.getIPlazoDia(), objDD.getIPlazoHora(), objDD.getStrFechaLimiteAtencion(),objDD.getStrSinPlazo());
		
		if(trazabilidad != null){
			newDoc.setFechaLimiteAtencion(trazabilidad.getFechalimiteatencion());
		}
		newDoc.setFechaAccion(fechaFueraHorario);
		newDoc = documentoDao.guardarDocumento(newDoc);
		
		tapoyo.setFechacreacion(fechaFueraHorario);
		tapoyo.setDocumento(newDoc.getIdDocumento());
		tapoyo.setNombrePC(nombrePC);
				
		if(trazabilidad != null){
			tapoyo.setFechalimiteatencion(trazabilidad.getFechalimiteatencion());
		}
				
		if(doc.getDocumentoreferencia() != null){
			trazabilidad = trazabilidadDocumentoService.encontrarUltimaTrazabilidadPorDocumento(doc.getDocumentoreferencia()); 
		}else{
			trazabilidad = trazabilidadDocumentoService.encontrarUltimaTrazabilidadPorDocumento(doc.getIdDocumento());
		}
				
		tapoyo.setTrazabilidad(trazabilidad);
		tapoyo.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_PENDIENTE));
		
		if(acciones != null){
			List<Proveido> proveidos = new ArrayList<Proveido>();
			
			for(int i = 1; i<acciones.length; i++){
				proveidos.add(proveidoDAO.buscarPorId(Integer.parseInt(acciones[i])));
			}
			
			tapoyo.setProveidos(proveidos);
			String texto = ""; 
			texto += "El documento se ha remitido para que se realicen las siguientes acciones: <br/><ul>";
			
			for(Proveido p : proveidos){
				texto += "<li>"+p.getNombre()+"</li>";
			}
			
			texto += "</ul>";
			texto = !mensaje.equals("") ? texto+mensaje : texto;
			tapoyo.setTexto(texto);
		}else{
			mensaje = mensaje != null ? mensaje : "";
			tapoyo.setTexto(mensaje);
		}
        //tapoyo.setAsunto(newDoc.getAsunto());
		//trazabilidadapoyoService.guardar(tapoyo);
		
		
        Trazabilidadapoyo temp = new Trazabilidadapoyo();
	    temp= trazabilidadapoyoService.guardar(tapoyo);
	    log.debug("temp.getIdtrazabilidadapoyo()"+temp.getIdtrazabilidadapoyo());
	    //--Trazabilidaddocumento trazdoc = new Trazabilidaddocumento();
	    
	    //trazdoc.setIdtrazabilidaddocumento(temp.getIdtrazabilidadapoyo().intValue());
	    //log.debug("trazdoc.getIdtrazabilidaddocumento()"+trazdoc.getIdtrazabilidaddocumento());
	    
	    //log.debug("newDoc.getIdDocumento()"+newDoc.getIdDocumento());
	    //---trazdoc = trazabilidadDocumentoService.encontrarUltimaTrazabilidadPorDocumento(354);
	    
	    //--log.debug("trazdoc.getIdtrazabilidaddocumento()"+trazdoc.getIdtrazabilidaddocumento());
	    //--trazdoc.setIdtrazabilidaddocumento(734);
	    
	    //---log.debug("trazdoc.getIdtrazabilidaddocumento()"+trazdoc.getIdtrazabilidaddocumento());
	    
	    Documentoenviado documentoenviado = new Documentoenviado();
		//documentoenviado.setTrazabilidaddocumento(trazdoc);
	    documentoenviado.setIdTrazabilidadEnvio(temp.getIdtrazabilidadapoyo());//buscar multiple
		documentoenviado.setUsuario(temp.getRemitente());
		documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
		documentoenviado.setTipoEnvio(""+ Constantes.TIPO_ENVIO_MULTIPLE);
		documentoEnviadoDao.saveDocumento(documentoenviado);

	}

	/**Crea copias de apoyo tomando como base un documento original ya existente ---------------------------------------------*
	@Transactional
	public void crearCopiaDelegacion(Documento doc, Usuario remitente, Integer idDestinatario, String mensaje, String nombrePC,Boolean horarioPermitido){
		log.debug("-> [Service] DocumentoService - crearCopiaDelegacion():void ");
		
		Documento newDoc = new Documento();
		try {
			PropertyUtils.copyProperties(newDoc, doc);
		} catch (IllegalAccessException e) {
			e.printStackTrace();
		} catch (InvocationTargetException e) {
			e.printStackTrace();
		} catch (NoSuchMethodException e) {
			e.printStackTrace();
		}

		Usuario destinatario = usuarioService.findByIdUsuario(idDestinatario);
		newDoc.setPropietario(destinatario);
		//newDoc.setDocumentoreferencia(new Integer(doc.getIdDocumento()));
		newDoc.setIdDocumento(null);
		newDoc.setArchivos(null);
		newDoc.setLeido('N');
		newDoc = documentoDao.guardarDocumento(newDoc);

		log.debug("Documento guardado, guardando traza de apoyo");
		Trazabilidadapoyo temp = new Trazabilidadapoyo();
	    temp=guardarTrazaDelegacion(newDoc, remitente.getIdusuario(), destinatario.getIdusuario(), mensaje, doc.getIdDocumento(), nombrePC,horarioPermitido);
		//wcarrasco 27-10-2011 Cuando se realiza un envio multiple tipo: delegacion se registra en documentoenvio
		Documentoenviado documentoenviado = new Documentoenviado();
	    documentoenviado.setIdTrazabilidadEnvio(temp.getIdtrazabilidadapoyo());//buscar multiple
		documentoenviado.setUsuario(temp.getRemitente());
		documentoenviado.setEstado("" + Constantes.ESTADO_ACTIVO);
		documentoenviado.setTipoEnvio(""+ Constantes.TIPO_ENVIO_MULTIPLE);
		documentoEnviadoDao.saveDocumento(documentoenviado);
	}*/
	
	@Transactional
	public void eliminarDocumento(Integer idDocumento){
		log.debug("-> [Service] DocumentoService - eliminarDocumento():void ");
		
		documentoDao.eliminarDocumento(idDocumento);
	}

	/**REN Se llama cuando se va a guardar la traza referente a la delegacin de la copia de apoyo ---------------------------*
	@Transactional
	public Trazabilidadapoyo guardarTrazaDelegacion(Documento doc, Integer idRemitente, Integer idDestinatario, String texto, Integer idDocOriginal, String nombrePC,Boolean horarioPermitido){
		log.debug("-> [Service] DocumentoService - guardarTrazaDelegacion():void ");
		
		Trazabilidadapoyo tapoyo = new Trazabilidadapoyo();

		tapoyo.setDocumento(doc.getIdDocumento());
		tapoyo.setAccion(accionService.findByNombre(Constantes.ACCION_DELEGAR));
		tapoyo.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_PENDIENTE));
		tapoyo.setRemitente(usuarioService.findByIdUsuario(idRemitente));
		tapoyo.setDestinatario(usuarioService.findByIdUsuario(idDestinatario));
		//tapoyo.setFechacreacion(new Date());
		Date fechaFueraHorario = new Date();	
		if(horarioPermitido == false){			
	        log.debug("Enviar Multiple:goDelegarApoyo  fuera de horario ");
	        log.debug("idDestinatario"+idDestinatario);
		    fechaFueraHorario = fechaLimite.fechaFueraHorarioHabil(fechaFueraHorario,idDestinatario);
			tapoyo.setFechacreacion(fechaFueraHorario);
	     }else{
	    	tapoyo.setFechacreacion(fechaFueraHorario);
	     }
		tapoyo.setTexto(texto.length() > 2000? texto.substring(0, 1999) : texto);
		tapoyo.setNombrePC(nombrePC);
		tapoyo.setAsunto(doc.getAsunto());
		Trazabilidadapoyo tapoyoorigen =  trazabilidadapoyoService.buscarUltimaDelegacionUsuario(idRemitente, idDocOriginal);
		tapoyoorigen.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_DELEGADO));
		tapoyoorigen = trazabilidadapoyoService.guardar(tapoyoorigen);

		tapoyo.setTrazabilidad(tapoyoorigen.getTrazabilidad());

		return trazabilidadapoyoService.guardar(tapoyo);
	}*/

	/**REN Se llama cuando se va a guardar la traza referente al termino del apoyo, ya sea aprobando o rechazando*/
	@Transactional
	public void guardarTrazaFinalizarApoyo(Integer idDoc, Integer idDestinatario, String codigoEstado){
		log.debug("-> [Service] DocumentoService - guardarTrazaFinalizarApoyo():void ");
		
		Trazabilidadapoyo tapoyoorigen =  trazabilidadapoyoService.buscarUltimaDelegacionUsuario(idDestinatario, idDoc);
		tapoyoorigen.setEstado(estadoService.findByCodigo(codigoEstado));
		tapoyoorigen = trazabilidadapoyoService.guardar(tapoyoorigen);

	}

	@Transactional
	public void archivarDocumento(Integer idDocumento, Usuario remitente, String observacion, String tipoArchivar, String nombrePC){
		log.debug("-> [Service] DocumentoService - archivarDocumento():void ");
		
		Documento doc = this.findByIdDocumento(idDocumento);
		doc.setEstado(Constantes.ESTADO_CERRADO);//podriamos cambiar por .ESTADO_ARCHIVAR o se queda con ESTADO_CERRADO
		//wcarrasco 24-10-2011 actualiza fechaAccion  
		doc.setFechaAccion(new Date());
		doc = documentoDao.updateDocumento(doc);    
	    
		if(doc.getDocumentoreferencia() == null){
			trazabilidadDocumentoService.guardarTrazabilidad(doc, remitente, doc.getPropietario(), Constantes.ACCION_ARCHIVAR, "Archivo del documento "+doc.getNumeroDocumento(), observacion, nombrePC);
		}else{
			try{
				Trazabilidadapoyo tapoyo = new Trazabilidadapoyo();
				tapoyo.setAccion(accionService.findByNombre(Constantes.ACCION_ARCHIVAR));
				tapoyo.setDestinatario(doc.getPropietario());
				tapoyo.setRemitente(remitente);
				tapoyo.setFechacreacion(new Date());
				tapoyo.setDocumento(doc.getIdDocumento());
				Trazabilidadapoyo tapoyoorigen =  trazabilidadapoyoService.buscarUltimaDelegacionUsuario(remitente.getIdusuario(), doc.getIdDocumento());
				if(tapoyoorigen != null && tapoyoorigen.getTrazabilidad() != null){
					log.debug("en trazabilidadapoyo");
					Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findTrabilidadbyId(tapoyoorigen.getTrazabilidad().getIdtrazabilidaddocumento());
					log.debug("trazabilidad.getIdtrazabilidaddocumento()"+ trazabilidad.getIdtrazabilidaddocumento());
					tapoyo.setTrazabilidad(trazabilidad);
					tapoyo.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_ARCHIVADO));
					tapoyo.setAsunto("Archivo del documento "+doc.getNumeroDocumento());
					tapoyo.setTexto(observacion != null ? observacion : "");
					tapoyo.setNombrePC(nombrePC);
					tapoyo.setFechalimiteatencion(tapoyo.getFechacreacion());
					trazabilidadapoyoService.guardar(tapoyo);
				}else{
					log.debug("No se encontro traza de apoyo");
				}
			}catch(Exception e){
				log.debug("No se ha podido guardar la traza del documento delegado");
				e.printStackTrace();
			}
		}
	}
	
	@Transactional
	public void reabrirDocumento(Documento documento, Usuario usuario, String nombrePC){
		log.debug("-> [Service] DocumentoService - reabrirDocumento():void ");
		
		documento.setEstado(Constantes.ESTADO_ACTIVO);
		documento.setFechaAccion(new Date());
		documento = documentoDao.updateDocumento(documento);
		
		String asunto = "Reapertura del documento "+documento.getNumeroDocumento();
		String contenido = "Documento reabierto por el usuario " + documento.getPropietario().getNombreCompleto();
		
		if(documento.getDocumentoreferencia() == null){
			trazabilidadDocumentoService.guardarTrazabilidad(documento, usuario, usuario, Constantes.ACCION_REABRIR, asunto, contenido, nombrePC);
		}else{
			try{
				Trazabilidadapoyo tapoyo = new Trazabilidadapoyo();
				tapoyo.setAccion(accionService.findByNombre(Constantes.ACCION_REABRIR));
				tapoyo.setDestinatario(documento.getPropietario());
				tapoyo.setRemitente(documento.getPropietario());
				tapoyo.setFechacreacion(new Date());
				tapoyo.setDocumento(documento.getIdDocumento());
				Trazabilidadapoyo tapoyoorigen =  trazabilidadapoyoService.buscarUltimaDelegacionUsuario(documento.getPropietario().getIdusuario(), documento.getIdDocumento());
				if(tapoyoorigen != null && tapoyoorigen.getTrazabilidad() != null){
					Trazabilidaddocumento trazabilidad = trazabilidadDocumentoService.findTrabilidadbyId(tapoyoorigen.getTrazabilidad().getIdtrazabilidaddocumento());
					tapoyo.setTrazabilidad(trazabilidad);
					
					Trazabilidaddocumento trazaPlazo = new Trazabilidaddocumento();
					trazaPlazo.setDestinatario(usuario);
					trazaPlazo = trazabilidadDocumentoService.aplicarPlazosADocumento(trazaPlazo, null, null, null,"revisar sin plazo?");
										
					tapoyo.setFechalimiteatencion(trazaPlazo.getFechalimiteatencion());
					tapoyo.setEstado(estadoService.findByCodigo(Constantes.ESTADO_CODIGO_PENDIENTE));
					tapoyo.setAsunto(asunto);
					tapoyo.setTexto(contenido);
					tapoyo.setNombrePC(nombrePC);
					trazabilidadapoyoService.guardar(tapoyo);
				}else{
					log.debug("No se encontro traza de apoyo");
				}
			}catch(Exception e){
				log.debug("No se ha podido guardar la traza del documento delegado");
				e.printStackTrace();
			}
		}
	}

	public List<Integer> getUsuariosPermitidos(Integer idDocumento){
		return documentoDao.getUsuariosPermitidos(idDocumento);
	}
	
	public void setAuditoriaDao(AuditoriaDAO auditoriaDao) {
		this.auditoriaDao = auditoriaDao;
	}

	public void setDocumentoDao(DocumentoDAO documentoDao) {
		this.documentoDao = documentoDao;
	}

	public void setDocumentoEnviadoDao(DocumentoEnviadoDAO documentoEnviadoDao) {
		this.documentoEnviadoDao = documentoEnviadoDao;
	}

	public void setDocumentoStorDao(DocumentostorDAO documentoStorDao) {
		this.documentoStorDao = documentoStorDao;
	}

	public void setSubmotivoDao(SubmotivoDAO submotivoDao) {
		this.submotivoDao = submotivoDao;
	}

	public void setSuministroDao(SuministroDAO suministroDao) {
		this.suministroDao = suministroDao;
	}

	public void setTipoDocumentoDao(TipodocumentoDAO tipoDocumentoDao) {
		this.tipoDocumentoDao = tipoDocumentoDao;
	}

	public void setListaService(ListaService listaService) {
		this.listaService = listaService;
	}

	public void setDocumentoPorExpedienteService(DocumentoxexpedienteService documentoPorExpedienteService) {
		this.documentoPorExpedienteService = documentoPorExpedienteService;
	}

	public void setTrazabilidadExpedienteService(TrazabilidadexpedienteService trazabilidadExpedienteService) {
		this.trazabilidadExpedienteService = trazabilidadExpedienteService;
	}

	public void setUsuarioService(UsuarioService usuarioService) {
		this.usuarioService = usuarioService;
	}

	public void setUsuarioStorService(UsuariostorService usuarioStorService) {
		this.usuarioStorService = usuarioStorService;
	}

	public void setDistritoService(DistritoService distritoService) {
		this.distritoService = distritoService;
	}

	public void setDiaFestivoService(DiafestivoService diaFestivoService) {
		this.diaFestivoService = diaFestivoService;
	}

	public void setAccionService(AccionService accionService) {
		this.accionService = accionService;
	}

	public void setExpedienteService(ExpedienteService expedienteService) {
		this.expedienteService = expedienteService;
	}

	public void setTrazabilidadDocumentoService(TrazabilidaddocumentoService trazabilidadDocumentoService) {
		this.trazabilidadDocumentoService = trazabilidadDocumentoService;
	}

	public void setusuarioService(UsuarioService usuarioService) {
		this.usuarioService = usuarioService;
	}

	public void setArchivoService(ArchivoService archivoService) {
		this.archivoService = archivoService;
	}

	/**
	 * @param repositorioService
	 *            the repositorioService to set
	 */
	 public void setRepositorioService(RepositorioService repositorioService) {
		this.repositorioService = repositorioService;
	}

	public void setFechaLimite(FechaLimite fechaLimite) {
		this.fechaLimite = fechaLimite;
	}

	public void setDiafestivoService(DiafestivoService diaFestivoService) {
		this.diaFestivoService = diaFestivoService;
	}

	public void setAuditoriaService(AuditoriaService auditoriaService) {
		this.auditoriaService = auditoriaService;
	}

	public void setNotificacionService(NotificacionService notificacionService) {
		this.notificacionService = notificacionService;
	}

	public void setProcesoDao(ProcesoDAO procesoDao) {
		this.procesoDao = procesoDao;
	}

	public void setSedeDao(SedeDAO sedeDao) {
		this.sedeDao = sedeDao;
	}

	public ArchivopendienteService getSrvArchivoPendiente() {
		return srvArchivoPendiente;
	}

	public void setSrvArchivoPendiente(ArchivopendienteService srvArchivoPendiente) {
		this.srvArchivoPendiente = srvArchivoPendiente;
	}

	public TrazabilidadcopiaService getTrazabilidadcopiaService() {
		return trazabilidadcopiaService;
	}

	public void setTrazabilidadcopiaService(
			TrazabilidadcopiaService trazabilidadcopiaService) {
		this.trazabilidadcopiaService = trazabilidadcopiaService;
	}

	public void setIntalioService(IntalioService intalioService) {
		this.intalioService = intalioService;
	}

	/**
	 * @return the mailService
	 */
	 public ManejoDeEmailService getMailService() {
		return mailService;
	}

	/**
	 * @param mailService the mailService to set
	 */
	 public void setMailService(ManejoDeEmailService mailService) {
		 this.mailService = mailService;
	 }

	 public CargoReporte obtenerCargo(Integer iddocumento) {
		 return documentoDao.obtenerCargo(iddocumento);
	 }

	 public AlfrescoWSService getAlfrescoWebServiceClient() {
		 return alfrescoWebServiceClient;
	 }

	 public void setAlfrescoWebServiceClient(AlfrescoWSService alfrescoWebServiceClient) {
		 this.alfrescoWebServiceClient = alfrescoWebServiceClient;
	 }

	 @SuppressWarnings("rawtypes")
	 public List getBandejaDocAtendidosUsuarioFinal(Usuario objUsuario) {
		 throw new UnsupportedOperationException("Not supported yet.");
	 }

	 public ClienteService getClienteService() {
		 return clienteService;
	 }

	 public void setClienteService(ClienteService clienteService) {
		 this.clienteService = clienteService;
	 }

	 public DocumentoxclienteService getDocumentoxclienteService() {
		 return documentoxclienteService;
	 }

	 public void setDocumentoxclienteService(
			 DocumentoxclienteService documentoxclienteService) {
		 this.documentoxclienteService = documentoxclienteService;
	 }

	 public NotificacionxEnumerarDAO getNotificacionxEnumerarDAO() {
		 return notificacionxEnumerarDAO;
	 }

	 public void setNotificacionxEnumerarDAO(
			 NotificacionxEnumerarDAO notificacionxEnumerarDAO) {
		 this.notificacionxEnumerarDAO = notificacionxEnumerarDAO;
	 }

	 public NumeracionService getNumeracionService() {
		 return numeracionService;
	 }

	 public void setNumeracionService(NumeracionService numeracionService) {
		 this.numeracionService = numeracionService;
	 }

	 public void setAlfrescoWebscriptClient(AlfrescoWebscriptService alfrescoWebscriptClient) {
		 this.alfrescoWebscriptClient = alfrescoWebscriptClient;
	 }

	 public TrazabilidadapoyoService getTrazabilidadapoyoService() {
		 return trazabilidadapoyoService;
	 }

	 public void setTrazabilidadapoyoService(
			 TrazabilidadapoyoService trazabilidadapoyoService) {
		 this.trazabilidadapoyoService = trazabilidadapoyoService;
	 }

	 public EstadoService getEstadoService() {
		 return estadoService;
	 }

	 public void setEstadoService(EstadoService estadoService) {
		 this.estadoService = estadoService;
	 }

	public ProveidoDAO getProveidoDAO() {
		return proveidoDAO;
	}

	public void setProveidoDAO(ProveidoDAO proveidoDAO) {
		this.proveidoDAO = proveidoDAO;
	}
	
	public void setParametroDao(ParametroDAO parametroDao) {
		this.parametroDao = parametroDao;
	}

	public void setRolDao(RolDAO rolDao) {
		this.rolDao = rolDao;
	}
	
	public Map<String, Object> getMapSession() {
		return mapSession;
	}

	public void setMapSession(Map<String, Object> mapSession) {
		this.mapSession = mapSession;
	}

	public UnidadService getUnidadService() {
		return unidadService;
	}

	public void setUnidadService(UnidadService unidadService) {
		this.unidadService = unidadService;
	}

	public ParametroService getParametroService() {
		return parametroService;
	}

	public void setParametroService(ParametroService parametroService) {
		this.parametroService = parametroService;
	}

	public FechaLimite getFechaLimite() {
		return fechaLimite;
	}

	public TrazabilidadapoyoDAO getTrazabilidadDocumentoDao() {
		return trazabilidadDocumentoDao;
	}

	public void setTrazabilidadDocumentoDao(
			TrazabilidadapoyoDAO trazabilidadDocumentoDao) {
		this.trazabilidadDocumentoDao = trazabilidadDocumentoDao;
	}

	public ProcesoService getProcesoService() {
		return procesoService;
	}

	public void setProcesoService(ProcesoService procesoService) {
		this.procesoService = procesoService;

	}

	@Override
	public List findDocumentosUsuarioFinalFiltro(Usuario objUsuario,
			boolean enviados, BusquedaAvanzada objFiltro) {
		log.debug("-> [Service] DocumentoService - findDocumentosUsuarioFinalFiltro():List ");		
		return documentoDao.findByDataUFFiltro(objUsuario.getIdusuario(), enviados,objFiltro);
	}	

	@Override
	public List<Nodo> getTreeDocumentosRecibidos(Usuario objUsuario,
			boolean enviados) {
		log.debug("-> [Service] DocumentoService - getTreeDocumentosRecibidos():List<Nodo> ");
		
		List<Nodo> lstArbol = null;
		List<FilaBandejaUF> lstDocumentosRecibidos = documentoDao.findByDataUFDocumentosRecibidos(objUsuario.getIdusuario(), enviados); 

		if (lstDocumentosRecibidos != null) {
			log.debug("Numero de documentos recibidos encontradas  [" + lstDocumentosRecibidos.size() + "]");

			lstArbol = new ArrayList<Nodo>();

			for (FilaBandejaUF objDocumentosRecibidos : lstDocumentosRecibidos) {
				Nodo objNodo = new Nodo(Boolean.TRUE, objDocumentosRecibidos.getId(), objDocumentosRecibidos.getDocumento(), null);				
				log.debug("Nodo con ID [" + objDocumentosRecibidos.getId() + "] documento [" + objDocumentosRecibidos.getDocumento() + "]");
				lstArbol.add(objNodo);
			}
		}

		return lstArbol;

		/*
		List<Nodo> lstArbol = null;
		List<FilaBandejaUF> lstDocumentosRecibidos = documentoDao.findByDataUFDocumentosRecibidos(objUsuario.getIdusuario(), enviados);
		if (lstDocumentosRecibidos != null) {
			log.debug("Numero de documentos recibidos encontradas  [" + lstDocumentosRecibidos.size() + "]");

			lstArbol = new ArrayList<Nodo>();

			for (FilaBandejaUF objDocumentosRecibidos : lstDocumentosRecibidos) {
				
				
				
				
			}
		}


		Integer idExpediente ;//= 1;
		Integer idDocumento = 1;
		    idExpediente = (documentoDao.findByIdDocumento(idDocumento)).getExpediente().getId().intValue();
	        Expediente objExpediente = expedienteDAO.findByIdExpediente(idExpediente);
	        List<NodoArbol> lstTreeDocumento = new ArrayList<NodoArbol>();
	        List<NodoArbol> allElements = new ArrayList<NodoArbol>();
	        List<Documento> documentos = this.getDocumentosPorExpediente(idExpediente);
	        
	        boolean contieneDoc = false;
	        for (Documento documento : documentos) {
	        	if(documento.getDocumentoreferencia() == null){
	        		//No deben listarse las copias de trabajo--------------------------------------------------------------------
	        		if(documento.getIdDocumento().intValue() == idDocumento.intValue()){
	        			contieneDoc = true;
	        		}
	        		if(String.valueOf(documento.getEstado()).equals(String.valueOf(Constantes.ESTADO_ANULADO))){
	        			NodoArbol objETDocumento = new NodoArbol(false, "D-" + documento.getIdDocumento(), documento.getTipoDocumento().getNombre() + " - " + documento.getNumeroDocumento() + " (Anulado)", null);
	        			lstTreeDocumento.add(objETDocumento);
	        		}else{
	        			NodoArbol objETDocumento = new NodoArbol(false, "D-" + documento.getIdDocumento(), documento.getTipoDocumento().getNombre() + " - " + documento.getNumeroDocumento(), null);
	        			lstTreeDocumento.add(objETDocumento);
	        		}        
	        	}
	        }
	        if(!contieneDoc){
	        	Documento documento = this.findByIdDocumento(idDocumento);
	        	if(documento.getDocumentoreferencia() == null){
	        		//No deben listarse las copias de trabajo--------------------------------------------------------------------
	        		if(String.valueOf(documento.getEstado()).equals(String.valueOf(Constantes.ESTADO_ANULADO))){
	        			NodoArbol objETDocumento = new NodoArbol(false, "D-" + documento.getIdDocumento(), documento.getTipoDocumento().getNombre() + " - " + documento.getNumeroDocumento() + " (Anulado)", null);
	        			lstTreeDocumento.add(objETDocumento);
	        		}else{
	        			NodoArbol objETDocumento = new NodoArbol(false, "D-" + documento.getIdDocumento(), documento.getTipoDocumento().getNombre() + " - " + documento.getNumeroDocumento(), null);
	        			lstTreeDocumento.add(objETDocumento);
	        		}        		
	        	}
	        }
	        // Para documentos virtuales
	        List<Documentoxexpediente> lstDocXExp = objExpediente.getDocumentoxexpedienteList();
	        for (Documentoxexpediente objDocXExp : lstDocXExp) {
	            Documento objDocumento = objDocXExp.getDocumento();
	            log.debug("Documento Virtual con ID [" + objDocumento.getIdDocumento() + "]");
	            if(String.valueOf(objDocumento.getEstado()).equals(String.valueOf(Constantes.ESTADO_ANULADO))){
	    			NodoArbol objETDocumento = new NodoArbol(false, "V-" + objDocumento.getIdDocumento(),  objDocumento.getTipoDocumento().getNombre() + " - " + objDocumento.getNumeroDocumento() + " (Anulado)", null);
	    			lstTreeDocumento.add(objETDocumento);
	    		}else{
	    			NodoArbol objETDocumento = new NodoArbol(false, "V-" + objDocumento.getIdDocumento(),  objDocumento.getTipoDocumento().getNombre() + " - " + objDocumento.getNumeroDocumento(), null);
	    			lstTreeDocumento.add(objETDocumento);
	    		}
	        }
	        NodoArbol objExpedienteTree = new NodoArbol(true, "E-" + idExpediente, objExpediente.getNroexpediente(), lstTreeDocumento); // new
	        allElements.add(objExpedienteTree);
	        allElements.addAll(lstTreeDocumento);
	        return allElements;*/

	}

	@Override
	public List getContDocUsuarioFinal(Usuario objUsuario, boolean enviados,BusquedaAvanzada objFiltro) {

		List<FilaBandejaUF> lstDocumentosRecibidos;
		
		if(objFiltro==null){
			lstDocumentosRecibidos=documentoDao.findByDataUFDocumentosRecibidos(objUsuario.getIdusuario(), enviados);
		}else{
			lstDocumentosRecibidos=documentoDao.findByDataUFDocumentosRecibidosFiltro(objUsuario.getIdusuario(), enviados,objFiltro);
		}
		
		if(lstDocumentosRecibidos.size() != 0){	
			return lstDocumentosRecibidos;			
		}else{
			return null;
		}
	}

	@Override
	public List<Nodo> getTreeDocumentosRecibidosFiltro(Usuario objUsuario,
			boolean enviados, BusquedaAvanzada objFiltro) {
		log.debug("-> [Service] DocumentoService - getTreeDocumentosRecibidos():List<Nodo> ");
		
		List<Nodo> lstArbol = null;
		List<FilaBandejaUF> lstDocumentosRecibidos = documentoDao.findByDataUFDocumentosRecibidosFiltro(objUsuario.getIdusuario(), enviados,objFiltro); 

		if (lstDocumentosRecibidos != null) {
			log.debug("Numero de documentos recibidos encontradas  [" + lstDocumentosRecibidos.size() + "]");

			lstArbol = new ArrayList<Nodo>();

			for (FilaBandejaUF objDocumentosRecibidos : lstDocumentosRecibidos) {
				Nodo objNodo = new Nodo(Boolean.TRUE, objDocumentosRecibidos.getId(), objDocumentosRecibidos.getDocumento(), null);				
				log.debug("Nodo con ID [" + objDocumentosRecibidos.getId() + "] documento [" + objDocumentosRecibidos.getDocumento() + "]");
				lstArbol.add(objNodo);
			}
		}

		return lstArbol;		

	    
	}

	public ExpedienteDAO getExpedienteDAO() {
		return expedienteDAO;
	}

	public void setExpedienteDAO(ExpedienteDAO expedienteDAO) {
		this.expedienteDAO = expedienteDAO;
	}

	@Override
	public List<NodoArbol> getDojoDocumentoTree(BusquedaAvanzada objFiltro,Integer idExpediente,
			Integer idDocumento) {
		log.debug("-> [Service] DocumentoService - getDojoDocumentoTree():List<Nodo> ");
		//Expediente objExpediente = expedienteDAO.findByIdExpediente(idExpediente);

        List<NodoArbol> lstTreeDocumento = new ArrayList<NodoArbol>();
        List<NodoArbol> allElements = new ArrayList<NodoArbol>();
        
        Usuario objUsuario = null;
        mapSession = ActionContext.getContext().getSession();
		objUsuario = (Usuario) mapSession.get(Constantes.SESSION_USUARIO);
		

		List<FilaBandejaUF> listDoc = null;		
         
		if (objFiltro == null) {
			log.debug("SIN FILTRO");
			listDoc = documentoDao.findFilasDXETree(objUsuario.getIdusuario(), idDocumento, true);

		}else{
			listDoc = documentoDao.findFilasDXETreeFiltro(objFiltro, objUsuario.getIdusuario(), idDocumento, true);
			
		}

       
        for (FilaBandejaUF documentoItemUF : listDoc) {       	
    	        Documento documento = findByIdDocumento(documentoItemUF.getId());
    	        if(idDocumento != documento.getIdDocumento().intValue()){
    	        	NodoArbol objETDocumento = new NodoArbol(false, "D-" + documento.getIdDocumento(), documento.getTipoDocumento().getNombre() + " - " + documento.getNumeroDocumento(), null);           			
           			lstTreeDocumento.add(objETDocumento);
    			}       			
        }
        
        Documento documento = findByIdDocumento(idDocumento);
        NodoArbol objExpedienteTree = new NodoArbol(true, "E-" + idDocumento, documento.getTipoDocumento().getNombre() + " - " + documento.getNumeroDocumento(), lstTreeDocumento); // new
        
        allElements.add(objExpedienteTree);
        allElements.addAll(lstTreeDocumento);
        return allElements;
	}
	
		public void setGridColumnaXUsuarioService(GridcolumnaxusuarioService gridColumnaXUsuarioService) {
		this.gridColumnaXUsuarioService = gridColumnaXUsuarioService;
	}
	
}

